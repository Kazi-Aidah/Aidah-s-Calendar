<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aidah's Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&family=Open+Sans:wght@400;600&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
    /* Multi-day event spanning style */
    .event-item.long-event {
        position: absolute;
        left: 0;
        top: 2.2em; /* below day number */
        height: 2.2em;
        display: flex;
        align-items: center;
        z-index: 2;
        width: 100%;
        min-width: 0;
        border-radius: var(--event-item-roundness);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        font-size: 0.95em;
        padding: 0.2em 0.8em;
        margin-bottom: 0.2em;
        overflow: hidden;
        /* grid-column is set inline by JS */
    }
    .day-cell { position: relative; }
    .event-container { position: relative; min-height: 2.2em; }
        :root {
        --select-bg: var(--secondary-button-bg);
        --select-text: var(--secondary-button-text);
        --select-border: var(--day-cell-border-color);
        --select-radius: var(--ui-roundness);
        --select-arrow-color: #8B4B66;
        --select-arrow: url("data:image/svg+xml;utf8,<svg fill='none' stroke='REPLACEME' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M6 9l6 6 6-6'/></svg>");
        
        .slider-group {
            margin-bottom: 1.5em;
            position: relative;
            min-height: 48px;
        }
        .slider-group .slider-value {
            height: 2em;
            font-size: calc(var(--base-font-size) * 0.8);

            display: block;
        }

        /* Accordion Styles */
            .accordion {
            border-radius: 8px;
            background: var(--main-container-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 1rem;
            }
            .accordion-header {
            cursor: pointer;
            padding: 1rem 1.2rem;
            font-weight: 900;
            color: var(--accent-color);
            background: var(--main-container-bg);
            border-radius: 8px 8px 0 0;
            transition: background 0.2s;
            border: 3px solid var(--accent-color);
            text-align: center;
            transition: 0.3ms all ease;
            }
            .accordion-header:hover {
            background: var(--day-cell-hover-bg);
            color: var(--main-text-color);
            border-color: var(--main-text-color); 
            transition: 0.3ms all ease;
            }
            
            .accordion-content {
            display: block !important;
            max-height: 0 !important;
            overflow: hidden;
            padding: 1.2rem;
            transition: max-height 0.3s cubic-bezier(0.4,0,0.2,1);
            }
            .accordion.open .accordion-content {
            padding: 1.2rem;
            max-height: 1000px !important;
            }

        /* Pretty select dropdown */
        select#weekStartDropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: var(--select-bg);
            color: var(--select-text);
            border: 3px solid var(--select-border);
            border-radius: var(--select-radius);
            padding: 0.2rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-image: var(--select-arrow);
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 1.2em;

        .theme-arrow-update {
            --select-arrow: url("data:image/svg+xml;utf8,<svg fill='none' stroke='REPLACEME' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M6 9l6 6 6-6'/></svg>");
        }
            cursor: pointer;
            min-width: 140px;
        }
        select#weekStartDropdown:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(224,133,176,0.15);
        }
        select#weekStartDropdown option {
            color: var(--text-color);
            background: var(--main-container-bg);
            font-weight: 500;
        }
        .dropdown-container label[for="weekStartDropdown"] {
            font-weight: 400; 
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .dropdown-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .dropdown-container label[for="weekStartDropdown"] {
            font-weight: 400;
            color: var(--text-color);
            margin-right: 0.5rem;
            text-align: left;
            flex: 1;
        }
        .dropdown-container select#weekStartDropdown {
            flex: 0;
        }
            --base-font-size: 16px;
            --ui-roundness: 8px;
            --ui-roundness-lg: calc(var(--ui-roundness) * 1.5);
            --ui-roundness-full: 9999px;
            --event-item-border-thickness: 3px;
            --event-item-roundness: 8px;
            --day-cell-min-width: 140px;
            --text-color: #4A4A4A;
            --header-bg: #ffffff;
            --primary-button-bg: #FFFFFF;
            --primary-button-text: #E085B0;
            --secondary-button-bg: #F3E0E9;
            --secondary-button-text: #8B4B66;
            --accent-color: #E085B0;
            --day-cell-border-color: #D4DDE3;
            --main-container-bg: #ffffff;
            --day-cell-bg: #ffffff;
            --day-cell-hover-bg-color: #F8F0F5;
            --current-day-bg: #FFEAF4;
            --arrow-button-bg: transparent;
            --arrow-button-hover-bg: rgba(0,0,0,0.05);
            --arrow-button-text: #4B5563;
            --header-border-color: #E5E7EB;
            --day-cell-drag-bg: #e0f7fa;
            --current-day-border-color: var(--accent-color);
            --drag-over-border-color: var(--accent-color);
            --slider-track-bg: var(--secondary-button-bg);
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --custom-pickers-overlay-bg: rgba(255, 255, 255, 0.5);
            --holder-sidebar-width: 250px; 
            --holder-border-thickness: 2px; 

            --main-container-margin: 1rem auto;
            --main-container-width: 90vw;
            --main-container-height: calc(100vh - 2rem);
            --main-container-border-radius-actual: var(--ui-roundness-lg);
            --icon-padding-right: 0;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
            font-size: var(--base-font-size);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #main-container {
            margin: var(--main-container-margin);
            width: var(--main-container-width);
            max-width: var(--main-container-width);
            height: var(--main-container-height);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--main-container-bg);
            border-radius: var(--main-container-border-radius-actual);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            transition: all 0.2s ease-out;
        }
        

        @media (max-width: 768px) {
        .modal-footer,
        #add-event-footer,
        #edit-event-footer {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0.5rem 1rem 0.5rem;
                border-radius: 0 !important;
                padding: 1rem;
        }
            #main-container > div.modal-content, #settings-modal > div.modal-content {
                border-radius: 0 !important;
            }
        }

        .calendar-scroll-container {
            flex-grow: 1;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
            margin-bottom: -0.5rem;
        }
        .calendar-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: transparent;
        }
        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
        }
        .calendar-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .hide-scrollbars::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbars {
            scrollbar-width: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(var(--day-cell-min-width), 1fr));
            gap: 0.75rem;
            min-width: calc(7 * var(--day-cell-min-width) + 6 * 0.75rem);
            flex-shrink: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .day-cell {
            min-height: 120px;
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 3px solid var(--day-cell-border-color);
            background-color: var(--day-cell-bg);
            padding-bottom: 0.5rem;
            border-radius: var(--ui-roundness);
        }
        .day-cell.inactive {
            background-color: var(--body-bg);
            opacity: 0.9;
        }
        .day-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: var(--day-cell-hover-bg-color);
        }
        .current-day {
            border: 3px solid var(--current-day-border-color);
            background-color: var(--current-day-bg);
        }
        .day-cell.drag-over {
            border: 3px dashed var(--drag-over-border-color);
            background-color: var(--day-cell-drag-bg);
        }

        .day-cell.folded {
            max-height: var(--day-cell-max-height, 140px);
            overflow-y: auto !important;
            position: relative;
        }


        .day-cell.folded:hover {
            overflow-y: auto; 
        }
        .day-cell.folded.hide-scrollbars::-webkit-scrollbar {
            display: none;
        }
        .day-cell.folded.hide-scrollbars {
            scrollbar-width: none;
        }

        .custom-checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            margin-right: 0.5em;
            cursor: pointer;
            user-select: none;
        }
        .custom-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--event-item-text-color-rgba-50);
            border-radius: var(--ui-roundness);
            border: 3px solid var(--event-item-text-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            transition: background 0.2s, border-color 0.2s;
            position: relative;
            transition: 0.3ms all ease;
            right: 2.5px;
        }
        .custom-checkbox .checkmark-svg {
            opacity: 0;
            transition: opacity 0.15s;
            stroke: var(--event-item-text-color);
            transition: 0.3ms all ease;
        }
        .custom-checkbox.checked .checkmark-svg {
            opacity: 1;
            color: var(--primary-button-text);
            transition: 0.3ms all ease;
        }
        .custom-checkbox.checked {
            background: var(--event-item-primary-color);
            transition: 0.3ms all ease;
        }

        /* EVENT TEXT STYLING */
        .event-title.centered, .event-description.centered {
            text-align: center !important;
        }
        .event-title.right, .event-description.right {
            text-align: right !important;
        }
        .event-title.italic, .event-description.italic {
            font-style: italic !important;
        }
        .event-title.serif, .event-description.serif {
            font-family: 'Times New Roman', Times, serif !important;
        }
        .event-title.monospace, .event-description.monospace {
            font-family: 'Courier New', Courier, monospace !important;
        }


        .event-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.4rem 0.6rem;
            font-size: 0.75em;
            margin-bottom: 0.25rem;
            cursor: grab;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
            border-width: var(--event-item-border-thickness);
            border-style: solid;
            border-radius: var(--event-item-roundness);
            position: relative;
        }
        .event-item:hover {
            filter: brightness(1.05);
        }
        .event-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--drag-over-border-color);
        }
        .event-item.drop-target-top {
            border-top: 3px solid var(--accent-color);
        }
        .event-item.drop-target-bottom {
            border-bottom: 3px solid var(--accent-color);
        }

        .event-item.striped2-effect {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 16px 16px;
        }

        .event-item.striped-effect {
            background-image: linear-gradient(135deg, var(--event-item-text-color-rgba-25) 25%, transparent 25%, transparent 50%, var(--event-item-text-color-rgba-25) 50%, var(--event-item-text-color-rgba-25) 75%, transparent 75%, transparent);
            background-size: 16px 16px;
        }

        .event-item.dotted-effect {
            background-image: radial-gradient(circle at 3px 3px, var(--event-item-text-color-rgba-25) 2px, transparent 0);
            background-size: 8px 8px;
        }

        .event-item.glowing {
            box-shadow: 0 0 8px var(--event-item-text-color), 0 0 15px var(--event-item-text-color);
        }

        .event-item.crosshatched-effect {
            background-image:
                repeating-linear-gradient(45deg, var(--event-item-text-color-rgba-25) 0 2px, transparent 2px 8px),
                repeating-linear-gradient(-45deg, var(--event-item-text-color-rgba-25) 0 2px, transparent 2px 8px);
            background-size: 12px 12px;
        }

        .event-item.checkerboard-effect {
            background-image: 
                repeating-conic-gradient(
                    var(--event-item-text-color-rgba-25) 0deg 90deg,
                    transparent 90deg 180deg,
                    var(--event-item-text-color-rgba-25) 180deg 270deg,
                    transparent 270deg 360deg
                );
            background-size: 16px 16px;
        }

        .event-item.argyle-effect {
            background-image: repeating-linear-gradient(45deg, var(--event-item-text-color-rgba-25) 0 8px, transparent 8px 16px),
                            repeating-linear-gradient(-45deg, var(--event-item-text-color-rgba-25) 0 8px, transparent 8px 16px);
            background-size: 16px 16px;
        }


        .event-item.thin-stripes-effect {
            background-image: repeating-linear-gradient(45deg, var(--event-item-text-color-rgba-25) 0 2px, transparent 2px 8px);
            background-size: 10px 10px;
        }


        .event-item.zigzag-lines-effect {
            --zigzag-color: var(--event-item-text-color-rgba-25);

            background-image: linear-gradient(
                to right,
                var(--zigzag-color) 25%,
                transparent 25%,
                transparent 75%,
                var(--zigzag-color) 75%
            );
            background-size: 10px 100%;
            position: relative;
        }

        .event-item.zigzag-lines-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background:
                linear-gradient(
                    -45deg,
                    transparent 75%,
                    var(--zigzag-color) 75%
                ),
                linear-gradient(
                    45deg,
                    transparent 75%,
                    var(--zigzag-color) 75%
                );
            background-size: 10px 8px;
            background-repeat: repeat-x;
        }


        .event-item.wavy-lines-effect {
            color: var(--event-item-text-color);
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='8'><path d='M0 4 Q 10 0 20 4 T 40 4' stroke='currentColor' stroke-width='2' fill='none' opacity='0.25'/></svg>");
            background-repeat: repeat;
            background-size: 40px 8px;
        }

.event-item.win95-button-effect {
  font-family: 'Courier New', monospace;
  font-size: 14px;
  color: var(--event-item-text-color, #000);

  background: linear-gradient(
    180deg,
    var(--event-item-primary-color, #e0e0e0) 0%,
    #c0c0c040 100%
  );

  border: 0px solid #808080;
  border-top-color: #ffffff;
  border-left-color: #ffffff;

  box-shadow:
    inset 2px 2px 0 #ffffff90,
    inset -3px -3px 0 #00000080;

  border-radius: 2px;
  padding: 4px 10px;
  cursor: pointer;
  user-select: none;
  transition: all 0.1s ease-in-out;
  text-align: center;
}

        /* for the icon placement dropdown bc I forgot how I did the week start day one ugh */
        .styled-dropdown {
            background: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 3px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            padding: 0.1em 2em;
            font-size: 1em;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.2s;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
            min-width: 120px;
            text-align: center;
        }
        .styled-dropdown:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb, 224,133,176), 0.2);
        }
        .styled-dropdown option {
            background: var(--day-cell-bg);
            color: var(--text-color);
        }




        .event-item.embossed-effect {
            box-shadow: 0 2px 4px 0 rgba(255,255,255,0.5) inset, 0 -2px 4px 0 rgba(0,0,0,0.15) inset;
            border: var(--event-item-border-thickness) solid rgba(0,0,0,0.07); /* EMBOSSED EFFECT PX CHANGE */
        }

        /* ANIMATED EFFECTS AHAHHAHAHA */
        .event-item.move-effect-horizontal {
            animation: move-effect-horizontal 2s linear infinite;
        }
        @keyframes move-effect-horizontal {
            0% { background-position-x: 0; }
            100% { background-position-x: 40px; }
        }

        .event-item.move-effect-vertical {
            animation: move-effect-vertical 2s linear infinite;
        }
        @keyframes move-effect-vertical {
            0% { background-position-y: 0; }
            100% { background-position-y: 40px; }
        }

        /* MOVEMENT BROKEN SO WE MUST CRY */
        .event-item.striped-effect,
        .event-item.striped2-effect {
            background-size: 16px 16px;
        }
        .event-item.striped-effect.move-effect-horizontal,
        .event-item.striped2-effect.move-effect-horizontal {
            animation: move-effect-horizontal-16 2s linear infinite;
        }
        @keyframes move-effect-horizontal-16 {
            0% { background-position-x: 0; }
            100% { background-position-x: 16px; }
        }

        .event-item.crosshatched-effect {
            background-size: 12px 12px;
        }
        .event-item.crosshatched-effect.move-effect-horizontal {
            animation: move-effect-horizontal-12 2s linear infinite;
        }
        @keyframes move-effect-horizontal-12 {
            0% { background-position-x: 0; }
            100% { background-position-x: 12px; }
        }

        .event-item.checkerboard-effect {
            background-size: 16px 16px;
        }
        .event-item.checkerboard-effect.move-effect-horizontal {
            animation: move-effect-horizontal-16 2s linear infinite;
        }
        @keyframes move-effect-horizontal-16 {
            0% { background-position-x: 0; }
            100% { background-position-x: 16px; }
        }

        .event-item.argyle-effect {
            background-size: 16px 16px;
        }
        .event-item.argyle-effect.move-effect-horizontal {
            animation: move-effect-horizontal-16 2s linear infinite;
        }
        @keyframes move-effect-horizontal-16 {
            0% { background-position-x: 0; }
            100% { background-position-x: 16px; }
        }

        /* vertical movements */
        .event-item.checkerboard-effect.move-effect-vertical,
        .event-item.striped-effect.move-effect-vertical,
        .event-item.striped2-effect.move-effect-vertical,
        .event-item.argyle-effect.move-effect-vertical {
            animation: move-effect-vertical-16 2s linear infinite;
        }
        @keyframes move-effect-vertical-16 {
            0% { background-position-y: 0; }
            100% { background-position-y: 16px; }
        }

        /* Crosshatched vertical movement */
        .event-item.crosshatched-effect.move-effect-vertical {
            animation: move-effect-vertical-12 2s linear infinite;
        }
        @keyframes move-effect-vertical-12 {
            0% { background-position-y: 0; }
            100% { background-position-y: 12px; }
        }

        /* WORKS AS INTENDED */
        .event-item.particles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-shadow:
                0px 0px 0 0px var(--event-item-text-color),
                10px 15px 0 0px var(--event-item-text-color),
                -5px 20px 0 0px var(--event-item-text-color),
                15px 5px 0 0px var(--event-item-text-color),
                -10px -10px 0 0px var(--event-item-text-color);
            animation: particle-flow 5s linear infinite;
            opacity: 0.7;
        }

        @keyframes particle-flow {
            0% {
                transform: translate(0, 0);
                opacity: 0.7;
                box-shadow:
                    0px 0px 0 0px var(--event-item-text-color),
                    10px 15px 0 0px var(--event-item-text-color),
                    -5px 20px 0 0px var(--event-item-text-color),
                    15px 5px 0 0px var(--event-item-text-color),
                    -10px -10px 0 0px var(--event-item-text-color);
            }
            100% {
                transform: translate(calc(100% * var(--particle-x-dir, 1)), calc(100% * var(--particle-y-dir, 1)));
                opacity: 0;
                box-shadow:
                    calc(100% * var(--particle-x-dir, 1)) calc(100% * var(--particle-y-dir, 1)) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 10px) calc(100% * var(--particle-y-dir, 1) + 15px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 5px) calc(100% * var(--particle-y-dir, 1) + 20px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 15px) calc(100% * var(--particle-y-dir, 1) + 5px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 10px) calc(100% * var(--particle-y-dir, 1) - 10px) 0 0px var(--event-item-text-color);
            }
        }

        .event-item.snow-falling::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(ellipse at 20% 10%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 70% 30%, var(--event-item-text-color-rgba-25) 2px, transparent 4px),
                radial-gradient(ellipse at 50% 50%, var(--event-item-text-color-rgba-25) 2.5px, transparent 5px),
                radial-gradient(ellipse at 90% 70%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 30% 90%, var(--event-item-text-color-rgba-25) 2.2px, transparent 4.4px),
                radial-gradient(ellipse at 10% 60%, var(--event-item-text-color-rgba-25) 2.4px, transparent 4.8px),
                radial-gradient(ellipse at 40% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(ellipse at 80% 10%, var(--event-item-text-color-rgba-25) 1.2px, transparent 2.4px),
                radial-gradient(ellipse at 15% 40%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 60% 80%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 25% 70%, var(--event-item-text-color-rgba-25) 1.3px, transparent 2.6px),
                radial-gradient(ellipse at 85% 50%, var(--event-item-text-color-rgba-25) 1.7px, transparent 3.4px);
            background-size: 200px 200px;
            animation: snow-fall 5s linear infinite;
            pointer-events: none;
        }

        @keyframes snow-fall {
            0% { 
                background-position: 
                    0 0, 50px 50px, 100px 100px, 150px 150px, 200px 200px, 250px 250px,
                    30px 30px, 80px 80px, 130px 130px, 180px 180px, 230px 230px, 280px 280px; 
            }
            100% { 
                background-position: 
                    0 400px, 50px 450px, 100px 500px, 150px 550px, 200px 600px, 250px 650px,
                    30px 430px, 80px 480px, 130px 530px, 180px 580px, 230px 630px, 280px 680px; 
            }
        }

        .event-item.glistening-stars::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(circle at 10% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(circle at 70% 80%, var(--event-item-text-color-rgba-25) 1.2px, transparent 2.2px),
                radial-gradient(circle at 40% 60%, var(--event-item-text-color-rgba-25) 0.8px, transparent 1.8px),
                radial-gradient(circle at 90% 30%, var(--event-item-text-color-rgba-25) 1.1px, transparent 2.1px),
                radial-gradient(circle at 25% 70%, var(--event-item-text-color-rgba-25) 0.9px, transparent 1.9px),
                radial-gradient(circle at 60% 10%, var(--event-item-text-color-rgba-25) 1.3px, transparent 2.3px);
            background-size: 50px 50px;
            animation: twinkle 2s ease-in-out infinite alternate, twinkle-scale 3s ease-in-out infinite;
            animation-delay: 0s, 1s;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            70% { opacity: 1; }
        }

        @keyframes twinkle-scale {
            0% { transform: scale(1); }
            40% { transform: scale(0.95); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }


        .event-item.gradient-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(45deg, 
                    var(--event-item-text-color-rgba-25) 0%, 
                    hsla(180, 100%, 50%, 0.315) 25%, 
                    hsla(270, 100%, 50%, 0.321) 50%,
                    hsla(0, 100%, 50%, 0.268) 75%, 
                    var(--event-item-text-color-rgba-25) 100%);
            background-size: 200% 200%;
            animation: 
                subtle-gradient 6s ease-in-out infinite alternate,
                hue-rotate 12s linear infinite;
            mix-blend-mode: overlay;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes subtle-gradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes hue-rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .event-item.animated-stripes {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: stripes-animation 2s linear infinite;
        }

        @keyframes stripes-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 0;
            }
        }

.event-item.animated-vertical-rainbow {
    position: relative;
    overflow: hidden;
}

.event-item.animated-vertical-rainbow::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        to bottom,
        hsla(0, 100%, 50%, 0.3) 0%,
        hsla(30, 100%, 50%, 0.3) 10%,
        hsla(60, 100%, 50%, 0.3) 20%,
        hsla(120, 100%, 50%, 0.3) 40%,
        hsla(240, 100%, 50%, 0.3) 60%,
        hsla(270, 100%, 50%, 0.3) 80%,
        hsla(300, 100%, 50%, 0.3) 100%
    );
    background-size: 100% 300%;
    animation: vertical-rainbow-scroll 1s linear infinite;
    z-index: 0;
    mix-blend-mode: overlay;
    opacity: 0.5;
    pointer-events: none;
    border-radius: inherit;
}

@keyframes vertical-rainbow-scroll {
    0% { background-position: 0% 0%; }
    100% { background-position: 0% 100%; }
}

.event-item.animated-vertical-rainbow > * {
    position: relative;
    z-index: 1;
}


        .event-item.no-animations {
            animation: none !important;
            transition: none !important;
        }
        .event-item.no-animations::before,
        .event-item.no-animations::after {
            animation: none !important;
            transition: none !important;
            display: none !important;
        }


        .event-item .main-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .event-item .text-content {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-grow: 1;
            min-width: 0;
            width: 100%;
        }
        .event-item .text-content .time-title-wrapper {
            display: flex;
            flex-wrap: wrap;
            flex-grow: 1;
            min-width: 0;
            align-items: baseline;
            width: 100%;
        }
        .event-item .text-content .time-title-wrapper .time-part {
            flex-shrink: 0;
            white-space: nowrap;
            margin-right: 0.25rem;
        }
        .event-item .text-content .time-title-wrapper .title-part {
            flex-grow: 1;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
            min-width: 0;
        }
        /* --- Customization toggles CSS --- */
        .event-item .custom-checkbox.dashed-border {
            border-style: dashed !important;
        }
        .event-item .main-content.strikethrough-text .title-part,
        .event-item .main-content.strikethrough-text .time-part {
            text-decoration: line-through;
        }
        .event-item .main-content.bold-title .title-part {
            font-weight: bold !important;
        }

        .event-item .event-icon-container {
            position: absolute;
            top: 0.1rem;
            right: 0.6rem;
            z-index: 10;
            font-size: 1.25rem;
            width: 1.5rem;
            text-align: center;
        }

        .event-description {
            font-size: 0.85em;
            white-space: normal;
            line-height: 1.2;
            margin-top: 0.2rem;
            padding-bottom: 3px;
            width: 100%;
            word-break: break-word;
        }

        
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 500px; 
            height: 100%;
            background: none; 
            box-shadow: -4px 0 16px rgba(0,0,0,0.08); 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            z-index: 999;
            transition: transform 0.3s ease;
        }
        .modal-content {
            background-color: var(--main-container-bg);
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            max-height: 90vh;
            overflow-y: hidden;
            border-radius: var(--ui-roundness);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
            border: 3px solid var(--day-cell-border-color);
        }

        body.dark-mode .modal-content {
            border: 3px solid var(--day-cell-border-color);
        }
        body.dark-mode .modal-content {
            border-color: var(--day-cell-border-color);
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #settings-modal .modal-content {
            width: 100%;
            max-width: 500px;
            height: 95%;
            min-height: 95%;
            border-radius: 0 !important; /* Here is our Settings modal radius adjustments, okie?*/
            border-top-left-radius: var(--ui-roundness) !important;
            border-bottom-left-radius: var(--ui-roundness) !important;
            border: 3px solid var(--day-cell-border-color);
            /* box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); */
            display: flex;
            flex-direction: column;
            padding: 0;
            position: relative;
            margin: 0 auto;
            top: 2.5%;
            left: 0;
            transform: none;
        }

        #settings-modal .modal-content h3 .fas,
        #settings-modal .modal-content h4 .fas {
            padding-right: 0.2em;
        }


        #settings-modal .modal-content h3 {
            margin-bottom: 0.5rem; 
            margin-top: 0.5rem; 
            padding-left: 0.2rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            border-bottom: 2px solid var(--day-cell-border)
        }

        .h4-settings {
            margin-top: 0rem !important;  
            margin-bottom: 0.3rem !important; 
            padding-left: 0.2rem;
            font-size: 1.15rem;
            font-weight: 600;
            text-align: left;
        }


        body.dark-mode #settings-modal .modal-content {
            border-radius: var(--ui-roundness) !important;
            border: 3px solid var(--day-cell-border-color) !important;
            border-color: var(--day-cell-border-color) !important;
        }

        .modal-content-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-right: 0.5rem;
        }
        .modal-content-scrollable::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .modal-content-scrollable {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .modal-footer {
            position: sticky;
            bottom: 0;
            background-color: var(--main-container-bg);
            padding: 1.5rem 1.5rem 1.5rem 0;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-bottom-left-radius: var(--ui-roundness-lg);
            border-bottom-right-radius: var(--ui-roundness-lg);
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        @media (max-width: 500px) {
            #main-container {
                border-radius: 0px !important;
            }

        .modal-footer .themed-button,
        #add-event-footer .themed-button,
        #edit-event-footer .themed-button {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            box-sizing: border-box;
            margin: 0;
            min-width: 0;
            padding: 0.4rem 0.4rem;
        }
        .modal-footer,
        #add-event-footer,
        #edit-event-footer {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
            gap: 0.5rem;
            padding: 1rem 0.5rem 1rem 0.5rem;
        }
        #add-event-footer .themed-button:first-child {
            flex: 0 1 45%;
            min-width: 80px;
            max-width: 140px;
        }
        #add-event-footer .themed-button:nth-child(2) {
            flex: 0 1 55%;
            min-width: 100px;
            max-width: 200px;
        }
        #edit-event-footer .themed-button:first-child {
            flex: 0 1 20%;
            min-width: 60px;
            max-width: 80px;
            padding: 0.2rem !important;
        }
        #edit-event-footer .themed-button:nth-child(2) {
            flex: 0 1 35%;
            min-width: 80px;
            max-width: 140px;
        }
        #edit-event-footer .themed-button:nth-child(3) {
            flex: 0 1 45%;
            min-width: 100px;
            max-width: 200px;
        }

        }
        #edit-event-footer .themed-button {
            pointer-events: auto;
            z-index: 1;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            border: 3px solid var(--day-cell-border-color);
            padding: 0.5rem;
            border-radius: var(--ui-roundness);
        }
        .icon-grid::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .icon-grid {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }


        .icon-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            background-color: var(--secondary-button-bg);
            cursor: pointer;
            font-size: 1.25em;
            transition: background-color 0.2s, transform 0.1s, color 0.2s;
            border-radius: var(--ui-roundness);
            color: var(--secondary-button-text);
        }
        .icon-item.selected {
            background-color: var(--primary-button-bg);
            border: 2px solid var(--primary-button-text);
            color: var(--primary-button-text);
        }
        .icon-item:hover {
            background-color: var(--secondary-button-hover-bg);
            transform: scale(1.05);
        }

                /* Icon Placement: Right (default) */
        body[data-icon-placement="right"] .event-item .main-content {
            flex-direction: row;
        }
        body[data-icon-placement="right"] .event-item .event-icon-container {
            order: 2;
            margin-left: 0.5rem;
            margin-right: 0;
            position: static;
        }
        body[data-icon-placement="right"] .event-item .text-content {
            order: 1;
        }

        /* Icon Placement: Left */
        body[data-icon-placement="left"] .event-item .main-content {
            display: flex !important;
            align-items: center !important;
            flex-direction: row !important;
            justify-content: flex-start !important;
        }
        body[data-icon-placement="left"] .event-item .event-icon-container {
            order: 1 !important;
            margin-right: 0.5em !important;
            margin-left: 0 !important;
            position: static !important;
        }
        body[data-icon-placement="left"] .event-item .text-content {
            order: 2 !important;
        }

        /* Icon Placement: Top */
        body[data-icon-placement="top"] .event-item .main-content {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        body[data-icon-placement="top"] .event-item .event-icon-container {
            order: 1 !important;
            margin-bottom: 0px !important;
            margin-right: 0 !important;
            margin-left: 0 !important;
            position: static !important;
        }
        body[data-icon-placement="top"] .event-item .text-content {
            order: 2 !important;
            width: 100% !important;
            justify-content: center !important;
        }

        /* Icon Placement: Top Left :D */
        body[data-icon-placement="top-left"] .event-item .main-content {
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }
        body[data-icon-placement="top-left"] .event-item .icon-top-left-iconrow {
            width: 100% !important;
            text-align: left !important;
            display: block !important;
            margin-bottom: 0.1em !important;
        }
        body[data-icon-placement="top-left"] .event-item .icon-top-left-textrow {
            width: 100% !important;
            text-align: left !important;
            display: block !important;
        }
        body[data-icon-placement="top-left"] .event-item .event-icon-container {
            margin-bottom: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            order: 1 !important;
            position: static !important;
        }
        body[data-icon-placement="top-left"] .event-item .text-content {
            order: 2 !important;
            width: 100% !important;
        }

        /* Icon Placement: Top Right */
        body[data-icon-placement="top-right"] .event-item .main-content {
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-end !important;
            justify-content: flex-start !important;
        }
        body[data-icon-placement="top-right"] .event-item .event-icon-container {
            margin-bottom: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            order: 1 !important;
            position: static !important;
        }
        body[data-icon-placement="top-right"] .event-item .text-content {
            order: 2 !important;
            width: 100% !important;
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .color-box {
            width: 30px;
            height: 30px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.1s;
            border-radius: var(--ui-roundness);
        }
        .color-box.selected {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }
        .color-box:hover {
            transform: scale(1.05);
        }

        .theme-box {
            width: 150px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            border: 3px solid rgba(var(--secondary-button-text-rgb), 0.5); 
            border-radius: var(--ui-roundness);
            transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .theme-box .color-preview {
            width: 40px;
            height: 20px;
            border-radius: var(--ui-roundness);
            margin-bottom: 0.25rem;
            border: 1px solid rgba(0,0,0,0.1);
        }


        .theme-box.selected {
            border-width: 4px;
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .special-theme-box.selected {
            border-width: 4px !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
        }
        .theme-box:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .custom-file-input {
            position: fixed;
            left: -9999px;
            width: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .custom-file-input + label {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            border-radius: var(--ui-roundness);
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--secondary-button-text);
            width: 100%;
            justify-content: center;
        }
        .custom-file-input + label:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .custom-file-input:focus + label {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .themed-button {
            padding: 0.75rem 1.5rem;
            border-radius: var(--ui-roundness);
            font-weight: 600;
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 3px solid var(--primary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .themed-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
            border-color: var(--primary-button-text);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .themed-button.secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 3px solid var(--secondary-button-text);
        }
        .themed-button.secondary:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            border-color: var(--secondary-button-text);
        }
        .themed-button.danger {
            background-color: #ef4444;
            color: white;
            border: 3px solid #dc2626;
        }
        .themed-button.danger:hover {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        input[type="text"], textarea {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input[type="text"]::placeholder, textarea::placeholder {
            color: var(--day-cell-border-color);
            opacity: 1;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border: 3px solid var(--text-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        /* input:focus, textarea:focus {
            outline: none;
            border: 3px solid var(--text-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        } */
        #iconSearchInput {
            border: 3px solid var(--day-cell-border-color);
        }

        input[type="time"], input[type="date"] {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            position: relative;
            padding-right: 2.5rem;
        }

        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--day-cell-border-color); 
        }
        input[type="time"]:focus::-webkit-calendar-picker-indicator,
        input[type="date"]:focus::-webkit-calendar-picker-indicator {
            color: var(--accent-color);
        }
        input[type="time"]::-moz-calendar-picker-indicator,
        input[type="date"]::-moz-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            color: var(--day-cell-border-color);
        }
        input[type="time"]:focus::-moz-calendar-picker-indicator,
        input[type="date"]:focus::-moz-calendar-picker-indicator {
            color: var(--accent-color); 
        }


        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: var(--slider-track-bg);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s, background-color .2s, box-shadow .2s;
            border-radius: var(--ui-roundness);
            border: 0px solid transparent !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.1);
            cursor: grabbing;
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-moz-range-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range:active {
            transform: scale(1.1);
            cursor: grabbing;
            border: 0px !important;
            border: 0px solid transparent !important;
        }


        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .color-input-group label {
            flex-grow: 1;
            font-size: 0.9em;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .toggle-container + .toggle-container {
            margin-top: 0.55rem;
        }

        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 44px;
            width: 44px;
            height: 26px;
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 3px; 
            left: 3px; 
            width: 20px;
            height: 20px;
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
        }

        input[type="checkbox"]:checked::before {
            transform: translateX(18px);
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
        }

        .toggle-label {
            margin-left: 0.5rem;
            cursor: pointer;
            display: inline-block;
            color: var(--text-color);
            flex-grow: 1;
            white-space: normal;
        }


        .special-theme-box {
            position: relative;
            border: 3px solid rgba(var(--secondary-button-text-rgb), 0.5);
        }

        .special-theme-lock-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--ui-roundness);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
        }

        .special-theme-box.unlocked .special-theme-lock-overlay {
            opacity: 0;
            pointer-events: none;
        }

        .special-theme-box.unlocked {
             border-color: var(--accent-color) !important;
        }

        .h4-settings {
            font-size: calc(var(--base-font-size) * 1.2);
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .last-saved-theme-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 3px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            padding: 0.5rem;
            background-color: var(--day-cell-bg);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            min-width: 100px;
        }
        .last-saved-theme-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .last-saved-theme-preview .color-swatches {
            display: flex;
            gap: 2px;
            width: 100%;
            height: 30px;
            border-radius: var(--ui-roundness);
            overflow: hidden;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .last-saved-theme-preview .color-swatch-main {
            flex-grow: 1;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .color-swatch-header {
            width: 30%;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .theme-name {
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .last-saved-theme-preview .apply-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: var(--ui-roundness);
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 2px solid var(--primary-button-text);
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .last-saved-theme-preview .apply-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
        }

        .event-icon-display {
            width: 60px;
            height: 60px; 
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            border: 3px solid var(--day-cell-border-color);
            cursor: pointer;
            font-size: 1.5em; 
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .event-icon-display:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        .event-icon-display.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        #holder-sidebar {
            background-color: var(--main-container-bg);
            border-right: var(--holder-border-thickness) solid var(--day-cell-border-color); 
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.15);
            transition: left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out;
            width: var(--holder-sidebar-width);
            overflow: hidden;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: calc(-1 * var(--holder-sidebar-width));
            height: 100%;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
        }
        #holder-sidebar.active {
            pointer-events: auto;
            left: 0;
        }

        #holder-sidebar h3 {
            color: var(--text-color);
            transition: color 0.3s ease-in-out;
            text-align: center;
            margin-bottom: 1rem;
        }
        #holder-content {
            border-color: var(--day-cell-border-color);
            background-color: var(--day-cell-bg);
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            border: 2px dashed var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
        }

        #addHolderEventButton.styled-like-holder {
            background-color: var(--day-cell-bg);
            color: var(--text-color);
            border: 3px solid var(--day-cell-border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        #addHolderEventButton.styled-like-holder:hover {
            background-color: var(--day-cell-hover-bg-color);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #eventContextMenu {
            position: fixed;
            background-color: var(--main-container-bg);
            border: 1px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0.5rem 0;
            min-width: 150px;
            display: none;
            flex-direction: column;
        }

        #eventContextMenu button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1rem;
            width: 100%;
            text-align: left;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #eventContextMenu button:hover {
            background-color: var(--day-cell-hover-bg-color);
        }

        #holderSidebarCloseButton {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            z-index: 60;
        }

        @media (max-width: 768px) {
            #holderSidebarCloseButton {
                display: block;
            }
        }

        /* EDIT EVENT FOOTER BUTTONS ADJUST BIG
      #edit-event-footer button,
      .modal-footer button {
        flex-direction: row;
        gap: 0.5rem;
        justify-content: center;
        align-items: stretch;
      }

      #edit-event-footer,
      .modal-footer {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        width: 100%;
      }

      #deleteEvent.themed-button.secondary {
        align-self: center;
        justify-content: center;
        text-align: center;
        height: 100%;
      } */


        .dark-mode-toggle-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1em; 
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: var(--ui-roundness);
            border: 3px solid var(--secondary-button-text);
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 100px;
            height: calc(80px * 2 + 0.75rem);             
            flex-shrink: 0; 
        }
        .dark-mode-toggle-button.selected {
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border-color: var(--secondary-button-text);
            border-width: 4px;
        }
        .dark-mode-toggle-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .dark-mode-toggle-button .small-text {
            font-size: 0.7em; 
            font-weight: 400;
            margin-top: 0.25rem;
        }



        @media (min-width: 768px) {

            /* .modal-content {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            #premadeThemeBoxesContainer {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            #premadeThemeBoxes {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 0.75rem;
                width: auto;
                transform: translateX(6px);
            }

            #specialThemeBoxes {
                display: grid;
                width: auto;
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 0.75rem;
            }
            
            .dark-mode-toggle-button {
                height: auto;
                min-height: calc(85px * 2 + 0.75rem);
            } */
            
        }

        @media (max-width: 767px) { 
            #premadeThemeBoxesContainer {
                flex-direction: column; 
                align-items: center;
            }
            .dark-mode-toggle-button {
                width: 100%; 
                height: auto; 
                margin-bottom: 0.75rem; 
            }
            #premadeThemeBoxes {
                width: 100%; 
                justify-content: center; 
            }
            #premadeThemeBoxes .theme-box,
            #specialThemeBoxes .theme-box {
                flex-basis: calc(50% - 0.375rem); 
                max-width: calc(50% - 0.375rem);
            }
            
        }
        #premadeThemeBoxesContainer {
            flex-direction: column;
            align-items: center;
        }
        .dark-mode-toggle-button {
            width: 100%;
            height: auto;
            margin-bottom: 0.75rem;
        }
        #premadeThemeBoxes {
            width: 100%;
            justify-content: center;
        }
        #premadeThemeBoxes .theme-box,
        #specialThemeBoxes .theme-box {
            flex-basis: calc(50% - 0.375rem);
            max-width: calc(50% - 0.375rem);
        }

    @media (min-width: 501px) {
        .modal-overlay:not(#settings-modal):not(.hidden) {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            /* background: var(--modal-overlay-bg, rgba(0,0,0,0.5)); */
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .modal-overlay:not(#settings-modal) .modal-content {
            margin: 0 auto;
            left: 0 !important;
            right: 0 !important;
            top: 0 !important;
            bottom: 0 !important;
            position: relative !important;
            transform: none !important;
            border-radius: var(--ui-roundness-lg) !important;
            width: 100%;
            max-width: 500px;
            min-width: 320px;
            height: auto;
            max-height: 90vh;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        }

        @media (max-width: 500px) {
                @media (max-width: 500px) {
      #add-event-footer button,
      #edit-event-footer button,
      .modal-footer button {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        justify-content: center;
        align-items: stretch;
      }

      #add-event-footer,
      #edit-event-footer,
      .modal-footer {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        width: 100%;
      }


      .modal-footer {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        justify-content: center;
        align-items: stretch;
      }
        .modal-footer .themed-button {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem 0.4rem;
        font-size: 0.95em;
        box-sizing: border-box;
        margin: 0;
        width: 100%;
        min-width: 0;
        }
          .modal-footer .themed-button:first-child {
            flex: 1 1 20%;
            padding: 0.2rem !important;
          }
          .modal-footer .themed-button:nth-child(2) {
            flex: 2 1 35%;
          }
          .modal-footer .themed-button:nth-child(3) {
            flex: 3 1 45%;
          }
          .modal-footer.two-buttons .themed-button:first-child {
            flex: 2 1 40%;
          }
          .modal-footer.two-buttons .themed-button:nth-child(2) {
            flex: 3 1 60%;
          }
    
            #settings-modal.modal-overlay:not(.hidden) {
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: var(--modal-overlay-bg, rgba(0,0,0,0.5));
                display: flex !important;
                align-items: center;
                justify-content: center;
                z-index: 999;
            }
            #settings-modal .modal-content {
                width: 99vw !important;
                max-width: 99vw !important;
                min-width: 99vw !important;
                border-radius: 0 !important;
                left: 0 !important;
                top: 0 !important;
                margin: 0 !important;
                height: 90vh !important;
                min-height: 90vh !important;
                max-height: 90vh !important;
                position: static !important;
                transform: none !important;
                box-shadow: none !important;
            }

              .heading-settings {
                margin-top: -0.5rem !important;
            }
    
            .modal-overlay:not(#settings-modal):not(.hidden) {
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: var(--modal-overlay-bg, rgba(0,0,0,0.5));
                display: flex !important;
                align-items: center;
                justify-content: center;
                z-index: 999;
            }
            .modal-overlay:not(#settings-modal) .modal-content {
                width: 100vw !important;
                max-width: 100vw !important;
                min-width: 100vw !important;
                border-radius: 0 !important;
                left: 0 !important;
                top: 0 !important;
                margin: 0 !important;
                height: auto !important;
                min-height: 0 !important;
                max-height: 90vh !important;
                position: static !important;
                transform: none !important;
                box-shadow: none !important;
            }
    
            .modal-content {
                padding: 1rem 1.5rem !important;
                border-radius: 0.5rem !important;
                height: 100vh;
            }
            .modal-content-scrollable {
                padding: 0.7rem !important;
                overflow-x: hidden !important;
                padding-right: 0.2rem !important;
            }
            .modal-footer {
                padding: 0.7rem !important;
                gap: 0.4rem !important;
                border-bottom-left-radius: 0.5rem !important;
                border-bottom-right-radius: 0.5rem !important;
            }
        }

        

        .resize-handle {
            width: 1.5px;
            height: 100%;
            background-color: var(--day-cell-border-color);
            position: absolute;
            right: 0;
            top: 0;
            cursor: ew-resize;
            z-index: 51;
            transition: background-color 0.2s ease;
        }
        .resize-handle:hover {
            background-color: var(--accent-color);
        }

        /* Custom checkbox styles for event items */
        .event-item .event-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid currentColor; 
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
            flex-shrink: 0;
            margin-right: 0.5rem;
            position: relative;
            top: 1px;
        }

        .event-item .event-checkbox:checked {
            background-color: currentColor; 
            border-color: currentColor;
        }

        .event-item .event-checkbox:checked::after {
            content: '\2713'; /* Checkmark character */
            display: block;
            color: var(--event-item-primary-color); 
            font-size: 14px;
            line-height: 1;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .event-item.completed {
            opacity: 0.7;
        }
        /* FOCUS TAILWIND OVERRIDE */
        input[type="text"]:focus,
        input[type="time"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            --tw-ring-color: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 1px var(--accent-color) !important;
        }
    }

            .selected-range {
                background-color: var(--current-day-bg) !important;
                border: 3px solid var(--current-day-border-color) !important;
                box-shadow: 0 0 0 2px var(--current-day-border-color, #ffb6d5);
                transition: background 0.15s, border 0.15s;
            }
            .selected-range .text-left,
            .selected-range .font-bold,
            .selected-range .text-lg {
                user-select: none !important;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
            }

        body.noselect-drag .day-cell, body.noselect-drag .day-cell * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        #longEventFields {
            margin-left: 0 !important;
            padding-left: 0 !important;
            width: 100%;
        }
        #event-modal .modal-content-scrollable {
            overflow-x: hidden !important;
        }

        #eventTime {
            width: 200px;
        }

        #eventDate {
            width: 200px;
        }

        #longEventStartDate {
            width: 200px;
        }

        #longEventEndDate {
            width: 200px;
        }

    </style>
</head>
<body>

    <div class="bg-white shadow-2xl p-6 w-full overflow-hidden transform transition-all duration-300"
         id="main-container">
        <div class="flex flex-col md:flex-row justify-between items-center mb-0 border-b pb-4"
             style="border-bottom: 3px solid var(--day-cell-border-color);">
            <div class="flex items-center space-x-2 mb-4 md:mb-0">
                <button id="hamburgerIcon" class="p-3 transition duration-200 ease-in-out -ml-2 hidden"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-bars"></i>
                </button>
                <button id="prevMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="currentMonthYear" class="font-extrabold text-3xl tracking-tight"
                    style="color: var(--text-color);"></h2>
                <button id="nextMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="todayButton" class="themed-button">
                    Today
                </button>
                <button id="settingsButton" class="themed-button secondary">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>

        <div class="calendar-scroll-container">
            <div class="calendar-grid text-center font-bold text-sm uppercase tracking-wide mb-2 mt-4"
                 style="color: var(--text-color);">
                <div class="p-2">Sun</div>
                <div class="p-2">Mon</div>
                <div class="p-2">Tue</div>
                <div class="p-2">Wed</div>
                <div class="p-2">Thu</div>
                <div class="p-2">Fri</div>
                <div class="p-2">Sat</div>
            </div>

            <div id="calendar" class="calendar-grid">
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 flex justify-between items-center">
            <span>Edit Event</span>
            <button
                id="duplicateEventBtn"
                title="Duplicate"
                type="button"
                class="text-base text-pink-500 hover:text-pink-700"
                style="display: none;"
            >
                <i class="fas fa-copy"></i>
            </button>
            </h3>
            <hr class="mb-0" style="border: 2px solid var(--day-cell-border-color);">
            <div class="modal-content-scrollable">
                <div class="mb-4">
                    <label for="eventTitle" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);"> Event Icon & Title</label>
                    <div class="flex items-center space-x-2">
                        <div id="eventIconDisplay" class="event-icon-display">
                            <i class="fas fa-plus"></i> 
                        </div>
                        <input type="text" id="eventTitle" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 flex-grow" style="color: var(--text-color); background-color: var(--day-cell-bg); border: 3px solid var(--day-cell-border-color);"
                               placeholder="Enter event title!">
                    </div>
                </div>

                <div class="mb-4 flex space-x-4">
                    <div class="mb-4 flex space-x-2" id="singleEventFields">
                        <div class="w-1/2">
                            <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Time (Optional)</label>
                            <input type="time" id="eventTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                        <div class="w-1/2">
                            <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Date</label>
                            <input type="date" id="eventDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                    </div>
                    <div id="longEventFields" style="display:none; margin-left:0; padding-left:0;">
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label for="longEventStartDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Start Date</label>
                                <input type="date" id="longEventStartDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                            </div>
                            <div class="w-1/2">
                                <label for="longEventEndDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">End Date</label>
                                <input type="date" id="longEventEndDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus-border-transparent transition duration-200">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <div class="w-1/2">
                                <label for="longEventStartTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Start Time</label>
                                <input type="time" id="longEventStartTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                            </div>
                            <div class="w-1/2">
                                <label for="longEventEndTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">End Time</label>
                                <input type="time" id="longEventEndTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Description (Optional)</label>
                    <textarea id="eventDescription" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Event Color</label>
                    <div id="colorPalette" class="color-palette">
                        </div>
                    <input type="hidden" id="eventColor">
                </div>

                <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">TEXT STYLING</label>
                <div class="mb-4" id="textStylingToggles">
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleTitleCenter">
                        <span class="toggle-label">Title in Center</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleDescriptionCenter">
                        <span class="toggle-label">Description in Center</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleTitleRight">
                        <span class="toggle-label">Title on the Right</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleDescriptionRight">
                        <span class="toggle-label">Description on the Right</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleItalicized">
                        <span class="toggle-label">Italicized</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleSerifFont">
                        <span class="toggle-label">Serif Font</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="eventToggleMonospaceFont">
                        <span class="toggle-label">Monospace Font</span>
                    </label>
                </div>


                <!---- EFFECTS ---->
                <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">EFFECTS</label>
                <div class="flex flex-col space-y-2">
                    
                    <!-- BASIC -->
                    <label class="toggle-container">
                    <input type="checkbox" id="effectShowCheckbox">
                    <span class="toggle-label">Show Checkbox</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectGlowing">
                    <span class="toggle-label">Glowing</span>
                    </label>

                    <!-- STRIPES -->
                     <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color); padding-top: 10px;">STRIPES</label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectStriped1">
                    <span class="toggle-label">Striped 1 (\\\\\)</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectStriped2">
                    <span class="toggle-label">Striped 2 (/////)</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectThinStripes">
                    <span class="toggle-label">Thin Textured Stripes</span>
                    </label>

                    <!-- PATTERNS -->
                     <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color); padding-top: 10px;">PATTERNS</label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectCrosshatched">
                    <span class="toggle-label">Crosshatched</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectCheckerboard">
                    <span class="toggle-label">Checkerboard</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectWavyLines">
                    <span class="toggle-label">Wavy Lines</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectDotted">
                    <span class="toggle-label">Dotted</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectArgyle">
                    <span class="toggle-label">Argyle</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectZigzag">
                    <span class="toggle-label">Teeth</span>
                    </label>

                    <!-- BUTTON STYLES -->
                     <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color); padding-top: 10px;">BUTTON STYLES</label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectEmbossed">
                    <span class="toggle-label">Embossed</span>
                    </label>
                    <label class="toggle-container">
                    <input type="checkbox" id="effectWin95Button">
                    <span class="toggle-label">Retro Button</span>
                    </label>

                </div>
                </div>


                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">ANIMATED EFFECTS</label>
                    <div class="flex flex-col space-y-2">
                        <label class="toggle-container">
                            <input type="checkbox" id="effectMoveHorizontally">
                            <span class="toggle-label">Move Horizontally</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectMoveVertically">
                            <span class="toggle-label">Move Vertically</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectParticles">
                            <span class="toggle-label">Particles</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectSnowFalling">
                            <span class="toggle-label">Snow Falling</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGlisteningStars">
                            <span class="toggle-label">Glistening Stars</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectAnimatedStripes">
                            <span class="toggle-label">Animated Stripes</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGradient">
                            <span class="toggle-label">Animated Gradient</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectAnimatedVerticalRainbow">
                            <span class="toggle-label">Animated Rainbow</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Choose Icon</label>
                    <input type="text" id="iconSearchInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 mb-3" placeholder="Search icons...">
                    <div id="iconGrid" class="icon-grid">
                        </div>
                    <input type="hidden" id="eventIcon">
                </div>
            </div>

            <div class="modal-footer">
                <!-- Add Event Footer (default visible) -->
                <div id="add-event-footer">
                    <button id="cancelEvent" class="themed-button secondary">Cancel</button>
                    <button id="saveEvent" class="themed-button">Save Event</button>
                </div>
                <!-- Edit Event Footer (hidden by default, shown in edit mode) -->
                <div id="edit-event-footer" style="display:none;">
                    <button id="deleteEvent" class="themed-button secondary"><i class="fas fa-trash"></i></button>
                    <button id="cancelEditEvent" class="themed-button secondary">Cancel</button>
                    <button id="updateEvent" class="themed-button">Update Event</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mt-4 mb-1 mr-2 heading-settings" style="color: var(--text-color);"><b>SETTINGS</b></h3>
            <hr class="mb-0" style="border: 2px solid var(--day-cell-border-color);">
            <div class="modal-content-scrollable">
                <!-- Application Settings -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-sliders-h"></i> <b>Application Settings</b></h4>
                    <div class="dropdown-container"><label for="weekStartDropdown">Week Start Day</label><select id="weekStartDropdown"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select></div>
                    <div class="toggle-container" id="colorWeekendsSettingsRow" style="display:flex;align-items:center;margin-top:8px;margin-bottom:8px;gap:12px;">
                        <input type="checkbox" id="colorWeekendsToggle">
                        <label for="colorWeekendsToggle" class="toggle-label" style="margin-bottom:0;">Color Weekends</label>
                    </div>
                    <div id="weekendTintControls" style="display:none;margin-top:2px;margin-bottom:6px;align-items:center;gap:8px;">
                        <label for="weekendTintColorPicker" style="margin:0;">> Weekends Tinting</label>
                        <input type="color" id="weekendTintColorPicker" value="#ffe4e1">
                    </div>
    <style>
    .weekend-tint {
        position: relative;
        overflow: hidden;
    }
    .weekend-tint::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        pointer-events: none;
        background: var(--weekend-tint-color, #ffe4e1);
        opacity: 0.7;
        mix-blend-mode: multiply;
        z-index: 1;
    }
    </style>
                    <div class="toggle-container"><input type="checkbox" id="use24HourFormatToggle"><label for="use24HourFormatToggle" class="toggle-label">Use 24-Hour Format</label></div>
                    <div class="toggle-container"><input type="checkbox" id="hideScrollbarsToggle"><label for="hideScrollbarsToggle" class="toggle-label">Hide Scrollbars</label></div>
                    <div class="toggle-container"><input type="checkbox" id="noBackgroundToggle"><label for="noBackgroundToggle" class="toggle-label">No Background (Full Screen)</label></div>
                    <div class="toggle-container"><input type="checkbox" id="foldDayCellsToggle"><label for="foldDayCellsToggle" class="toggle-label">Fold Day Cells (Scrollable) </label></div>
                    <div class="input-group" style="margin-top:0.5em;">
                        <label for="dayCellMaxHeightInput" style="margin-right:0.5em;">Day Cell Max Height (px):</label>
                        <input type="number" id="dayCellMaxHeightInput" min="50" max="500" value="120" style="width:80px; background-color: var(--secondary-button-bg); border: 3px solid var(--day-cell-border-color); color: var(--secondary-button-text); padding: 0.1em; border-radius: var(--ui-roundness); text-align: center; font-weight: bold; font-size: 0.9em;">
                    </div>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- UI Appearance -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-paint-brush"></i> <b>UI Appearance</b></h4>
<div class="slider-group"><label for="uiRoundness">UI Roundness</label><input type="range" id="uiRoundness" min="0" max="24" value="8"><span id="uiRoundnessValue" class="slider-value">8px</span></div>
<div class="slider-group"><label for="eventRoundness">Event Roundness</label><input type="range" id="eventRoundness" min="0" max="24" value="8"><span id="eventRoundnessValue" class="slider-value">8px</span></div>
<div class="slider-group"><label for="eventBorderThickness">Event Border Thickness</label><input type="range" id="eventBorderThickness" min="0" max="5" value="3"><span id="eventBorderThicknessValue" class="slider-value">3px</span></div>
<div class="slider-group"><label for="fontSize">Base Font Size</label><input type="range" id="fontSize" min="12" max="36" value="16"><span id="fontSizeValue" class="slider-value">16px</span></div>
<div class="slider-group"><label for="dayCellMinWidth">Day Cell Minimum Width</label><input type="range" id="dayCellMinWidth" min="100" max="300" value="140"><span id="dayCellMinWidthValue" class="slider-value">140px</span></div>
                </div>
                <hr class="mb-6 mt-10" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Event Styling -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-edit"></i> <b>Event Styling</b></h4>

                    <div class="dropdown-container" style="margin-top:0.75rem;">
                        <label for="iconPlacementDropdown">Icon Placement:</label>
                        <select id="iconPlacementDropdown" class="styled-dropdown">
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                            <option value="top">Top</option>
                            <option value="top-left">Top Left</option>
                            <option value="top-right">Top Right</option>
                        </select>
                    </div>


                    <div class="toggle-container"><input type="checkbox" id="customizationCheckboxDashedBorderToggle"><label for="customizationCheckboxDashedBorderToggle" class="toggle-label">Checkbox Dashed Border (When Checked)</label></div>
                    <div class="toggle-container"><input type="checkbox" id="customizationStrikethroughTextToggle"><label for="customizationStrikethroughTextToggle" class="toggle-label">Strikethrough Text (When Checked)</label></div>
                    <div class="toggle-container"><input type="checkbox" id="customizationBoldTitleToggle"><label for="customizationBoldTitleToggle" class="toggle-label">Bold Event Titles</label></div>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Holder Sidebar -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-columns"></i> <b>Holder Sidebar</b></h4>
                    <div class="settings-description" style="margin-bottom:0.5rem;margin-top:-6px;color:var(--text-color);">A sidebar for events you haven’t scheduled yet.</div>
                    <div class="toggle-container"><input type="checkbox" id="holderIconToggle"><label for="holderIconToggle" class="toggle-label">Show Holder Icon</label></div>
                    <div class="toggle-container"><input type="checkbox" id="showHolderByDefaultToggle"><label for="showHolderByDefaultToggle" class="toggle-label">Show Holder Sidebar by Default</label></div>
                    <div class="toggle-container"><input type="checkbox" id="disableSidebarAnimationsToggle"><label for="disableSidebarAnimationsToggle" class="toggle-label">Disable Sidebar Animations</label></div>
                    <div class="toggle-container"><input type="checkbox" id="hideAddEventButtonInHolderToggle"><label for="hideAddEventButtonInHolderToggle" class="toggle-label">Hide Add Event Button in Holder</label></div>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Font Settings -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-font"></i> <b>Font Settings</b></h4>
                    <input type="file" id="customFontUpload" accept=".ttf,.otf,.woff,.woff2" class="custom-file-input">
                    <label for="customFontUpload"><i class="fas fa-upload"></i> Upload Font File</label>
                    <div id="currentCustomFontDisplay" style="padding-top: 6px;"><span class="font-semibold">Current:</span> <span id="customFontNameDisplay">Inter (Default)</span></div>
                    <button id="resetCustomFont" class="themed-button secondary mt-2">Reset to Default</button>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Themes -->
                <div class="mb-6">
                    <h4 class="h4-settings"><i class="fas fa-palette"></i> <b>Themes</b></h4>
                    <div><h4 class="h3-settings" style="margin: 0px 0px 10px 0px;"><b>Pre-made Themes</b></h4><button id="darkModeButton" class="dark-mode-toggle-button"><i class="fas fa-moon"></i> Dark Mode <span class="small-text">(Off)</span></button><div id="premadeThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center"></div></div>
                    <div class="mb-4 mt-4"><h4 class="h3-settings"><b>Special Themes</b></h4>
                      <div id="specialThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center special-theme-list collapsed" style="position:relative;">
                        <div class="special-theme-box">Theme 1</div>
                        <div class="special-theme-box">Theme 2</div>
                        <div class="special-theme-box">Theme 3</div>
                        <div class="special-theme-box">Theme 4</div>
                        <!-- More themes -->
                        <div class="special-theme-gradient" style="position:absolute;left:0;right:0;bottom:0;height:40px;background:linear-gradient(to bottom,rgba(255,255,255,0),var(--main-container-bg) 80%);display:flex;align-items:flex-end;justify-content:center;pointer-events:none;"></div>
                        <div class="show-more-btn" id="showMoreThemesBtn" style="position:absolute;left:0;right:0;bottom:0;height:40px;background:none;color:var(--accent-color);font-weight:600;text-align:center;cursor:pointer;z-index:2;pointer-events:auto;">Show more...</div>
                      </div>
                    </div>
                    <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                    <div>
                    <div class="accordion" id="customThemeAccordion">
                    <div class="accordion-header" id="customThemeAccordionHeader">
                        Custom Theming Options
                    </div>
                    <div class="accordion-content" id="customThemeAccordionContent">
                          <div id="customColorPickersContainer" class="relative">
                            <h4 class="h4-settings"><b>Custom Theming</b></h4>
                            <div class="color-input-group"><label for="themeBodyBg">Background Color</label><input type="color" id="themeBodyBg"></div>
                            <div class="color-input-group"><label for="themeTextColor">Main Text Color</label><input type="color" id="themeTextColor"></div>
                            <div class="color-input-group"><label for="themeHeaderBg">Header Background</label><input type="color" id="themeHeaderBg"></div>
                            <div class="color-input-group"><label for="themeMainContainerBg">Main Container Background</label><input type="color" id="themeMainContainerBg"></div>
                            <div class="color-input-group"><label for="themeDayCellBg">Day Cell Background</label><input type="color" id="themeDayCellBg"></div>
                            <div class="color-input-group"><label for="themeDayCellHoverBg">Day Cell Hover Background</label><input type="color" id="themeDayCellHoverBg"></div>
                            <div class="color-input-group"><label for="themeCurrentDayBg">Today's Day Cell Background</label><input type="color" id="themeCurrentDayBg"></div>
                            <div class="color-input-group"><label for="themePrimaryButtonBg">Primary Button Background</label><input type="color" id="themePrimaryButtonBg"></div>
                            <div class="color-input-group"><label for="themePrimaryButtonText">Primary Button Text</label><input type="color" id="themePrimaryButtonText"></div>
                            <div class="color-input-group"><label for="themeSecondaryButtonBg">Secondary Button Background</label><input type="color" id="themeSecondaryButtonBg"></div>
                            <div class="color-input-group"><label for="themeSecondaryButtonText">Secondary Button Text</label><input type="color" id="themeSecondaryButtonText"></div>
                            <div class="color-input-group"><label for="themeAccentColor">Accent Color (Borders, Sliders)</label><input type="color" id="themeAccentColor"></div>
                            <div class="color-input-group"><label for="themeDayCellBorderColor">Day Cell Border Color</label><input type="color" id="themeDayCellBorderColor"></div>
                            <button id="saveCustomThemeButton" class="themed-button w-full mb-3">Save Current Custom Theme</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div><h4 class="h4-settings"><i class="fas fa-download" style="padding-right: 8px;"></i><b>Saved Custom Themes</b></h4><div id="savedThemePreviews" class="flex flex-wrap gap-2 mt-2 justify-center"></div></div>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Event Export Options -->
                <div class="mb-6">
                    <h4 class="h4-settings" style="padding-bottom: 6px;"><i class="fas fa-clipboard"></i> <b>Calendar Copy Options</b></h4>
                    <div class="settings-description" style="margin-bottom:0.5rem;margin-top:-10px;color:var(--text-color);">Copies the Month & Event in a Markdown Table.</div>
                    <div class="toggle-container"><input type="checkbox" id="exportTitles" checked><label for="exportTitles" class="toggle-label">Event Titles</label></div>
                    <div class="toggle-container"><input type="checkbox" id="exportDescriptions" checked><label for="exportDescriptions" class="toggle-label">Event Descriptions</label></div>
                    <button id="copyCurrentMonthBtn" class="themed-button w-full mb-3 mt-3"><i class="fas fa-copy"></i> COPY CURRENT MONTH</button>
                    <hr class="my-4" style="border: 2px solid var(--day-cell-border-color);">
                    <div id="calendarSyncSection">
                        <h4 class="h4-settings" style="padding-bottom: 2px;"><i class="fas fa-sync-alt"></i> <b>Calendar Sync</b></h4>
                        <div class="settings-description" style="margin-bottom:0.5rem;margin-top:-10px;color:var(--text-color);">Sync your calendar and theming to your Google account. Optionally sync events to Google Calendar.</div>
                        <div style="display:flex;align-items:center;gap:1em;margin-bottom:0.5em;">
                            <button id="googleSignInBtn" class="themed-button secondary" style="min-width:120px;"><i class="fab fa-google"></i> Sign In</button>
                            <button id="googleSignOutBtn" class="themed-button secondary" style="min-width:120px;display:none;"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
                            <span id="googleSyncStatus" style="margin-left:1em;color:var(--accent-color);font-weight:600;">Not signed in</span>
                        </div>
                        <div id="calendarLastSyncText" style="font-size:13px;color:#888;margin-top:4px;"></div>
                        <div class="toggle-container">
                            <input type="checkbox" id="googleCalendarSyncToggle">
                            <label for="googleCalendarSyncToggle" class="toggle-label">Sync to Google Calendar</label>
                        </div>
                    </div>
                </div>
                <hr class="my-6" style="border: 2px solid var(--day-cell-border-color);">
                <!-- Danger Zone -->
                <div>
                    <h4 class="h4-settings" style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> <b>Danger Zone</b></h4>
                    <button id="removeAllEventsButton" class="themed-button danger w-full mb-3"><b>Remove All Events</b></button>
                    <button id="removeAllCustomThemesButton" class="themed-button danger w-full mb-3"><b>Remove All Custom Themes</b></button>
                    <button id="resetApplicationButton" class="themed-button danger w-full"><b>Reset the Application</b></button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelSettings" class="themed-button secondary">Cancel</button>
                <button id="saveSettings" class="themed-button">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="theme-name-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Name Your Custom Theme</h3>
            <div class="mb-4">
                <label for="themeNameInput" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Theme Name</label>
                <input type="text" id="themeNameInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
            </div>
            <div class="modal-footer">
                <button id="cancelThemeName" class="themed-button secondary">Cancel</button>
                <button id="saveThemeName" class="themed-button">Save</button>
            </div>
        </div>
    </div>

    <div id="holder-sidebar" class="fixed top-0 left-0 h-full bg-white shadow-lg z-50 transition-all duration-300 flex flex-col items-center p-4">
        <button id="holderSidebarCloseButton" class="md:hidden">
            <i class="fas fa-times"></i>
        </button>
        <h3 class="text-xl font-bold mb-4 text-gray-700">HOLDER</h3>
        <div id="holder-content" class="flex-grow w-full border-2 border-dashed border-gray-300 rounded-lg p-2 overflow-y-auto"
             style="min-height: 100px; background-color: var(--day-cell-bg);">
        </div>
        <button id="addHolderEventButton" class="themed-button w-full mt-4 styled-like-holder">
            <i class="fas fa-plus mr-2"></i> Add Event
        </button>
        <div class="resize-handle"></div>
    </div>


    <div id="eventContextMenu" class="hidden">
        <button id="contextEditEvent"><i class="fas fa-edit"></i> Edit Event</button>
        <hr class="mb-0" style="border: 2px solid var(--day-cell-border-color);">
        <button id="contextDuplicateEvent"><i class="fas fa-copy"></i> Duplicate Event</button>
        <button id="contextDeleteEvent"><i class="fas fa-trash"></i> Delete Event</button>
    </div>
<script>
    // --- Unified Weekend Coloring Settings Logic ---
function updateWeekendTintControlsVisibility() {
    var colorWeekendsToggle = document.getElementById('colorWeekendsToggle');
    var weekendTintControls = document.getElementById('weekendTintControls');
    if (colorWeekendsToggle && weekendTintControls) {
    weekendTintControls.style.display = colorWeekendsToggle.checked ? 'block' : 'none';
    }
    var weekendTintColorPicker = document.getElementById('weekendTintColorPicker');
    if (weekendTintColorPicker) {
        weekendTintColorPicker.disabled = !colorWeekendsToggle.checked;
    }
}

function syncWeekendSettingsUI() {
    var colorWeekendsToggle = document.getElementById('colorWeekendsToggle');
    var weekendTintColorPicker = document.getElementById('weekendTintColorPicker');
    var colorWeekends = localStorage.getItem('settingsColorWeekends') === '1';
    var weekendTintColor = localStorage.getItem('settingsWeekendTintColor') || '#ffe4e1';
    if (colorWeekendsToggle) colorWeekendsToggle.checked = colorWeekends;
    if (weekendTintColorPicker) weekendTintColorPicker.value = weekendTintColor;
    document.documentElement.style.setProperty('--weekend-tint-color', weekendTintColor);
    updateWeekendTintControlsVisibility();
}

function saveWeekendSettings() {
    var colorWeekendsToggle = document.getElementById('colorWeekendsToggle');
    var weekendTintColorPicker = document.getElementById('weekendTintColorPicker');
    localStorage.setItem('settingsColorWeekends', colorWeekendsToggle && colorWeekendsToggle.checked ? '1' : '');
    if (weekendTintColorPicker) {
        localStorage.setItem('settingsWeekendTintColor', weekendTintColorPicker.value);
        document.documentElement.style.setProperty('--weekend-tint-color', weekendTintColorPicker.value);
    }
}

function setupWeekendSettingsListeners() {
    var colorWeekendsToggle = document.getElementById('colorWeekendsToggle');
    var weekendTintColorPicker = document.getElementById('weekendTintColorPicker');
    if (colorWeekendsToggle) {
        colorWeekendsToggle.addEventListener('change', function() {
            saveWeekendSettings();
            updateWeekendTintControlsVisibility();
            if (typeof renderCalendar === 'function') renderCalendar();
        });
    }
    if (weekendTintColorPicker) {
        weekendTintColorPicker.addEventListener('input', function() {
            saveWeekendSettings();
            if (typeof renderCalendar === 'function') renderCalendar();
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    syncWeekendSettingsUI();
    setupWeekendSettingsListeners();
    // Ensure calendarEl is initialized before calling renderCalendar
    window.calendarEl = document.getElementById('calendar');
    if (window.calendarEl && typeof renderCalendar === 'function') renderCalendar();
});
    let currentDate = new Date();
    let events = [];
    let holderEvents = [];
    let editingEventId = null;
    let currentCustomFontName = null;
    let draggedEventId = null;
    let contextMenuEventId = null;
    let isResizingHolder = false;
    let initialHolderWidth;
    let initialMouseX;

        const MAX_SAVED_THEMES = 5;
        const MAX_VISIBLE_EVENTS_FOLDED = 3;
        const MIN_HOLDER_WIDTH = 150;
        const MAX_HOLDER_WIDTH = 400;

        const DEFAULT_FONT_FAMILY = 'Inter, sans-serif';

        class CapacitorPreferences {
            async set({ key, value }) {
                try {
                    localStorage.setItem(key, value);
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async get({ key }) {
                try {
                    const value = localStorage.getItem(key);
                    return Promise.resolve({ value });
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async remove({ key }) {
                try {
                    localStorage.removeItem(key);
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async clear() {
                try {
                    localStorage.clear();
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }
        }
        const Preferences = new CapacitorPreferences();

        const adjustColor = (hex, lum) => {
            if (!hex || typeof hex !== 'string') return hex;
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            let rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }
            return rgb;
        };

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };

        const rgbToHsl = (r, g, b) => {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; 
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s * 100, l * 100];
        };

        const hslToRgb = (h, s, l) => {
            h /= 360;
            s /= 100;
            l /= 100;
            let r, g, b;

            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        };

        const hexToHsl = (hex) => {
            const rgb = hexToRgb(hex);
            if (rgb) {
                return rgbToHsl(rgb.r, rgb.g, rgb.b);
            }
            return [0, 0, 0];
        };

        const hslToHex = (h, s, l) => {
            const [r, g, b] = hslToRgb(h, s, l);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        };

        const hexToRgba = (hex, alpha) => {
            const rgb = hexToRgb(hex);
            if (rgb) {
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
            }
            return hex;
        };

        const isColorLight = (hex) => {
            if (!hex || typeof hex !== 'string' || hex.length < 7) return false;
            const cleanHex = hex.startsWith('#') ? hex.substring(1) : hex;
            if (cleanHex.length !== 6) return false;

            const r = parseInt(cleanHex.substring(0, 2), 16);
            const g = parseInt(cleanHex.substring(2, 4), 16);
            const b = parseInt(cleanHex.substring(4, 6), 16);
            const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
            return luminance > 0.5;
        };

        const THEMES = {
            light: {
                name: "Light",
                bodyBg: '#F8E8F0',
                mainText: '#4A4A4A',
                headerBg: '#FFFFFF',
                primaryButtonBg: '#F3E0E9',
                primaryButtonText: '#8B4B66',
                secondaryButtonBg: '#FFFFFF',
                secondaryButtonText: '#E085B0',
                accentColor: '#E085B0',
                dayCellBorder: '#D4DDE3',
                mainContainerBg: '#FFFFFF',
                dayCellBg: '#FFFFFF',
                dayCellHoverBg: '#F8F0F5',
                currentDayBg: '#FFEAF4',
                arrowButtonBg: 'transparent',
                arrowButtonHoverBg: 'rgba(0,0,0,0.05)',
                arrowButtonText: '#4B5563',
                headerBorderColor: '#E5E7EB'
            },
            dark: {
                name: "Dark",
                bodyBg: '#2C2C34',
                mainText: '#E0E0E0',
                headerBg: '#3A3A45',
                mainContainerBg: '#3A3A45',
                dayCellBg: '#4A4A50',
                dayCellHoverBg: '#5A5A60',
                currentDayBg: '#6A6A70',
                primaryButtonBg: '#E085B0',
                primaryButtonText: '#FFFFFF',
                secondaryButtonBg: '#6E6E77',
                secondaryButtonText: '#C0C0C0',
                accentColor: '#FFADD9',
                dayCellBorder: '#5A5A60',
                arrowButtonBg: 'transparent',
                arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                arrowButtonText: '#E0E0E0',
                headerBorderColor: 'rgba(255,255,255,0.15)'
            },
            pastelBlue: {
                light: {
                    name: "Blue", bodyBg: '#E0F2F7', mainText: '#3F51B5', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#CFECF5', currentDayBg: '#B3E5FC',
                    primaryButtonBg: '#BBDEFB',
                    primaryButtonText: '#2196F3',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#42A5F5',
                    accentColor: '#42A5F5', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#2196F3', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Blue (Dark)", bodyBg: '#060b14', mainText: '#90caf9', headerBg: '#3A4B5C', mainContainerBg: '#12152b',
                    dayCellBg: '#18203a', dayCellHoverBg: '#090c1c', currentDayBg: '#12173b',
                    primaryButtonBg: '#18587e', primaryButtonText: '#85d6ff',
                    secondaryButtonBg: '#12152b',
                    secondaryButtonText: '#90CAF9', accentColor: '#81D4FA', dayCellBorder: '#2a4f7e',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#81d4fa', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelGreen: {
                light: {
                    name: "Green", bodyBg: '#E8F5E9', mainText: '#388E3C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#D9F1DB', currentDayBg: '#C8E6C9',
                    primaryButtonBg: '#C5E1A5',
                    primaryButtonText: '#66BB6A',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#81C784',
                    accentColor: '#81C784', dayCellBorder: '#A1CF90',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#66BB6A', headerBorderColor: '#A1CF90'
                },
                dark: {
                    name: "Green (Dark)", bodyBg: '#132018', mainText: '#C8E6C9', headerBg: '#4B5C4A', mainContainerBg: '#1e332c',
                    dayCellBg: '#375847', dayCellHoverBg: '#20402a', currentDayBg: '#2f4b36',
                    primaryButtonBg: '#418145', primaryButtonText: '#b8eab9',
                    secondaryButtonBg: '#2f4b36',
                    secondaryButtonText: '#a5d6a7', accentColor: '#a5d6a7', dayCellBorder: '#6c906a',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C8E6C9', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelYellow: {
                light: {
                    name: "Yellow", bodyBg: '#FFFDE7', mainText: '#c78800', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#fff9c4', currentDayBg: '#fff9c4',
                    primaryButtonBg: '#fff59d',
                    primaryButtonText: '#c89406', 
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#d39831',
                    accentColor: '#ffc800', dayCellBorder: '#FFD375',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#FFCA28', headerBorderColor: '#FFF176'
                },
                dark: {
                    name: "Yellow (Dark)",
                    bodyBg: '#0b0d11',
                    mainText: '#eeda9f',
                    headerBg: '#f4ad35',
                    mainContainerBg: '#1f180c',
                    dayCellBg: '#281b0d',
                    dayCellHoverBg: '#170f08',
                    currentDayBg: '#22160a',
                    primaryButtonBg: '#391c0b',
                    primaryButtonText: '#e0a906',
                    secondaryButtonBg: '#1f180c',
                    secondaryButtonText: '#c89406',
                    accentColor: '#c89406', 
                    dayCellBorder: '#50371b',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#e6a900',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelPurple: {
                light: {
                    name: "Purple", bodyBg: '#F3E5F5', mainText: '#7B1FA2', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#ECCFF0', currentDayBg: '#E1BEE7',
                    primaryButtonBg: '#E1BEE7',
                    primaryButtonText: '#9C27B0',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#BA68C8',
                    accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Purple (Dark)",
                    bodyBg: '#080512',
                    mainText: '#d0a1ed',
                    headerBg: '#402a63',
                    mainContainerBg: '#1c102f',
                    dayCellBg: '#291547',
                    dayCellHoverBg: '#190c2e',
                    currentDayBg: '#220e42',
                    primaryButtonBg: '#51227f',
                    primaryButtonText: '#cc9beb',
                    secondaryButtonBg: '#25123f',
                    secondaryButtonText: '#b994e6',
                    accentColor: '#9876df',
                    dayCellBorder: '#5A3D82',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#cc9beb',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelPink: {
                light: {
                    name: "Pink", bodyBg: '#FCE4EC', mainText: '#C2185B', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F8D1DF', currentDayBg: '#F8BBD0',
                    primaryButtonBg: '#F8BBD0',
                    primaryButtonText: '#EC407A',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#E91E63',
                    accentColor: '#E91E63', dayCellBorder: '#ffa3c2',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#EC407A', headerBorderColor: '#F06292'
                },
                dark: {
                    name: "Pink (Dark)",
                    bodyBg: '#1a0e18',
                    mainText: '#eb81ab',
                    headerBg: '#3d1c2b',
                    mainContainerBg: '#260a15',
                    dayCellBg: '#420123',
                    dayCellHoverBg: '#1f0010',
                    currentDayBg: '#820c3b',
                    primaryButtonBg: '#820c3b',
                    primaryButtonText: '#eb81ab',
                    secondaryButtonBg: '#29111c',
                    secondaryButtonText: '#eb81ab',
                    accentColor: '#eb81ab',
                    dayCellBorder: '#80264a',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#eb81ab',
                    headerBorderColor: '#5a2a3a'
                }
            },
            pureBlack: {
                light: {
                    name: "Pure Black", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#111111', dayCellHoverBg: '#222222', currentDayBg: '#333333',
                    primaryButtonBg: '#333333',
                    primaryButtonText: '#CCCCCC',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#000000',
                    accentColor: '#CCCCCC', dayCellBorder: '#3d3d3d',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#BBBBBB', headerBorderColor: '#2A2A2A'
                },
                dark: {
                    name: "Pure Black (Dark)", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#0A0A0A', dayCellHoverBg: '#1A1A1A', currentDayBg: '#2A2A2A',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#000000',
                    secondaryButtonBg: '#1A1A1A',
                    secondaryButtonText: '#AAAAAA', accentColor: '#AAAAAA', dayCellBorder: '#1A1A1A',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#E0E0E0', headerBorderColor: '#1A1A1A'
                }
            },
            aidah: {
                light: {
                    name: "Aidah", bodyBg: '#F7F7F7', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EEEEEE', currentDayBg: '#E8E8E8',
                    primaryButtonBg: '#D1D1D1',
                    primaryButtonText: '#333333',
                    secondaryButtonBg: '#E9E9E9',
                    secondaryButtonText: '#555555',
                    accentColor: '#AAAAAA', dayCellBorder: '#DDDDDD',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4B5563', headerBorderColor: '#E5E7EB'
                },
                dark: {
                    name: "Aidah (Dark)",
                    bodyBg: '#181926', mainText: '#c5cfe9', headerBg: '#333333', mainContainerBg: '#24273a',
                    dayCellBg: '#32354b', dayCellHoverBg: '#181926', currentDayBg: '#3a2c40',
                    primaryButtonBg: '#2f402c', primaryButtonText: '#a6da85',
                    secondaryButtonBg: '#3a2c40', secondaryButtonText: '#ff9bd5',
                    accentColor: '#ff9bd5', dayCellBorder: '#454b66',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#a6d475', headerBorderColor: '#454b66',
                }
            },
            dracula: {
                light: {
                    name: "Dracula", bodyBg: '#F8F8F2', mainText: '#282A36', headerBg: '#F8F8F2', mainContainerBg: '#F8F8F2',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EAEAEA', currentDayBg: '#F0F0F0',
                    primaryButtonBg: '#FF79C6',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#BD93F9',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#FF79C6', dayCellBorder: '#EAEAEA',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#44475A', headerBorderColor: '#EAEAEA'
                },
                dark: {
                    name: "Dracula",
                    bodyBg: '#282A36',
                    mainText: '#f8f8f2',
                    headerBg: '#21222c',
                    mainContainerBg: '#282a36',
                    dayCellBg: '#21222d',
                    dayCellHoverBg: '#1e1f29',
                    currentDayBg: '#44475a',
                    primaryButtonBg: '#ff79c6',
                    primaryButtonText: '#282a37',
                    secondaryButtonBg: '#bd93f9',
                    secondaryButtonText: '#36394a',
                    accentColor: '#ffb86c',
                    dayCellBorder: '#62617b',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.12)',
                    arrowButtonText: '#5c5c74',
                    headerBorderColor: '#44475a'
                }
            },
            nord: {
                light: {
                    name: "Nord", bodyBg: '#ECEFF4', mainText: '#2E3440', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#D8DEE9', dayCellHoverBg: '#E5E9F0', currentDayBg: '#BF616A',
                    primaryButtonBg: '#88C0D0',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#E5E9F0',
                    secondaryButtonText: '#4C566A',
                    accentColor: '#88C0D0', dayCellBorder: '#D8DEE9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4C566A', headerBorderColor: '#D8DEE9'
                },
                dark: {
                    name: "Nord", bodyBg: '#2E3440', mainText: '#ECEFF4', headerBg: '#3B4252', mainContainerBg: '#3B4252',
                    dayCellBg: '#4C566A', dayCellHoverBg: '#5E81AC', currentDayBg: '#81A1C1',
                    primaryButtonBg: '#4c566a', 
                    primaryButtonText: '#89bdcc',
                    secondaryButtonBg: '#4C566A', 
                    secondaryButtonText: '#ECEFF4',
                    accentColor: '#88C0D0', dayCellBorder: '#4C566A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ECEFF4', headerBorderColor: '#4C566A'
                }
            },
            oneDark: {
                light: {
                    name: "One Dark", bodyBg: '#FBFBFB', mainText: '#383A42', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#61AFEF',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#98C379',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#E06C75', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4B5563', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "One Dark", bodyBg: '#282C34', mainText: '#ABB2BF', headerBg: '#333842', mainContainerBg: '#333842',
                    dayCellBg: '#3E4451', dayCellHoverBg: '#4B5262', currentDayBg: '#5C6777',
                    primaryButtonBg: '#61AFEF',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#ABB2BF', 
                    secondaryButtonText: '#282C34',
                    accentColor: '#E06C75', dayCellBorder: '#3E4451',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ABB2BF', headerBorderColor: '#3E4451'
                }
            },
            serikaDark: {
                light: {
                    name: "Serika Dark", bodyBg: '#F0F0F0', mainText: '#363636', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#F5C77F',
                    primaryButtonText: '#363636',
                    secondaryButtonBg: '#E0E0E0',
                    secondaryButtonText: '#5A5A5A',
                    accentColor: '#F5C77F', dayCellBorder: '#C7C7C7',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#5A5A5A', headerBorderColor: '#C7C7C7'
                },
                dark: {
                    name: "Serika Dark", bodyBg: '#2C2C2C', mainText: '#D0D0D0', headerBg: '#3A3A3A', mainContainerBg: '#3A3A3A',
                    dayCellBg: '#4A4A4A', dayCellHoverBg: '#5A5A5A', currentDayBg: '#6A6A6A',
                    primaryButtonBg: '#F5C77F',
                    primaryButtonText: '#363636', 
                    secondaryButtonBg: '#5A5A5A', 
                    secondaryButtonText: '#D0D0D0',
                    accentColor: '#F5C77F', dayCellBorder: '#4A4A4A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#D0D0D0', headerBorderColor: '#4A4A4A'
                }
            },
            superuser: {
                light: {
                    name: "Super user", bodyBg: '#EFEFEF', mainText: '#1C1C1C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#00FF00',
                    primaryButtonText: '#1C1C1C',
                    secondaryButtonBg: '#333333',
                    secondaryButtonText: '#EFEFEF',
                    accentColor: '#00FF00', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1C1C1C', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "Super user", bodyBg: '#000000', mainText: '#00FF00', headerBg: '#111111', mainContainerBg: '#111111',
                    dayCellBg: '#222222', dayCellHoverBg: '#333333', currentDayBg: '#444444',
                    primaryButtonBg: '#00FF00',
                    primaryButtonText: '#000000',
                    secondaryButtonBg: '#444444', 
                    secondaryButtonText: '#00FF00', 
                    accentColor: '#00FF00', dayCellBorder: '#222222',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#00FF00', headerBorderColor: '#222222'
                }
            },
            stealth: {
                light: {
                    name: "Stealth", bodyBg: '#F5F5F5', mainText: '#424242', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E0E0E0', dayCellHoverBg: '#D0D0D0', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#BDBDBD', 
                    primaryButtonText: '#424242',
                    secondaryButtonBg: '#9E9E9E', 
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#757575', dayCellBorder: '#D0D0D0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#424242', headerBorderColor: '#D0D0D0'
                },
                dark: {
                    name: "Stealth", bodyBg: '#212121', mainText: '#BDBDBD', headerBg: '#2C2C2C', mainContainerBg: '#2C2C2C',
                    dayCellBg: '#363636', dayCellHoverBg: '#424242', currentDayBg: '#525252',
                    primaryButtonBg: '#9E9E9E', 
                    primaryButtonText: '#212121', 
                    secondaryButtonBg: '#424242', 
                    secondaryButtonText: '#BDBDBD', 
                    accentColor: '#9E9E9E', dayCellBorder: '#363636',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#BDBDBD', headerBorderColor: '#363636'
                }
            },
            taro: {
                light: {
                    name: "Taro", bodyBg: '#F5F0FF', mainText: '#5A2C85', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E1BEE7', dayCellHoverBg: '#CFADDF', currentDayBg: '#BA68C8',
                    primaryButtonBg: '#FFEB3B',
                    primaryButtonText: '#5A2C85',
                    secondaryButtonBg: '#CE93D8',
                    secondaryButtonText: '#9C27B0',
                    accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Taro", bodyBg: '#3A2B5E', mainText: '#FDF9E2', headerBg: '#47396B', mainContainerBg: '#47396B',
                    dayCellBg: '#544679', dayCellHoverBg: '#615486', currentDayBg: '#706294',
                    primaryButtonBg: '#FFEB3B', 
                    primaryButtonText: '#3A2B5E', 
                    secondaryButtonBg: '#615486', 
                    secondaryButtonText: '#FDF9E2',
                    accentColor: '#BA68C8', dayCellBorder: '#544679',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#FDF9E2', headerBorderColor: '#544679',
                }
            },
            horizon: {
                light: {
                    name: "Horizon", bodyBg: '#FDF0ED', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FDF0ED', dayCellHoverBg: '#FADAD1', currentDayBg: '#E73665',
                    primaryButtonBg: '#E73665',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#F7806D',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#E73665', dayCellBorder: '#FADAD1',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#333333', headerBorderColor: '#FADAD1'
                },
                dark: {
                    name: "Horizon", bodyBg: '#1C1E26', mainText: '#F9F0DA', headerBg: '#2A2C34', mainContainerBg: '#2A2C34',
                    dayCellBg: '#2E303B', dayCellHoverBg: '#3A3C47', currentDayBg: '#E95678',
                    primaryButtonBg: '#E95678',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FAB795',
                    secondaryButtonText: '#6d7095',
                    accentColor: '#E95678', dayCellBorder: '#3A3C47',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#F9F0DA', headerBorderColor: '#3A3C47'
                }
            },
            sweden: {
                light: {
                    name: "Sweden", bodyBg: '#E0F2F7', mainText: '#004B8E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#B3E5FC', dayCellHoverBg: '#81D4FA', currentDayBg: '#4FC3F7',
                    primaryButtonBg: '#FFD700',
                    primaryButtonText: '#004B8E',
                    secondaryButtonBg: '#BBDEFB',
                    secondaryButtonText: '#1976D2',
                    accentColor: '#FFD700', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1976D2', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Sweden", bodyBg: '#002B4B', mainText: '#ADD8E6', headerBg: '#003A63', mainContainerBg: '#003A63',
                    dayCellBg: '#004D8C', dayCellHoverBg: '#005CA8', currentDayBg: '#006CD0',
                    primaryButtonBg: '#FFD700',
                    primaryButtonText: '#002B4B', 
                    secondaryButtonBg: '#004D8C',
                    secondaryButtonText: '#ADD8E6', 
                    accentColor: '#FFD700', dayCellBorder: '#004D8C',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ADD8E6', headerBorderColor: '#004D8C'
                }
            },
            catppuccinLatte: {
                light: {
                    name: "Catppuccin Latte", bodyBg: '#EFF1F5', mainText: '#4C4F69', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E6E9EF', dayCellHoverBg: '#DCE0EE', currentDayBg: '#CCD0DA',
                    primaryButtonBg: '#DC8A78',
                    primaryButtonText: '#4C4F69',
                    secondaryButtonBg: '#D2D4E3',
                    secondaryButtonText: '#6C6F85',
                    accentColor: '#DC8A78', dayCellBorder: '#DCE0EE',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#6C6F85', headerBorderColor: '#DCE0EE'
                },
                dark: {
                    name: "Catppuccin Mocha", bodyBg: '#1E1E2E', mainText: '#CDD6F4', headerBg: '#181825', mainContainerBg: '#181825',
                    dayCellBg: '#313244', dayCellHoverBg: '#45475A', currentDayBg: '#F38BA8',
                    primaryButtonBg: '#F38BA8',
                    primaryButtonText: '#1E1E2E',
                    secondaryButtonBg: '#45475A',
                    secondaryButtonText: '#CDD6F4',
                    accentColor: '#F38BA8', dayCellBorder: '#313244',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#CDD6F4', headerBorderColor: '#313244'
                }
            },
            github: {
                light: {
                    name: "GitHub", bodyBg: '#F6F8FA', mainText: '#24292E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F3F4F6', currentDayBg: '#E6E8EB',
                    primaryButtonBg: '#28A745',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#F6F8FA',
                    secondaryButtonText: '#24292E',
                    accentColor: '#0366D6', dayCellBorder: '#D1D5DA',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#24292E', headerBorderColor: '#D1D5DA'
                },
                dark: {
                    name: "GitHub Dark", bodyBg: '#0D1117', mainText: '#C9D1D9', headerBg: '#161B22', mainContainerBg: '#161B22',
                    dayCellBg: '#21262D', dayCellHoverBg: '#30363D', currentDayBg: '#444C56',
                    primaryButtonBg: '#238636',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#30363D',
                    secondaryButtonText: '#C9D1D9',
                    accentColor: '#58A6FF', dayCellBorder: '#30363D',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C9D1D9', headerBorderColor: '#30363D'
                }
            },
            tokyoNight: {
                light: {
                    name: "Tokyo Night", bodyBg: '#E1E4F2', mainText: '#565A6E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F0F2F9', currentDayBg: '#C7C9DB',
                    primaryButtonBg: '#BB9AF7',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#DDE1F0',
                    secondaryButtonText: '#565A6E', 
                    accentColor: '#BB9AF7', dayCellBorder: '#DDE1F0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#565A6E', headerBorderColor: '#DDE1F0'
                },
                dark: {
                    name: "Tokyo Night", bodyBg: '#1A1B26', mainText: '#C0CAF5', headerBg: '#232635', mainContainerBg: '#232635',
                    dayCellBg: '#2D3043', dayCellHoverBg: '#393D55', currentDayBg: '#4A4F6B',
                    primaryButtonBg: '#BB9AF7',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#393D55', 
                    secondaryButtonText: '#C0CAF5',
                    accentColor: '#BB9AF7', dayCellBorder: '#2D3043',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C0CAF5', headerBorderColor: '#2D3043'
                }
            },
            gruvbox: {
                light: {
                    name: "Gruvbox", bodyBg: '#FBF1C7', mainText: '#3C3836', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#F2E5BC', dayCellHoverBg: '#EBDBB2', currentDayBg: '#D5C4A1',
                    primaryButtonBg: '#FABD2F',
                    primaryButtonText: '#3C3836',
                    secondaryButtonBg: '#EBDBB2',
                    secondaryButtonText: '#3C3836',
                    accentColor: '#D79921', dayCellBorder: '#EBDBB2',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#3C3836', headerBorderColor: '#EBDBB2'
                },
                dark: {
                    name: "Gruvbox Dark", bodyBg: '#282828', mainText: '#EBDBB2', headerBg: '#32302F', mainContainerBg: '#32302F',
                    dayCellBg: '#3C3836', dayCellHoverBg: '#504945', currentDayBg: '#665C54',
                    primaryButtonBg: '#FABD2F',
                    primaryButtonText: '#282828',
                    secondaryButtonBg: '#504945',
                    secondaryButtonText: '#EBDBB2',
                    accentColor: '#FABD2F', dayCellBorder: '#3C3836',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#EBDBB2', headerBorderColor: '#3C3836'
                }
            },
            solarized: {
                light: {
                    name: "Solarized Light", bodyBg: '#FDF6E3', mainText: '#657B83', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EEE8D5', dayCellHoverBg: '#E0DECE', currentDayBg: '#D9D2B6',
                    primaryButtonBg: '#2AA198',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FDF6E3',
                    secondaryButtonText: '#657B83',
                    accentColor: '#2AA198', dayCellBorder: '#E0DECE',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#657B83', headerBorderColor: '#E0DECE'
                },
                dark: {
                    name: "Solarized Dark", bodyBg: '#002B36', mainText: '#839496', headerBg: '#073642', mainContainerBg: '#073642',
                    dayCellBg: '#073642', dayCellHoverBg: '#586E75', currentDayBg: '#1a575b',
                    primaryButtonBg: '#2AA198',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#073642',
                    secondaryButtonText: '#839496',
                    accentColor: '#2AA198', dayCellBorder: '#586E75',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#839496', headerBorderColor: '#586E75'
                }
            }
        };

        let currentBaseThemeKey = 'pastelBlue';
        let isDarkModeActive = false;
        let holderIconEnabled = true;
        let noBackgroundMode = false;
        let disableSidebarAnimations = true;
        let hideScrollbars = true;
        let foldDayCellsEnabled = false;
        let showHolderByDefault = false;
        let use24HourFormat = false;
        let hideAddEventButtonInHolder = false;
        let currentBaseTheme = THEMES.pastelBlue.light;
        let unlockedSpecialThemesKeys = new Set();
        let savedCustomThemes = [];
        let holderSidebarWidth = 250; 

        let saveEvents = async () => {
            await Preferences.set({ key: 'calendarEvents', value: JSON.stringify(events) });
            await Preferences.set({ key: 'holderEvents', value: JSON.stringify(holderEvents) });
        };

        const loadEvents = async () => {
            const { value: eventsValue } = await Preferences.get({ key: 'calendarEvents' });
            if (eventsValue) {
                try {
                    const parsedEvents = JSON.parse(eventsValue);
                    events = parsedEvents.filter(event => event && typeof event === 'object' && event.id && typeof event.color === 'string');
                } catch (e) {
                    events = [];
                }
            } else {
                events = [];
            }

            const { value: holderValue } = await Preferences.get({ key: 'holderEvents' });
            if (holderValue) {
                try {
                    const parsedHolderEvents = JSON.parse(holderValue);
                    holderEvents = parsedHolderEvents.filter(event => event && typeof event === 'object' && event.id && typeof event.color === 'string');
                } catch (e) {
                    holderEvents = [];
                }
            } else {
                holderEvents = [];
            }
        };

        let saveSettings = async (fontName, fontData, baseThemeKey, isDarkMode, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColors = null, unlockedSpecialThemes = [], holderIconEnabledState = false, noBackgroundModeState = false, savedThemes = [], disableSidebarAnimationsState = false, hideScrollbarsState = false, foldDayCellsEnabledState = false, showHolderByDefaultState = false, use24HourFormatState = false, currentHolderSidebarWidth = 250, hideAddEventButtonInHolderState = false) => {
            const maxHeightInput = document.getElementById('dayCellMaxHeightInput');
            const settings = {
                customFontName: fontName,
                customFontData: fontData,
                customFontData: fontData,
                baseThemeKey: baseThemeKey,
                isDarkMode: isDarkMode,
                uiRoundness: uiRoundness,
                fontSize: fontSize,
                eventRoundness: eventRoundness,
                eventBorderThickness: eventBorderThickness,
                dayCellMinWidth: dayCellMinWidth,
                customThemeColors: baseThemeKey === null ? customThemeColors : null,
                unlockedSpecialThemes: Array.from(unlockedSpecialThemes),
                holderIconEnabled: holderIconEnabledState,
                noBackgroundMode: noBackgroundModeState,
                savedCustomThemes: savedThemes,
                disableSidebarAnimations: disableSidebarAnimationsState,
                hideScrollbars: hideScrollbarsState,
                foldDayCellsEnabled: foldDayCellsEnabledState,
                showHolderByDefault: showHolderByDefaultState,
                use24HourFormat: use24HourFormatState,
                holderSidebarWidth: currentHolderSidebarWidth,
                hideAddEventButtonInHolder: hideAddEventButtonInHolderState,
                dayCellMaxHeight: maxHeightInput ? parseInt(maxHeightInput.value, 10) || 120 : 120
            };
            await Preferences.set({ key: 'calendarSettings', value: JSON.stringify(settings) });
        };

        let calendarEl, currentMonthYearEl, prevMonthButton, nextMonthButton, todayButton, settingsButton,
            eventModal, modalTitle, eventTitleInput, eventTimeInput, eventDateInput, eventDescriptionInput,
            eventColorInput, eventIconInput, colorPaletteEl, iconGridEl, saveEventButton, deleteEventButton, cancelEventButton,
            settingsModal, customFontUploadInput, customFontNameDisplay, resetCustomFontButton,
            uiRoundnessInput, uiRoundnessValueDisplay, fontSizeInput, fontSizeValueDisplay,
            eventRoundnessInput, eventRoundnessValueDisplay, eventBorderThicknessInput, eventBorderThicknessValueDisplay,
            dayCellMinWidthInput, dayCellMinWidthValueDisplay,
            themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
            themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
            themePrimaryButtonBgInput, themePrimaryButtonTextInput, themeSecondaryButtonBgInput,
            themeSecondaryButtonTextInput, themeAccentColorInput, themeDayCellBorderColorInput,
            saveSettingsButton, cancelSettingsButton, premadeThemeBoxesEl, iconSearchInput,
            specialThemeBoxesEl, saveCustomThemeButton, savedThemePreviewsEl, removeAllEventsButton, resetApplicationButton,
            removeAllCustomThemesButton, themeNameModal, themeNameInput, cancelThemeNameButton, saveThemeNameButton, effectShowCheckbox,
            effectGlowing, effectStriped, effectDotted, effectParticles, effectSnowFalling, effectGlisteningStars, effectGradient, effectAnimatedStripes, effectAnimatedVerticalRainbow, eventIconDisplay,
            holderContentEl, hamburgerIcon, holderSidebar, holderIconToggle, noBackgroundToggle, disableSidebarAnimationsToggle, mainContainerEl,
            hideScrollbarsToggle, holderSidebarCloseButton,
            darkModeButton, foldDayCellsToggle, showHolderByDefaultToggle, use24HourFormatToggle, addHolderEventButton, hideAddEventButtonInHolderToggle,
            holderResizeHandle, premadeThemeBoxesContainer;

// Ensure modal-related DOM elements are initialized on page load
document.addEventListener('DOMContentLoaded', function() {
    eventModal = document.getElementById('event-modal');
    modalTitle = document.getElementById('modalTitle');
    eventTitleInput = document.getElementById('eventTitle');
    eventTimeInput = document.getElementById('eventTime');
    eventDateInput = document.getElementById('eventDate');
    eventDescriptionInput = document.getElementById('eventDescription');
    eventColorInput = document.getElementById('eventColor');
    eventIconInput = document.getElementById('eventIcon');
    colorPaletteEl = document.getElementById('colorPalette');
    iconGridEl = document.getElementById('iconGrid');
    saveEventButton = document.getElementById('saveEventButton');
    deleteEventButton = document.getElementById('deleteEventButton');
    cancelEventButton = document.getElementById('cancelEventButton');
    iconSearchInput = document.getElementById('iconSearchInput');
    effectShowCheckbox = document.getElementById('effectShowCheckbox');
    effectGlowing = document.getElementById('effectGlowing');
    effectStriped = document.getElementById('effectStriped');
    effectDotted = document.getElementById('effectDotted');
    effectParticles = document.getElementById('effectParticles');
    effectSnowFalling = document.getElementById('effectSnowFalling');
    effectGlisteningStars = document.getElementById('effectGlisteningStars');
    effectGradient = document.getElementById('effectGradient');
    effectAnimatedStripes = document.getElementById('effectAnimatedStripes');
    effectAnimatedVerticalRainbow = document.getElementById('effectAnimatedVerticalRainbow');
    eventIconDisplay = document.getElementById('eventIconDisplay');
    // Add any other modal-related elements as needed
});

        // --- Icon Placement Dropdown Logic ---
        function saveIconPlacement(value) {
            try {
                localStorage.setItem('eventIconPlacement', value);
            } catch (e) {}
            applyIconPlacement(value);
        }
        function applyIconPlacement(value) {
            document.body.setAttribute('data-icon-placement', value);
        }
        function setupIconPlacementDropdown() {
            var dropdown = document.getElementById('iconPlacementDropdown');
            if (!dropdown) return;
            // Set value from storage or default
            var saved = 'right';
            try {
                saved = localStorage.getItem('eventIconPlacement') || 'right';
            } catch (e) {}
            dropdown.value = saved;
            applyIconPlacement(saved);
            if (!dropdown._iconPlacementListener) {
                dropdown.addEventListener('change', function() {
                    saveIconPlacement(this.value);
                });
                dropdown._iconPlacementListener = true;
            }
        }

document.addEventListener('DOMContentLoaded', function() {
  // icon placement
  setupIconPlacementDropdown();

  const header = document.getElementById('customThemeAccordionHeader');
  const accordion = document.getElementById('customThemeAccordion');

  if (header && accordion) {
    header.addEventListener('click', () => {
      if (accordion.classList.contains('open')) {
        // close it
        accordion.classList.remove('open');
        const content = accordion.querySelector('.accordion-content');
        content.style.maxHeight = '0';
        content.style.padding = '0 1.2rem';
      } else {
        // open it
        accordion.classList.add('open');
        const content = accordion.querySelector('.accordion-content');
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.padding = '1.2rem';
      }
    });

    // Initially close the accordion
    const content = accordion.querySelector('.accordion-content');
    content.style.maxHeight = '0';
    content.style.padding = '0 1.2rem';
    accordion.classList.remove('open');
  }
});


        // --- Slider Value Live Update ---
function setupSliderValueLiveUpdate() {
// --- Day Cell Max Height Control ---
function setupDayCellMaxHeightControl() {
    const maxHeightInput = document.getElementById('dayCellMaxHeightInput');
    const foldToggle = document.getElementById('foldDayCellsToggle');
    function applyMaxHeight(save = true) {
        const maxHeight = parseInt(maxHeightInput.value, 10) || 120;
        // Save to calendarSettings
        if (save) {
            Preferences.get({ key: 'calendarSettings' }).then(({ value }) => {
                let settings = value ? JSON.parse(value) : {};
                settings.dayCellMaxHeight = maxHeight;
                Preferences.set({ key: 'calendarSettings', value: JSON.stringify(settings) });
            });
        }
        // Set CSS variable for max height
        document.documentElement.style.setProperty('--day-cell-max-height', maxHeight + 'px');
        // Update ALL day cells
        const allDayCells = document.querySelectorAll('.day-cell');
        if (foldToggle && foldToggle.checked) {
            allDayCells.forEach(cell => {
                cell.classList.add('folded');
                cell.style.maxHeight = maxHeight + 'px';
                cell.style.overflowY = 'auto';
                // Always force scrollability, even if there are 0-3 events. It does not work yet
                let eventsList = cell.querySelector('.events-list');
                if (eventsList) {
                    eventsList.style.maxHeight = (maxHeight - 8) + 'px'; 
                    eventsList.style.overflowY = 'auto';
                }
            });
        } else {
            allDayCells.forEach(cell => {
                cell.classList.remove('folded');
                cell.style.maxHeight = '';
                cell.style.overflowY = '';
                let eventsList = cell.querySelector('.events-list');
                if (eventsList) {
                    eventsList.style.maxHeight = '';
                    eventsList.style.overflowY = '';
                }
            });
        }
    }
    // Restore saved value on load from calendarSettings
    if (maxHeightInput) {
        Preferences.get({ key: 'calendarSettings' }).then(({ value }) => {
            let settings = value ? JSON.parse(value) : {};
            let maxHeight = settings.dayCellMaxHeight !== undefined ? settings.dayCellMaxHeight : 120;
            maxHeightInput.value = maxHeight;
            applyMaxHeight(false);
        });
    }
    if (maxHeightInput) {
        maxHeightInput.addEventListener('input', () => applyMaxHeight(true));
        maxHeightInput.addEventListener('change', () => applyMaxHeight(true));
    }
    if (foldToggle) {
        foldToggle.addEventListener('change', () => applyMaxHeight(false));
    }
    // Initial apply
    setTimeout(() => applyMaxHeight(false), 0);
}
  const sliders = document.querySelectorAll('.slider-group input[type="range"]');
  sliders.forEach(slider => {
    const valueDisplay = slider.nextElementSibling;
    const unit = valueDisplay && valueDisplay.id.includes('MinWidth') ? 'px' : 'px';
    if (valueDisplay) {
      slider.parentElement.style.position = 'relative';
      valueDisplay.style.position = 'absolute';
      valueDisplay.style.bottom = '-60%';
      valueDisplay.style.pointerEvents = 'none';
      valueDisplay.style.minWidth = '32px';
      valueDisplay.style.textAlign = 'center';
      valueDisplay.style.userSelect = 'none';
      valueDisplay.style.fontSize = '14px';
      valueDisplay.style.zIndex = '2';
    // SLIDER THUMB IS BEING FOLLOWED
      const updateValue = () => {
        valueDisplay.textContent = slider.value + unit;
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        const val = parseFloat(slider.value);
        const percent = (val - min) / (max - min);
        const sliderWidth = slider.offsetWidth;
        const thumbWidth = 24;
        const px = percent * (sliderWidth - thumbWidth) + thumbWidth / 2;
        valueDisplay.style.left = px + 'px';
        valueDisplay.style.transform = 'translateX(-50%)';
      };
      slider.addEventListener('input', updateValue);
      slider.addEventListener('change', updateValue);
      window.addEventListener('resize', updateValue);
      // Ensure updateValue runs after layout is ready
      setTimeout(updateValue, 0);
      // Also update when the settings modal is shown (in case of display:none -> block)
      const settingsModal = document.getElementById('settings-modal') || document.getElementById('settingsModal');
      if (settingsModal) {
        const observer = new MutationObserver(() => {
          if (settingsModal.style.display !== 'none' && !settingsModal.classList.contains('hidden')) {
            setTimeout(updateValue, 10);
          }
        });
        observer.observe(settingsModal, { attributes: true, attributeFilter: ['style', 'class'] });
      }
    }
  });
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupSliderValueLiveUpdate);
} else {
  setupSliderValueLiveUpdate();
}

        const loadSettings = async () => {
            const { value: storedSettings } = await Preferences.get({ key: 'calendarSettings' });
            const defaultRoundness = 8;
            const defaultFontSize = 16;
            const defaultEventBorderThickness = 3;
            const defaultDayCellMinWidth = 140;

            let currentUiRoundness = defaultRoundness;
            let currentFontSize = defaultFontSize;
            let currentEventRoundness = defaultRoundness;
            let currentEventBorderThickness = defaultEventBorderThickness;
            let currentDayCellMinWidth = defaultDayCellMinWidth;

            let loadedCustomFontName = null;
            let loadedCustomFontData = null;
            let loadedBaseThemeKey = 'pastelBlue';
            let loadedIsDarkMode = false;
            let loadedHolderIconEnabled = true;
            let loadedNoBackgroundMode = false;
            let loadedDisableSidebarAnimations = true;
            let loadedHideScrollbars = true;
            let loadedFoldDayCellsEnabled = false;
            let loadedShowHolderByDefault = false;
            let loadedUse24HourFormat = false;
            let loadedHideAddEventButtonInHolder = false;
            let loadedCustomThemeColors = null;
            let loadedUnlockedSpecialThemes = [];
            let loadedSavedCustomThemes = [];
            let loadedHolderSidebarWidth = 250;

            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                loadedCustomFontName = settings.customFontName;
                loadedCustomFontData = settings.customFontData;

                loadedBaseThemeKey = settings.baseThemeKey !== undefined ? settings.baseThemeKey : 'pastelBlue';
                loadedIsDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false;
                loadedHolderIconEnabled = settings.holderIconEnabled !== undefined ? settings.holderIconEnabled : false;
                loadedNoBackgroundMode = settings.noBackgroundMode !== undefined ? settings.noBackgroundMode : false;
                loadedDisableSidebarAnimations = settings.disableSidebarAnimations !== undefined ? settings.disableSidebarAnimations : true;
                loadedHideScrollbars = settings.hideScrollbars !== undefined ? settings.hideScrollbars : false;
                loadedFoldDayCellsEnabled = settings.foldDayCellsEnabled !== undefined ? settings.foldDayCellsEnabled : false;
                loadedShowHolderByDefault = settings.showHolderByDefault !== undefined ? settings.showHolderByDefault : false;
                loadedUse24HourFormat = settings.use24HourFormat !== undefined ? settings.use24HourFormat : false;
                loadedHideAddEventButtonInHolder = settings.hideAddEventButtonInHolder !== undefined ? settings.hideAddEventButtonInHolder : false; 

                currentUiRoundness = settings.uiRoundness !== undefined ? settings.uiRoundness : defaultRoundness;
                currentFontSize = settings.fontSize !== undefined ? settings.fontSize : defaultFontSize;
                currentEventRoundness = settings.eventRoundness !== undefined ? settings.eventRoundness : currentUiRoundness;
                currentEventBorderThickness = settings.eventBorderThickness !== undefined ? settings.eventBorderThickness : defaultEventBorderThickness;
                currentDayCellMinWidth = settings.dayCellMinWidth !== undefined ? settings.dayCellMinWidth : defaultDayCellMinWidth;
                loadedHolderSidebarWidth = settings.holderSidebarWidth !== undefined ? settings.holderSidebarWidth : 250;

                loadedCustomThemeColors = settings.customThemeColors || null;
                loadedUnlockedSpecialThemes = settings.unlockedSpecialThemes || [];
                loadedSavedCustomThemes = settings.savedCustomThemes || [];

                // Restore dayCellMaxHeight to input and CSS variable
                const maxHeightInput = document.getElementById('dayCellMaxHeightInput');
                const foldToggle = document.getElementById('foldDayCellsToggle');
                let maxHeight = settings.dayCellMaxHeight !== undefined ? settings.dayCellMaxHeight : 120;
                if (maxHeightInput) {
                    maxHeightInput.value = maxHeight;
                }
                document.documentElement.style.setProperty('--day-cell-max-height', maxHeight + 'px');
                // Update all day cells
                document.querySelectorAll('.day-cell').forEach(cell => {
                    if (foldToggle && foldToggle.checked) {
                        cell.classList.add('folded');
                        cell.style.maxHeight = 'var(--day-cell-max-height)';
                        cell.style.overflowY = 'auto';
                    } else {
                        cell.classList.remove('folded');
                        cell.style.maxHeight = '';
                        cell.style.overflowY = '';
                    }
                });
            }

            if (loadedCustomFontData && loadedCustomFontName) {
                injectCustomFont(loadedCustomFontName, loadedCustomFontData);
            }

            currentCustomFontName = loadedCustomFontName;
            currentBaseThemeKey = loadedBaseThemeKey;
            isDarkModeActive = loadedIsDarkMode;
            holderIconEnabled = loadedHolderIconEnabled;
            noBackgroundMode = loadedNoBackgroundMode;
            disableSidebarAnimations = loadedDisableSidebarAnimations;
            hideScrollbars = loadedHideScrollbars;
            foldDayCellsEnabled = loadedFoldDayCellsEnabled;
            showHolderByDefault = loadedShowHolderByDefault;
            use24HourFormat = loadedUse24HourFormat;
            hideAddEventButtonInHolder = loadedHideAddEventButtonInHolder; 
            unlockedSpecialThemesKeys = new Set(loadedUnlockedSpecialThemes);
            savedCustomThemes = loadedSavedCustomThemes;
            holderSidebarWidth = loadedHolderSidebarWidth;

            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedCustomThemeColors || { ...THEMES.pastelBlue.light };
            } else {
                if (THEMES[currentBaseThemeKey]) {
                    currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
                } else {
                    currentBaseTheme = THEMES.pastelBlue.light;
                    currentBaseThemeKey = 'pastelBlue';
                }
            }


            return {
                currentCustomFontName: loadedCustomFontName,
                customFontData: loadedCustomFontData,
                currentBaseThemeKey: loadedBaseThemeKey,
                isDarkModeActive: loadedIsDarkMode,
                holderIconEnabled: loadedHolderIconEnabled,
                noBackgroundMode: loadedNoBackgroundMode,
                disableSidebarAnimations: loadedDisableSidebarAnimations,
                hideScrollbars: loadedHideScrollbars,
                foldDayCellsEnabled: loadedFoldDayCellsEnabled,
                showHolderByDefault: loadedShowHolderByDefault,
                use24HourFormat: loadedUse24HourFormat,
                hideAddEventButtonInHolder: loadedHideAddEventButtonInHolder, 
                currentUiRoundness: currentUiRoundness,
                currentFontSize: currentFontSize,
                currentEventRoundness: currentEventRoundness,
                currentEventBorderThickness: currentEventBorderThickness,
                currentDayCellMinWidth: currentDayCellMinWidth,
                customThemeColors: loadedCustomThemeColors,
                unlockedSpecialThemes: loadedUnlockedSpecialThemes,
                savedCustomThemes: loadedSavedCustomThemes,
                holderSidebarWidth: loadedHolderSidebarWidth
            };
        };

const eventColors = [
  // Dark Colors
  { name: 'red', primary: '#880e0e', text: '#FF8A80' },
  { name: 'rose pink', primary: '#AD1457', text: '#F8BBD0' }, 
  { name: 'magenta', primary: '#880E4F', text: '#F8BBD0' },
  { name: 'violet', primary: '#6A1B9A', text: '#E1BEE7' },
  { name: 'purple', primary: '#4527A0', text: '#B39DDB' },
  { name: 'indigo', primary: '#1A237E', text: '#C5CAE9' },
  { name: 'blue', primary: '#0D47A1', text: '#90CAF9' },
  { name: 'sky blue', primary: '#01579B', text: '#81D4FA' },
  { name: 'cyan', primary: '#006064', text: '#80DEEA' }, 
  { name: 'bluergreen', primary: '#004D40', text: '#80CBC4' },
  { name: 'green', primary: '#1B5E20', text: '#A5D6A7' },
  { name: 'lime green', primary: '#558B2F', text: '#C5E1A5' },
  { name: 'dandelion', primary: '#da9830', text: '#573100' },
  { name: 'orange', primary: '#ab3d02', text: '#FFD180' },

  // Bright Colors
  { name: 'red', primary: '#E53935', text: '#FFB3B1' },
  { name: 'rose pink', primary: '#D81B60', text: '#F48FB1' },
  { name: 'magenta', primary: '#C2185B', text: '#F8BBD0' },
  { name: 'violet', primary: '#8E24AA', text: '#E1BEE7' },
  { name: 'purple', primary: '#673AB7', text: '#D1C4E9' },
  { name: 'indigo', primary: '#3949AB', text: '#C5CAE9' },
  { name: 'blue', primary: '#2196F3', text: '#BBDEFB' },
  { name: 'sky blue', primary: '#03A9F4', text: '#B3E5FC' },
  { name: 'cyan', primary: '#00BCD4', text: '#B2EBF2' },
  { name: 'bluergreen', primary: '#009688', text: '#B2DFDB' },
  { name: 'green', primary: '#4CAF50', text: '#C8E6C9' },
  { name: 'lime green', primary: '#8BC34A', text: '#DCEDC8' },
  { name: 'dandelion', primary: '#FFC107', text: '#3E3300' },
  { name: 'orange', primary: '#FF9800', text: '#4E2600' },
  { name: 'peach', primary: '#fa957f', text: '#6a2a1f' },

  // Light Colors
  { name: 'red', primary: '#FFCDD2', text: '#D32F2F' },
  { name: 'rose pink', primary: '#F8BBD0', text: '#C2185B' },
  { name: 'magenta', primary: '#ffc4fa', text: '#b30098' },
  { name: 'violet', primary: '#e6adf0', text: '#7B1FA2' },
  { name: 'purple', primary: '#bbacff', text: '#2608a2' },
  { name: 'indigo', primary: '#afb8ed', text: '#303F9F' },
  { name: 'blue', primary: '#93c3ed', text: '#003b99' },
  { name: 'sky blue', primary: '#B3E5FC', text: '#0277BD' },
  { name: 'cyan', primary: '#B2EBF2', text: '#0097A7' },
  { name: 'bluergreen', primary: '#a0dece', text: '#2e7d32' },
  { name: 'green', primary: '#C8E6C9', text: '#2E7D32' },
  { name: 'lime green', primary: '#DCEDC8', text: '#689F38' },
  { name: 'pale yellow', primary: '#FFFDE7', text: '#F9A825' },
  { name: 'dandelion', primary: '#FFF9C4', text: '#db9d02' },
  { name: 'orange', primary: '#FFE0B2', text: '#d15e00' },

  // Neutral Colors (Brown, Biscuit, White, Greys, Black) - Appended at the end
  { name: 'biscuit', primary: '#bd956f', text: '#3b2613' },
  { name: 'lighter brown', primary: '#6D4C41', text: '#D7CCC8' },
  { name: 'dark brown', primary: '#4E342E', text: '#D7CCC8' },
  { name: 'brown', primary: '#3E2723', text: '#BCAAA4' },
  { name: 'black', primary: '#171717', text: '#E0E0E0' },
  { name: 'darker gray', primary: '#1f1f1f', text: '#e3e3e3' },
  { name: 'dark gray', primary: '#242424', text: '#b3b3b3' },
  { name: 'grey', primary: '#616161', text: '#FFFFFF' },
  { name: 'light grey', primary: '#b3b3b3', text: '#454545' },
  { name: 'lighter grey', primary: '#E0E0E0', text: '#616161' },
  { name: 'white', primary: '#FFFFFF', text: '#212121' },
  { name: 'light muted coffee', primary: '#D7CCC8', text: '#5D4037' },
];


        // --- Customization Toggles Functionality ---
        const customizationCheckboxDashedBorderToggle = document.getElementById('customizationCheckboxDashedBorderToggle');
        const customizationStrikethroughTextToggle = document.getElementById('customizationStrikethroughTextToggle');
        const customizationBoldTitleToggle = document.getElementById('customizationBoldTitleToggle');

        // CUSTOMIZATION TOGGLES ARE ON
        if (customizationCheckboxDashedBorderToggle) customizationCheckboxDashedBorderToggle.checked = true;
        if (customizationStrikethroughTextToggle) customizationStrikethroughTextToggle.checked = true;
        if (customizationBoldTitleToggle) customizationBoldTitleToggle.checked = true;

        // Save/restore customization settings
        function saveCustomizationSettings() {
            Preferences.set({ key: 'customizationSettings', value: JSON.stringify({
                dashed: customizationCheckboxDashedBorderToggle.checked,
                strikethrough: customizationStrikethroughTextToggle.checked,
                bold: customizationBoldTitleToggle.checked
            }) });
        }

        function loadCustomizationSettings() {
            Preferences.get({ key: 'customizationSettings' }).then(({ value }) => {
                let settings = {
                    dashed: true,
                    strikethrough: true, 
                    bold: true
                };
                if (value) {
                    try {
                        const parsedSettings = JSON.parse(value);
                        settings = { ...settings, ...parsedSettings };
                    } catch (e) {
                    }
                }
                customizationCheckboxDashedBorderToggle.checked = settings.dashed;
                customizationStrikethroughTextToggle.checked = settings.strikethrough;
                customizationBoldTitleToggle.checked = settings.bold;
                updateCustomizationClasses();
            });
        }

        customizationCheckboxDashedBorderToggle.addEventListener('change', () => {
            saveCustomizationSettings();
            updateCustomizationClasses();
        });
        customizationStrikethroughTextToggle.addEventListener('change', () => {
            saveCustomizationSettings();
            updateCustomizationClasses();
        });
        customizationBoldTitleToggle.addEventListener('change', () => {
            saveCustomizationSettings();
            updateCustomizationClasses();
        });

        function updateCustomizationClasses() {
            document.body.classList.toggle('custom-dashed-checkbox', customizationCheckboxDashedBorderToggle.checked);
            document.body.classList.toggle('custom-strikethrough-text', customizationStrikethroughTextToggle.checked);
            document.body.classList.toggle('custom-bold-event-title', customizationBoldTitleToggle.checked);
            if (calendarEl) { 
                renderCalendar();
            }
            if (holderContentEl) { 
                renderHolderEvents();
            }
        }

        // --- CSS for Customization ---
        const style = document.createElement('style');
        style.innerHTML = `
        /* Dashed border for checked checkboxes */
        .custom-dashed-checkbox .custom-checkbox.checked {
            border-style: dashed !important;
        }
        /* Strikethrough for checked event text */
        .custom-strikethrough-text .event-item.completed .main-content .title-part,
        .custom-strikethrough-text .event-item.completed .main-content .time-part {
            text-decoration: line-through !important;
            opacity: 0.7;
        }
        /* Bold event titles */
        .custom-bold-event-title .event-item .main-content .title-part {
            font-weight: 900 !important;
            letter-spacing: 0.01em;
        }
        `;
        document.head.appendChild(style);



        // --- Calendar Copy Functionality ---
        // Add toggle in settings modal
        let copyEventTitlesOnly = false;
        // Add toggle UI to settings modal
        window.addEventListener('DOMContentLoaded', () => {
            loadCustomizationSettings();
            // Add all settings into three main accordions for clarity
            let settingsModal = document.getElementById('settingsModal') || document.querySelector('.settings-modal');
            if (settingsModal) {
                // --- General Settings Accordion ---
                if (!settingsModal.querySelector('#generalSettingsAccordion')) {
                    let generalAccordion = document.createElement('div');
                    generalAccordion.id = 'generalSettingsAccordion';
                    generalAccordion.className = 'settings-section';
                    generalAccordion.style.marginBottom = '18px';
                    generalAccordion.innerHTML = `
                        <button type="button" style="width:100%;text-align:left;font-size:16px;padding:8px 0;background:none;border:none;outline:none;cursor:pointer;font-weight:600;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">General Settings ▼</button>
                        <div style="display:block;padding:8px 0 0 0;" id="generalSettingsContent">
                            <div class="settings-row" style="margin:8px 0;">
                                <label style="display:flex;align-items:center;gap:8px;font-size:15px;cursor:pointer;">
                                    <input type="checkbox" id="copyEventTitlesToggle" style="width:18px;height:18px;cursor:pointer;">
                                    <span>Copy only event titles (not descriptions) when using Ctrl+A + Ctrl+C</span>
                                </label>
                            </div>
                            <div class="settings-row" style="margin:8px 0;">
                                <label style="display:flex;align-items:center;gap:8px;font-size:15px;cursor:pointer;">
                                    <span>Week starts on:</span>
                                    <select id="weekStartDropdown" style="font-size:15px;padding:2px 8px;">
                                        <option value="0">Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                </label>
                            </div>
                            <div class="settings-row" style="margin:8px 0 0 0;">
                                <button id="copyCurrentMonthBtn" style="font-size:15px;padding:6px 18px;cursor:pointer;">Copy Current Month</button>
                            </div>
                        </div>
                    `;
                    settingsModal.appendChild(generalAccordion);
                }

                // --- Custom Theming Accordion ---
                if (!settingsModal.querySelector('#customThemeAccordion')) {
                    let customThemeAccordion = document.createElement('div');
                    customThemeAccordion.id = 'customThemeAccordion';
                    customThemeAccordion.className = 'settings-section';
                    customThemeAccordion.style.marginBottom = '18px';
                    customThemeAccordion.innerHTML = `
                        <button type="button" style="width:100%;text-align:left;font-size:16px;padding:8px 0;background:none;border:none;outline:none;cursor:pointer;font-weight:600;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">Custom Theming ▼</button>
                        <div style="display:none;padding:8px 0 0 0;" id="customThemeContent">
                            <!-- Custom theme controls will be inserted here by your existing logic -->
                        </div>
                    `;
                    settingsModal.appendChild(customThemeAccordion);
                }

                // --- Special Themes Accordion ---
                if (!settingsModal.querySelector('#specialThemeAccordion')) {
                    let specialThemeAccordion = document.createElement('div');
                    specialThemeAccordion.id = 'specialThemeAccordion';
                    specialThemeAccordion.className = 'settings-section';
                    specialThemeAccordion.style.marginBottom = '18px';
                    specialThemeAccordion.innerHTML = `
                        <button type="button" style="width:100%;text-align:left;font-size:16px;padding:8px 0;background:none;border:none;outline:none;cursor:pointer;font-weight:600;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">Special Themes ▼</button>
                        <div style="display:none;padding:8px 0 0 0;" id="specialThemeContent">
                            <!-- Special theme controls will be inserted here by your existing logic -->
                        </div>
                    `;
                    settingsModal.appendChild(specialThemeAccordion);
                }
            }
            // Listen for toggle changes
            let toggle = document.getElementById('copyEventTitlesToggle');
            if (toggle) {
                let val = localStorage.getItem('copyEventTitlesOnly');
                copyEventTitlesOnly = val === 'true';
                toggle.checked = copyEventTitlesOnly;
                toggle.addEventListener('change', function() {
                    copyEventTitlesOnly = toggle.checked;
                    localStorage.setItem('copyEventTitlesOnly', copyEventTitlesOnly ? 'true' : 'false');
                });
            }
            // Listen for week start changes
            let weekStartDropdown = document.getElementById('weekStartDropdown');
            if (weekStartDropdown) {
                let val = localStorage.getItem('weekStartDay');
                if (val !== null) weekStartDropdown.value = val;
                weekStartDropdown.addEventListener('change', function() {
                    localStorage.setItem('weekStartDay', weekStartDropdown.value);
                    if (typeof renderCalendar === 'function') renderCalendar();
                });
            }
            // Listen for copy button
            let copyBtn = document.getElementById('copyCurrentMonthBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const text = getCalendarMonthText();
                    calendarCopyTextarea.value = text;
                    calendarCopyTextarea.select();
                    document.execCommand('copy');
                });
            }
        });

        // hidden textarea for copying
        const calendarCopyTextarea = document.createElement('textarea');
        calendarCopyTextarea.style.position = 'fixed';
        calendarCopyTextarea.style.opacity = '0';
        calendarCopyTextarea.style.pointerEvents = 'none';
        calendarCopyTextarea.style.zIndex = '-1';
        document.body.appendChild(calendarCopyTextarea);


        // generate the this current month table as plain text
        function getCalendarMonthText() {
            // Try to get month/year heading
            let heading = '';
            const headingEl = document.querySelector('.calendar-month-label, .calendar-header, .calendar-title, .current-month-year');
            if (headingEl) {
                heading = headingEl.textContent.trim();
            }

            // Check export options
            const exportTitlesCheckbox = document.getElementById('exportTitles');
            const exportDescriptionsCheckbox = document.getElementById('exportDescriptions');
            const includeTitles = exportTitlesCheckbox ? exportTitlesCheckbox.checked : true;
            // Always include descriptions if present
            const includeDescriptions = true;

            // format a day cell
            function formatDayCell(cell) {
                let date = '';
                let dateEl = cell.querySelector('.date, .day-number, .calendar-date, .date-label');
                if (dateEl) {
                    date = dateEl.textContent.trim();
                } else {
                    let match = cell.textContent.match(/\d+/);
                    if (match) date = match[0];
                }
                let eventEls = cell.querySelectorAll('.event-item, .calendar-event, .event, .event-title');
                let eventTexts = [];
                eventEls.forEach(ev => {
                    let title = '';
                    let desc = '';
                    let titleEl = ev.querySelector('.title, .event-title, .main-content .title-part');
                    let descEl = ev.querySelector('.desc, .event-desc, .description, .event-description');
                    if (titleEl) title = titleEl.textContent.trim();
                    else title = ev.textContent.trim();
                    if (descEl) desc = descEl.textContent.trim();
                    // Always add description if present
                    let cellText = '';
                    if (includeTitles && title) cellText += title;
                    if (desc) cellText += (cellText ? ' - ' : '') + desc;
                    if (cellText) eventTexts.push(cellText);
                });
                if (eventTexts.length === 0 && cell.childNodes.length > 1) {
                    let raw = cell.textContent.trim();
                    if (date) raw = raw.replace(date, '').trim();
                    if (raw) eventTexts.push(raw);
                }
                let result = '';
                if (date) {
                    result = date + (eventTexts.length ? '. ' + eventTexts.join(', ') : '');
                } else {
                    result = eventTexts.join(', ');
                }
                return result;
            }

            // Try to get table structure first
            const calendarTable = document.querySelector('.calendar-table');
            if (calendarTable) {
                const rows = Array.from(calendarTable.querySelectorAll('tr'));
                if (rows.length === 0) return '';
                const headerCells = Array.from(rows[0].querySelectorAll('th,td'));
                const headerRow = '| ' + headerCells.map(cell => cell.textContent.trim().replace(/\n/g, ' ')).join(' | ') + ' |';
                const separatorRow = '| ' + headerCells.map(() => '---').join(' | ') + ' |';
                const weekRows = rows.slice(1).map(row => {
                    const cells = Array.from(row.querySelectorAll('th,td'));
                    if (cells.length === 0 || cells.every(cell => cell.textContent.trim() === '')) return null;
                    return '| ' + cells.map(cell => formatDayCell(cell)).join(' | ') + ' |';
                }).filter(Boolean);
                return (heading ? heading + '\n' : '') + [headerRow, separatorRow, ...weekRows].join('\n');
            }

            // If not a table, try to get from grid structure
            // Assume: .calendar-grid-week for each week, .calendar-grid-day for each day
            const weekEls = document.querySelectorAll('.calendar-grid-week');
            if (weekEls.length > 0) {
                let headerRow = '| Sun | Mon | Tue | Wed | Thu | Fri | Sat |';
                let separatorRow = '| --- | --- | --- | --- | --- | --- | --- |';
                let weekRows = [];
                weekEls.forEach(weekEl => {
                    const dayEls = weekEl.querySelectorAll('.calendar-grid-day');
                    if (dayEls.length === 0) return;
                    let row = '| ' + Array.from(dayEls).map(dayEl => formatDayCell(dayEl)).join(' | ') + ' |';
                    weekRows.push(row);
                });
                return (heading ? heading + '\n' : '') + [headerRow, separatorRow, ...weekRows].join('\n');
            }

            // !!!Fallback: try to get all day cells in a list
            const dayEls = document.querySelectorAll('.calendar-day, .calendar-cell, .day-cell');
            if (dayEls.length > 0) {
                let headerRow = '| Sun | Mon | Tue | Wed | Thu | Fri | Sat |';
                let separatorRow = '| --- | --- | --- | --- | --- | --- | --- |';
                let weekRows = [];
                for (let i = 0; i < dayEls.length; i += 7) {
                    let week = Array.from(dayEls).slice(i, i + 7).map(dayEl => formatDayCell(dayEl));
                    let row = '| ' + week.join(' | ') + ' |';
                    weekRows.push(row);
                }
                return (heading ? heading + '\n' : '') + [headerRow, separatorRow, ...weekRows].join('\n');
            }

            return '';
        }


        // STARE for Ctrl+A and Ctrl+C on the calendar
        let calendarJustSelected = false;
        document.addEventListener('keydown', function(e) {
            // Ctrl+A: select all calendar area
            if (e.ctrlKey && e.key.toLowerCase() === 'a') {
                let calendarArea = document.querySelector('.calendar-table, .calendar-grid, .calendar-main, .calendar-content, #calendar, .calendar');
                if (calendarArea) {
                    e.preventDefault();
                    let range = document.createRange();
                    range.selectNode(calendarArea);
                    let sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    calendarJustSelected = true;
                }
            }
            // Ctrl+C: copy calendar as markdown table if just selected!!!
            if (e.ctrlKey && e.key.toLowerCase() === 'c') {
                if (calendarJustSelected) {
                    e.preventDefault();
                    const text = getCalendarMonthText();
                    calendarCopyTextarea.value = text;
                    calendarCopyTextarea.select();
                    document.execCommand('copy');
                    calendarJustSelected = false;
                }
            }
        });
        // Add Event Descriptions export option (checked by default) if not present
        if (!document.getElementById('exportDescriptions')) {
            const exportTitlesDiv = document.getElementById('exportTitles')?.parentNode;
            if (exportTitlesDiv) {
                const descToggle = document.createElement('div');
                descToggle.className = 'toggle-container';
                descToggle.innerHTML = '<input type="checkbox" id="exportDescriptions" checked><label for="exportDescriptions" class="toggle-label">Event Descriptions</label>';
                exportTitlesDiv.parentNode.insertBefore(descToggle, exportTitlesDiv.nextSibling);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadCustomizationSettings();
            // Add click handler for COPY CURRENT MONTH button
            const copyCurrentMonthBtn = document.getElementById('copyCurrentMonthBtn');
            if (copyCurrentMonthBtn) {
                copyCurrentMonthBtn.addEventListener('click', () => {
                    const text = getCalendarMonthText();
                    navigator.clipboard.writeText(text).then(() => {
                        copyCurrentMonthBtn.textContent = 'Copied!';
                        setTimeout(() => copyCurrentMonthBtn.textContent = 'COPY CURRENT MONTH', 1200);
                    });
                });
            }
            // --- Edit Event Modal Logic ---
            // Attach edit button listeners to all event items
            function attachEventEditButtonListeners() {
                // Try to find all event edit buttons (assume they have class 'edit-event-btn' and data-event-id)
                const editBtns = document.querySelectorAll('.edit-event-btn[data-event-id]');
                editBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const eventId = btn.getAttribute('data-event-id');
                        if (eventId) {
                            window.openEditEventModal(eventId);
                        } else {
                            console.warn('Edit button clicked but no eventId found on button.');
                        }
                    });
                });
            }
            // Call this after calendar render
            if (typeof renderCalendar === 'function') {
                const originalRenderCalendar = renderCalendar;
                window.renderCalendar = function() {
                    originalRenderCalendar.apply(this, arguments);
                    attachEventEditButtonListeners();
                };
            } else {
                // If renderCalendar not defined yet, attach after DOMContentLoaded
                attachEventEditButtonListeners();
            }
            // Helper to attach click listeners robustly
           // ...existing code...
window.openEditEventModal = function(eventId) {
    // Reuse openEventModal to ensure all fields (including long event fields) are populated correctly.
    // Find the event in either events or holderEvents
    let ev = null;
    if (window.events) ev = window.events.find(e => String(e.id) === String(eventId));
    if (!ev && window.holderEvents) ev = window.holderEvents.find(e => String(e.id) === String(eventId));
    if (!ev) {
        console.error('Event not found for edit:', eventId);
        return;
    }

    const dateParam = ev.date || ev.startDate || null;
    const endParam = (ev.startDate && ev.endDate && ev.startDate !== ev.endDate) ? ev.endDate : null;
    // Call the main openEventModal to show the modal and populate fields
    if (typeof openEventModal === 'function') {
        openEventModal(eventId, dateParam, endParam);
    } else {
        console.error('openEventModal not available when opening edit modal');
    }

    // Wire up delete button inside event modal if present
    const eventModal = document.getElementById('event-modal');
    if (eventModal) {
        const deleteBtn = eventModal.querySelector('#deleteEvent, #deleteEventButton');
        if (deleteBtn) {
            deleteBtn.onclick = async () => {
                const id = editingEventId || eventId;
                const idx = window.events.findIndex(ev => String(ev.id) === String(id));
                if (idx !== -1) {
                    window.events.splice(idx, 1);
                } else {
                    const hidx = window.holderEvents.findIndex(ev => String(ev.id) === String(id));
                    if (hidx !== -1) window.holderEvents.splice(hidx, 1);
                }
                try {
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                    if (eventModal) { eventModal.classList.add('hidden'); eventModal.style.display = 'none'; }
                } catch (err) {
                    console.error('Failed to delete event from edit modal:', err);
                }
            };
        }
    }
}
            // If you have a function that opens the modal, call attachEditModalListeners() after opening
                const removeAllEventsButton = document.getElementById('removeAllEventsButton');
            if (removeAllEventsButton) {
                removeAllEventsButton.addEventListener('click', handleRemoveAllEvents);
            }

            // Fix Remove All Custom Themes button
            const removeAllCustomThemesButton = document.getElementById('removeAllCustomThemesButton');
            if (removeAllCustomThemesButton) {
                removeAllCustomThemesButton.addEventListener('click', handleRemoveAllCustomThemes);
            }

            // Fix Reset Application button
            const resetApplicationButton = document.getElementById('resetApplicationButton');
            if (resetApplicationButton) {
                resetApplicationButton.addEventListener('click', handleResetApplication);
            }
        });


const initColorPalette = () => {
    colorPaletteEl.innerHTML = '';
    const colorsToShow = [];

    const lightColors = eventColors.slice(0, 20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: true
    }));

    const darkColors = eventColors.slice(20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: false
    }));

    colorsToShow.push(...lightColors, ...darkColors);

    colorsToShow.forEach(color => {
        const colorBox = document.createElement('div');
        colorBox.classList.add('color-box');
        colorBox.title = color.name;
        colorBox.style.backgroundColor = color.primary;
        colorBox.dataset.primary = color.primary;
        colorBox.dataset.textColor = color.text;
        colorBox.addEventListener('click', () => {
            document.querySelectorAll('.color-box').forEach(box => box.classList.remove('selected'));
            colorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: color.primary, text: color.text });
        });
        colorPaletteEl.appendChild(colorBox);
    });

    const initialSelectedColor = eventColorInput.value;
    let foundInitialSelection = false;
    if (initialSelectedColor) {
        try {
            const parsedColor = JSON.parse(initialSelectedColor);
            const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${parsedColor.primary}"][data-text-color="${parsedColor.text}"]`);
            if (colorBox) {
                colorBox.classList.add('selected');
                foundInitialSelection = true;
            }
        } catch (e) {
        }
    }

    if (!foundInitialSelection && colorsToShow.length > 0) {
        const defaultColor = colorsToShow[0];
        const defaultColorBox = document.querySelector(`#colorPalette .color-box[data-primary="${defaultColor.primary}"][data-text-color="${defaultColor.text}"]`);
        if (defaultColorBox) {
            defaultColorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: defaultColor.primary, text: defaultColor.text });
        }
    }
};


        const allEventIcons = [
            'fas fa-star', 'far fa-star', 'fas fa-heart', 'far fa-heart', 'fas fa-bell', 'far fa-bell',
            'fas fa-bookmark', 'far fa-bookmark', 'fas fa-flag', 'far fa-flag', 'fas fa-calendar-alt', 'far fa-calendar-alt',
            'fas fa-compass', 'far fa-compass', 'fas fa-lightbulb', 'far fa-lightbulb', 'fas fa-comment', 'far fa-comment',
            'fas fa-folder', 'far fa-folder', 'far fa-circle', 'fas fa-circle', 'far fa-square', 'fas fa-square', 'fas fa-file', 'far fa-file', 'fas fa-image', 'far fa-image',
            'fas fa-play-circle', 'far fa-play-circle', 'fas fa-question-circle', 'far fa-question-circle',
            'fas fa-smile', 'far fa-smile', 'fas fa-meh', 'far fa-meh', 'fas fa-frown', 'far fa-frown',
            'fas fa-paper-plane', 'far fa-paper-plane', 'fas fa-envelope', 'far fa-envelope', 'fab fa-youtube', 'fab fa-instagram', 'fab fa-facebook', 'fab fa-tiktok', 'fab fa-whatsapp', 'fab fa-telegram', 'fab fa-twitter', 'fab fa-linkedin',
            'fab fa-github', 'fab fa-google', 'fab fa-apple', 'fab fa-windows', 'fab fa-android', 'fab fa-linux',
            'fas fa-sun', 'far fa-sun', 'fas fa-moon', 'far fa-moon', 'fas fa-grin', 'far fa-grin',
            'fas fa-surprise', 'far fa-surprise', 'fas fa-tired', 'far fa-tired', 'fas fa-sad-cry', 'far fa-sad-cry', 'far fa-face-laugh-beam', 'fas fa-clock', 'far fa-clock', 'far fa-hourglass', 'fas fa-lemon', 'far fa-lemon',
            'fas fa-futbol', 'far fa-futbol', 'fas fa-hand-peace', 'far fa-hand-peace',
            'fas fa-snowflake', 'far fa-snowflake', 'fas fa-thumbs-up', 'far fa-thumbs-up',
            'fas fa-thumbs-down', 'far fa-thumbs-down', 'fas fa-check-circle', 'far fa-check-circle',
            'fas fa-times-circle', 'far fa-times-circle', 'fas fa-edit', 'far fa-edit',
            'fas fa-trash', 'far fa-trash-alt', 'fas fa-plus-circle', 'far fa-plus-circle',
            'fas fa-minus-circle', 'far fa-minus-circle', 'fas fa-info-circle', 'far fa-info-circle',
            'fas fa-briefcase', 'fas fa-home', 'fas fa-gift', 'fas fa-plane', 'fas fa-utensils',
            'fas fa-dumbbell', 'fas fa-graduation-cap', 'fas fa-film', 'fas fa-book', 'fas fa-music',
            'fas fa-shopping-cart', 'fas fa-phone', 'fas fa-laptop', 'fas fa-coffee', 'fas fa-gamepad',
            'fas fa-cloud', 'fas fa-tree', 'fas fa-car', 'fas fa-train', 'fas fa-building',
            'fas fa-pizza-slice', 'fas fa-palette', 'fas fa-brush', 'fas fa-microchip',
            'fas fa-chart-line', 'fas fa-globe', 'fas fa-paint-brush',
            'fas fa-lock', 'fas fa-unlock', 'fas fa-key', 'fas fa-wifi', 'fas fa-plug',
            'fas fa-cube', 'fas fa-flask', 'fas fa-bug', 'fas fa-code', 'fas fa-terminal',
            'fas fa-database', 'fas fa-server', 'fas fa-cloud-upload-alt', 'fas fa-cloud-download-alt',
            'fas fa-chart-pie', 'fas fa-chart-bar', 'fas fa-receipt', 'fas fa-credit-card',
            'fas fa-dollar-sign', 'fas fa-euro-sign', 'fas fa-pound-sign', 'fas fa-yen-sign',
            'fas fa-handshake', 'fas fa-gavel', 'fas fa-balance-scale', 'fas fa-shield-alt',
            'fas fa-user-friends', 'fas fa-users', 'fas fa-user-circle', 'far fa-user-circle',
            'fas fa-trophy', 'fas fa-medal', 'fas fa-award', 'fas fa-crown',
            'fas fa-rocket', 'fas fa-space-shuttle', 'fas fa-earth-americas', 'fas fa-map-marker-alt',
            'fas fa-bus', 'fas fa-bicycle', 'fas fa-motorcycle', 'fas fa-ship',
            'fas fa-camera', 'fas fa-video', 'fas fa-microphone', 'fas fa-headphones',
            'fas fa-desktop', 'fas fa-tablet-alt', 'fas fa-mobile-alt', 'fas fa-gamepad',
            'fas fa-cogs', 'fas fa-tools', 'fas fa-wrench', 'fas fa-hammer',
            'fas fa-shopping-bag', 'fas fa-store', 'fas fa-warehouse', 'fas fa-truck',
            'fas fa-hospital', 'fas fa-clinic-medical', 'fas fa-stethoscope', 'fas fa-syringe',
            'fas fa-first-aid', 'fas fa-briefcase-medical',
            'fas fa-dog', 'fas fa-cat', 'fas fa-paw',
            'fas fa-fish', 'fas fa-carrot', 'fas fa-egg', 'fas fa-apple-alt', 'fas fa-mountain', 'fas fa-water', 'fas fa-fire',
            'fas fa-anchor', 'fas fa-life-ring', 'fas fa-umbrella', 'fas fa-wind',
            'fas fa-poo', 'fas fa-ghost', 'fas fa-spider', 'fas fa-skull',
            'fas fa-robot', 'fas fa-microchip', 'fas fa-atom', 'fas fa-dna',
            'fas fa-satellite', 'fas fa-globe-americas', 'fas fa-flask', 'fas fa-magnet',
            'fas fa-bug', 'fas fa-seedling', 'fas fa-leaf', 'fas fa-concierge-bell', 'fas fa-hotel', 'fas fa-bed',
            'fas fa-person-walking', 'fas fa-running', 'fas fa-biking', 'fas fa-swimmer',
            'fas fa-chart-line', 'fas fa-mug-hot', 'fas fa-pizza-slice', 'fas fa-plane-departure', 'fas fa-school', 'fas fa-hospital-user', 'far fa-closed-captioning', 'fab fa-money-bill', 
            'fas fa-clipboard', 'fas fa-clipboard-list', 'fas fa-clipboard-check',
            'fas fa-birthday-cake', 'fas fa-candy-cane', 'fas fa-cookie', 'fas fa-ice-cream',
            'fas fa-beer', 'fas fa-cocktail', 'fas fa-wine-glass-alt',
            'fas fa-whiskey-glass', 'fas fa-champagne-glasses', 'fas fa-basketball-ball',
            'fas fa-football-ball', 'fas fa-baseball-ball', 'fas fa-hockey-puck',
            'fas fa-table-tennis', 'fas fa-volleyball-ball', 'fas fa-swimming-pool',
            'fas fa-skiing', 'fas fa-snowboarding', 'fas fa-campground',
            'fas fa-binoculars', 'fas fa-camera-retro', 'fas fa-video-slash',
            'fas fa-headset', 'fas fa-keyboard', 'fas fa-mouse', 'fas fa-print',
            'fas fa-fax', 'fas fa-sd-card', 'fas fa-sim-card',
            'fas fa-ethernet', 'fas fa-hdd', 'fas fa-memory',
            'fas fa-barcode', 'fas fa-qrcode', 'fas fa-satellite-dish',
            'fas fa-stopwatch', 'fas fa-calendar-plus',
            'fas fa-calendar-minus', 'fas fa-calendar-times', 'fas fa-calendar-check',
            'fas fa-business-time', 'fas fa-piggy-bank', 'fas fa-wallet',
            'fas fa-money-bill-wave', 'fas fa-coins', 'fas fa-ring',
            'fas fa-tshirt', 'fas fa-hat-cowboy', 'fas fa-socks', 'fas fa-shoe-prints',
            'fas fa-umbrella-beach', 'fas fa-bath', 'fas fa-shower',
            'fas fa-toilet', 'fas fa-sink', 'fas fa-couch', 'fas fa-chair',
            'fas fa-door-open', 'fas fa-traffic-light', 'fas fa-car-battery', 'fas fa-gas-pump',
            'fas fa-screwdriver', 'fas fa-toolbox', 'fas fa-ruler', 'fas fa-tape',
            'fas fa-paint-roller', 'fas fa-pencil-ruler', 'fas fa-stamp',
            'fas fa-paperclip', 'fas fa-scissors', 'fas fa-calculator',
            'fas fa-chalkboard', 'fas fa-atlas', 'fas fa-map-marked',
            'fas fa-map-marked-alt', 'fas fa-vials',
            'fas fa-prescription', 'fas fa-thermometer', 'fas fa-crutch',
            'fas fa-wheelchair', 'fas fa-procedures', 'fas fa-virus',
            'fas fa-virus-slash', 'fas fa-filter', 'fas fa-funnel-dollar',
            'fas fa-trash-restore', 'fas fa-trash-restore-alt', 'fas fa-broom',
            'fas fa-spray-can', 'fas fa-hand-sparkles', 'fas fa-hand-holding-water',
            'fas fa-hand-holding-medical', 'fas fa-peace',
            'fas fa-pray', 'fas fa-om', 'fas fa-yin-yang', 'fas fa-star-and-crescent',
            'fas fa-cross', 'fas fa-church', 'fas fa-mosque', 'fas fa-synagogue',
            'fas fa-torah', 'fas fa-bible', 'fas fa-quran', 'fas fa-place-of-worship',
            'fas fa-ankh', 'fas fa-hamsa', 'fas fa-kaaba', 'fas fa-jedi',
            'fas fa-journal-whills', 'fas fa-pastafarianism', 'fas fa-pen-fancy',
            'fas fa-feather', 'fas fa-scroll', 'fas fa-chess', 'fas fa-chess-king',
            'fas fa-chess-queen', 'fas fa-chess-pawn', 'fas fa-chess-bishop',
            'fas fa-chess-knight', 'fas fa-chess-rook', 'fas fa-dice-d20',
            'fas fa-dice-d6', 'fas fa-dice-five',
            'fas fa-head-side-virus', 'fas fa-mask', 'fas fa-theater-masks',
            'fas fa-hat-wizard', 'fas fa-dragon', 'fas fa-horse-head',
            'fas fa-kiwi-bird', 'fas fa-otter', 'fas fa-hippo', 'fas fa-crow',
            'fas fa-pepper-hot', 'fas fa-tractor', 'fas fa-truck-pickup', 'fas fa-icicles', 'fas fa-smog', 'fas fa-meteor',
            'fas fa-shuttle-space', 'fas fa-user-astronaut', 'fas fa-cloud-moon-rain',
            'fas fa-cloud-showers-heavy', 'fas fa-cloud-sun-rain',
            'fas fa-temperature-high', 'fas fa-temperature-low',
            'fas fa-spa',
        ];

        const initIconGrid = (filterText = '') => {
            iconGridEl.innerHTML = '';
            const filteredIcons = allEventIcons.filter(iconClass =>
                iconClass.toLowerCase().includes(filterText.toLowerCase())
            );

            filteredIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-item');
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                iconItem.dataset.icon = iconClass;
                iconItem.addEventListener('click', () => {
                    if (iconItem.classList.contains('selected') && eventIconInput.value === iconClass) {
                        iconItem.classList.remove('selected');
                        eventIconInput.value = '';
                        eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                        eventIconDisplay.classList.remove('selected');
                    } else {
                        document.querySelectorAll('.icon-item').forEach(item => item.classList.remove('selected'));
                        iconItem.classList.add('selected');
                        eventIconInput.value = iconClass;
                        eventIconDisplay.innerHTML = `<i class="${iconClass}"></i>`;
                        eventIconDisplay.classList.add('selected'); 
                    }
                });
                iconGridEl.appendChild(iconItem);
            });

            const currentSelectedIcon = eventIconInput.value;
            if (currentSelectedIcon) {
                const iconItemInGrid = document.querySelector(`#iconGrid .icon-item[data-icon="${currentSelectedIcon}"]`);
                if (iconItemInGrid) {
                    iconItemInGrid.classList.add('selected');
                    eventIconDisplay.innerHTML = `<i class="${currentSelectedIcon}"></i>`;
                    eventIconDisplay.classList.add('selected');
                } else {
                    eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                    eventIconDisplay.classList.remove('selected');
                    eventIconInput.value = '';
                }
            } else {
                eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                eventIconDisplay.classList.remove('selected');
                eventIconInput.value = '';
            }
        };

        const applyFont = (fontFamily) => {
            document.body.style.fontFamily = fontFamily;
        };

        const getEffectiveTheme = (baseThemeKey, isDarkMode) => {
            let themeToApply;

            if (baseThemeKey === null) {
                themeToApply = { ...currentBaseTheme };
            } else {
                const themeDef = THEMES[baseThemeKey];
                if (themeDef) {
                    themeToApply = isDarkMode ? { ...themeDef.dark } : { ...themeDef.light };
                } else {
                    themeToApply = isDarkMode ? { ...THEMES.pastelBlue.dark } : { ...THEMES.pastelBlue.light };
                    currentBaseThemeKey = 'pastelBlue';
                }
            }

            themeToApply.primaryButtonBorderColor = themeToApply.primaryButtonText;
            return themeToApply;
        };


        const applyTheme = (effectiveTheme, inputs) => {
            // Update select arrow color based on theme
            const arrowColor = effectiveTheme.secondaryButtonText || '#8B4B66';
            const encodedColor = encodeURIComponent(arrowColor);
            const arrowSvg = `url("data:image/svg+xml;utf8,<svg fill='none' stroke='${encodedColor}' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M6 9l6 6 6-6'/></svg>")`;
            document.documentElement.style.setProperty('--select-arrow', arrowSvg);
            document.body.style.backgroundColor = effectiveTheme.bodyBg;

            document.documentElement.style.setProperty('--text-color', effectiveTheme.mainText);
            document.documentElement.style.setProperty('--header-bg', effectiveTheme.headerBg);
            document.documentElement.style.setProperty('--main-container-bg', effectiveTheme.mainContainerBg);
            document.documentElement.style.setProperty('--day-cell-bg', effectiveTheme.dayCellBg);
            document.documentElement.style.setProperty('--day-cell-hover-bg-color', effectiveTheme.dayCellHoverBg);
            document.documentElement.style.setProperty('--current-day-bg', effectiveTheme.currentDayBg);

            document.documentElement.style.setProperty('--primary-button-bg', effectiveTheme.primaryButtonBg);
            document.documentElement.style.setProperty('--primary-button-text', effectiveTheme.primaryButtonText);
            document.documentElement.style.setProperty('--primary-button-border-color', effectiveTheme.primaryButtonText);

            document.documentElement.style.setProperty('--secondary-button-bg', effectiveTheme.secondaryButtonBg);
            document.documentElement.style.setProperty('--secondary-button-text', effectiveTheme.secondaryButtonText);
            document.documentElement.style.setProperty('--select-arrow-color', arrowColor);
            const secondaryTextRgb = hexToRgb(effectiveTheme.secondaryButtonText);
            if (secondaryTextRgb) {
                document.documentElement.style.setProperty('--secondary-button-text-rgb', `${secondaryTextRgb.r}, ${secondaryTextRgb.g}, ${secondaryTextRgb.b}`);
            }


            document.documentElement.style.setProperty('--accent-color', effectiveTheme.accentColor);
            document.documentElement.style.setProperty('--day-cell-border-color', effectiveTheme.dayCellBorder);

            document.documentElement.style.setProperty('--arrow-button-bg', effectiveTheme.arrowButtonBg);
            document.documentElement.style.setProperty('--arrow-button-hover-bg', effectiveTheme.arrowButtonHoverBg);
            document.documentElement.style.setProperty('--arrow-button-text', effectiveTheme.arrowButtonText);
            document.documentElement.style.setProperty('--header-border-color', effectiveTheme.headerBorderColor);

            if (isDarkModeActive) {
                document.documentElement.style.setProperty('--slider-track-bg', '#666666');
            } else {
                document.documentElement.style.setProperty('--slider-track-bg', '#D1D5DB');
            }

            document.documentElement.style.setProperty('--modal-overlay-bg', `rgba(0, 0, 0, 0.5)`);

            document.documentElement.style.setProperty('--custom-pickers-overlay-bg', `rgba(255, 255, 255, 0.5)`);

            if (inputs && inputs.themeBodyBgInput) {
                const sourceThemeForPickers = effectiveTheme;

                if (sourceThemeForPickers) {
                    inputs.themeBodyBgInput.value = sourceThemeForPickers.bodyBg;
                    inputs.themeTextColorInput.value = sourceThemeForPickers.mainText;
                    inputs.themeHeaderBgInput.value = sourceThemeForPickers.headerBg;
                    inputs.themeMainContainerBgInput.value = sourceThemeForPickers.mainContainerBg;
                    inputs.themeDayCellBgInput.value = sourceThemeForPickers.dayCellBg;
                    inputs.themeDayCellHoverBgInput.value = sourceThemeForPickers.dayCellHoverBg;
                    inputs.themeCurrentDayBgInput.value = sourceThemeForPickers.currentDayBg;
                    inputs.themePrimaryButtonBgInput.value = sourceThemeForPickers.primaryButtonBg;
                    inputs.themePrimaryButtonTextInput.value = sourceThemeForPickers.primaryButtonText;
                    inputs.themeSecondaryButtonBgInput.value = sourceThemeForPickers.secondaryButtonBg;
                    inputs.themeSecondaryButtonTextInput.value = sourceThemeForPickers.secondaryButtonText;
                    inputs.themeAccentColorInput.value = sourceThemeForPickers.accentColor;
                    inputs.themeDayCellBorderColorInput.value = sourceThemeForPickers.dayCellBorder;
                }
            }


            document.documentElement.style.setProperty('--day-cell-drag-bg', effectiveTheme.dayCellHoverBg);

            const accentHex = effectiveTheme.accentColor.replace('#', '');
            const r = parseInt(accentHex.substring(0, 2), 16);
            const g = parseInt(accentHex.substring(2, 4), 16);
            const b = parseInt(accentHex.substring(4, 6), 16);
            document.documentElement.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);

            updateMainContainerLayout();
            renderCalendar();
            renderHolderEvents();
            applyAnimationsState();
            applyScrollbarVisibility();
            applyAddEventButtonVisibility(); 
        };

        const injectCustomFont = (fontName, fontData) => {
            const styleId = 'custom-uploaded-font-style';
            let styleTag = document.getElementById(styleId);
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = styleId;
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = `
                @font-face {
                    font-family: "${fontName}";
                    src: url("${fontData}") format("woff2"),
                         url("${fontData}") format("woff"),
                         url("${fontData}") format("truetype"),
                         url("${fontData}") format("opentype");
                    font-weight: normal;
                    font-style: normal;
                }
            `;
        };

        const handleFontUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const fontData = reader.result;
                const fontName = `CustomUploadedFont-${Date.now()}`;
                injectCustomFont(fontName, fontData);
                applyFont(fontName);
                currentCustomFontName = fontName;
                customFontNameDisplay.textContent = file.name;

                await saveSettings(fontName, fontData, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            };
            reader.readAsDataURL(file);
        };

        const resetCustomFont = async () => {
            const styleTag = document.getElementById('custom-uploaded-font-style');
            if (styleTag) {
                styleTag.remove();
            }
            applyFont(DEFAULT_FONT_FAMILY);
            customFontNameDisplay.textContent = 'Inter (Default)';
            currentCustomFontName = null;

            await saveSettings(null, null, currentBaseThemeKey, isDarkModeActive,
                         uiRoundnessInput.value, fontSizeInput.value,
                         eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
        };

        const initPremadeThemeBoxes = () => {
            premadeThemeBoxesEl.innerHTML = '';
        
            const pureBlackTheme = THEMES.pureBlack.light;
            const pureBlackThemeBox = document.createElement('div');
            pureBlackThemeBox.classList.add('theme-box');

            const pureBlackColorPreview = document.createElement('div');
            pureBlackColorPreview.classList.add('color-preview');
            pureBlackColorPreview.style.backgroundColor = pureBlackTheme.accentColor;
            pureBlackThemeBox.appendChild(pureBlackColorPreview);

            const pureBlackThemeName = document.createElement('span');
            pureBlackThemeName.textContent = 'Pure Black';
            pureBlackThemeBox.appendChild(pureBlackThemeName);

            pureBlackThemeBox.addEventListener('click', async () => {
                document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                pureBlackThemeBox.classList.add('selected');
                darkModeButton.classList.remove('selected');

                currentBaseThemeKey = 'pureBlack';
                currentBaseTheme = null;

                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                initColorPalette();

                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });
            premadeThemeBoxesEl.appendChild(pureBlackThemeBox);

            const pastelThemeKeysOrdered = ['pastelBlue', 'pastelGreen', 'pastelYellow', 'pastelPink', 'pastelPurple'];

            pastelThemeKeysOrdered.forEach(key => {
                const theme = THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box');
                themeBox.dataset.themeKey = key;

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                colorPreview.style.backgroundColor = theme.accentColor;
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name.replace(' (Dark)', '');
                themeBox.appendChild(themeName);

                themeBox.addEventListener('click', async () => {
                    document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                    themeBox.classList.add('selected');
                    darkModeButton.classList.remove('selected');

                    currentBaseThemeKey = key;
                    currentBaseTheme = null;

                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    initColorPalette();

                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                premadeThemeBoxesEl.appendChild(themeBox);
            });
            updateThemeSelectionInSettings();
        };

        const initSpecialThemeBoxes = () => {
            specialThemeBoxesEl.innerHTML = '';
            const specialThemeKeysOrdered = ['dracula', 'nord', 'oneDark', 'serikaDark', 'superuser', 'stealth', 'taro', 'horizon', 'sweden', 'catppuccinLatte', 'github', 'tokyoNight', 'gruvbox', 'solarized', 'aidah'];

            specialThemeKeysOrdered.forEach(key => {
                const theme = THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box', 'special-theme-box');
                themeBox.dataset.themeKey = key;

                unlockedSpecialThemesKeys.add(key);
                themeBox.classList.add('unlocked');

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                colorPreview.style.backgroundColor = theme.accentColor;
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name;
                themeBox.appendChild(themeName);

                themeBox.addEventListener('click', async () => {
                    document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                    themeBox.classList.add('selected');
                    darkModeButton.classList.remove('selected');

                    currentBaseThemeKey = key;
                    currentBaseTheme = null;
                    
                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    initColorPalette();

                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                specialThemeBoxesEl.appendChild(themeBox);
            });
        };

        const updateThemeSelectionInSettings = () => {
            document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
            if (currentBaseThemeKey) {
                const selectedThemeBox = document.querySelector(`.theme-box[data-theme-key="${currentBaseThemeKey}"]`);
                if (selectedThemeBox) {
                    selectedThemeBox.classList.add('selected');
                }
            }
            if (darkModeButton) {
                if (isDarkModeActive) {
                    darkModeButton.classList.add('selected');
                    darkModeButton.innerHTML = `Dark Mode <span class="small-text">(On)</span>`;
                } else {
                    darkModeButton.classList.remove('selected');
                    darkModeButton.innerHTML = `Dark Mode <span class="small-text">(Off)</span>`;
                }
            }
        };


        const renderCalendar = () => {
    if (!calendarEl) {
        calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error('renderCalendar: calendarEl is not defined.');
            return;
        }
    }
    calendarEl.innerHTML = '';
    // We'll collect multi-day events to render after day cells
    const multiDayEventsToRender = [];

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    currentMonthYearEl.textContent = new Date(year, month).toLocaleString('en-US', {
        month: 'long',
        year: 'numeric'
    });

    // Get week start from localStorage (default 0 = Sunday)
    let weekStart = parseInt(localStorage.getItem('weekStartDay') || '0', 10);
    if (isNaN(weekStart) || weekStart < 0 || weekStart > 6) weekStart = 0;

    // Render weekday headers
    const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const orderedWeekDays = weekDays.slice(weekStart).concat(weekDays.slice(0, weekStart));
    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-grid text-center font-bold text-sm uppercase tracking-wide mb-2 mt-4';
    headerRow.style.color = 'var(--text-color)';
    // Weekend coloring settings
    let colorWeekends = localStorage.getItem('settingsColorWeekends') === '1';
    let weekendTintColor = localStorage.getItem('settingsWeekendTintColor') || '#ffe4e1';
    document.documentElement.style.setProperty('--weekend-tint-color', weekendTintColor);
    for (let i = 0; i < 7; i++) {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'p-2';
        dayHeader.textContent = orderedWeekDays[i];
        // Do NOT apply .weekend-tint to weekday headers
        headerRow.appendChild(dayHeader);
    }
    // Remove any existing header row
    const scrollContainer = calendarEl.parentElement;
    const oldHeader = scrollContainer.querySelector('.calendar-grid.text-center.font-bold');
    if (oldHeader) oldHeader.remove();
    scrollContainer.insertBefore(headerRow, calendarEl);

    // Calculate the first day index for the month, adjusted for weekStart
    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const numDaysInMonth = new Date(year, month + 1, 0).getDate();
    let leadingEmpty = (firstDayOfMonth - weekStart + 7) % 7;

    for (let i = 0; i < leadingEmpty; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('day-cell', 'p-2', 'inactive');
        emptyCell.style.borderColor = `var(--day-cell-border-color)`;
        emptyCell.style.color = `var(--text-color)`;
        calendarEl.appendChild(emptyCell);
    }

    for (let day = 1; day <= numDaysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.classList.add('day-cell', 'p-2');
        const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        dayCell.dataset.date = fullDate;

        // Tint Friday/Saturday columns if enabled
        if (colorWeekends) {
            const dateObj = new Date(year, month, day);
            let weekdayIdx = (dateObj.getDay() - weekStart + 7) % 7;
            const weekdayName = orderedWeekDays[weekdayIdx];
            if (weekdayName === 'Fri' || weekdayName === 'Sat') {
                dayCell.classList.add('weekend-tint');
            }
        }

        const dayNumber = document.createElement('div');
        dayNumber.classList.add('text-left', 'font-bold', 'text-lg', 'mb-2');
        dayNumber.textContent = day;
        dayNumber.style.color = `var(--text-color)`;
        dayCell.appendChild(dayNumber);

        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayCell.classList.add('current-day');
        }

        // Only render single-day events in the cell
        const dayEvents = events.filter(event => {
            if (event.startDate && event.endDate) return false; // skip multi-day events here
            if (event.date) {
                return event.date === fullDate;
            }
            return false;
        });

        const eventContainer = document.createElement('div');
        eventContainer.classList.add('event-container');
        // If this cell is the start of a long event, add margin-top to push normal events down
        if (events.some(ev => ev.startDate === fullDate && ev.endDate && ev.startDate !== ev.endDate)) {
            eventContainer.style.marginTop = '2.4em'; // slightly more than long event bar height
        }
        dayCell.appendChild(eventContainer);

        dayEvents.forEach(event => {
            eventContainer.appendChild(createEventItem(event));
        });

        dayCell.addEventListener('click', (e) => {
            // Only open modal if not clicking an event inside the day cell
            if (!e.target.closest('.event-item')) {
                openEventModal(null, fullDate);
            }
        });

        dayCell.addEventListener('dragover', (e) => {
            e.preventDefault();
            dayCell.classList.add('drag-over');
        });

        dayCell.addEventListener('dragleave', () => {
            dayCell.classList.remove('drag-over');
        });

        dayCell.addEventListener('drop', async (e) => {
            e.preventDefault();
            if (e.target.classList.contains('event-item') || e.target.closest('.event-item')) {
                dayCell.classList.remove('drag-over');
                return;
            }

            dayCell.classList.remove('drag-over');

            const droppedEventId = e.dataTransfer.getData('text/plain');
            const newDate = dayCell.dataset.date;

            if (droppedEventId) {
                let eventFound = false;

                let eventIndex = events.findIndex(event => event.id === droppedEventId);
                if (eventIndex !== -1) {
                    // If this is a multi-day event, update startDate and endDate accordingly
                    if (events[eventIndex].startDate && events[eventIndex].endDate) {
                        const span = Math.floor((new Date(events[eventIndex].endDate) - new Date(events[eventIndex].startDate)) / (1000*60*60*24));
                        events[eventIndex].startDate = newDate;
                        const newStart = new Date(newDate);
                        const newEnd = new Date(newStart);
                        newEnd.setDate(newStart.getDate() + span);
                        events[eventIndex].endDate = `${newEnd.getFullYear()}-${String(newEnd.getMonth()+1).padStart(2,'0')}-${String(newEnd.getDate()).padStart(2,'0')}`;
                    } else {
                        events[eventIndex].date = newDate;
                    }
                    eventFound = true;
                } else {
                    eventIndex = holderEvents.findIndex(event => event.id === droppedEventId);
                    if (eventIndex !== -1) {
                        const eventToMove = holderEvents.splice(eventIndex, 1)[0];
                        if (eventToMove.startDate && eventToMove.endDate) {
                            const span = Math.floor((new Date(eventToMove.endDate) - new Date(eventToMove.startDate)) / (1000*60*60*24));
                            eventToMove.startDate = newDate;
                            const newStart = new Date(newDate);
                            const newEnd = new Date(newStart);
                            newEnd.setDate(newStart.getDate() + span);
                            eventToMove.endDate = `${newEnd.getFullYear()}-${String(newEnd.getMonth()+1).padStart(2,'0')}-${String(newEnd.getDate()).padStart(2,'0')}`;
                        } else {
                            eventToMove.date = newDate;
                        }
                        events.push(eventToMove);
                        eventFound = true;
                    }
                }

                if (eventFound) {
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                }
            }
        });

        calendarEl.appendChild(dayCell);
    }

    // Now render multi-day events as direct children of the grid
    // Get all day cells (skip header row)
    const allDayCells = Array.from(calendarEl.children);
    // Render long events as direct children of the grid, absolutely positioned to span across the correct cells
    calendarEl.style.position = 'relative';
    events.forEach(event => {
        if (event.startDate && event.endDate && event.startDate !== event.endDate) {
            // Find the start cell index (0-based)
            const startIdx = allDayCells.findIndex(cell => cell.dataset && cell.dataset.date === event.startDate);
            if (startIdx !== -1) {
                // Find all long events that overlap this event's start day
                const eventStart = new Date(event.startDate);
                const eventEnd = new Date(event.endDate);
                const overlappingLongEvents = events.filter(ev => {
                    if (!(ev.startDate && ev.endDate && ev.startDate !== ev.endDate)) return false;
                    const evStart = new Date(ev.startDate);
                    const evEnd = new Date(ev.endDate);
                    // Overlaps if ev's range includes event.startDate
                    return evStart <= eventStart && evEnd >= eventStart;
                }).sort((a, b) => (a.id > b.id ? 1 : -1));
                const stackIndex = overlappingLongEvents.findIndex(ev => ev.id === event.id);
                const barHeight = 36; // px, adjust if needed (2.2em ~ 35px)
                const barSpacing = 4; // px between bars

                const span = Math.floor((eventEnd - eventStart) / (1000*60*60*24)) + 1;
                const firstCell = allDayCells[startIdx];
                const lastCell = allDayCells[startIdx + span - 1];
                if (firstCell && lastCell) {
                    const calendarRect = calendarEl.getBoundingClientRect();
                    const firstRect = firstCell.getBoundingClientRect();
                    const lastRect = lastCell.getBoundingClientRect();
                    // Calculate the height of the day number element and its margin
                    let dayNumHeight = 0;
                    let dayNumMargin = 0;
                    const dayNum = firstCell.querySelector('.text-left.font-bold.text-lg');
                    if (dayNum) {
                        const dayNumRect = dayNum.getBoundingClientRect();
                        dayNumHeight = dayNumRect.height;
                        // Get computed margin-bottom (usually where normal events start)
                        const style = window.getComputedStyle(dayNum);
                        dayNumMargin = parseFloat(style.marginBottom) || 0;
                    } else {
                        dayNumHeight = 24;
                        dayNumMargin = 2;
                    }
                    // Calculate left/top/width relative to calendarEl
                    const left = firstRect.left - calendarRect.left + calendarEl.scrollLeft - 4;
                    // Stack bars vertically by index
                    const top = firstRect.top - calendarRect.top + calendarEl.scrollTop + dayNumHeight + dayNumMargin + 9 + (stackIndex * (barHeight + barSpacing));
                    const width = (lastRect.right - firstRect.left) + 8;
                    const eventDiv = createEventItem(event);
                    eventDiv.classList.add('long-event');
                    eventDiv.style.position = 'absolute';
                    eventDiv.style.left = left + 'px';
                    eventDiv.style.top = top + 'px';
                    eventDiv.style.width = width + 'px';
                    eventDiv.style.height = '2.2em';
                    eventDiv.style.zIndex = 10;
                    // Add click handler to open edit modal with long event fields
                    eventDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEventModal(event.id, event.startDate, event.endDate);
                    });
                    calendarEl.appendChild(eventDiv);
                }
            }
        }
    });
    applyAnimationsState();
};

        const createEventItem = (event) => {
            const eventItem = document.createElement('div');
            let eventColorData = { primary: '#FFCDD2', text: '#C62828' };

            try {
                const parsedColor = JSON.parse(event.color);
                eventColorData = parsedColor;
            } catch (e) {
            }

            eventItem.style.backgroundColor = eventColorData.primary;
            eventItem.style.color = eventColorData.text;
            eventItem.style.borderColor = eventColorData.text;
            eventItem.style.setProperty('--event-item-text-color', eventColorData.text);
            eventItem.style.setProperty('--event-item-primary-color', eventColorData.primary); // For checkbox checkmark!!

            const borderColor = eventColorData.border || eventColorData.text;
            const borderColorRgba25 = hexToRgba(borderColor, 0.25);
            eventItem.style.setProperty('--event-item-border-color-rgba-25', borderColorRgba25);

            const textColorRgba25 = hexToRgba(eventColorData.text, 0.25);
            eventItem.style.setProperty('--event-item-text-color-rgba-25', textColorRgba25);

            eventItem.classList.add('event-item');
            eventItem.dataset.id = event.id;
            eventItem.title = `${event.title} ${event.time ? '(' + event.time + ')' : ''}${event.description ? ' - ' + event.description : ''}`;
            eventItem.setAttribute('draggable', 'true');

            if (event.completed) {
                eventItem.classList.add('completed');
            }
            

            if (event.effects) {
                if (event.effects.glowing) eventItem.classList.add('glowing');
                if (event.effects.striped1) eventItem.classList.add('striped2-effect');
                if (event.effects.striped2) eventItem.classList.add('striped-effect');
                if (event.effects.thinStripes) eventItem.classList.add('thin-stripes-effect');
                if (event.effects.dotted) eventItem.classList.add('dotted-effect');
                if (event.effects.crosshatched) eventItem.classList.add('crosshatched-effect');
                if (event.effects.checkerboard) eventItem.classList.add('checkerboard-effect');
                if (event.effects.argyle) eventItem.classList.add('argyle-effect');
                if (event.effects.zigzag) eventItem.classList.add('zigzag-lines-effect');
                if (event.effects.wavyLines) eventItem.classList.add('wavy-lines-effect');
                if (event.effects.embossed) eventItem.classList.add('embossed-effect');
                if (event.effects.win95Button) eventItem.classList.add('win95-button-effect');

                if (event.effects.moveEffectHorizontally) eventItem.classList.add('move-effect-horizontal');
                if (event.effects.moveEffectVertically) eventItem.classList.add('move-effect-vertical');

                if (event.effects.particles) eventItem.classList.add('particles');
                if (event.effects.snowFalling) eventItem.classList.add('snow-falling');
                if (event.effects.glisteningStars) eventItem.classList.add('glistening-stars');
                if (event.effects.gradientEffect) eventItem.classList.add('gradient-effect');
                if (event.effects.animatedStripes) eventItem.classList.add('animated-stripes');
            
                if (event.effects.animatedVerticalRainbow) {
                    eventItem.classList.add('animated-vertical-rainbow');
                    const [h, s, l] = hexToHsl(eventColorData.text);
                    const gradientColors = [];
                    for (let i = 0; i < 7; i++) {
                        const hue = (h + (i * (360 / 6))) % 360;
                        gradientColors.push(hslToHex(hue, s, l));
                    }
                    eventItem.style.backgroundImage = `linear-gradient(to bottom, ${gradientColors.join(', ')})`;
                }
            }
            



            const mainContentDiv = document.createElement('div');
            mainContentDiv.classList.add('main-content');
            // Always clear content first!
            mainContentDiv.innerHTML = '';

            // Add checkbox if enabled!!!
            if (event.effects && event.effects.showCheckbox) {
                const checkboxWrapper = document.createElement('span');
                checkboxWrapper.classList.add('custom-checkbox-wrapper');

                const checkbox = document.createElement('span');
                checkbox.classList.add('custom-checkbox');
                if (event.completed) {
                    checkbox.classList.add('checked');
                    // Apply dashed border if customization toggle is on!!!!
                    if (document.body.classList.contains('custom-dashed-checkbox')) {
                        checkbox.classList.add('dashed-border');
                    }
                }

                // Set custom thingies for color
                if (eventColorData && eventColorData.text && eventColorData.primary) {
                    checkbox.style.setProperty('--event-item-text-color', eventColorData.text);
                    checkbox.style.setProperty('--event-item-primary-color', eventColorData.primary);
                    // Use a lighter version of the text color for background
                    if (typeof hexToRgba === 'function') {
                        checkbox.style.setProperty('--event-item-text-color-rgba-25', hexToRgba(eventColorData.text, 0.15));
                    } else {
                        checkbox.style.setProperty('--event-item-text-color-rgba-25', eventColorData.text);
                    }
                }

                // Checkmark SVG with dynamic stroke color
                const checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                checkmark.setAttribute('viewBox', '0 0 16 16');
                checkmark.setAttribute('width', '16');
                checkmark.setAttribute('height', '16');
                checkmark.classList.add('checkmark-svg');
                checkmark.innerHTML = '<polyline id="checkbox-tick" points="4,9 7,12 12,5" stroke="var(--event-item-text-color)" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>'; // TICK MARK COLOUR TICKOLOR!!!
                checkbox.appendChild(checkmark);

                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    event.completed = !event.completed;
                    checkbox.classList.toggle('checked', event.completed);
                    eventItem.classList.toggle('completed', event.completed);
                    
                    // Apply/remove dashed border
                    checkbox.classList.toggle('dashed-border', event.completed && document.body.classList.contains('custom-dashed-checkbox'));
                    
                    // Apply/remove strikethrough
                    mainContentDiv.classList.toggle('strikethrough-text', event.completed && document.body.classList.contains('custom-strikethrough-text'));

                    await saveEvents();
                });
                mainContentDiv.insertBefore(checkboxWrapper, mainContentDiv.firstChild);
            }


            const textContentSpan = document.createElement('span');
            textContentSpan.classList.add('text-content');

            const timeTitleWrapper = document.createElement('span');
            timeTitleWrapper.classList.add('time-title-wrapper');

            if (event.time) {
                const timePart = document.createElement('span');
                timePart.classList.add('font-semibold', 'time-part');
                const [hours, minutes] = event.time.split(':');
                const dateForFormatting = new Date();
                dateForFormatting.setHours(parseInt(hours), parseInt(minutes));
                timePart.textContent = dateForFormatting.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: !use24HourFormat });
                timeTitleWrapper.appendChild(timePart);
            }
            const titlePart = document.createElement('span');
            titlePart.classList.add('title-part');
            titlePart.textContent = event.title;
            timeTitleWrapper.appendChild(titlePart);

            if (event.textStyling) {
        // Remove all previous text styling classes first
        titlePart.classList.remove('text-center', 'text-right', 'w-full', 'block', 'italic', 'font-serif', 'font-mono');

        // Center or right align title
        if (event.textStyling.center) {
            titlePart.classList.add('text-center', 'w-full', 'block');
        } else if (event.textStyling.right) {
            titlePart.classList.add('text-right', 'w-full', 'block');
        }

        // Italic
        if (event.textStyling.italic) {
            titlePart.classList.add('italic');
        }
        // Serif
        if (event.textStyling.serif) {
            titlePart.classList.add('font-serif');
        }
        // Monospace
        if (event.textStyling.mono) {
            titlePart.classList.add('font-mono');
        }
    }

            textContentSpan.appendChild(timeTitleWrapper);
            mainContentDiv.appendChild(textContentSpan);

            // Apply strikethrough and bold
            if (event.completed && document.body.classList.contains('custom-strikethrough-text')) {
                mainContentDiv.classList.add('strikethrough-text');
            } else {
                mainContentDiv.classList.remove('strikethrough-text');
            }
            if (document.body.classList.contains('custom-bold-event-title')) {
                mainContentDiv.classList.add('bold-title');
            } else {
                mainContentDiv.classList.remove('bold-title');
            }


            // Add icon (if any)
            if (event.icon) {
                const iconContainer = document.createElement('span');
                iconContainer.classList.add('event-icon-container');
                iconContainer.innerHTML = `<i class="${event.icon}"></i> `;
                mainContentDiv.appendChild(iconContainer);
            }
            // Add text content
            mainContentDiv.appendChild(textContentSpan);
            eventItem.appendChild(mainContentDiv);


            if (event.description) {
                const eventDescriptionEl = document.createElement('div');
                eventDescriptionEl.classList.add('event-description');
                eventDescriptionEl.style.color = adjustColor(eventColorData.text, 0.15);
                eventDescriptionEl.textContent = event.description;

                // Remove all previous text styling classes first
                eventDescriptionEl.classList.remove('italic', 'font-serif', 'font-mono', 'text-center', 'text-right', 'w-full', 'block');
                if (event.textStyling) {
                    if (event.textStyling.italic) eventDescriptionEl.classList.add('italic');
                    if (event.textStyling.serif) eventDescriptionEl.classList.add('font-serif');
                    if (event.textStyling.mono) eventDescriptionEl.classList.add('font-mono');
                    if (event.textStyling.descriptionCenter) {
                    eventDescriptionEl.classList.add('text-center', 'w-full', 'block');
                    } else if (event.textStyling.descriptionRight) {
                    eventDescriptionEl.classList.add('text-right', 'w-full', 'block');
                    }
                }
                eventItem.appendChild(eventDescriptionEl);
                }

            eventItem.addEventListener('click', (e) => {
                // Only open modal if not clicking the checkbox...
                if (!e.target.closest('.custom-checkbox-wrapper')) { 
                    e.stopPropagation();
                    openEventModal(event.id);
                }
            });

            eventItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                contextMenuEventId = event.id;
                eventContextMenu.style.left = `${e.clientX}px`;
                eventContextMenu.style.top = `${e.clientY}px`;
                eventContextMenu.style.display = 'flex';
            });

            eventItem.addEventListener('dragstart', (e) => {
                draggedEventId = event.id;
                e.dataTransfer.setData('text/plain', event.id);
                setTimeout(() => {
                    eventItem.classList.add('dragging');
                }, 0);
            });

            eventItem.addEventListener('dragend', () => {
                draggedEventId = null;
                eventItem.classList.remove('dragging');
                document.querySelectorAll('.event-item').forEach(item => item.classList.remove('drop-target-top', 'drop-target-bottom'));
                document.querySelectorAll('.day-cell').forEach(cell => cell.classList.remove('drag-over'));
                holderContentEl.classList.remove('drag-over');
            });

            eventItem.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const rect = eventItem.getBoundingClientRect();
                const y = e.clientY - rect.top;
                if (y < rect.height / 2) {
                    eventItem.classList.add('drop-target-top');
                    eventItem.classList.remove('drop-target-bottom');
                } else {
                    eventItem.classList.add('drop-target-bottom');
                    eventItem.classList.remove('drop-target-top');
                }
            });

            eventItem.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                eventItem.classList.remove('drop-target-top', 'drop-target-bottom');
            });

            eventItem.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                eventItem.classList.remove('drop-target-top', 'drop-target-bottom');

                const droppedEventId = e.dataTransfer.getData('text/plain');
                if (!droppedEventId || droppedEventId === event.id) return;

                const draggedEventIndex = events.findIndex(ev => ev.id === droppedEventId);
                const targetEventIndex = events.findIndex(ev => ev.id === event.id);

                if (draggedEventIndex === -1 && holderEvents.findIndex(ev => ev.id === droppedEventId) === -1) return;
                if (targetEventIndex === -1 && holderEvents.findIndex(ev => ev.id === event.id) === -1) return;

                let draggedEvent;
                let draggedFromHolder = false;

                if (events.findIndex(ev => ev.id === droppedEventId) !== -1) {
                    draggedEvent = events.splice(events.findIndex(ev => ev.id === droppedEventId), 1)[0];
                } else {
                    draggedEvent = holderEvents.splice(holderEvents.findIndex(ev => ev.id === droppedEventId), 1)[0];
                    draggedFromHolder = true;
                }

                if (draggedEvent.date !== event.date) {
                    draggedEvent.date = event.date;
                    events.push(draggedEvent);
                } else {
                    const rect = eventItem.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const currentEventsInDay = events.filter(ev => ev.date === event.date);
                    const targetIndexInDay = currentEventsInDay.findIndex(ev => ev.id === event.id);

                    let newPositionIndex = events.indexOf(currentEventsInDay[targetIndexInDay]);
                    if (y > rect.height / 2) {
                        newPositionIndex++;
                    }

                    events.splice(newPositionIndex, 0, draggedEvent);
                }
                saveEvents();
                renderCalendar();
                renderHolderEvents();
            });
            return eventItem;
        };

        const renderHolderEvents = () => {
            holderContentEl.innerHTML = '';
            holderEvents.forEach(event => {
                const eventItem = document.createElement('div');
                let eventColorData = { primary: '#FFCDD2', text: '#C62828' };
                try {
                    const parsedColor = JSON.parse(event.color);
                    eventColorData = parsedColor;
                } catch (e) {
                }

                eventItem.style.backgroundColor = eventColorData.primary;
                eventItem.style.color = eventColorData.text;
                eventItem.style.borderColor = eventColorData.text;
                eventItem.style.setProperty('--event-item-text-color', eventColorData.text);
                eventItem.style.setProperty('--event-item-primary-color', eventColorData.primary); // For checkbox checkmark

                const textColorRgba25 = hexToRgba(eventColorData.text, 0.25);
                eventItem.style.setProperty('--event-item-text-color-rgba-25', textColorRgba25);

                eventItem.classList.add('event-item');
                eventItem.dataset.id = event.id;
                eventItem.title = `${event.title}${event.time ? ' (' + event.time + ')' : ''}${event.description ? ' - ' + event.description : ''}`;
                eventItem.setAttribute('draggable', 'true');

                if (event.completed) {
                    eventItem.classList.add('completed');
                }

                if (event.effects) {
                        if (event.effects.glowing) eventItem.classList.add('glowing');
                        if (event.effects.striped1) eventItem.classList.add('striped2-effect');
                        if (event.effects.striped2) eventItem.classList.add('striped-effect');
                        if (event.effects.thinStripes) eventItem.classList.add('thin-stripes-effect');
                        if (event.effects.dotted) eventItem.classList.add('dotted-effect');
                        if (event.effects.crosshatched) eventItem.classList.add('crosshatched-effect');
                        if (event.effects.checkerboard) eventItem.classList.add('checkerboard-effect');
                        if (event.effects.argyle) eventItem.classList.add('argyle-effect');
                        if (event.effects.zigzag) eventItem.classList.add('zigzag-lines-effect');
                        if (event.effects.wavyLines) eventItem.classList.add('wavy-lines-effect');
                        if (event.effects.embossed) eventItem.classList.add('embossed-effect');
                        if (event.effects.win95Button) eventItem.classList.add('win95-button-effect');

                        if (event.effects.moveEffectHorizontally) eventItem.classList.add('move-effect-horizontal');
                        if (event.effects.moveEffectVertically) eventItem.classList.add('move-effect-vertical');

                        if (event.effects.particles) eventItem.classList.add('particles');
                        if (event.effects.snowFalling) eventItem.classList.add('snow-falling');
                        if (event.effects.glisteningStars) eventItem.classList.add('glistening-stars');
                        if (event.effects.gradientEffect) eventItem.classList.add('gradient-effect');
                        if (event.effects.animatedStripes) eventItem.classList.add('animated-stripes');

                        if (event.effects.animatedVerticalRainbow) {
                            eventItem.classList.add('animated-vertical-rainbow');
                            const [h, s, l] = hexToHsl(eventColorData.text);
                            const gradientColors = [];
                            for (let i = 0; i < 7; i++) {
                                const hue = (h + (i * (360 / 6))) % 360;
                                gradientColors.push(hslToHex(hue, s, l));
                            }
                            eventItem.style.backgroundImage = `linear-gradient(to bottom, ${gradientColors.join(', ')})`;
                        }
                    }

                const mainContentDiv = document.createElement('div');
                mainContentDiv.classList.add('main-content');

                // Add checkbox if enabled
                if (event.effects && event.effects.showCheckbox) {
                    const checkboxWrapper = document.createElement('span');
                    checkboxWrapper.classList.add('custom-checkbox-wrapper');

                    const checkbox = document.createElement('span');
                    checkbox.classList.add('custom-checkbox');
                    if (event.completed) {
                        checkbox.classList.add('checked');
                        // Apply dashed border if customization toggle is on
                        if (document.body.classList.contains('custom-dashed-checkbox')) {
                            checkbox.classList.add('dashed-border');
                        }
                    }

                    // Set custom properties for color
                    if (eventColorData && eventColorData.text && eventColorData.primary) {
                        checkbox.style.setProperty('--event-item-text-color', eventColorData.text);
                        checkbox.style.setProperty('--event-item-primary-color', eventColorData.primary);
                        // Use a lighter version of the text color for background
                        if (typeof hexToRgba === 'function') {
                            checkbox.style.setProperty('--event-item-text-color-rgba-25', hexToRgba(eventColorData.text, 0.15));
                        } else {
                            checkbox.style.setProperty('--event-item-text-color-rgba-25', eventColorData.text);
                        }
                    }

                    // Checkmark SVG with dynamic stroke color
                    const checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    checkmark.setAttribute('viewBox', '0 0 16 16');
                    checkmark.setAttribute('width', '16');
                    checkmark.setAttribute('height', '16');
                    checkmark.classList.add('checkmark-svg');
                    checkmark.innerHTML = '<polyline id="checkbox-tick" points="4,9 7,12 12,5" stroke="var(--event-item-text-color)" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
                    checkbox.appendChild(checkmark);

                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        event.completed = !event.completed;
                        checkbox.classList.toggle('checked', event.completed);
                        eventItem.classList.toggle('completed', event.completed); // Toggle main item class

                        // Apply/remove dashed border based on customization toggle
                        checkbox.classList.toggle('dashed-border', event.completed && document.body.classList.contains('custom-dashed-checkbox'));
                        
                        // Apply/remove strikethrough based on customization toggle
                        mainContentDiv.classList.toggle('strikethrough-text', event.completed && document.body.classList.contains('custom-strikethrough-text'));

                        await saveEvents();
                    });
                    mainContentDiv.insertBefore(checkboxWrapper, mainContentDiv.firstChild);
                }

                const textContentSpan = document.createElement('span');
                textContentSpan.classList.add('text-content');

                const timeTitleWrapper = document.createElement('span');
                timeTitleWrapper.classList.add('time-title-wrapper');

                if (event.time) {
                    const timePart = document.createElement('span');
                    timePart.classList.add('font-semibold', 'time-part');
                    const [hours, minutes] = event.time.split(':');
                    const dateForFormatting = new Date();
                    dateForFormatting.setHours(parseInt(hours), parseInt(minutes));
                    timePart.textContent = dateForFormatting.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: !use24HourFormat });
                    timeTitleWrapper.appendChild(timePart);
                }
                const titlePart = document.createElement('span');
                titlePart.classList.add('title-part');
                titlePart.textContent = event.title;
                timeTitleWrapper.appendChild(titlePart);

                if (event.textStyling) {
                // Center or right align title
                if (event.textStyling.center) {
                    titlePart.classList.add('text-center', 'w-full', 'block');
                } else if (event.textStyling.right) {
                    titlePart.classList.add('text-right', 'w-full', 'block');
                }

                // Italic
                if (event.textStyling.italic) {
                    titlePart.classList.add('italic');
                    if (eventDescriptionEl) eventDescriptionEl.classList.add('italic');
                }
                // Serif
                if (event.textStyling.serif) {
                    titlePart.classList.add('font-serif');
                    if (eventDescriptionEl) eventDescriptionEl.classList.add('font-serif');
                }
                // Monospace
                if (event.textStyling.mono) {
                    titlePart.classList.add('font-mono');
                    if (eventDescriptionEl) eventDescriptionEl.classList.add('font-mono');
                }
            }

                textContentSpan.appendChild(timeTitleWrapper);
                mainContentDiv.appendChild(textContentSpan);

                // Apply strikethrough and bold based on customization toggles
                if (event.completed && document.body.classList.contains('custom-strikethrough-text')) {
                    mainContentDiv.classList.add('strikethrough-text');
                } else {
                    mainContentDiv.classList.remove('strikethrough-text');
                }
                if (document.body.classList.contains('custom-bold-event-title')) {
                    mainContentDiv.classList.add('bold-title');
                } else {
                    mainContentDiv.classList.remove('bold-title');
                }


                // Remove any previous icon/text-content from mainContentDiv
                mainContentDiv.innerHTML = '';
                // Add icon and text content in correct order for all placements
                const iconPlacement = document.body.getAttribute('data-icon-placement') || 'right';
                let iconContainer = null;
                if (event.icon) {
                    iconContainer = document.createElement('span');
                    iconContainer.classList.add('event-icon-container');
                    iconContainer.innerHTML = `<i class="${event.icon}"></i> `;
                }
                if (iconPlacement === 'left') {
                    if (iconContainer) mainContentDiv.appendChild(iconContainer);
                    mainContentDiv.appendChild(textContentSpan);
                } else if (iconPlacement === 'top') {
                    if (iconContainer) mainContentDiv.appendChild(iconContainer);
                    mainContentDiv.appendChild(textContentSpan);
                } else if (iconPlacement === 'top-left') {
                    // Icon above, left-aligned, title below
                    const iconRow = document.createElement('div');
                    iconRow.classList.add('icon-top-left-iconrow');
                    if (iconContainer) iconRow.appendChild(iconContainer);
                    mainContentDiv.appendChild(iconRow);
                    const textRow = document.createElement('div');
                    textRow.classList.add('icon-top-left-textrow');
                    textRow.appendChild(textContentSpan);
                    mainContentDiv.appendChild(textRow);
                } else {
                    // Default: right
                    mainContentDiv.appendChild(textContentSpan);
                    if (iconContainer) mainContentDiv.appendChild(iconContainer);
                }
                eventItem.appendChild(mainContentDiv);

                if (event.description) {
                    const eventDescriptionEl = document.createElement('div');
                    eventDescriptionEl.classList.add('event-description');
                    eventDescriptionEl.style.color = adjustColor(eventColorData.text, 0.15);
                    eventDescriptionEl.textContent = event.description;
                    eventItem.appendChild(eventDescriptionEl);
                }

                eventItem.addEventListener('click', (e) => {
                    // Only open modal if not clicking the checkbox
                    if (!e.target.closest('.custom-checkbox-wrapper')) { // Changed from .event-checkbox to .custom-checkbox-wrapper
                        e.stopPropagation();
                        openEventModal(event.id);
                    }
                });

                eventItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    contextMenuEventId = event.id;
                    eventContextMenu.style.left = `${e.clientX}px`;
                    eventContextMenu.style.top = `${e.clientY}px`;
                    eventContextMenu.style.display = 'flex';
                });

                eventItem.addEventListener('dragstart', (e) => {
                    draggedEventId = event.id;
                    e.dataTransfer.setData('text/plain', event.id);
                    setTimeout(() => {
                        eventItem.classList.add('dragging');
                    }, 0);
                });

                eventItem.addEventListener('dragend', () => {
                    draggedEventId = null;
                    eventItem.classList.remove('dragging');
                    document.querySelectorAll('.event-item').forEach(item => item.classList.remove('drop-target-top', 'drop-target-bottom'));
                    document.querySelectorAll('.day-cell').forEach(cell => cell.classList.remove('drag-over'));
                    holderContentEl.classList.remove('drag-over');
                });

                eventItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const rect = eventItem.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    if (y < rect.height / 2) {
                        eventItem.classList.add('drop-target-top');
                        eventItem.classList.remove('drop-target-bottom');
                    } else {
                        eventItem.classList.add('drop-target-bottom');
                        eventItem.classList.remove('drop-target-top');
                    }
                });

                eventItem.addEventListener('dragleave', (e) => {
                    e.stopPropagation();
                    eventItem.classList.remove('drop-target-top', 'drop-target-bottom');
                });

                eventItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    eventItem.classList.remove('drop-target-top', 'drop-target-bottom');

                    const droppedEventId = e.dataTransfer.getData('text/plain');
                    if (!droppedEventId || droppedEventId === event.id) return;

                    const draggedEventIndex = holderEvents.findIndex(ev => ev.id === droppedEventId);
                    const targetEventIndex = holderEvents.findIndex(ev => ev.id === event.id);

                    if (draggedEventIndex === -1 && events.findIndex(ev => ev.id === droppedEventId) === -1) return;
                    if (targetEventIndex === -1 && events.findIndex(ev => ev.id === event.id) === -1) return;

                    let draggedEvent;
                    let draggedFromCalendar = false;

                    if (holderEvents.findIndex(ev => ev.id === droppedEventId) !== -1) {
                        draggedEvent = holderEvents.splice(holderEvents.findIndex(ev => ev.id === droppedEventId), 1)[0];
                    } else {
                        draggedEvent = events.splice(events.findIndex(ev => ev.id === droppedEventId), 1)[0];
                        draggedFromCalendar = true;
                    }

                    if (draggedEvent.date !== 'holder') {
                        draggedEvent.date = 'holder';
                        holderEvents.push(draggedEvent);
                    } else {
                        const rect = eventItem.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        const currentEventsInHolder = holderEvents;
                        const targetIndexInHolder = currentEventsInHolder.findIndex(ev => ev.id === event.id);

                        let newPositionIndex = holderEvents.indexOf(currentEventsInHolder[targetIndexInHolder]);
                        if (y > rect.height / 2) {
                            newPositionIndex++;
                        }
                        holderEvents.splice(newPositionIndex, 0, draggedEvent);
                    }
                    saveEvents();
                    renderHolderEvents();
                    renderCalendar();
                });
                holderContentEl.appendChild(eventItem);
            });
            applyAnimationsState();
            applyAddEventButtonVisibility();
        };

    const openEventModal = (eventId = null, date = null, endDate = null) => {
// --- Multi-day selection logic (global, after calendar is rendered) ---
let isSelecting = false;
let selectionStartCell = null;
let selectionEndCell = null;
let selectedCells = [];

function clearCellSelection() {
    selectedCells.forEach(cell => {
        cell.classList.remove('selected-range');
        // Restore user-select on date number
        const dateNum = cell.querySelector('.text-left.font-bold.text-lg');
        if (dateNum) dateNum.style.userSelect = '';
    });
    selectedCells = [];
}

document.addEventListener('mousedown', (e) => {
    const dayCell = e.target.closest('.day-cell');
    if (!dayCell || e.button !== 0 || e.target.closest('.event-item')) return;
    isSelecting = true;
    document.body.classList.add('noselect-drag');
    selectionStartCell = dayCell;
    selectionEndCell = dayCell;
    clearCellSelection();
    dayCell.classList.add('selected-range');
    // Prevent text selection on date number
    const dateNum = dayCell.querySelector('.text-left.font-bold.text-lg');
    if (dateNum) dateNum.style.userSelect = 'none';
    selectedCells = [dayCell];
    document.body.style.userSelect = 'none';
});

document.addEventListener('mouseover', (e) => {
    if (!isSelecting) return;
    const dayCell = e.target.closest('.day-cell');
    if (!dayCell) return;
    selectionEndCell = dayCell;
    clearCellSelection();
    const allCells = Array.from(document.querySelectorAll('.day-cell'));
    const startIdx = allCells.indexOf(selectionStartCell);
    const endIdx = allCells.indexOf(selectionEndCell);
    if (startIdx !== -1 && endIdx !== -1) {
        const [min, max] = [Math.min(startIdx, endIdx), Math.max(startIdx, endIdx)];
        selectedCells = allCells.slice(min, max + 1);
        selectedCells.forEach(cell => {
            cell.classList.add('selected-range');
            // Prevent text selection on date number
            const dateNum = cell.querySelector('.text-left.font-bold.text-lg');
            if (dateNum) dateNum.style.userSelect = 'none';
        });
    }
});

document.addEventListener('mouseup', (e) => {
    if (!isSelecting) return;
    isSelecting = false;
    document.body.style.userSelect = '';
    document.body.classList.remove('noselect-drag');
    if (selectedCells.length > 1) {
        const startDate = selectedCells[0].dataset.date;
        const endDate = selectedCells[selectedCells.length - 1].dataset.date;
        openEventModal(null, startDate, endDate);
    } else if (selectedCells.length === 1) {
        openEventModal(null, selectedCells[0].dataset.date);
    }
    setTimeout(() => {
        clearCellSelection();
    }, 200);
});

document.addEventListener('selectstart', (e) => {
    if (isSelecting && e.target.closest('.day-cell')) e.preventDefault();
});
            // If modal is opened from holder sidebar, force date = 'holder'
            if (window._creatingHolderEvent) {
                date = 'holder';
                window._creatingHolderEvent = false;
            }
            eventModal.classList.remove('hidden');
            editingEventId = eventId;

            eventTitleInput.value = '';
            eventTimeInput.value = '';
            eventDescriptionInput.value = '';
            eventDateInput.value = '';
            eventColorInput.value = '';
            eventIconInput.value = '';
            iconSearchInput.value = '';
            effectShowCheckbox.checked = false;
            // Long event fields
            if (document.getElementById('longEventStartDate')) document.getElementById('longEventStartDate').value = '';
            if (document.getElementById('longEventEndDate')) document.getElementById('longEventEndDate').value = '';
            if (document.getElementById('longEventStartTime')) document.getElementById('longEventStartTime').value = '';
            if (document.getElementById('longEventEndTime')) document.getElementById('longEventEndTime').value = '';
            // Show/hide long event fields
            const singleFields = document.getElementById('singleEventFields');
            const longFields = document.getElementById('longEventFields');
            if (endDate && endDate !== date) {
                singleFields.style.display = 'none';
                longFields.style.display = '';
                document.getElementById('longEventStartDate').value = date;
                document.getElementById('longEventEndDate').value = endDate;
            } else if (eventId && events && events.find(ev => ev.id === eventId && ev.startDate && ev.endDate && ev.startDate !== ev.endDate)) {
                // Always show long event fields for multi-day events
                singleFields.style.display = 'none';
                longFields.style.display = '';
                const ev = events.find(ev => ev.id === eventId);
                if (ev) {
                    document.getElementById('longEventStartDate').value = ev.startDate;
                    document.getElementById('longEventEndDate').value = ev.endDate;
                }
            } else if (eventId && holderEvents && holderEvents.find(ev => ev.id === eventId && ev.startDate && ev.endDate && ev.startDate !== ev.endDate)) {
                // Also check holderEvents for long events
                singleFields.style.display = 'none';
                longFields.style.display = '';
                const ev = holderEvents.find(ev => ev.id === eventId);
                if (ev) {
                    document.getElementById('longEventStartDate').value = ev.startDate;
                    document.getElementById('longEventEndDate').value = ev.endDate;
                }
            } else {
                singleFields.style.display = '';
                longFields.style.display = 'none';
                if (date) document.getElementById('eventDate').value = date;
            }
        // Always focus and select the event title input when modal opens
        setTimeout(function() {
            if (eventTitleInput) {
                eventTitleInput.focus();
                eventTitleInput.select();
            }
        }, 50);
        // Show duplicate button only in edit mode
        const duplicateBtn = document.getElementById('duplicateEventBtn');
        if (duplicateBtn) {
            if (eventId) {
                duplicateBtn.style.display = '';
            } else {
                duplicateBtn.style.display = 'none';
            }
        }
            let eventToEdit = null;
            if (eventId) {
                eventToEdit = events.find(e => e.id === eventId) || holderEvents.find(e => e.id === eventId);
            }

                // Add scroll-to-icon-grid handler every time modal opens
                const eventIconDisplay = document.getElementById('eventIconDisplay');
                if (eventIconDisplay) {
                    eventIconDisplay.onclick = function() {
                        const scrollable = document.querySelector('#event-modal .modal-content-scrollable');
                        const iconGrid = document.getElementById('iconGrid');
                        if (scrollable && iconGrid) {
                            const scrollableRect = scrollable.getBoundingClientRect();
                            const iconGridRect = iconGrid.getBoundingClientRect();
                            const offset = iconGridRect.top - scrollableRect.top + scrollable.scrollTop;
                            scrollable.scrollTo({ top: offset, behavior: 'smooth' });
                        }
                    };
                }
            // Show/hide modal footers and delete button based on mode
            const addEventFooter = document.getElementById('add-event-footer');
            const editEventFooter = document.getElementById('edit-event-footer');
            if (eventToEdit) {
                modalTitle.textContent = 'Edit Event';
                saveEventButton.textContent = 'Update Event';
                if (editEventFooter) editEventFooter.style.display = '';
                if (addEventFooter) addEventFooter.style.display = 'none';
                deleteEventButton.classList.remove('hidden');

                eventTitleInput.value = eventToEdit.title;
                eventTimeInput.value = eventToEdit.time || '';
                eventDescriptionInput.value = eventToEdit.description || '';

                if (eventToEdit.date === 'holder') {
                    eventDateInput.value = 'holder';
                    eventDateInput.disabled = true;
                } else {
                    eventDateInput.value = eventToEdit.date;
                    eventDateInput.disabled = false;
                }

                if (eventToEdit) {
                const styling = eventToEdit.textStyling || {};
                document.getElementById('eventToggleTitleCenter').checked = !!styling.center;
                document.getElementById('eventToggleTitleRight').checked = !!styling.right;
                document.getElementById('eventToggleDescriptionCenter').checked = !!styling.descriptionCenter;
                document.getElementById('eventToggleDescriptionRight').checked = !!styling.descriptionRight;
                document.getElementById('eventToggleItalicized').checked = !!styling.italic;
                document.getElementById('eventToggleSerifFont').checked = !!styling.serif;
                document.getElementById('eventToggleMonospaceFont').checked = !!styling.mono;
                } else {
                    // Reset all text styling toggles to false when adding a new event
                    document.getElementById('eventToggleTitleCenter').checked = false;
                    document.getElementById('eventToggleDescriptionCenter').checked = false;
                    document.getElementById('eventToggleTitleRight').checked = false;
                    document.getElementById('eventToggleDescriptionRight').checked = false;
                    document.getElementById('eventToggleItalicized').checked = false;
                    document.getElementById('eventToggleSerifFont').checked = false;
                    document.getElementById('eventToggleMonospaceFont').checked = false;
                }

                let selectedColorPrimary;
                let selectedColorText;
                try {
                    const eventColor = JSON.parse(eventToEdit.color);
                    selectedColorPrimary = eventColor.primary;
                    selectedColorText = eventColor.text;
                } catch (e) {}
                const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${selectedColorPrimary}"][data-text-color="${selectedColorText}"]`);
                if (colorBox) {
                    colorBox.classList.add('selected');
                    eventColorInput.value = eventToEdit.color;
                } else {
                    initColorPalette();
                    const defaultColor = eventColors.find(c => c.isLight) || eventColors[0];
                    const defaultPrimary = defaultColor.primary;
                    const defaultText = defaultColor.text;
                    eventColorInput.value = JSON.stringify({ primary: defaultPrimary, text: defaultText });
                    const defaultColorBox = document.querySelector(`#colorPalette .color-box[data-primary="${defaultPrimary}"][data-text-color="${defaultText}"]`);
                    if(defaultColorBox) defaultColorBox.classList.add('selected');
                }

                if (eventToEdit.icon) {
                    eventIconDisplay.innerHTML = `<i class="${eventToEdit.icon}"></i>`;
                    eventIconDisplay.classList.add('selected');
                    eventIconInput.value = eventToEdit.icon;
                } else {
                    eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                    eventIconDisplay.classList.remove('selected');
                    eventIconInput.value = '';
                }
                initIconGrid();
                // Attach duplicate event handler
                if (duplicateBtn) {
                    duplicateBtn.onclick = function() {
                        // Duplicate the event
                        if (!eventToEdit) return;
                        const newEvent = JSON.parse(JSON.stringify(eventToEdit));
                        newEvent.id = generateUniqueId();
                        newEvent.title = eventToEdit.title + ' (Copy)';
                        // Optionally, set date to today or keep same date
                        events.push(newEvent);
                        saveEvents();
                        renderCalendar();
                        closeEventModal();
                        // Optionally, show a toast/notification
                    };
                }
                

                if (eventToEdit.effects) {
                    effectShowCheckbox.checked = eventToEdit.effects.showCheckbox || false;
                    effectGlowing.checked = eventToEdit.effects.glowing || false;
                    effectStriped1.checked = eventToEdit.effects.striped1 || false;
                    effectStriped2.checked = eventToEdit.effects.striped2 || false;
                    effectThinStripes.checked = eventToEdit.effects.thinStripes || false;
                    effectDotted.checked = eventToEdit.effects.dotted || false;
                    effectCrosshatched.checked = eventToEdit.effects.crosshatched || false;
                    effectCheckerboard.checked = eventToEdit.effects.checkerboard || false;
                    effectArgyle.checked = eventToEdit.effects.argyle || false;
                    effectZigzag.checked = eventToEdit.effects.zigzag || false;
                    effectWavyLines.checked = eventToEdit.effects.wavyLines || false;
                    effectEmbossed.checked = eventToEdit.effects.embossed || false;
                    effectWin95Button.checked = eventToEdit.effects.win95Button || false;

                    effectMoveHorizontally.checked = eventToEdit.effects.moveEffectHorizontally || false;
                    effectMoveVertically.checked = eventToEdit.effects.moveEffectVertically || false;

                    effectParticles.checked = eventToEdit.effects.particles || false;
                    effectSnowFalling.checked = eventToEdit.effects.snowFalling || false;
                    effectGlisteningStars.checked = eventToEdit.effects.glisteningStars || false;
                    effectGradient.checked = eventToEdit.effects.gradientEffect || false;
                    effectAnimatedStripes.checked = eventToEdit.effects.animatedStripes || false;
                    effectAnimatedVerticalRainbow.checked = eventToEdit.effects.animatedVerticalRainbow || false;
                }
            } else {
                modalTitle.textContent = 'Add New Event';
                saveEventButton.textContent = 'Save Event';
                if (editEventFooter) editEventFooter.style.display = 'none';
                if (addEventFooter) addEventFooter.style.display = '';
                deleteEventButton.classList.add('hidden');
                if (date === 'holder') {
                    eventDateInput.value = 'holder';
                    eventDateInput.disabled = true;
                } else {
                    eventDateInput.value = date;
                    eventDateInput.disabled = false;
                }
                initColorPalette();
                initIconGrid();
            }
                        effectStriped2.checked = eventToEdit.effects.striped2 || false;
                        effectThinStripes.checked = eventToEdit.effects.thinStripes || false;
                        effectDotted.checked = eventToEdit.effects.dotted || false;
                        effectCrosshatched.checked = eventToEdit.effects.crosshatched || false;
                        effectCheckerboard.checked = eventToEdit.effects.checkerboard || false;
                        effectArgyle.checked = eventToEdit.effects.argyle || false;
                        effectZigzag.checked = eventToEdit.effects.zigzag || false;
                        effectWavyLines.checked = eventToEdit.effects.wavyLines || false;
                        effectEmbossed.checked = eventToEdit.effects.embossed || false;
                        effectWin95Button.checked = eventToEdit.effects.win95Button || false;

                        effectMoveHorizontally.checked = eventToEdit.effects.moveEffectHorizontally || false;
                        effectMoveVertically.checked = eventToEdit.effects.moveEffectVertically || false;

                        effectParticles.checked = eventToEdit.effects.particles || false;
                        effectSnowFalling.checked = eventToEdit.effects.snowFalling || false;
                        effectGlisteningStars.checked = eventToEdit.effects.glisteningStars || false;
                        effectGradient.checked = eventToEdit.effects.gradientEffect || false;
                        effectAnimatedStripes.checked = eventToEdit.effects.animatedStripes || false;
                        effectAnimatedVerticalRainbow.checked = eventToEdit.effects.animatedVerticalRainbow || false;

        }
        
        window.openEventModal = openEventModal;

        

        const closeEventModal = () => {
            eventModal.classList.add('hidden');
            editingEventId = null;
        };

        const generateUniqueId = () => {
            return '_' + Math.random().toString(36).substr(2, 9);
        };

        const handleSaveEvent = async () => {
            const title = eventTitleInput.value.trim();
            const time = eventTimeInput.value.trim();
            const description = eventDescriptionInput.value.trim();
            let date = eventDateInput.value;
            // Always force date to 'holder' if creating from holder button or if date is 'holder'
            if (window._creatingHolderEvent || date === 'holder' || !date) {
                date = 'holder';
            }
            const color = eventColorInput.value;
            const icon = eventIconInput.value;

            const textStyling = {
            center: document.getElementById('eventToggleTitleCenter').checked,
            right: document.getElementById('eventToggleTitleRight').checked,
            descriptionCenter: document.getElementById('eventToggleDescriptionCenter').checked,
            descriptionRight: document.getElementById('eventToggleDescriptionRight').checked,
            italic: document.getElementById('eventToggleItalicized').checked,
            serif: document.getElementById('eventToggleSerifFont').checked,
            mono: document.getElementById('eventToggleMonospaceFont').checked
            };

        const effects = {
            showCheckbox: effectShowCheckbox.checked,
            glowing: effectGlowing.checked,
            striped1: effectStriped1.checked,
            striped2: effectStriped2.checked,
            thinStripes: effectThinStripes.checked,
            dotted: effectDotted.checked,
            crosshatched: effectCrosshatched.checked,
            checkerboard: effectCheckerboard.checked,
            argyle: effectArgyle.checked,
            zigzag: effectZigzag.checked,
            wavyLines: effectWavyLines.checked,
            embossed: effectEmbossed.checked,
            win95Button: effectWin95Button.checked,
            moveEffectHorizontally: effectMoveHorizontally.checked,
            moveEffectVertically: effectMoveVertically.checked,
            particles: effectParticles.checked,
            snowFalling: effectSnowFalling.checked,
            glisteningStars: effectGlisteningStars.checked,
            gradientEffect: effectGradient.checked,
            animatedStripes: effectAnimatedStripes.checked,
            animatedVerticalRainbow: effectAnimatedVerticalRainbow.checked
        };

            // --- Ensure correct event placement ---
            if (!editingEventId) {
                if (!title) {
                    // Show error modal or feedback for empty title
                    return;
                }
                // Multi-day event support
                let startDate = null, endDate = null;
                const longEventFields = document.getElementById('longEventFields');
                const longEventStartDateInput = document.getElementById('longEventStartDate');
                const longEventEndDateInput = document.getElementById('longEventEndDate');
                if (
                    longEventFields &&
                    longEventFields.style.display !== 'none' &&
                    longEventStartDateInput && longEventEndDateInput &&
                    longEventStartDateInput.value && longEventEndDateInput.value
                ) {
                    startDate = longEventStartDateInput.value;
                    endDate = longEventEndDateInput.value;
                }
                let newEvent;
                if (startDate && endDate && startDate !== endDate) {
                    newEvent = {
                        id: generateUniqueId(),
                        title,
                        time,
                        description,
                        startDate,
                        endDate,
                        color,
                        icon,
                        textStyling,
                        effects,
                        completed: false
                    };
                } else {
                    newEvent = {
                        id: generateUniqueId(),
                        title,
                        time,
                        description,
                        date,
                        color,
                        icon,
                        textStyling,
                        effects,
                        completed: false
                    };
                }
                if (date === 'holder') {
                    holderEvents.push(newEvent);
                    await saveEvents();
                    renderHolderEvents();
                } else {
                    events.push(newEvent);
                    await saveEvents();
                    renderCalendar();
                }
                closeEventModal();
                window._creatingHolderEvent = false;
                // Always re-initialize modal logic after adding event
                if (!eventModal) {
                    eventModal = document.getElementById('event-modal');
                }
                return;
            }

if (editingEventId) {
    // Defensive: Don't allow update if user tries to blank out long event fields
    const longEventFields = document.getElementById('longEventFields');
    const longEventStartDateInput = document.getElementById('longEventStartDate');
    const longEventEndDateInput = document.getElementById('longEventEndDate');
    if (
        longEventFields &&
        longEventFields.style.display !== 'none' &&
        (!longEventStartDateInput.value || !longEventEndDateInput.value)
    ) {
        // Show error and do not proceed
        const messageBox = document.createElement('div');
        messageBox.innerHTML = `
            <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                    <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Please enter both a start and end date for multi-day events.</p>
                    <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            </div>
        `;
        document.body.appendChild(messageBox);
        return;
    }
    let eventIndex = events.findIndex(e => e.id === editingEventId);
    if (eventIndex !== -1) {
        if (date === 'holder' && !(longEventStartDateInput && longEventEndDateInput && longEventStartDateInput.value && longEventEndDateInput.value)) {
            // Move from events to holderEvents ONLY if not a valid long event
            const eventToMove = events.splice(eventIndex, 1)[0];
            eventToMove.title = title;
            eventToMove.time = time;
            eventToMove.date = date;
            eventToMove.description = description;
            eventToMove.color = color;
            eventToMove.icon = icon;
            eventToMove.effects = effects;
            eventToMove.textStyling = textStyling;
            eventToMove.completed = eventToMove.completed || false;
            // Remove long event fields if moving to holder
            delete eventToMove.startDate;
            delete eventToMove.endDate;
            holderEvents.push(eventToMove);
        } else {
            // Update event in events array
            const eventObj = events[eventIndex];
            eventObj.title = title;
            eventObj.time = time;
            eventObj.description = description;
            eventObj.color = color;
            eventObj.icon = icon;
            eventObj.effects = effects;
            eventObj.textStyling = textStyling;

            if (
                longEventFields &&
                longEventFields.style.display !== 'none' &&
                longEventStartDateInput && longEventEndDateInput &&
                longEventStartDateInput.value && longEventEndDateInput.value
            ) {
                // Update as long event (multi-day)
                eventObj.startDate = longEventStartDateInput.value;
                eventObj.endDate = longEventEndDateInput.value;
                delete eventObj.date;
            } else if (
                eventObj.startDate && eventObj.endDate &&
                eventObj.startDate !== eventObj.endDate
            ) {
                // Already a long event, and user didn't change the long event fields: PRESERVE startDate/endDate
                // Do nothing, keep as is
            } else if (
                eventObj.startDate && eventObj.endDate && eventObj.startDate === eventObj.endDate
            ) {
                // Edge case: start and end date are the same, treat as single-day
                eventObj.date = eventObj.startDate;
                delete eventObj.startDate;
                delete eventObj.endDate;
            } else if (
                longEventFields &&
                longEventFields.style.display !== 'none' &&
                (!longEventStartDateInput.value || !longEventEndDateInput.value) &&
                eventObj.startDate && eventObj.endDate && eventObj.startDate !== eventObj.endDate
            ) {
                // User left long event fields blank, but event is already a long event: PRESERVE startDate/endDate
                // Do nothing, keep as is
            } else {
                // Single-day event
                eventObj.date = date;
                delete eventObj.startDate;
                delete eventObj.endDate;
            }
        }
    } else {
        eventIndex = holderEvents.findIndex(e => e.id === editingEventId);
        if (eventIndex !== -1) {
            if (date === 'holder') {
                // Update event in holderEvents
                const eventObj = holderEvents[eventIndex];
                eventObj.title = title;
                eventObj.time = time;
                eventObj.date = date;
                eventObj.description = description;
                eventObj.color = color;
                eventObj.icon = icon;
                eventObj.effects = effects;
                eventObj.textStyling = textStyling;
            } else {
                // Move from holderEvents to events
                const eventToMove = holderEvents.splice(eventIndex, 1)[0];
                eventToMove.title = title;
                eventToMove.time = time;
                eventToMove.date = date;
                eventToMove.description = description;
                eventToMove.color = color;
                eventToMove.icon = icon;
                eventToMove.effects = effects;
                eventToMove.textStyling = textStyling;
                eventToMove.completed = eventToMove.completed || false;
                events.push(eventToMove);
            }
        }
    }
    await saveEvents();
    // DEBUG: log event state before re-render to trace long-event loss
    try {
        console.debug('handleSaveEvent: editingEventId=', editingEventId);
        if (editingEventId) {
            const eInEvents = events.find(e => String(e.id) === String(editingEventId));
            const eInHolder = holderEvents.find(e => String(e.id) === String(editingEventId));
            console.debug('event in events:', JSON.parse(JSON.stringify(eInEvents || null)));
            console.debug('event in holderEvents:', JSON.parse(JSON.stringify(eInHolder || null)));
        }
        const longStart = document.getElementById('longEventStartDate')?.value;
        const longEnd = document.getElementById('longEventEndDate')?.value;
        console.debug('longEventFields values:', { longStart, longEnd });
    } catch (logErr) {
        console.debug('handleSaveEvent: logging failed', logErr);
    }
    renderCalendar();
    renderHolderEvents();
    closeEventModal();
}

            if (eventDateInput.disabled && editingEventId) {
                const existingEvent = holderEvents.find(e => e.id === editingEventId);
                if (existingEvent && existingEvent.date === 'holder') {
                    date = 'holder';
                }
            } else if (eventDateInput.disabled && !editingEventId) {
                date = 'holder';
            }


            if (!title || (!date && !eventDateInput.disabled)) { 
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Please enter event title and date.</p>
                            <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
                return;
            }
            await saveEvents();
            // Only re-render the relevant section
            if (date === 'holder') {
                renderHolderEvents();
            } else {
                renderCalendar();
                renderHolderEvents();
            }
            closeEventModal();
        };

        const handleDeleteEvent = () => {
            if (contextMenuEventId) {
                editingEventId = contextMenuEventId;
            }
            if (editingEventId) {
                const confirmBox = document.createElement('div');
                confirmBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to delete this event?</p>
                            <div class="flex justify-center space-x-4">
                                <button class="themed-button" id="confirmDeleteYes">Yes</button>
                                <button class="themed-button secondary" id="confirmDeleteNo">No</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirmDeleteYes').onclick = async () => {
                    let deleted = false;
                    const initialEventsLength = events.length;
                    events = events.filter(e => e.id !== editingEventId);
                    if (events.length < initialEventsLength) {
                        deleted = true;
                    } else {
                        const initialHolderLength = holderEvents.length;
                        holderEvents = holderEvents.filter(e => e.id !== editingEventId);
                        if (holderEvents.length < initialHolderLength) {
                            deleted = true;
                        }
                    }

                    if (deleted) {
                        await saveEvents();
                        renderCalendar();
                        renderHolderEvents();
                        closeEventModal();
                    }
                    confirmBox.remove();
                    contextMenuEventId = null;
                };
                document.getElementById('confirmDeleteNo').onclick = () => {
                    confirmBox.remove();
                    contextMenuEventId = null;
                };
            }
        };

        const handleDuplicateEvent = async () => {
            if (contextMenuEventId) {
                let eventToDuplicate = events.find(e => e.id === contextMenuEventId) || holderEvents.find(e => e.id === contextMenuEventId);
                if (eventToDuplicate) {
                    const newEvent = { ...eventToDuplicate, id: generateUniqueId(), completed: false };
                    if (newEvent.date === 'holder') {
                        holderEvents.push(newEvent);
                    } else {
                        events.push(newEvent);
                    }
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                }
                contextMenuEventId = null;
            }
        };

        //  open settings modal!
        const openSettingsModal = () => {
            settingsModal.classList.remove('hidden');
            // Initialization stuff
            uiRoundnessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness').replace('px', '');
            uiRoundnessValueDisplay.textContent = `${uiRoundnessInput.value}px`;
            fontSizeInput.value = getComputedStyle(document.documentElement).getPropertyValue('--base-font-size').replace('px', '');
            fontSizeValueDisplay.textContent = `${fontSizeInput.value}px`;
            eventRoundnessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--event-item-roundness').replace('px', '');
            eventRoundnessValueDisplay.textContent = `${eventRoundnessInput.value}px`;
            eventBorderThicknessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--event-item-border-thickness').replace('px', '');
            eventBorderThicknessValueDisplay.textContent = `${eventBorderThicknessInput.value}px`;
            dayCellMinWidthInput.value = getComputedStyle(document.documentElement).getPropertyValue('--day-cell-min-width').replace('px', '');
            dayCellMinWidthValueDisplay.textContent = `${dayCellMinWidthInput.value}px`;

            holderIconToggle.checked = holderIconEnabled;
            noBackgroundToggle.checked = noBackgroundMode;
            disableSidebarAnimationsToggle.checked = disableSidebarAnimations;
            hideScrollbarsToggle.checked = hideScrollbars;
            foldDayCellsToggle.checked = foldDayCellsEnabled;
            showHolderByDefaultToggle.checked = showHolderByDefault;
            use24HourFormatToggle.checked = use24HourFormat;
            hideAddEventButtonInHolderToggle.checked = hideAddEventButtonInHolder; 

            // Initialize customization toggles from body classes
            customizationCheckboxDashedBorderToggle.checked = document.body.classList.contains('custom-dashed-checkbox');
            customizationStrikethroughTextToggle.checked = document.body.classList.contains('custom-strikethrough-text');
            customizationBoldTitleToggle.checked = document.body.classList.contains('custom-bold-event-title');

            updateThemeSelectionInSettings();
            renderSavedThemes();
            
            // MAKE color picker have values of current theme
            const rootStyles = getComputedStyle(document.documentElement);
            themeBodyBgInput.value = rootStyles.getPropertyValue('--body-bg');
            themeTextColorInput.value = rootStyles.getPropertyValue('--text-color');
            themeHeaderBgInput.value = rootStyles.getPropertyValue('--header-bg');
            themeMainContainerBgInput.value = rootStyles.getPropertyValue('--main-container-bg');
            themeDayCellBgInput.value = rootStyles.getPropertyValue('--day-cell-bg');
            themeDayCellHoverBgInput.value = rootStyles.getPropertyValue('--day-cell-hover-bg-color');
            themeCurrentDayBgInput.value = rootStyles.getPropertyValue('--current-day-bg');
            themePrimaryButtonBgInput.value = rootStyles.getPropertyValue('--primary-button-bg');
            themePrimaryButtonTextInput.value = rootStyles.getPropertyValue('--primary-button-text');
            themeSecondaryButtonBgInput.value = rootStyles.getPropertyValue('--secondary-button-bg');
            themeSecondaryButtonTextInput.value = rootStyles.getPropertyValue('--secondary-button-text');
            themeAccentColorInput.value = rootStyles.getPropertyValue('--accent-color');
            themeDayCellBorderColorInput.value = rootStyles.getPropertyValue('--day-cell-border-color');
        };

        // close settings modal
        const closeSettingsModal = () => {
            settingsModal.classList.add('hidden');
        };

        const getCustomThemeColorsFromInputs = () => {
            return {
                name: "Custom",
                bodyBg: themeBodyBgInput.value,
                mainText: themeTextColorInput.value,
                headerBg: themeHeaderBgInput.value,
                mainContainerBg: themeMainContainerBgInput.value,
                dayCellBg: themeDayCellBgInput.value,
                dayCellHoverBg: themeDayCellHoverBgInput.value,
                currentDayBg: themeCurrentDayBgInput.value,
                primaryButtonBg: themePrimaryButtonBgInput.value,
                primaryButtonText: themePrimaryButtonTextInput.value,
                secondaryButtonBg: themeSecondaryButtonBgInput.value,
                secondaryButtonText: themeSecondaryButtonTextInput.value,
                accentColor: themeAccentColorInput.value,
                dayCellBorder: themeDayCellBorderColorInput.value
            };
        };

        const handleSaveCustomTheme = () => {
            openThemeNameModal();
        };

        const openThemeNameModal = () => {
            themeNameModal.classList.remove('hidden');
            themeNameInput.value = '';
        };

        const closeThemeNameModal = () => {
            themeNameModal.classList.add('hidden');
        };

        const handleSaveThemeName = async () => {
            const themeName = themeNameInput.value.trim();
            if (!themeName) {
                // Show error message
                return;
            }

            const customTheme = getCustomThemeColorsFromInputs();
            customTheme.name = themeName;

            // Ensure we don't exceed max saved themes
            if (savedCustomThemes.length >= MAX_SAVED_THEMES) {
                savedCustomThemes.shift();
            }
            
            // Check if theme with same name exists
            const existingIndex = savedCustomThemes.findIndex(t => t.name === themeName);
            if (existingIndex >= 0) {
                savedCustomThemes[existingIndex] = customTheme;
            } else {
                savedCustomThemes.push(customTheme);
            }

            await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                        uiRoundnessInput.value, fontSizeInput.value,
                        eventRoundnessInput.value, eventBorderThicknessInput.value, 
                        dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, 
                        holderIconEnabled, noBackgroundMode, savedCustomThemes, 
                        disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, 
                        showHolderByDefault, use24HourFormat, holderSidebarWidth, 
                        hideAddEventButtonInHolder);
                        
            renderSavedThemes();
            closeThemeNameModal();
        };

        const renderSavedThemes = () => {
            savedThemePreviewsEl.innerHTML = '';
            if (savedCustomThemes.length === 0) {
                savedThemePreviewsEl.textContent = 'No custom themes saved yet.';
                savedThemePreviewsEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                savedThemePreviewsEl.style.fontSize = '0.9em';
                savedThemePreviewsEl.style.textAlign = 'center';
                return;
            }

            savedCustomThemes.forEach((theme, index) => {
                const themePreview = document.createElement('div');
                themePreview.classList.add('last-saved-theme-preview');

                const colorSwatches = document.createElement('div');
                colorSwatches.classList.add('color-swatches');

                const mainSwatch = document.createElement('div');
                mainSwatch.classList.add('color-swatch-main');
                mainSwatch.style.backgroundColor = theme.mainContainerBg;
                colorSwatches.appendChild(mainSwatch);

                const headerSwatch = document.createElement('div');
                headerSwatch.classList.add('color-swatch-header');
                headerSwatch.style.backgroundColor = theme.headerBg;
                colorSwatches.appendChild(headerSwatch);

                themePreview.appendChild(colorSwatches);

                const themeName = document.createElement('div');
                themeName.classList.add('theme-name');
                themeName.textContent = theme.name;
                themePreview.appendChild(themeName);

                const applyButton = document.createElement('button');
                applyButton.classList.add('apply-button');
                applyButton.textContent = 'Apply';
                applyButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    currentBaseThemeKey = null;
                    currentBaseTheme = theme;
                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    updateThemeSelectionInSettings();
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, theme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                themePreview.appendChild(applyButton);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('themed-button', 'danger', 'mt-2', 'w-full', 'py-1', 'text-xs');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    deleteCustomTheme(index);
                });
                themePreview.appendChild(deleteButton);

                savedThemePreviewsEl.appendChild(themePreview);
            });
        };

        const deleteCustomTheme = async (index) => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to delete this custom theme?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmDeleteThemeYes">Yes</button>
                            <button class="themed-button secondary" id="confirmDeleteThemeNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmDeleteThemeYes').onclick = async () => {
                savedCustomThemes.splice(index, 1);
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                renderSavedThemes();
                confirmBox.remove();
            };
            document.getElementById('confirmDeleteThemeNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleRemoveAllEvents = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove all events?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmRemoveAllEventsYes">Yes</button>
                            <button class="themed-button secondary" id="confirmRemoveAllEventsNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveAllEventsYes').onclick = async () => {
                events = [];
                holderEvents = [];
                await saveEvents();
                renderCalendar();
                renderHolderEvents();
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveAllEventsNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleRemoveAllCustomThemes = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove all custom themes?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmRemoveAllThemesYes">Yes</button>
                            <button class="themed-button secondary" id="confirmRemoveAllThemesNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveAllThemesYes').onclick = async () => {
                savedCustomThemes = [];
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                renderSavedThemes();
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveAllThemesNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleResetApplication = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to reset the entire application?</p>
                        <p class="text-sm text-gray-500 mb-4">(This will delete all events, custom themes, and reset all settings)</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button danger" id="confirmResetAppYes">Yes, Reset All</button>
                            <button class="themed-button secondary" id="confirmResetAppNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmResetAppYes').onclick = async () => {
                await Preferences.clear();
                location.reload();
            };
            document.getElementById('confirmResetAppNo').onclick = () => {
                confirmBox.remove();
            };
        };


        const handleSaveSettings = async () => {
            const uiRoundness = uiRoundnessInput.value;
            const fontSize = fontSizeInput.value;
            const eventRoundness = eventRoundnessInput.value;
            const eventBorderThickness = eventBorderThicknessInput.value;
            const dayCellMinWidth = dayCellMinWidthInput.value;
            const newHolderIconEnabled = holderIconToggle.checked;
            const newNoBackgroundMode = noBackgroundToggle.checked;
            const newDisableSidebarAnimations = disableSidebarAnimationsToggle.checked;
            const newHideScrollbars = hideScrollbarsToggle.checked;
            const newFoldDayCellsEnabled = foldDayCellsToggle.checked;
            const newShowHolderByDefault = showHolderByDefaultToggle.checked;
            const newUse24HourFormat = use24HourFormatToggle.checked;
            const newHideAddEventButtonInHolder = hideAddEventButtonInHolderToggle.checked;

            let customThemeColorsToSave = null;
            if (currentBaseThemeKey === null) {
                customThemeColorsToSave = getCustomThemeColorsFromInputs();
                currentBaseTheme = customThemeColorsToSave;
            } else {
                currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
            }

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });

            document.documentElement.style.setProperty('--ui-roundness', `${uiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${uiRoundness * 1.5}px`);
            
            const mainContainerRadius = noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${uiRoundness * 1.5}px`;
            document.querySelector('#main-container').style.borderRadius = mainContainerRadius;
            document.querySelector('#event-modal .modal-content').style.borderRadius = `${uiRoundness * 1.5}px`;
            document.querySelector('#settings-modal .modal-content').style.borderRadius = `var(--ui-roundness)`;

            document.documentElement.style.setProperty('--base-font-size', `${fontSize}px`);
            document.documentElement.style.setProperty('--event-item-roundness', `${eventRoundness}px`);
            document.documentElement.style.setProperty('--event-item-border-thickness', `${eventBorderThickness}px`);
            document.documentElement.style.setProperty('--day-cell-min-width', `${dayCellMinWidth}px`);

            const fontToSave = currentCustomFontName || null;
            let fontDataToSave = null;
            if (fontToSave) {
                const storedSettingsValue = (await Preferences.get({ key: 'calendarSettings' })).value;
                if (storedSettingsValue) {
                    fontDataToSave = JSON.parse(storedSettingsValue).customFontData;
                }
            }

            disableSidebarAnimations = newDisableSidebarAnimations;
            applyAnimationsState();

            hideScrollbars = newHideScrollbars;
            applyScrollbarVisibility();

            foldDayCellsEnabled = newFoldDayCellsEnabled;
            showHolderByDefault = newShowHolderByDefault;
            use24HourFormat = newUse24HourFormat;
            hideAddEventButtonInHolder = newHideAddEventButtonInHolder; 
            applyAddEventButtonVisibility(); 

            await saveSettings(fontToSave, fontDataToSave, currentBaseThemeKey, isDarkModeActive, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColorsToSave, unlockedSpecialThemesKeys, newHolderIconEnabled, newNoBackgroundMode, savedCustomThemes, newDisableSidebarAnimations, newHideScrollbars, newFoldDayCellsEnabled, newShowHolderByDefault, newUse24HourFormat, holderSidebarWidth, newHideAddEventButtonInHolder);
            holderIconEnabled = newHolderIconEnabled;
            noBackgroundMode = newNoBackgroundMode;
            updateHamburgerIconVisibility();
            updateMainContainerLayout();
            if (showHolderByDefault && !holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            } else if (!showHolderByDefault && holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            }
            closeSettingsModal();
        };

        const updateHamburgerIconVisibility = () => {
            if (holderIconEnabled) {
                hamburgerIcon.classList.remove('hidden');
            } else {
                hamburgerIcon.classList.add('hidden');
                holderSidebar.style.left = `-${parseInt(getComputedStyle(holderSidebar).width)}px`;
                holderSidebar.classList.remove('active');
            }
            updateMainContainerLayout();
        };

        const toggleHolderSidebar = () => {
            const sidebar = document.getElementById('holder-sidebar');
            if (disableSidebarAnimations) {
                sidebar.style.transition = 'none';
            } else {
                sidebar.style.transition = 'left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out';
            }

            if (sidebar.classList.contains('active')) {
                sidebar.style.left = `-${parseInt(getComputedStyle(sidebar).width)}px`;
                sidebar.classList.remove('active');
            } else {
                sidebar.style.left = '0px';
                sidebar.classList.add('active');
            }
            updateMainContainerLayout();
        };

        const updateMainContainerLayout = () => {
            const sidebarWidth = parseInt(getComputedStyle(holderSidebar).width);
            const mainContainer = document.getElementById('main-container');

            if (disableSidebarAnimations) {
                mainContainer.style.transition = 'none';
            } else {
                mainContainer.style.transition = 'all 0.2s ease-out';
            }

            if (window.innerWidth <= 768) {
                document.documentElement.style.setProperty('--main-container-margin', '0');
                document.documentElement.style.setProperty('--main-container-width', '100vw');
                document.documentElement.style.setProperty('--main-container-height', '100vh');
                document.documentElement.style.setProperty('--main-container-border-radius-actual', '0px');
                return;
            }

            if (holderSidebar.classList.contains('active')) {
                document.documentElement.style.setProperty('--main-container-width', `calc(100vw - ${noBackgroundMode ? '0px' : '2rem'} - ${sidebarWidth}px)`);
                document.documentElement.style.setProperty('--main-container-margin', `${noBackgroundMode ? '0' : '1rem'} ${noBackgroundMode ? '0' : '1rem'} ${noBackgroundMode ? '0' : '1rem'} calc(${noBackgroundMode ? '0px' : '1rem'} + ${sidebarWidth}px)`);
                if (noBackgroundMode) {
                    mainContainer.style.borderRadius = '0px';
                }
            } else {
                document.documentElement.style.setProperty('--main-container-width', `calc(100vw - ${noBackgroundMode ? '0px' : '2rem'})`);
                document.documentElement.style.setProperty('--main-container-margin', `${noBackgroundMode ? '0' : '1rem'} auto`);
                document.documentElement.style.setProperty('--main-container-border-radius-actual', noBackgroundMode ? '0px' : 'var(--ui-roundness-lg)');
                mainContainer.style.borderRadius = noBackgroundMode ? '0px' : getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness-lg');
            }
            document.documentElement.style.setProperty('--main-container-height', noBackgroundMode ? '100vh' : 'calc(100vh - 2rem)');
        };

        const applyAnimationsState = () => {
            const sidebar = document.getElementById('holder-sidebar');
            const mainContainer = document.getElementById('main-container');

            if (disableSidebarAnimations) {
                sidebar.style.transition = 'none';
                mainContainer.style.transition = 'none';
            } else {
                sidebar.style.transition = 'left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out';
                mainContainer.style.transition = 'all 0.2s ease-out';
            }
        };

        const applyScrollbarVisibility = () => {
            const scrollContainers = document.querySelectorAll('.calendar-scroll-container, .modal-content-scrollable, .icon-grid, #holder-content');
            if (hideScrollbars) {
                scrollContainers.forEach(container => container.classList.add('hide-scrollbars'));
                document.querySelectorAll('.day-cell.folded').forEach(cell => cell.classList.add('hide-scrollbars'));
            } else {
                scrollContainers.forEach(container => container.classList.remove('hide-scrollbars'));
                document.querySelectorAll('.day-cell.folded').forEach(cell => cell.classList.remove('hide-scrollbars'));
            }
        };

        const applyAddEventButtonVisibility = () => {
            if (addHolderEventButton) {
                if (hideAddEventButtonInHolder) {
                    addHolderEventButton.classList.add('hidden');
                } else {
                    addHolderEventButton.classList.remove('hidden');
                }
            }
        };

        const setupHolderResizing = () => {
            holderResizeHandle.addEventListener('mousedown', (e) => {
                isResizingHolder = true;
                initialMouseX = e.clientX;
                initialHolderWidth = holderSidebar.offsetWidth;
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none'; 
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizingHolder) return;

                let newWidth = initialHolderWidth + (e.clientX - initialMouseX);
                newWidth = Math.max(MIN_HOLDER_WIDTH, Math.min(MAX_HOLDER_WIDTH, newWidth));

                holderSidebar.style.width = `${newWidth}px`;
                document.documentElement.style.setProperty('--holder-sidebar-width', `${newWidth}px`);
                holderSidebarWidth = newWidth;
                updateMainContainerLayout();
            });

            document.addEventListener('mouseup', async () => {
                if (isResizingHolder) {
                    isResizingHolder = false;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                }
            });
        };


        window.onload = async () => {
            // Scroll to icon grid when eventIconDisplay is clicked
            if (eventIconDisplay) {
                eventIconDisplay.addEventListener('click', () => {
                    const scrollable = document.querySelector('#event-modal .modal-content-scrollable');
                    const iconGrid = document.getElementById('iconGrid');
                    if (scrollable && iconGrid) {
                        // Scroll so iconGrid is visible at the bottom
                        const scrollableRect = scrollable.getBoundingClientRect();
                        const iconGridRect = iconGrid.getBoundingClientRect();
                        // Calculate offset relative to scrollable
                        const offset = iconGridRect.top - scrollableRect.top + scrollable.scrollTop;
                        scrollable.scrollTo({ top: offset, behavior: 'smooth' });
                    }
                });
            }
            calendarEl = document.getElementById('calendar');
            currentMonthYearEl = document.getElementById('currentMonthYear');
            prevMonthButton = document.getElementById('prevMonth');
            nextMonthButton = document.getElementById('nextMonth');
            todayButton = document.getElementById('todayButton');
            settingsButton = document.getElementById('settingsButton');

            eventModal = document.getElementById('event-modal');
            modalTitle = document.getElementById('modal-title');
            eventTitleInput = document.getElementById('eventTitle');
            eventTimeInput = document.getElementById('eventTime');
            eventDateInput = document.getElementById('eventDate');
            eventDescriptionInput = document.getElementById('eventDescription');
            eventColorInput = document.getElementById('eventColor');
            iconGridEl = document.getElementById('iconGrid');
            eventIconInput = document.getElementById('eventIcon');
            colorPaletteEl = document.getElementById('colorPalette');
            saveEventButton = document.getElementById('saveEvent');
            deleteEventButton = document.getElementById('deleteEvent');
            cancelEventButton = document.getElementById('cancelEvent');
            iconSearchInput = document.getElementById('iconSearchInput');
            eventIconDisplay = document.getElementById('eventIconDisplay');
            
            effectShowCheckbox = document.getElementById('effectShowCheckbox');
            effectGlowing = document.getElementById('effectGlowing');
            effectStriped1 = document.getElementById('effectStriped1');
            effectStriped2 = document.getElementById('effectStriped2');
            effectThinStripes = document.getElementById('effectThinStripes');
            effectDotted = document.getElementById('effectDotted');
            effectCrosshatched = document.getElementById('effectCrosshatched');
            effectCheckerboard = document.getElementById('effectCheckerboard');
            effectArgyle = document.getElementById('effectArgyle');
            effectZigzag = document.getElementById('effectZigzag');
            effectWavyLines = document.getElementById('effectWavyLines');
            effectEmbossed = document.getElementById('effectEmbossed');

            effectMoveHorizontally = document.getElementById('effectMoveHorizontally');
            effectMoveVertically = document.getElementById('effectMoveVertically');

            effectParticles = document.getElementById('effectParticles');
            effectSnowFalling = document.getElementById('effectSnowFalling');
            effectGlisteningStars = document.getElementById('effectGlisteningStars');
            effectAnimatedStripes = document.getElementById('effectAnimatedStripes');
            effectGradient = document.getElementById('effectGradient');
            effectAnimatedVerticalRainbow = document.getElementById('effectAnimatedVerticalRainbow');



            settingsModal = document.getElementById('settings-modal');
            customFontUploadInput = document.getElementById('customFontUpload');
            customFontNameDisplay = document.getElementById('customFontNameDisplay');
            resetCustomFontButton = document.getElementById('resetCustomFont');
            premadeThemeBoxesContainer = document.getElementById('premadeThemeBoxesContainer');
            premadeThemeBoxesEl = document.getElementById('premadeThemeBoxes');
            specialThemeBoxesEl = document.getElementById('specialThemeBoxes');

            uiRoundnessInput = document.getElementById('uiRoundness');
            uiRoundnessValueDisplay = document.getElementById('uiRoundnessValue');
            fontSizeInput = document.getElementById('fontSize');
            fontSizeValueDisplay = document.getElementById('fontSizeValue');
            holderIconToggle = document.getElementById('holderIconToggle');
            noBackgroundToggle = document.getElementById('noBackgroundToggle');
            disableSidebarAnimationsToggle = document.getElementById('disableSidebarAnimationsToggle');
            hideScrollbarsToggle = document.getElementById('hideScrollbarsToggle');
            foldDayCellsToggle = document.getElementById('foldDayCellsToggle');
            showHolderByDefaultToggle = document.getElementById('showHolderByDefaultToggle');
            use24HourFormatToggle = document.getElementById('use24HourFormatToggle');
            hideAddEventButtonInHolderToggle = document.getElementById('hideAddEventButtonInHolderToggle');

            eventRoundnessInput = document.getElementById('eventRoundness');
            eventRoundnessValueDisplay = document.getElementById('eventRoundnessValue');
            eventBorderThicknessInput = document.getElementById('eventBorderThickness');
            eventBorderThicknessValueDisplay = document.getElementById('eventBorderThicknessValue');
            dayCellMinWidthInput = document.getElementById('dayCellMinWidth');
            dayCellMinWidthValueDisplay = document.getElementById('dayCellMinWidthValue');
            const cancelEditBtn = document.getElementById('cancelEditEvent');

            const updateBtn = document.getElementById('updateEvent'); // FINALLY THE CANCEL BUTTON AND UPDATE EVENTS BUTTON GOT FIXED, I FEEL LIKE CRYING AHHHHH (15JULY2025-1:12PM)

            if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', closeEventModal);
            }
            if (updateBtn) {
            updateBtn.addEventListener('click', handleSaveEvent);
            }

            themeBodyBgInput = document.getElementById('themeBodyBg');
            themeTextColorInput = document.getElementById('themeTextColor');
            themeHeaderBgInput = document.getElementById('themeHeaderBg');
            themeMainContainerBgInput = document.getElementById('themeMainContainerBg');
            themeDayCellBgInput = document.getElementById('themeDayCellBg');
            themeDayCellHoverBgInput = document.getElementById('themeDayCellHoverBg');
            themeCurrentDayBgInput = document.getElementById('themeCurrentDayBg');
            themePrimaryButtonBgInput = document.getElementById('themePrimaryButtonBg');
            themePrimaryButtonTextInput = document.getElementById('themePrimaryButtonText');
            themeSecondaryButtonBgInput = document.getElementById('themeSecondaryButtonBg');
            themeSecondaryButtonTextInput = document.getElementById('themeSecondaryButtonText');
            themeAccentColorInput = document.getElementById('themeAccentColor');
            themeDayCellBorderColorInput = document.getElementById('themeDayCellBorderColor');

            saveSettingsButton = document.getElementById('saveSettings');
            cancelSettingsButton = document.getElementById('cancelSettings');

            saveCustomThemeButton = document.getElementById('saveCustomThemeButton');
            savedThemePreviewsEl = document.getElementById('savedThemePreviews');
            removeAllEventsButton = document.getElementById('removeAllEvents');
            resetApplicationButton = document.getElementById('resetApplicationButton');
            removeAllCustomThemesButton = document.getElementById('removeAllCustomThemesButton');

            themeNameModal = document.getElementById('theme-name-modal');
            themeNameInput = document.getElementById('themeNameInput');
            cancelThemeNameButton = document.getElementById('cancelThemeName');
            saveThemeNameButton = document.getElementById('saveThemeName');
            cancelThemeNameButton.addEventListener('click', closeThemeNameModal);
            saveThemeNameButton.addEventListener('click', handleSaveThemeName);

            holderContentEl = document.getElementById('holder-content');
            hamburgerIcon = document.getElementById('hamburgerIcon');
            holderSidebar = document.getElementById('holder-sidebar');
            mainContainerEl = document.getElementById('main-container');
            holderSidebarCloseButton = document.getElementById('holderSidebarCloseButton');
            addHolderEventButton = document.getElementById('addHolderEventButton');
            holderResizeHandle = document.querySelector('.resize-handle');


            eventContextMenu = document.getElementById('eventContextMenu');
            contextEditEventButton = document.getElementById('contextEditEvent');
            contextDuplicateEventButton = document.getElementById('contextDuplicateEvent');
            contextDeleteEventButton = document.getElementById('contextDeleteEvent');

            darkModeButton = document.getElementById('darkModeButton');
            
            darkModeButton.addEventListener('click', async () => {
                isDarkModeActive = !isDarkModeActive;
            
                
                // dark mode button on off thingy switchy
                darkModeButton.innerHTML = `Dark Mode <span class="small-text">(${isDarkModeActive ? 'On' : 'Off'})</span>`;
                
                darkModeButton.classList.toggle('selected');
                
                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                
                // SAVE SETTINGS RAAAAAAAAAAAAHHHHHHH
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                    uiRoundnessInput.value, fontSizeInput.value,
                    eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, 
                    currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, 
                    savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, 
                    showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            // Duplicate Event Button logic
            const duplicateEventBtn = document.getElementById('duplicateEventBtn');
            if (duplicateEventBtn) {
                duplicateEventBtn.onclick = async () => {
                    if (!editingEventId) return;
                    const eventToDuplicate = events.find(e => e.id === editingEventId) || holderEvents.find(e => e.id === editingEventId);
                    if (eventToDuplicate) {
                        const newEvent = { ...eventToDuplicate, id: generateUniqueId(), completed: false };
                        if (newEvent.date === 'holder') {
                            holderEvents.push(newEvent);
                        } else {
                            events.push(newEvent);
                        }
                        await saveEvents();
                        renderCalendar();
                        renderHolderEvents();
                        closeEventModal();
                    }
                };
            }

            // Patch openEventModal to show/hide the duplicate button and scroll modal to top
            if (window.openEventModal) {
                const originalOpenEventModal = window.openEventModal;
                window.openEventModal = function(eventId = null, date = null) {
                    originalOpenEventModal.call(this, eventId, date);
                    if (duplicateEventBtn) {
                        if (editingEventId) {
                            duplicateEventBtn.style.display = "";
                        } else {
                            duplicateEventBtn.style.display = "none";
                        }
                        }
                    // Scroll modal-content-scrollable to top
                    const scrollable = document.querySelector('#event-modal .modal-content-scrollable');
                    if (scrollable) scrollable.scrollTop = 0;
                };
            }

            // Also scroll to top when settings modal is opened
            if (window.openSettingsModal) {
                const originalOpenSettingsModal = window.openSettingsModal;
                window.openSettingsModal = function() {
                    originalOpenSettingsModal.call(this);
                    const scrollable = document.querySelector('#settings-modal .modal-content-scrollable');
                    if (scrollable) scrollable.scrollTop = 0;
                };
            }

            const loadedSettings = await loadSettings();

            if (loadedSettings.customFontData && loadedSettings.currentCustomFontName) {
                injectCustomFont(loadedSettings.currentCustomFontName, loadedSettings.customFontData);
                applyFont(loadedSettings.currentCustomFontName);
                customFontNameDisplay.textContent = loadedSettings.currentCustomFontName;
            } else {
                applyFont(DEFAULT_FONT_FAMILY);
                customFontNameDisplay.textContent = 'Inter (Default)';
            }
            currentCustomFontName = loadedSettings.currentCustomFontName;

            isDarkModeActive = loadedSettings.isDarkModeActive;
            holderIconToggle.checked = loadedSettings.holderIconEnabled;
            holderIconEnabled = loadedSettings.holderIconEnabled;
            noBackgroundToggle.checked = loadedSettings.noBackgroundMode;
            noBackgroundMode = loadedSettings.noBackgroundMode;
            disableSidebarAnimationsToggle.checked = loadedSettings.disableSidebarAnimations;
            disableSidebarAnimations = loadedSettings.disableSidebarAnimations;
            hideScrollbarsToggle.checked = loadedSettings.hideScrollbars;
            hideScrollbars = loadedSettings.hideScrollbars;
            foldDayCellsToggle.checked = loadedSettings.foldDayCellsEnabled;
            foldDayCellsEnabled = loadedSettings.foldDayCellsEnabled;
            showHolderByDefaultToggle.checked = loadedSettings.showHolderByDefault;
            showHolderByDefault = loadedSettings.showHolderByDefault;
            use24HourFormatToggle.checked = loadedSettings.use24HourFormat;
            use24HourFormat = loadedSettings.use24HourFormat;
            hideAddEventButtonInHolderToggle.checked = loadedSettings.hideAddEventButtonInHolder;
            hideAddEventButtonInHolder = loadedSettings.hideAddEventButtonInHolder;
            holderSidebarWidth = loadedSettings.holderSidebarWidth;
            document.documentElement.style.setProperty('--holder-sidebar-width', `${holderSidebarWidth}px`);


            currentBaseThemeKey = loadedSettings.currentBaseThemeKey;
            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedSettings.customThemeColors || { ...THEMES.pastelBlue.light };
            } else {
                if (THEMES[currentBaseThemeKey]) {
                    currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
                } else {
                    currentBaseTheme = THEMES.pastelBlue.light;
                    currentBaseThemeKey = 'pastelBlue';
                }
            }


            initPremadeThemeBoxes();
            initSpecialThemeBoxes();

            updateThemeSelectionInSettings();

            uiRoundnessInput.value = loadedSettings.currentUiRoundness;
            uiRoundnessValueDisplay.textContent = `${loadedSettings.currentUiRoundness}px`;
            document.documentElement.style.setProperty('--ui-roundness', `${loadedSettings.currentUiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${loadedSettings.currentUiRoundness * 1.5}px`);
            
            const initialMainContainerRadius = loadedSettings.noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${loadedSettings.currentUiRoundness * 1.5}px`;
            document.documentElement.style.setProperty('--main-container-border-radius-actual', initialMainContainerRadius);
            mainContainerEl.style.borderRadius = initialMainContainerRadius;


            const eventModalContent = document.querySelector('#event-modal .modal-content');
            if (eventModalContent) eventModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;
            const settingsModalContent = document.querySelector('#settings-modal .modal-content');
            if (settingsModalContent) settingsModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;

            fontSizeInput.value = loadedSettings.currentFontSize;
            fontSizeValueDisplay.textContent = `${loadedSettings.currentFontSize}px`;
            document.documentElement.style.setProperty('--base-font-size', `${loadedSettings.currentFontSize}px`);

            eventRoundnessInput.value = loadedSettings.currentEventRoundness;
            eventRoundnessValueDisplay.textContent = `${loadedSettings.currentEventRoundness}px`;
            document.documentElement.style.setProperty('--event-item-roundness', `${loadedSettings.currentEventRoundness}px`);

            eventBorderThicknessInput.value = loadedSettings.currentEventBorderThickness;
            eventBorderThicknessValueDisplay.textContent = `${loadedSettings.currentEventBorderThickness}px`;
            document.documentElement.style.setProperty('--event-item-border-thickness', `${loadedSettings.currentEventBorderThickness}px`);

            dayCellMinWidthInput.value = loadedSettings.currentDayCellMinWidth;
            dayCellMinWidthValueDisplay.textContent = `${loadedSettings.currentDayCellMinWidth}px`;
            document.documentElement.style.setProperty('--day-cell-min-width', `${loadedSettings.currentDayCellMinWidth}px`);

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });
            updateMainContainerLayout();


            await loadEvents();
            initColorPalette();
            initIconGrid();
            renderCalendar();
            renderHolderEvents();
            applyAnimationsState();
            applyScrollbarVisibility();
            applyAddEventButtonVisibility(); 


            updateHamburgerIconVisibility();
            if (showHolderByDefault && !holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            }
            setupHolderResizing();


            prevMonthButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            nextMonthButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            todayButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate = new Date();
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            settingsButton.addEventListener('click', openSettingsModal);
            saveEventButton.addEventListener('click', handleSaveEvent);
            deleteEventButton.addEventListener('click', handleDeleteEvent);
            cancelEventButton.addEventListener('click', closeEventModal);
            saveSettingsButton.addEventListener('click', handleSaveSettings);
            cancelSettingsButton.addEventListener('click', closeSettingsModal);
            customFontUploadInput.addEventListener('change', handleFontUpload);
            resetCustomFontButton.addEventListener('click', resetCustomFont);

            iconSearchInput.addEventListener('input', (e) => {
                initIconGrid(e.target.value);
            });




            uiRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                uiRoundnessValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--ui-roundness', `${value}px`);
                document.documentElement.style.setProperty('--ui-roundness-lg', `${value * 1.5}px`);
                const currentMainContainerRadius = noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${value * 1.5}px`;
                document.documentElement.style.setProperty('--main-container-border-radius-actual', currentMainContainerRadius);
                mainContainerEl.style.borderRadius = currentMainContainerRadius;
                document.querySelector('#event-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                document.querySelector('#settings-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                renderSavedThemes();
            });

            eventRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventRoundnessValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--event-item-roundness', `${value}px`);
            });

            eventBorderThicknessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventBorderThicknessValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--event-item-border-thickness', `${value}px`);
            });

            fontSizeInput.addEventListener('input', (e) => {
                const value = e.target.value;
                fontSizeValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--base-font-size', `${value}px`);
            });

            dayCellMinWidthInput.addEventListener('input', (e) => {
                const value = e.target.value;
                dayCellMinWidthValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--day-cell-min-width', `${value}px`);
            });

            holderIconToggle.addEventListener('change', async () => {
                holderIconEnabled = holderIconToggle.checked;
                updateHamburgerIconVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            noBackgroundToggle.addEventListener('change', async () => {
                noBackgroundMode = noBackgroundToggle.checked;
                updateMainContainerLayout();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            disableSidebarAnimationsToggle.addEventListener('change', async () => {
                disableSidebarAnimations = disableSidebarAnimationsToggle.checked;
                applyAnimationsState();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            hideScrollbarsToggle.addEventListener('change', async () => {
                hideScrollbars = hideScrollbarsToggle.checked;
                applyScrollbarVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            foldDayCellsToggle.addEventListener('change', async () => {
                foldDayCellsEnabled = foldDayCellsToggle.checked;
                renderCalendar();
                applyScrollbarVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            showHolderByDefaultToggle.addEventListener('change', async () => {
                showHolderByDefault = showHolderByDefaultToggle.checked;
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            use24HourFormatToggle.addEventListener('change', async () => {
                use24HourFormat = use24HourFormatToggle.checked;
                renderCalendar();
                renderHolderEvents();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });


            hamburgerIcon.addEventListener('click', toggleHolderSidebar);
            holderSidebarCloseButton.addEventListener('click', toggleHolderSidebar);
            addHolderEventButton.addEventListener('click', () => {
                window._creatingHolderEvent = true;
                openEventModal(null, 'holder');
            });

            const updateThemeAndApply = async () => {
                currentBaseThemeKey = null;
                currentBaseTheme = getCustomThemeColorsFromInputs();

                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                updateThemeSelectionInSettings();
            };

            themeBodyBgInput.addEventListener('input', updateThemeAndApply);
            themeTextColorInput.addEventListener('input', updateThemeAndApply);
            themeHeaderBgInput.addEventListener('input', updateThemeAndApply);
            themeMainContainerBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellHoverBgInput.addEventListener('input', updateThemeAndApply);
            themeCurrentDayBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeAccentColorInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBorderColorInput.addEventListener('input', updateThemeAndApply);

            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    closeEventModal();
                }
            });

            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    closeSettingsModal();
                }
            });

            holderContentEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                holderContentEl.classList.add('drag-over');
            });

            holderContentEl.addEventListener('dragleave', () => {
                holderContentEl.classList.remove('drag-over');
            });

            holderContentEl.addEventListener('drop', async (e) => {
                e.preventDefault();
                holderContentEl.classList.remove('drag-over');

                const droppedEventId = e.dataTransfer.getData('text/plain');
                if (!droppedEventId) return;

                const eventIndex = events.findIndex(event => event.id === droppedEventId);
                if (eventIndex !== -1) {
                    const eventToMove = events.splice(eventIndex, 1)[0];
                    eventToMove.date = 'holder';
                    holderEvents.push(eventToMove);
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                }
            });

            // removeAllEventsButton.addEventListener('click', handleRemoveAllEvents);
            if (removeAllCustomThemesButton) removeAllCustomThemesButton.addEventListener('click', handleRemoveAllCustomThemes);
            if (resetApplicationButton) resetApplicationButton.addEventListener('click', handleResetApplication);
            if (saveCustomThemeButton) saveCustomThemeButton.addEventListener('click', handleSaveCustomTheme); 

            if (contextEditEventButton) {
                contextEditEventButton.addEventListener('click', () => {
                    eventContextMenu.style.display = 'none';
                    if (contextMenuEventId) {
                        openEventModal(contextMenuEventId);
                    }
                });
            }

            if (contextDuplicateEventButton) {
                contextDuplicateEventButton.addEventListener('click', () => {
                    eventContextMenu.style.display = 'none';
                    handleDuplicateEvent();
                });
            }

            if (contextDeleteEventButton) {
                contextDeleteEventButton.addEventListener('click', () => {
                    eventContextMenu.style.display = 'none';
                    handleDeleteEvent();
                });
            }

            document.addEventListener('click', (e) => {
                if (eventContextMenu.style.display === 'flex' && !eventContextMenu.contains(e.target)) {
                    eventContextMenu.style.display = 'none';
                    contextMenuEventId = null;
                }
            });

            document.addEventListener('contextmenu', (e) => {
                if (eventContextMenu.style.display === 'flex' && !eventContextMenu.contains(e.target)) {
                    eventContextMenu.style.display = 'none';
                    contextMenuEventId = null;
                }
            })
        };

</script>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aidah's Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&family=Open+Sans:wght@400;600&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --base-font-size: 16px;
            --ui-roundness: 8px;
            --ui-roundness-lg: calc(var(--ui-roundness) * 1.5);
            --ui-roundness-full: 9999px;
            --event-item-border-thickness: 2px;
            --event-item-roundness: 6px;
            --day-cell-min-width: 175px;
            --body-bg: #f0f2f5;
            --text-color: #4A4A4A;
            --header-bg: #ffffff;
            --primary-button-bg: #FFFFFF;
            --primary-button-text: #E085B0;
            --secondary-button-bg: #F3E0E9;
            --secondary-button-text: #8B4B66;
            --accent-color: #E085B0;
            --day-cell-border-color: #D4DDE3;
            --main-container-bg: #ffffff;
            --day-cell-bg: #ffffff;
            --day-cell-hover-bg-color: #F8F0F5;
            --current-day-bg: #FFEAF4;
            --arrow-button-bg: transparent;
            --arrow-button-hover-bg: rgba(0,0,0,0.05);
            --arrow-button-text: #4B5563;
            --header-border-color: #E5E7EB;
            --day-cell-drag-bg: #e0f7fa;
            --current-day-border-color: var(--accent-color);
            --drag-over-border-color: var(--accent-color);
            --slider-track-bg: var(--secondary-button-bg);
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --custom-pickers-overlay-bg: rgba(255, 255, 255, 0.5);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #4A4A4A;
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
            font-size: var(--base-font-size);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #watchAdButton {
            position: relative;
            z-index: 100;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        #main-container,
        #main-container > div.flex.flex-col.md\:flex-row,
        #main-container > div.flex.flex-col.md\:flex-row > div.flex.items-center,
        #main-container > div.calendar-scroll-container > div.calendar-grid {
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
        }

        #main-container {
            margin: 1rem auto;
            width: 90vw;
            max-width: 90vw;
            height: calc(100vh - 2rem);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--main-container-bg);
            border-radius: var(--ui-roundness-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                padding: 0;
            }
            #main-container {
                width: 100vw;
                max-width: 100vw;
                height: 100vh;
                max-height: 100vh;
                margin: 0;
                border-radius: 0 !important;
                padding: 1rem;
            }
            #main-container > div.modal-content, #settings-modal > div.modal-content {
                border-radius: 0 !important;
            }
        }

        .calendar-scroll-container {
            flex-grow: 1;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
            margin-bottom: -0.5rem;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .calendar-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: transparent;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
        }

        .calendar-grid, .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, minmax(var(--day-cell-min-width), 1fr));
            gap: 8px;
            padding: 8px;
            width: 100%;
        }

        .calendar-grid {
            flex: 1;
        }

        .weekday-header {
            margin-bottom: 4px;
            background-color: var(--main-container-bg);
        }

        .weekday-header > div {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            color: var(--text-color);
            padding: 2px 0;
        }

        .day-cell {
            min-width: var(--day-cell-min-width);
            width: 100%;
            min-height: 120px;
            height: 100%;
            border: 3px solid var(--day-cell-border-color);
            background-color: var(--day-cell-bg);
            border-radius: var(--ui-roundness);
            transition: background-color 0.2s ease;
            position: relative;
            cursor: default;
            padding: 8px;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }

        .day-number {
            position: absolute;
            top: 8px;
            left: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-color);
            z-index: 3;
            padding-bottom: 20px;
        }

        .events-container {
            padding-top: 32px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .day-cell:hover {
            background-color: var(--day-cell-hover-bg);
        }

        .day-cell.selected-range,
        .day-cell.selecting {
            background-color: var(--current-day-bg);
            border-color: var(--current-day-border-color);
        }

        .current-day {
            border: 3px solid var(--current-day-border-color);
            background-color: var(--current-day-bg);
        }

        .day-cell.drag-over {
            border: 3px dashed var(--drag-over-border-color);
            background-color: var(--day-cell-drag-bg);
        }

        .event-item {
            margin: 2px 0;
            padding: 4px 8px;
            border-radius: var(--event-item-roundness);
            border-width: var(--event-item-border-thickness);
            border-style: solid;
            font-size: 0.9em;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }

        .event-item.no-transition {
            transition: none !important;
        }

        /* Base spacing for all events */
        .day-cell .event-item {
            margin: 2px 0;
        }

        /* Multiday events positioning */
        .day-cell .event-item.multi-day {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 2;
            margin: 0;
        }

        /* Position multiday events below day number */
        .day-cell .event-item.multi-day:not(.has-description) {
            top: 32px; /* Standard height below day number */
            height: 28px; /* Standard height */
        }

        /* Taller multiday events (with description) */
        .day-cell .event-item.multi-day.has-description {
            top: 32px; /* Same starting position */
            height: auto; /* Height grows with content */
            min-height: 56px; /* Minimum height for description */
        }

        /* Events container padding - accounts for tallest possible multiday event */
        .day-cell:has(.event-item.multi-day) .events-container {
            padding-top: 90px; /* Enough space for multiday with description */
        }

        /* Normal events spacing - consistent whether after multiday or not */
        .day-cell .event-item:not(.multi-day) {
            margin-top: 4px;
            position: relative; /* Ensure they stack below multiday */
            z-index: 1;
        }

        .event-item.multi-day {
            border-radius: 0;
            border-left: none;
            border-right: none;
            padding: 0.5em 8px;
            background-color: var(--accent-color);
            color: white;
        }

        .event-item.multi-day.event-start,
        .event-item.multi-day.event-end {
            min-height: 2.5em;
        }

        .event-item.multi-day.event-middle {
            height: 2.5em;
            min-height: 2.5em;
            border-radius: 0;
            border-left: none;
            border-right: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide title in all middle cells by default */
        .event-item.multi-day.event-middle .title-part {
            color: transparent;
            user-select: none;
        }

        /* Show title only in the 4th column's middle cell */
        .calendar-grid > .day-cell:nth-child(4) .event-item.multi-day.event-middle .title-part {
            color: inherit;
            user-select: auto;
        }

        .event-item.multi-day.event-start:has(.event-description),
        .event-item.multi-day.event-end:has(.event-description) {
            min-height: 4em;
        }

        .event-item.multi-day .event-content {
            display: flex;
            flex-direction: column;
            gap: 0.25em;
            width: 100%;
            overflow: hidden;
        }

        .event-item.multi-day .event-description {
            font-size: 0.85em;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .event-item.multi-day .event-icon-container {
            margin-right: 4px;
            display: inline-flex;
            align-items: center;
            padding-top: 4px;
        }

        .event-item.multi-day .time-title-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-item.multi-day.event-end {
            border-top-right-radius: var(--event-item-roundness);
            border-bottom-right-radius: var(--event-item-roundness);
            border-bottom-left-radius: var(--event-item-roundness);
            border-top-left-radius: 0;
            border-right: var(--event-item-border-thickness) solid;
            width: calc(100% + 16px);
        }

        .event-item.multi-day.event-start {
            border-top-left-radius: var(--event-item-roundness);
            border-bottom-left-radius: var(--event-item-roundness);
            border-bottom-right-radius: var(--event-item-roundness);
            border-top-right-radius: 0;
            border-left: var(--event-item-border-thickness) solid;
            width: calc(100% + 16px);
        }

        .event-item.multi-day.event-middle {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        .event-item:hover {
            filter: brightness(1.05);
        }

        .event-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--drag-over-border-color);
        }

        .event-item.drop-target-top {
            border-top: 3px solid var(--accent-color);
        }

        .event-item.drop-target-bottom {
            border-bottom: 3px solid var(--accent-color);
        }

        .event-item.striped-effect {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
        }

        .event-item.dotted-effect {
            background-image: radial-gradient(circle at 3px 3px, var(--event-item-text-color-rgba-25) 2px, transparent 0);
            background-size: 8px 8px;
        }

        .event-item.glowing {
            box-shadow: 0 0 8px var(--event-item-text-color), 0 0 15px var(--event-item-text-color);
        }

        .event-item.particles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-shadow:
                0px 0px 0 0px var(--event-item-text-color),
                10px 15px 0 0px var(--event-item-text-color),
                -5px 20px 0 0px var(--event-item-text-color),
                15px 5px 0 0px var(--event-item-text-color),
                -10px -10px 0 0px var(--event-item-text-color);
            animation: particle-flow 5s linear infinite;
            opacity: 0.7;
        }

        @keyframes particle-flow {
            0% {
                transform: translate(0, 0);
                opacity: 0.7;
                box-shadow:
                    0px 0px 0 0px var(--event-item-text-color),
                    10px 15px 0 0px var(--event-item-text-color),
                    -5px 20px 0 0px var(--event-item-text-color),
                    15px 5px 0 0px var(--event-item-text-color),
                    -10px -10px 0 0px var(--event-item-text-color);
            }
            100% {
                transform: translate(calc(100% * var(--particle-x-dir, 1)), calc(100% * var(--particle-y-dir, 1)));
                opacity: 0;
                box-shadow:
                    calc(100% * var(--particle-x-dir, 1)) calc(100% * var(--particle-y-dir, 1)) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 10px) calc(100% * var(--particle-y-dir, 1) + 15px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 5px) calc(100% * var(--particle-y-dir, 1) + 20px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 15px) calc(100% * var(--particle-y-dir, 1) + 5px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 10px) calc(100% * var(--particle-y-dir, 1) - 10px) 0 0px var(--event-item-text-color);
            }
        }

        .event-item.snow-falling::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(ellipse at 20% 10%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 70% 30%, var(--event-item-text-color-rgba-25) 2px, transparent 4px),
                radial-gradient(ellipse at 50% 50%, var(--event-item-text-color-rgba-25) 2.5px, transparent 5px),
                radial-gradient(ellipse at 90% 70%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 30% 90%, var(--event-item-text-color-rgba-25) 2.2px, transparent 4.4px),
                radial-gradient(ellipse at 10% 60%, var(--event-item-text-color-rgba-25) 2.4px, transparent 4.8px),
                radial-gradient(ellipse at 40% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(ellipse at 80% 10%, var(--event-item-text-color-rgba-25) 1.2px, transparent 2.4px),
                radial-gradient(ellipse at 15% 40%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 60% 80%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 25% 70%, var(--event-item-text-color-rgba-25) 1.3px, transparent 2.6px),
                radial-gradient(ellipse at 85% 50%, var(--event-item-text-color-rgba-25) 1.7px, transparent 3.4px);
            background-size: 200px 200px;
            animation: snow-fall 5s linear infinite;
            pointer-events: none;
        }

        @keyframes snow-fall {
            0% { 
                background-position: 
                    0 0, 50px 50px, 100px 100px, 150px 150px, 200px 200px, 250px 250px,
                    30px 30px, 80px 80px, 130px 130px, 180px 180px, 230px 230px, 280px 280px; 
            }
            100% { 
                background-position: 
                    0 400px, 50px 450px, 100px 500px, 150px 550px, 200px 600px, 250px 650px,
                    30px 430px, 80px 480px, 130px 530px, 180px 580px, 230px 630px, 280px 680px; 
            }
        }

        .event-item.glistening-stars::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(circle at 10% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(circle at 30% 40%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(circle at 50% 60%, var(--event-item-text-color-rgba-25) 2px, transparent 4px),
                radial-gradient(circle at 70% 80%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(circle at 90% 10%, var(--event-item-text-color-rgba-25) 2.2px, transparent 4.4px);
            background-size: 100px 100px;
            animation: glisten 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes glisten {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .event-item.rainbow-border {
            border-image: linear-gradient(
                45deg,
                #ff0000,
                #ff7f00,
                #ffff00,
                #00ff00,
                #0000ff,
                #4b0082,
                #8b00ff
            ) 1;
            animation: rainbow-border 3s linear infinite;
        }

        @keyframes rainbow-border {
            0% { border-image-source: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff); }
            100% { border-image-source: linear-gradient(405deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff); }
        }

        .event-item.pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .event-item.shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .event-item.bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .event-item.rotate {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .event-item.fade {
            animation: fade 2s ease-in-out infinite;
        }

        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .event-item.slide {
            animation: slide 2s ease-in-out infinite;
        }

        @keyframes slide {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        .event-item.zoom {
            animation: zoom 2s ease-in-out infinite;
        }

        @keyframes zoom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .event-item.flip {
            animation: flip 2s ease-in-out infinite;
            transform-style: preserve-3d;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .event-item.wave {
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: skewX(0deg); }
            50% { transform: skewX(5deg); }
        }

        .event-item.swing {
            animation: swing 2s ease-in-out infinite;
            transform-origin: top center;
        }

        @keyframes swing {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        .event-item.wobble {
            animation: wobble 2s ease-in-out infinite;
        }

        @keyframes wobble {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotate(-2deg); }
            75% { transform: translateX(3px) rotate(2deg); }
        }

        .event-item.tada {
            animation: tada 2s ease-in-out infinite;
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .event-item.jello {
            animation: jello 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes jello {
            0%, 100% { transform: scale3d(1, 1, 1); }
            30% { transform: scale3d(1.25, 0.75, 1); }
            40% { transform: scale3d(0.75, 1.25, 1); }
            50% { transform: scale3d(1.15, 0.85, 1); }
            65% { transform: scale3d(0.95, 1.05, 1); }
            75% { transform: scale3d(1.05, 0.95, 1); }
        }

        .event-item.rubber-band {
            animation: rubber-band 2s ease-in-out infinite;
        }

        @keyframes rubber-band {
            0% { transform: scale(1); }
            30% { transform: scaleX(1.25) scaleY(0.75); }
            40% { transform: scaleX(0.75) scaleY(1.25); }
            50% { transform: scaleX(1.15) scaleY(0.85); }
            65% { transform: scaleX(0.95) scaleY(1.05); }
            75% { transform: scaleX(1.05) scaleY(0.95); }
            100% { transform: scale(1); }
        }

        .event-item.heartbeat {
            animation: heartbeat 2s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        .event-item.flash {
            animation: flash 2s ease-in-out infinite;
        }

        @keyframes flash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }

        .event-item.shake-x {
            animation: shake-x 2s ease-in-out infinite;
        }

        @keyframes shake-x {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        .event-item.shake-y {
            animation: shake-y 2s ease-in-out infinite;
        }

        @keyframes shake-y {
            0%, 100% { transform: translateY(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateY(-2px); }
            20%, 40%, 60%, 80% { transform: translateY(2px); }
        }

        .event-item.head-shake {
            animation: head-shake 2s ease-in-out infinite;
        }

        @keyframes head-shake {
            0% { transform: translateX(0); }
            6.5% { transform: translateX(-2px) rotateY(-9deg); }
            18.5% { transform: translateX(2px) rotateY(7deg); }
            31.5% { transform: translateX(-1px) rotateY(-5deg); }
            43.5% { transform: translateX(1px) rotateY(3deg); }
            50% { transform: translateX(0); }
        }

        .event-item.swing-x {
            animation: swing-x 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-x {
            20% { transform: rotate3d(0, 0, 1, 15deg); }
            40% { transform: rotate3d(0, 0, 1, -10deg); }
            60% { transform: rotate3d(0, 0, 1, 5deg); }
            80% { transform: rotate3d(0, 0, 1, -5deg); }
            100% { transform: rotate3d(0, 0, 1, 0deg); }
        }

        .event-item.swing-y {
            animation: swing-y 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-y {
            20% { transform: rotate3d(1, 0, 0, 15deg); }
            40% { transform: rotate3d(1, 0, 0, -10deg); }
            60% { transform: rotate3d(1, 0, 0, 5deg); }
            80% { transform: rotate3d(1, 0, 0, -5deg); }
            100% { transform: rotate3d(1, 0, 0, 0deg); }
        }

        .event-item.swing-z {
            animation: swing-z 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-z {
            20% { transform: rotate3d(0, 1, 0, 15deg); }
            40% { transform: rotate3d(0, 1, 0, -10deg); }
            60% { transform: rotate3d(0, 1, 0, 5deg); }
            80% { transform: rotate3d(0, 1, 0, -5deg); }
            100% { transform: rotate3d(0, 1, 0, 0deg); }
        }

        .event-item.swing-xy {
            animation: swing-xy 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-xy {
            20% { transform: rotate3d(1, 1, 0, 15deg); }
            40% { transform: rotate3d(1, 1, 0, -10deg); }
            60% { transform: rotate3d(1, 1, 0, 5deg); }
            80% { transform: rotate3d(1, 1, 0, -5deg); }
            100% { transform: rotate3d(1, 1, 0, 0deg); }
        }

        .event-item.swing-xz {
            animation: swing-xz 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-xz {
            20% { transform: rotate3d(1, 0, 1, 15deg); }
            40% { transform: rotate3d(1, 0, 1, -10deg); }
            60% { transform: rotate3d(1, 0, 1, 5deg); }
            80% { transform: rotate3d(1, 0, 1, -5deg); }
            100% { transform: rotate3d(1, 0, 1, 0deg); }
        }

        .event-item.swing-yz {
            animation: swing-yz 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-yz {
            20% { transform: rotate3d(0, 1, 1, 15deg); }
            40% { transform: rotate3d(0, 1, 1, -10deg); }
            60% { transform: rotate3d(0, 1, 1, 5deg); }
            80% { transform: rotate3d(0, 1, 1, -5deg); }
            100% { transform: rotate3d(0, 1, 1, 0deg); }
        }

        .event-item.swing-xyz {
            animation: swing-xyz 2s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes swing-xyz {
            20% { transform: rotate3d(1, 1, 1, 15deg); }
            40% { transform: rotate3d(1, 1, 1, -10deg); }
            60% { transform: rotate3d(1, 1, 1, 5deg); }
            80% { transform: rotate3d(1, 1, 1, -5deg); }
            100% { transform: rotate3d(1, 1, 1, 0deg); }
        }

        .event-item.gradient-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(45deg, 
                    var(--event-item-text-color-rgba-25) 0%, 
                    hsla(180, 100%, 50%, 0.315) 25%, 
                    hsla(270, 100%, 50%, 0.321) 50%,
                    hsla(0, 100%, 50%, 0.268) 75%, 
                    var(--event-item-text-color-rgba-25) 100%);
            background-size: 200% 200%;
            animation: 
                subtle-gradient 6s ease-in-out infinite alternate,
                hue-rotate 12s linear infinite;
            mix-blend-mode: overlay;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes subtle-gradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes hue-rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .event-item.animated-stripes {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: stripes-animation 2s linear infinite;
        }

        @keyframes stripes-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 0;
            }
        }

        .event-item.rainbow-vertical::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to bottom,
                #ff0000,
                #ff7f00,
                #ffff00,
                #00ff00,
                #0000ff,
                #4b0082,
                #8b00ff,
                #ff0000
            );
            background-size: 100% 700%;
            animation: rainbow-vertical 10s linear infinite;
            mix-blend-mode: overlay;
            opacity: 0.7;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes rainbow-vertical {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 700%; }
        }

        .event-item.svg-stars::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z'/%3E%3C/svg%3E");
            background-size: 20px 20px;
            background-repeat: repeat;
            opacity: 10%;
            animation: 
                stars-drift 30s linear infinite,
                stars-twinkle 5s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes stars-drift {
            0% {
                background-position: 0% 0%;
                transform: scale(1) rotate(0deg) translate(-5%, -5%);
            }
            100% {
                background-position: 200% 200%;
                transform: scale(1.05) rotate(2deg) translate(5%, 5%);
            }
        }

        @keyframes stars-twinkle {
            0%   { opacity: 0.1; filter: blur(0px); }
            50%  { opacity: 0.3; filter: blur(0.3px); }
            100% { opacity: 0.2; filter: blur(0.1px); }
        }


        .event-item.inner-glow::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(
                circle at center,
                var(--event-item-text-color-rgba-25) 0%,
                transparent 60%
            );
            animation: inner-glow-pulse 3.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
            border-radius: inherit;
        }

        @keyframes inner-glow-pulse {
            0%, 100% {
                opacity: 0.7;
                transform: scale(0.94);
                filter: blur(2px);
            }
            50% {
                opacity: 0.4;
                transform: scale(1.06);
                filter: blur(1px);
            }
        }


        .event-item {
            transition: filter 0.5s ease, transform 0.5s ease;
        }

        .event-item .main-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .event-item .text-content {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-grow: 1;
            overflow: hidden;
            min-width: 0;
        }
        .event-item .text-content .time-title-wrapper {
            display: flex;
            flex-wrap: wrap;
            flex-grow: 1;
            min-width: 0;
            align-items: baseline;
            gap: 0.25rem;
        }
        .event-item .text-content .time-title-wrapper .time-part {
            flex-shrink: 0;
            white-space: nowrap;
        }
        .event-item .text-content .time-title-wrapper .title-part {
            flex-grow: 8;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-item .event-icon-container {
            position: absolute;
            top: 0.1rem;
            right: 0.2rem;
            z-index: 10;
            font-size: 1.25rem;
        }

        .event-description {
            font-size: 0.85em;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.2;
            margin-top: 0.2rem;
            padding: 0 0.6rem 0.4rem 0;
            width: 100%;
            word-break: break-word;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background-color: var(--main-container-bg);
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            max-height: 90vh;
            overflow-y: hidden;
            border-radius: var(--ui-roundness-lg);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        #settings-modal .modal-content {
            max-width: 700px;
        }

        .modal-content-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-right: 0.5rem;
        }
        .modal-content-scrollable::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .modal-content-scrollable {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .modal-footer {
            position: sticky;
            bottom: 0;
            background-color: var(--main-container-bg);
            padding: 1.5rem 1.5rem 1.5rem 0;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-bottom-left-radius: var(--ui-roundness-lg);
            border-bottom-right-radius: var(--ui-roundness-lg);
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            border: 3px solid var(--day-cell-border-color);
            padding: 0.5rem;
            border-radius: var(--ui-roundness);
        }
        .icon-grid::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .icon-grid {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }


        .icon-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            background-color: var(--secondary-button-bg);
            cursor: pointer;
            font-size: 1.25em;
            transition: background-color 0.2s, transform 0.1s, color 0.2s;
            border-radius: var(--ui-roundness);
            color: var(--secondary-button-text);
        }
        .icon-item.selected {
            background-color: var(--primary-button-bg);
            border: 2px solid var(--primary-button-text);
            color: var(--primary-button-text);
        }
        .icon-item:hover {
            background-color: var(--secondary-button-hover-bg);
            transform: scale(1.05);
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .color-box {
            width: 30px;
            height: 30px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.1s;
            border-radius: var(--ui-roundness);
        }
        .color-box.selected {
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        .color-box:hover {
            transform: scale(1.05);
        }

        .theme-box {
            width: 100px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: var(--ui-roundness);
            transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .theme-box .color-preview {
            width: 40px;
            height: 20px;
            border-radius: var(--ui-roundness);
            margin-bottom: 0.25rem;
            border: 1px solid rgba(0,0,0,0.1);
        }


        .theme-box.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .special-theme-box.selected {
            border-width: 4px !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
        }
        .theme-box:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .custom-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        .custom-file-input + label {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            border-radius: var(--ui-roundness);
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--secondary-button-text);
            width: 100%;
            justify-content: center;
        }
        .custom-file-input + label:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .custom-file-input:focus + label {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .themed-button {
            padding: 0.75rem 1.5rem;
            border-radius: var(--ui-roundness);
            font-weight: 600;
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 3px solid var(--primary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .themed-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
            border-color: var(--primary-button-text);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .themed-button.secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 3px solid var(--secondary-button-text);
        }
        .themed-button.secondary:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            border-color: var(--secondary-button-text);
        }
        .themed-button.danger {
            background-color: #ef4444;
            color: white;
            border: 3px solid #dc2626;
        }
        .themed-button.danger:hover {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        input[type="text"], textarea {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        #iconSearchInput {
            border: 3px solid var(--day-cell-border-color);
        }

        input[type="time"], input[type="date"] {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            position: relative;
            padding-right: 2.5rem;
        }

        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--day-cell-border-color); 
        }
        input[type="time"]:focus::-webkit-calendar-picker-indicator,
        input[type="date"]:focus::-webkit-calendar-picker-indicator {
            color: var(--accent-color);
        }
        input[type="time"]::-moz-calendar-picker-indicator,
        input[type="date"]::-moz-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            color: var(--day-cell-border-color);
        }
        input[type="time"]:focus::-moz-calendar-picker-indicator,
        input[type="date"]:focus::-moz-calendar-picker-indicator {
            color: var(--accent-color); 
        }


        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: var(--slider-track-bg);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s, background-color .2s, box-shadow .2s;
            border-radius: var(--ui-roundness);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.1);
            cursor: grabbing;
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-moz-range-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range:active {
            transform: scale(1.1);
            cursor: grabbing;
        }


        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .color-input-group label {
            flex-grow: 1;
            font-size: 0.9em;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .toggle-container + .toggle-container {
            margin-top: 0.55rem;
        }

        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 44px;
            width: 44px;
            height: 26px;
            background-color: var(--secondary-button-bg);
            border-radius: var(--ui-roundness);
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 3px; 
            left: 3px; 
            width: 20px;
            height: 20px;
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
        }

        input[type="checkbox"]:checked::before {
            transform: translateX(18px);
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
        }

        .toggle-label {
            margin-left: 0.5rem;
            cursor: pointer;
            display: inline-block;
            color: var(--text-color);
            flex-grow: 1;
            white-space: normal;
        }


        #adMobPlaceholder {
            transition: opacity 0.3s ease-in-out;
        }
        #adMobPlaceholder > div {
            background-color: var(--main-container-bg);
            color: var(--text-color);
        }


        .special-theme-box {
            position: relative;
        }

        .special-theme-lock-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--ui-roundness);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
        }

        .special-theme-box.unlocked .special-theme-lock-overlay {
            opacity: 0;
            pointer-events: none;
        }

        .special-theme-box.unlocked {
             border-color: var(--accent-color) !important;
        }

        .h4-settings {
            font-size: calc(var(--base-font-size) * 1.125);
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .last-saved-theme-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 3px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            padding: 0.5rem;
            background-color: var(--day-cell-bg);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            min-width: 100px;
        }
        .last-saved-theme-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .last-saved-theme-preview .color-swatches {
            display: flex;
            gap: 2px;
            width: 100%;
            height: 30px;
            border-radius: var(--ui-roundness);
            overflow: hidden;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .last-saved-theme-preview .color-swatch-main {
            flex-grow: 1;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .color-swatch-header {
            width: 30%;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .theme-name {
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .last-saved-theme-preview .apply-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: var(--ui-roundness);
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 2px solid var(--primary-button-text);
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .last-saved-theme-preview .apply-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
        }

        .event-icon-display {
            width: 60px;
            height: 60px; 
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            border: 3px solid var(--day-cell-border-color);
            cursor: pointer;
            font-size: 1.5em; 
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .event-icon-display:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        .event-icon-display.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        .event-item.multi-day.event-start:not(:has(.event-description)) {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: var(--event-item-roundness);
            border-top-left-radius: var(--event-item-roundness);
        }

        .event-item.multi-day.event-end:not(:has(.event-description)) {
            border-top-right-radius: var(--event-item-roundness);
            border-bottom-right-radius: var(--event-item-roundness);
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
        }

        .day-cell:has(.event-item.multi-day:not(.has-description)) .event-item.multi-day.has-description {
            top: 80px !important;
        }

        .event-content {
          position: relative;
        }
        .event-icon-container {
          position: absolute;
          top: 0.1rem;
          right: 0.6rem;
          z-index: 10;
          font-size: 1.25rem;
          display: flex;
          align-items: center;
          height: 1.5em;
        }
        .time-title-wrapper {
          padding-right: 2em;
          display: block;
          white-space: normal;
          word-break: break-word;
        }
        .title-part {
          display: block;
          white-space: normal;
          word-break: break-word;
        }

        .event-content {
          position: relative;
        }
        .event-icon-container {
          float: right;
          margin-left: 0.5em;
          margin-bottom: 0.1em;
          height: 1.5em;
          width: 1.5em;
          display: block;
          position: static;
        }
        .time-title-wrapper {
          display: block;
          white-space: normal;
          word-break: break-word;
          overflow: hidden;
        }
        .title-part {
          display: inline;
          white-space: normal;
          word-break: break-word;
        }
        .time-title-wrapper::after {
          content: '';
          display: table;
          clear: both;
        }

        .event-content {
          position: relative;
        }
        .event-icon-container {
          position: absolute;
          top: 0.1em;
          right: 0.6em;
          height: 1.5em;
          width: 1.5em;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .time-title-wrapper {
          padding-right: 2em;
          display: block;
          white-space: normal;
          word-break: break-word;
          overflow: hidden;
        }
        .title-part {
          display: inline;
          white-space: normal;
          word-break: break-word;
        }
        .time-part {
          white-space: nowrap;
          display: inline;
        }

        .event-icon-container {
          position: absolute;
          top: 0.1em;
          right: 0.2em;
          height: 1.3em;
          width: 1.3em;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .time-title-wrapper {
          padding-right: 1.4em;
          display: block;
          white-space: normal;
          word-break: break-word;
          overflow: hidden;
        }

        .glow-box {
            width: 200px;
            height: 200px;
            background: #222;
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0, 255, 255, 0.3);
            animation: innerGlowPulse 2s infinite ease-in-out;
        }

        @keyframes innerGlowPulse {
            0% {
                box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
            }
            50% {
                box-shadow: inset 0 0 25px rgba(0, 255, 255, 0.6);
            }
            100% {
                box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
            }
        }

        .event-item.multi-day.event-middle {
            height: 24px; /* Fixed height for middle segments */
            min-height: 24px; /* Prevent content from expanding height */
            padding: 0; /* Remove any internal spacing */
            margin: 0; /* Remove any external spacing */
            border-radius: 0;
            border-left: none;
            border-right: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide title in all middle cells by default */
        .event-item.multi-day.event-middle .title-part {
            color: transparent;
            user-select: none;
        }

        /* Show title only in the 4th column's middle cell */
        .calendar-grid > .day-cell:nth-child(4) .event-item.multi-day.event-middle .title-part {
            color: inherit;
            user-select: auto;
        }

        /* Ensure the container padding still accommodates the tallest multiday parts */
        .day-cell:has(.event-item.multi-day) .events-container {
            padding-top: 90px; /* Match your existing value */
        }

        .event-item.multi-day.event-start:has(.event-description),
        .event-item.multi-day.event-end:has(.event-description) {
            min-height: 4em;
        }


        /* Visually join the middle segments of multiday events */
        .event-item.multi-day.event-middle {
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
            margin-left: -1px;
            margin-right: -1px;
            z-index: 2;
        }

        

        /* Start and end segments keep their rounded corners and borders */
        .event-item.multi-day.event-start {
            border-top-left-radius: var(--event-item-roundness);
            border-bottom-left-radius: var(--event-item-roundness);
            border-left: var(--event-item-border-thickness) solid;
            margin-left: 0;
        }
        .event-item.multi-day.event-end {
            border-top-right-radius: var(--event-item-roundness);
            border-bottom-right-radius: var(--event-item-roundness);
            border-right: var(--event-item-border-thickness) solid;
            margin-right: 0;
        }

        /* Make middle nameless multiday events the same height as normal events */
        .event-item.multi-day.event-middle {
            height: 28px;
            min-height: 0;
            max-height: 28px;
            padding: 0;
            margin: 0;
            overflow: hidden;
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Only the space between middle segments and first normal event */
        .day-cell .event-item.multi-day.event-middle + .event-item:not(.multi-day) {
            margin-top: 8px; /* Your special spacing value */
        }

        /* Reset for all other cases to prevent unintended effects */
        .day-cell .event-item:not(.multi-day) {
            margin-top: 4px; /* Default spacing */
        }

        /* Force middle nameless multiday events to match normal event height */
        .event-item.multi-day.event-middle {
            height: 28px !important;
            min-height: 0 !important;
            max-height: 28px !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden !important;
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- FORCE OVERRIDE --- */
        .calendar-grid {
            gap: 8px !important;
        }
        .event-item.multi-day {
            position: absolute !important;
            left: -6px !important;
            right: -6px !important;
            width: auto !important;
            z-index: 10 !important;
        }
        .event-item.multi-day.event-middle {
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
            margin: 0 !important;
            left: -10px !important;
            right: -10px !important;
            z-index: 10 !important;
            height: 28px !important;
            min-height: 0 !important;
            max-height: 28px !important;
            padding: 0 !important;
            overflow: hidden !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Add bottom padding under the description in multiday events */
        .event-item.multi-day .event-description {
            padding-bottom: 6px !important;
        }

        /* Add extra bottom padding for placeholder start/end descriptions */
        .event-item.multi-day .placeholder-description {
            padding-bottom: 10px !important;
        }

        /* Add extra bottom padding for multiday events with no real description */
        .event-item.multi-day.no-description {
            padding-bottom: 50px !important;
        }
    </style>
</head>
<body>

    <div class="bg-white shadow-2xl p-6 w-full overflow-hidden transform transition-all duration-300"
         id="main-container">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4"
             style="border-color: var(--header-border-color);">
            <div class="flex items-center space-x-2 mb-4 md:mb-0">
                <button id="prevMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="currentMonthYear" class="font-extrabold text-3xl tracking-tight"
                    style="color: var(--text-color);"></h2>
                <button id="nextMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="todayButton" class="themed-button">
                    Today
                </button>
                <button id="settingsButton" class="themed-button secondary">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>

        <div class="calendar-scroll-container">
            <div class="weekday-header">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <div id="calendar" class="calendar-grid">
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4" style="color: var(--text-color);">Add New Event</h3>
            <div class="modal-content-scrollable">
                <div class="mb-4">
                    <label for="eventTitle" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Event Icon & Title</label>
                    <div class="flex items-center space-x-2">
                        <div id="eventIconDisplay" class="event-icon-display">
                            <i class="fas fa-plus"></i> 
                        </div>
                        <input type="text" id="eventTitle" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 flex-grow">
                    </div>
                </div>

                <div id="singleDayFields" class="mb-4 flex space-x-4">
                    <div class="w-1/2">
                        <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Time (Optional)</label>
                        <input type="time" id="eventTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                    </div>
                    <div class="w-1/2">
                        <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Date</label>
                        <input type="date" id="eventDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                    </div>
                </div>

                <div id="multiDayFields" class="mb-4 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="eventStartDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Start Date</label>
                            <input type="date" id="eventStartDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="eventStartTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Start Time (Optional)</label>
                            <input type="time" id="eventStartTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="eventEndDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">End Date</label>
                            <input type="date" id="eventEndDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="eventEndTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">End Time (Optional)</label>
                            <input type="time" id="eventEndTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="eventStartDescription" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Start Description (Optional)</label>
                        <textarea id="eventStartDescription" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                    </div>
                    <div class="mt-4">
                        <label for="eventEndDescription" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">End Description (Optional)</label>
                        <textarea id="eventEndDescription" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Description (Optional)</label>
                    <textarea id="eventDescription" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Event Color</label>
                    <div id="colorPalette" class="color-palette">
                        </div>
                    <input type="hidden" id="eventColor">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Effects</label>
                    <div class="flex flex-col space-y-2">
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGlowing">
                            <span class="toggle-label">Glowing</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectStriped">
                            <span class="toggle-label">Striped</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectDotted">
                            <span class="toggle-label">Dotted</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Animated Effects</label>
                    <div class="flex flex-col space-y-2">
                        <label class="toggle-container">
                            <input type="checkbox" id="effectParticles">
                            <span class="toggle-label">Particles</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectSnowFalling">
                            <span class="toggle-label">Snow Falling</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGlisteningStars">
                            <span class="toggle-label">Glistening Stars</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectAnimatedStripes">
                            <span class="toggle-label">Animated Stripes</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGradient">
                            <span class="toggle-label">Animated Gradient</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectRainbowVertical">
                            <span class="toggle-label">Rainbow Vertical</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectSvgStars">
                            <span class="toggle-label">Moving Stars</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectInnerGlow">
                            <span class="toggle-label">Inner Glow</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Choose Icon</label>
                    <input type="text" id="iconSearchInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 mb-3" placeholder="Search icons...">
                    <div id="iconGrid" class="icon-grid">
                        </div>
                    <input type="hidden" id="eventIcon">
                </div>
            </div>

            <div class="modal-footer">
                <button id="deleteEvent" class="themed-button secondary hidden">Delete</button>
                <button id="cancelEvent" class="themed-button secondary">Cancel</button>
                <button id="saveEvent" class="themed-button">Save Event</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Settings</h3>

            <div class="modal-content-scrollable">
                <div class="mb-6">
                    <h4 class="h4-settings">Custom Font Upload</h4>
                    <input type="file" id="customFontUpload" accept=".ttf,.otf,.woff,.woff2" class="custom-file-input">
                    <label for="customFontUpload">
                        <i class="fas fa-upload"></i>
                        <span>Upload Font File</span>
                    </label>
                    <div id="currentCustomFontDisplay" class="mt-2 text-sm text-gray-600" style="color: var(--text-color);">
                        <span class="font-semibold">Current:</span> <span id="customFontNameDisplay">Inter (Default)</span>
                    </div>
                    <button id="resetCustomFont" class="themed-button secondary mt-2">Reset to Default</button>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">UI Roundness</h4>
                    <input type="range" id="uiRoundness" min="0" max="24" value="8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="uiRoundnessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">8px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Event Roundness</h4>
                    <input type="range" id="eventRoundness" min="0" max="24" value="8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="eventRoundnessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">8px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Event Border Thickness</h4>
                    <input type="range" id="eventBorderThickness" min="0" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="eventBorderThicknessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">3px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Base Font Size</h4>
                    <input type="range" id="fontSize" min="12" max="36" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="fontSizeValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">16px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Day Cell Minimum Width</h4>
                    <input type="range" id="dayCellMinWidth" min="100" max="300" value="140" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="dayCellMinWidthValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">140px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Application Settings</h4>
                    <div class="toggle-container">
                        <input type="checkbox" id="timeFormatToggle">
                        <label for="timeFormatToggle" class="toggle-label">Use 24-hour time format</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="forceLandscapeToggle">
                        <label for="forceLandscapeToggle" class="toggle-label">Force Landscape Mode (Android Only)</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="darkModeToggle">
                        <label for="darkModeToggle" class="toggle-label">Dark Mode</label>
                    </div>


                    <div class="mb-4">
                        <h4 class="h4-settings">Pre-made Themes</h4>
                        <div id="premadeThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center">
                            </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="h4-settings">Special Themes</h4>
                        <div id="specialThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center">
                            </div>
                    </div>

                    <div id="customColorPickersContainer" class="relative">
                        <div id="colorPickersOverlay" class="absolute inset-0 flex flex-col items-center justify-center p-4 rounded-lg z-10 hidden" style="border-radius: var(--ui-roundness); background-color: var(--custom-pickers-overlay-bg);">
                            <p class="text-center font-medium mb-4" style="color: var(--text-color);">Unlock custom themes by watching an ad!</p>
                            <button id="watchAdButton" class="themed-button">
                                <i class="fas fa-play-circle mr-2"></i> Watch Ad
                            </button>
                            <div id="adLoadingSpinner" class="hidden mt-4">
                                <i class="fas fa-spinner fa-spin text-accent-color text-2xl"></i>
                            </div>
                        </div>
                        <h4 class="h4-settings">Custom Theming</h4>
                        <div class="color-input-group">
                            <label for="themeBodyBg">Background Color</label>
                            <input type="color" id="themeBodyBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeTextColor">Main Text Color</label>
                            <input type="color" id="themeTextColor">
                        </div>
                         <div class="color-input-group">
                            <label for="themeHeaderBg">Header Background</label>
                            <input type="color" id="themeHeaderBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeMainContainerBg">Main Container Background</label>
                            <input type="color" id="themeMainContainerBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellBg">Day Cell Background</label>
                            <input type="color" id="themeDayCellBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellHoverBg">Day Cell Hover Background</label>
                            <input type="color" id="themeDayCellHoverBg">
                        </div>
                         <div class="color-input-group">
                            <label for="themeCurrentDayBg">Today's Day Cell Background</label>
                            <input type="color" id="themeCurrentDayBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themePrimaryButtonBg">Primary Button Background</label>
                            <input type="color" id="themePrimaryButtonBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themePrimaryButtonText">Primary Button Text</label>
                            <input type="color" id="themePrimaryButtonText">
                        </div>
                         <div class="color-input-group">
                            <label for="themeSecondaryButtonBg">Secondary Button Background</label>
                            <input type="color" id="themeSecondaryButtonBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeSecondaryButtonText">Secondary Button Text</label>
                            <input type="color" id="themeSecondaryButtonText">
                        </div>
                        <div class="color-input-group">
                            <label for="themeAccentColor">Accent Color (Borders, Sliders)</label>
                            <input type="color" id="themeAccentColor">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellBorderColor">Day Cell Border Color</label>
                            <input type="color" id="themeDayCellBorderColor">
                        </div>
                        <button id="saveCustomThemeButton" class="themed-button w-full mb-3">Save Current Custom Theme</button>
                    </div>

                    <div class="mb-4 pt-4 border-t" style="border-color: var(--header-border-color);">
                        <h4 class="h4-settings">Saved Custom Themes</h4>
                        <div id="savedThemePreviews" class="flex flex-wrap gap-2 mt-2 justify-center">
                        </div>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t" style="border-color: var(--header-border-color);">
                    <h4 class="h4-settings" style="color: #ef4444;">Danger Zone</h4>
                    <button id="removeAllEventsButton" class="themed-button danger w-full mb-3">Remove All Events</button>
                    <button id="removeAllCustomThemesButton" class="themed-button danger w-full mb-3">Remove All Custom Themes</button>
                    <button id="resetApplicationButton" class="themed-button danger w-full">Reset the Application</button>
                </div>

            </div>

            <div class="modal-footer">
                <button id="cancelSettings" class="themed-button secondary">Cancel</button>
                <button id="saveSettings" class="themed-button">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="theme-name-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Name Your Custom Theme</h3>
            <div class="mb-4">
                <label for="themeNameInput" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Theme Name</label>
                <input type="text" id="themeNameInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
            </div>
            <div class="modal-footer">
                <button id="cancelThemeName" class="themed-button secondary">Cancel</button>
                <button id="saveThemeName" class="themed-button">Save</button>
            </div>
        </div>
    </div>

    <div id="adMobPlaceholder" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1001] hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center flex flex-col items-center justify-center" style="max-width: 90%; width: 400px; height: 250px; border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
            <i class="fas fa-video fa-3x text-red-500 mb-4 animate-pulse"></i>
            <p class="text-xl font-semibold mb-2" style="color: var(--text-color);">Loading Your Ad...</p>
            <p class="text-sm text-gray-600" style="color: var(--text-color);">Please wait a moment.</p>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let events = [];
        let editingEventId = null;
        let currentCustomFontName = null;
        let draggedEventId = null;
        let isDraggingSelection = false;
        let selectionStartDate = null;
        let selectionEndDate = null;
        let longPressTimer = null;
        let selectionDelayTimer = null;
        const LONG_PRESS_DURATION = 500;
        const SELECTION_DELAY = 100;
        const MAX_SAVED_THEMES = 5;

        const DEFAULT_FONT_FAMILY = 'Inter, sans-serif';

        class CapacitorPreferences {
            async set({ key, value }) {
                try {
                    localStorage.setItem(key, value);
                    return Promise.resolve();
                } catch (e) {
                    console.error('Error setting preference:', e);
                    return Promise.reject(e);
                }
            }

            async get({ key }) {
                try {
                    const value = localStorage.getItem(key);
                    return Promise.resolve({ value });
                } catch (e) {
                    console.error('Error getting preference:', e);
                    return Promise.reject(e);
                }
            }

            async remove({ key }) {
                try {
                    localStorage.removeItem(key);
                    return Promise.resolve();
                } catch (e) {
                    console.error('Error removing preference:', e);
                    return Promise.reject(e);
                }
            }

            async clear() {
                try {
                    localStorage.clear();
                    return Promise.resolve();
                } catch (e) {
                    console.error('Error clearing preferences:', e);
                    return Promise.reject(e);
                }
            }
        }
        const Preferences = new CapacitorPreferences();

        const adjustColor = (hex, lum) => {
            if (!hex || typeof hex !== 'string') return hex;
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            let rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }
            return rgb;
        };

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };

        const hexToRgba = (hex, alpha) => {
            const rgb = hexToRgb(hex);
            if (rgb) {
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
            }
            return hex;
        };

        const isColorLight = (hex) => {
            if (!hex || typeof hex !== 'string' || hex.length < 7) return false;
            const cleanHex = hex.startsWith('#') ? hex.substring(1) : hex;
            if (cleanHex.length !== 6) return false;

            const r = parseInt(cleanHex.substring(0, 2), 16);
            const g = parseInt(cleanHex.substring(2, 4), 16);
            const b = parseInt(cleanHex.substring(4, 6), 16);
            const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
            return luminance > 0.5;
        };
        

        const DEFAULT_LIGHT_THEME = {
            name: "Default Light",
            bodyBg: '#F8E8F0',
            mainText: '#4A4A4A',
            headerBg: '#FFFFFF',
            primaryButtonBg: '#FFFFFF',
            primaryButtonText: '#E085B0',
            secondaryButtonBg: '#F3E0E9',
            secondaryButtonText: '#8B4B66',
            accentColor: '#E085B0',
            dayCellBorder: '#D4DDE3',
            mainContainerBg: '#FFFFFF',
            dayCellBg: '#FFFFFF',
            dayCellHoverBg: '#F8F0F5',
            currentDayBg: '#FFEAF4',
            arrowButtonBg: 'transparent',
            arrowButtonHoverBg: 'rgba(0,0,0,0.05)',
            arrowButtonText: '#4B5563',
            headerBorderColor: '#E5E7EB'
        };

        const DEFAULT_DARK_THEME = {
            name: "Default Dark",
            bodyBg: '#2C2C34',
            mainText: '#E0E0E0',
            headerBg: '#3A3A45',
            mainContainerBg: '#3A3A45',
            dayCellBg: '#4A4A50',
            dayCellHoverBg: '#5A5A60',
            currentDayBg: '#6A6A70',
            primaryButtonBg: '#E085B0',
            primaryButtonText: '#FFFFFF',
            secondaryButtonBg: '#6E6E77',
            secondaryButtonText: '#C0C0C0',
            accentColor: '#FFADD9',
            dayCellBorder: '#5A5A60',
            arrowButtonBg: 'transparent',
            arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
            arrowButtonText: '#E0E0E0',
            headerBorderColor: 'rgba(255,255,255,0.15)'
        };

        const PASTEL_THEMES = {
            blue: {
                light: {
                    name: "Blue", bodyBg: '#E0F2F7', mainText: '#3F51B5', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#CFECF5', currentDayBg: '#B3E5FC',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#42A5F5',
                    secondaryButtonBg: '#BBDEFB',
                    secondaryButtonText: '#2196F3', accentColor: '#42A5F5', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#2196F3', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Blue (Dark)", bodyBg: '#060b14', mainText: '#90caf9', headerBg: '#3A4B5C', mainContainerBg: '#12152b',
                    dayCellBg: '#18203a', dayCellHoverBg: '#18437c', currentDayBg: '#1a2854',
                    primaryButtonBg: '#18587e', primaryButtonText: '#85d6ff',
                    secondaryButtonBg: '#12152b',
                    secondaryButtonText: '#90CAF9', accentColor: '#81D4FA', dayCellBorder: '#2a4f7e',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#81d4fa', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            green: {
                light: {
                    name: "Green", bodyBg: '#E8F5E9', mainText: '#388E3C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#D9F1DB', currentDayBg: '#C8E6C9',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#81C784',
                    secondaryButtonBg: '#C5E1A5',
                    secondaryButtonText: '#66BB6A', accentColor: '#81C784', dayCellBorder: '#A1CF90',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#66BB6A', headerBorderColor: '#A1CF90'
                },
                dark: {
                    name: "Green (Dark)", bodyBg: '#132018', mainText: '#C8E6C9', headerBg: '#4B5C4A', mainContainerBg: '#1e332c',
                    dayCellBg: '#375847', dayCellHoverBg: '#20402a', currentDayBg: '#2f4b36',
                    primaryButtonBg: '#418145', primaryButtonText: '#b8eab9',
                    secondaryButtonBg: '#2f4b36',
                    secondaryButtonText: '#a5d6a7', accentColor: '#a5d6a7', dayCellBorder: '#6c906a',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C8E6C9', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            yellow: {
                light: {
                    name: "Yellow", bodyBg: '#FFFDE7', mainText: '#c78800', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#fff9c4', currentDayBg: '#fff9c4',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#d39831',
                    secondaryButtonBg: '#fff59d',
                    secondaryButtonText: '#e0a906', accentColor: '#d07916', dayCellBorder: '#FFD375',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#FFCA28', headerBorderColor: '#FFF176'
                },
                dark: {
                    name: "Yellow (Dark)",
                    bodyBg: '#0b0d11',
                    mainText: '#eeda9f',
                    headerBg: '#f4ad35',
                    mainContainerBg: '#1f180c',
                    dayCellBg: '#281b0d',
                    dayCellHoverBg: '#170f08',
                    currentDayBg: '#22160a',
                    primaryButtonBg: '#663a1c',
                    primaryButtonText: '#ffd95f',
                    secondaryButtonBg: '#391c0b',
                    secondaryButtonText: '#e0a906',
                    accentColor: '#E6A900',
                    dayCellBorder: '#50371b',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#e6a900',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            purple: {
                light: {
                    name: "Purple", bodyBg: '#F3E5F5', mainText: '#7B1FA2', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#ECCFF0', currentDayBg: '#E1BEE7',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#BA68C8',
                    secondaryButtonBg: '#E1BEE7',
                    secondaryButtonText: '#9C27B0', accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Purple (Dark)",
                    bodyBg: '#080512',
                    mainText: '#d0a1ed',
                    headerBg: '#402a63',
                    mainContainerBg: '#1c102f',
                    dayCellBg: '#291547',
                    dayCellHoverBg: '#190c2e',
                    currentDayBg: '#220e42',
                    primaryButtonBg: '#51227f',
                    primaryButtonText: '#cc9beb',
                    secondaryButtonBg: '#25123f',
                    secondaryButtonText: '#b994e6',
                    accentColor: '#9876df',
                    dayCellBorder: '#5A3D82',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#cc9beb',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pink: {
                light: {
                    name: "Pink", bodyBg: '#FCE4EC', mainText: '#C2185B', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F8D1DF', currentDayBg: '#F8BBD0',
                    primaryButtonBg: '#F8BBD0', primaryButtonText: '#E91E63',
                    secondaryButtonBg: '#f2cbe5',
                    secondaryButtonText: '#EC407A', accentColor: '#E91E63', dayCellBorder: '#ffa3c2',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#EC407A', headerBorderColor: '#F06292'
                },
                dark: {
                    name: "Pink (Dark)", bodyBg: '#29071e', mainText: '#ff93c8', headerBg: '#523A40', mainContainerBg: '#350825',
                    dayCellBg: '#400c2e', dayCellHoverBg: '#2f0422', currentDayBg: '#3d0a2b',
                    primaryButtonBg: '#891857', primaryButtonText: '#f56eb6',
                    secondaryButtonBg: '#4c1238',
                    secondaryButtonText: '#F48FB1', accentColor: '#ef70b9', dayCellBorder: '#731f53',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ff93c8', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pureBlack: {
                light: {
                    name: "Pure Black", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#111111', dayCellHoverBg: '#222222', currentDayBg: '#333333',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#000000',
                    secondaryButtonBg: '#333333',
                    secondaryButtonText: '#CCCCCC', accentColor: '#CCCCCC', dayCellBorder: '#3d3d3d',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#BBBBBB', headerBorderColor: '#2A2A2A'
                },
                dark: {
                    name: "Pure Black (Dark)", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#0A0A0A', dayCellHoverBg: '#1A1A1A', currentDayBg: '#2A2A2A',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#000000',
                    secondaryButtonBg: '#1A1A1A',
                    secondaryButtonText: '#AAAAAA', accentColor: '#AAAAAA', dayCellBorder: '#3d3d3d',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#E0E0E0', headerBorderColor: '#1A1A1A'
                }
            }
        };

        const SPECIAL_THEMES = {
            dracula: {
                defaultIsDark: true,
                light: {
                    name: "Dracula", bodyBg: '#F8F8F2', mainText: '#282A36', headerBg: '#F8F8F2', mainContainerBg: '#F8F8F2',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EAEAEA', currentDayBg: '#F0F0F0',
                    primaryButtonBg: '#FF79C6', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#BD93F9', secondaryButtonText: '#FFFFFF', accentColor: '#FF79C6', dayCellBorder: '#EAEAEA',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#44475A', headerBorderColor: '#EAEAEA'
                },
                dark: {
                    name: "Dracula", bodyBg: '#282A36', mainText: '#F8F8F2', headerBg: '#3A3A4A', mainContainerBg: '#3A3A4A',
                    dayCellBg: '#44475A', dayCellHoverBg: '#505364', currentDayBg: '#6272A4',
                    primaryButtonBg: '#FF79C6', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#6272A4', secondaryButtonText: '#F8F8F2', accentColor: '#FF79C6', dayCellBorder: '#5d6283',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#F8F8F2', headerBorderColor: '#44475A'
                }
            },
            nord: {
                defaultIsDark: true,
                light: {
                    name: "Nord", bodyBg: '#ECEFF4', mainText: '#2E3440', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#D8DEE9', dayCellHoverBg: '#E5E9F0', currentDayBg: '#BF616A',
                    primaryButtonBg: '#88C0D0', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#E5E9F0', secondaryButtonText: '#4C566A', accentColor: '#88C0D0', dayCellBorder: '#D8DEE9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4C566A', headerBorderColor: '#D8DEE9'
                },
                dark: {
                    name: "Nord", bodyBg: '#2E3440', mainText: '#ECEFF4', headerBg: '#3B4252', mainContainerBg: '#3B4252',
                    dayCellBg: '#4C566A', dayCellHoverBg: '#5E6B7A', currentDayBg: '#81A1C1',
                    primaryButtonBg: '#88C0D0', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#4C566A', secondaryButtonText: '#ECEFF4', accentColor: '#88C0D0', dayCellBorder: '#4C566A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ECEFF4', headerBorderColor: '#4C566A'
                }
            },
            oneDark: {
                defaultIsDark: true,
                light: {
                    name: "One Dark", bodyBg: '#FBFBFB', mainText: '#383A42', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#61AFEF', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#98C379', secondaryButtonText: '#FFFFFF', accentColor: '#E06C75', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4B5563', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "One Dark", bodyBg: '#282C34', mainText: '#ABB2BF', headerBg: '#333842', mainContainerBg: '#333842',
                    dayCellBg: '#3E4451', dayCellHoverBg: '#4B5262', currentDayBg: '#5C6777',
                    primaryButtonBg: '#61AFEF', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#ABB2BF', secondaryButtonText: '#282C34', accentColor: '#E06C75', dayCellBorder: '#3E4451',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ABB2BF', headerBorderColor: '#3E4451'
                }
            },
            serikaDark: {
                defaultIsDark: true,
                light: {
                    name: "Serika Dark", bodyBg: '#F0F0F0', mainText: '#363636', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#F5C77F', primaryButtonText: '#363636',
                    secondaryButtonBg: '#E0E0E0', secondaryButtonText: '#5A5A5A', accentColor: '#F5C77F', dayCellBorder: '#C7C7C7',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#5A5A5A', headerBorderColor: '#C7C7C7'
                },
                dark: {
                    name: "Serika Dark", bodyBg: '#2C2C2C', mainText: '#D0D0D0', headerBg: '#3A3A3A', mainContainerBg: '#3A3A3A',
                    dayCellBg: '#4A4A4A', dayCellHoverBg: '#5A5A5A', currentDayBg: '#6A6A6A',
                    primaryButtonBg: '#F5C77F', primaryButtonText: '#363636',
                    secondaryButtonBg: '#5A5A5A', secondaryButtonText: '#D0D0D0', accentColor: '#F5C77F', dayCellBorder: '#4A4A4A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#D0D0D0', headerBorderColor: '#4A4A4A'
                }
            },
            superuser: {
                defaultIsDark: true,
                light: {
                    name: "Super user", bodyBg: '#EFEFEF', mainText: '#1C1C1C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#00FF00', primaryButtonText: '#1C1C1C',
                    secondaryButtonBg: '#333333', secondaryButtonText: '#EFEFEF', accentColor: '#00FF00', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1C1C1C', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "Super user", bodyBg: '#000000', mainText: '#00FF00', headerBg: '#111111', mainContainerBg: '#111111',
                    dayCellBg: '#222222', dayCellHoverBg: '#333333', currentDayBg: '#444444',
                    primaryButtonBg: '#00FF00', primaryButtonText: '#000000',
                    secondaryButtonBg: '#444444', secondaryButtonText: '#00FF00', accentColor: '#00FF00', dayCellBorder: '#222222',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#00FF00', headerBorderColor: '#222222'
                }
            },
            stealth: {
                defaultIsDark: true,
                light: {
                    name: "Stealth", bodyBg: '#F5F5F5', mainText: '#424242', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E0E0E0', dayCellHoverBg: '#D0D0D0', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#9E9E9E', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#BDBDBD', secondaryButtonText: '#424242', accentColor: '#757575', dayCellBorder: '#D0D0D0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#424242', headerBorderColor: '#D0D0D0'
                },
                dark: {
                    name: "Stealth", bodyBg: '#212121', mainText: '#BDBDBD', headerBg: '#2C2C2C', mainContainerBg: '#2C2C2C',
                    dayCellBg: '#363636', dayCellHoverBg: '#424242', currentDayBg: '#525252',
                    primaryButtonBg: '#9E9E9E', primaryButtonText: '#212121',
                    secondaryButtonBg: '#424242', secondaryButtonText: '#BDBDBD', accentColor: '#9E9E9E', dayCellBorder: '#363636',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#BDBDBD', headerBorderColor: '#363636'
                }
            },
            taro: {
                defaultIsDark: true,
                light: {
                    name: "Taro", bodyBg: '#F5F0FF', mainText: '#5A2C85', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E1BEE7', dayCellHoverBg: '#CFADDF', currentDayBg: '#BA68C8',
                    primaryButtonBg: '#FFEB3B', primaryButtonText: '#5A2C85',
                    secondaryButtonBg: '#CE93D8', secondaryButtonText: '#9C27B0', accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Taro", bodyBg: '#3A2B5E', mainText: '#FDF9E2', headerBg: '#47396B', mainContainerBg: '#47396B',
                    dayCellBg: '#544679', dayCellHoverBg: '#615486', currentDayBg: '#706294',
                    primaryButtonBg: '#FFEB3B', primaryButtonText: '#3A2B5E',
                    secondaryButtonBg: '#615486', secondaryButtonText: '#FDF9E2', accentColor: '#BA68C8', dayCellBorder: '#544679',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#FDF9E2', headerBorderColor: '#544679'
                }
            },
            horizon: {
                defaultIsDark: true,
                light: {
                    name: "Horizon", bodyBg: '#F8F8F8', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#F0F0F0', dayCellHoverBg: '#E0E0E0', currentDayBg: '#D0D0D0',
                    primaryButtonBg: '#DA4453', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FF6F61', secondaryButtonText: '#FFFFFF', accentColor: '#DA4453', dayCellBorder: '#E0E0E0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#333333', headerBorderColor: '#E0E0E0'
                },
                dark: {
                    name: "Horizon", bodyBg: '#1C1E26', mainText: '#F9F0DA', headerBg: '#2A2C34', mainContainerBg: '#2A2C34',
                    dayCellBg: '#383A42', dayCellHoverBg: '#464850', currentDayBg: '#54565E',
                    primaryButtonBg: '#DA4453', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FF6F61', secondaryButtonText: '#F9F0DA', accentColor: '#DA4453', dayCellBorder: '#4c4f57',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#F9F0DA', headerBorderColor: '#383A42'
                }
            },
            sweden: {
                defaultIsDark: false,
                light: {
                    name: "Sweden", bodyBg: '#E0F2F7', mainText: '#004B8E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#B3E5FC', dayCellHoverBg: '#81D4FA', currentDayBg: '#4FC3F7',
                    primaryButtonBg: '#FFD700', primaryButtonText: '#004B8E',
                    secondaryButtonBg: '#BBDEFB', secondaryButtonText: '#1976D2', accentColor: '#FFD700', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1976D2', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Sweden", bodyBg: '#002B4B', mainText: '#ADD8E6', headerBg: '#003A63', mainContainerBg: '#003A63',
                    dayCellBg: '#004D8C', dayCellHoverBg: '#005CA8', currentDayBg: '#006CD0',
                    primaryButtonBg: '#FFD700', primaryButtonText: '#002B4B',
                    secondaryButtonBg: '#004D8C', secondaryButtonText: '#ADD8E6', accentColor: '#FFD700', dayCellBorder: '#004D8C',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ADD8E6', headerBorderColor: '#004D8C'
                }
            },
            catppuccinLatte: {
                defaultIsDark: false,
                light: {
                    name: "Catppuccin Latte", bodyBg: '#EFF1F5', mainText: '#4C4F69', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E6E9EF', dayCellHoverBg: '#DCE0EE', currentDayBg: '#CCD0DA',
                    primaryButtonBg: '#DC8A78', primaryButtonText: '#4C4F69',
                    secondaryButtonBg: '#D2D4E3', secondaryButtonText: '#6C6F85', accentColor: '#DC8A78', dayCellBorder: '#DCE0EE',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#6C6F85', headerBorderColor: '#DCE0EE'
                },
                dark: {
                    name: "Catppuccin Mocha", bodyBg: '#24273A', mainText: '#CAD3F5', headerBg: '#363A4F', mainContainerBg: '#363A4F',
                    dayCellBg: '#494D64', dayCellHoverBg: '#5B6078', currentDayBg: '#6E738D',
                    primaryButtonBg: '#F28C8C', primaryButtonText: '#24273A',
                    secondaryButtonBg: '#5B6078', secondaryButtonText: '#CAD3F5', accentColor: '#F28C8C', dayCellBorder: '#494D64',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#CAD3F5', headerBorderColor: '#494D64'
                }
            },
            github: {
                defaultIsDark: false,
                light: {
                    name: "GitHub", bodyBg: '#F6F8FA', mainText: '#24292E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F0F3F6', currentDayBg: '#E6E8EB',
                    primaryButtonBg: '#2EA44F', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#F3F4F6', secondaryButtonText: '#24292E', accentColor: '#0366D6', dayCellBorder: '#D1D7DC',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#24292E', headerBorderColor: '#D1D7DC'
                },
                dark: {
                    name: "GitHub Dark", bodyBg: '#0D1117', mainText: '#C9D1D9', headerBg: '#161B22', mainContainerBg: '#161B22',
                    dayCellBg: '#21262D', dayCellHoverBg: '#30363D', currentDayBg: '#444C56',
                    primaryButtonBg: '#238636', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#30363D', secondaryButtonText: '#C9D1D9', accentColor: '#58A6FF', dayCellBorder: '#21262D',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C9D1D9', headerBorderColor: '#21262D'
                }
            },
            tokyoNight: {
                defaultIsDark: true,
                light: {
                    name: "Tokyo Night", bodyBg: '#E1E4F2', mainText: '#565A6E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F0F2F9', currentDayBg: '#C7C9DB',
                    primaryButtonBg: '#BB9AF7', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#DDE1F0', secondaryButtonText: '#565A6E', accentColor: '#BB9AF7', dayCellBorder: '#DDE1F0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#565A6E', headerBorderColor: '#DDE1F0'
                },
                dark: {
                    name: "Tokyo Night", bodyBg: '#1A1B26', mainText: '#C0CAF5', headerBg: '#232635', mainContainerBg: '#232635',
                    dayCellBg: '#2D3043', dayCellHoverBg: '#393D55', currentDayBg: '#4A4F6B',
                    primaryButtonBg: '#BB9AF7', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#393D55', secondaryButtonText: '#C0CAF5', accentColor: '#BB9AF7', dayCellBorder: '#2D3043',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C0CAF5', headerBorderColor: '#2D3043'
                }
            },
            gruvbox: {
                defaultIsDark: true,
                light: {
                    name: "Gruvbox", bodyBg: '#FBF1C7', mainText: '#3C3836', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FEFBF3', dayCellHoverBg: '#F2E5BC', currentDayBg: '#FABD2F',
                    primaryButtonBg: '#FABD2F', primaryButtonText: '#3C3836',
                    secondaryButtonBg: '#EBDBB2', secondaryButtonText: '#3C3836', accentColor: '#D79921', dayCellBorder: '#D6C09D',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#3C3836', headerBorderColor: '#D6C09D'
                },
                dark: {
                    name: "Gruvbox Dark", bodyBg: '#282828', mainText: '#EBDBB2', headerBg: '#32302F', mainContainerBg: '#32302F',
                    dayCellBg: '#3C3836', dayCellHoverBg: '#504945', currentDayBg: '#665C54',
                    primaryButtonBg: '#FABD2F', primaryButtonText: '#282828',
                    secondaryButtonBg: '#504945', secondaryButtonText: '#EBDBB2', accentColor: '#FABD2F', dayCellBorder: '#3C3836',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#EBDBB2', headerBorderColor: '#3C3836'
                }
            },
            solarized: {
                defaultIsDark: false,
                light: {
                    name: "Solarized Light", bodyBg: '#FDF6E3', mainText: '#657B83', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EEE8D5', dayCellHoverBg: '#E0DECE', currentDayBg: '#CB4B16',
                    primaryButtonBg: '#2AA198', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FDF6E3', secondaryButtonText: '#657B83', accentColor: '#2AA198', dayCellBorder: '#D0D0C8',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#657B83', headerBorderColor: '#D0D0C8'
                },
                dark: {
                    name: "Solarized Dark", bodyBg: '#002B36', mainText: '#839496', headerBg: '#073642', mainContainerBg: '#073642',
                    dayCellBg: '#073642', dayCellHoverBg: '#586E75', currentDayBg: '#DC322F',
                    primaryButtonBg: '#2AA198', primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#073642', secondaryButtonText: '#839496', accentColor: '#2AA198', dayCellBorder: '#586E75',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#839496', headerBorderColor: '#586E75'
                }
            },
            aidah: {
                defaultIsDark: true,
                light: {
                    name: "Aidah", bodyBg: '#F7F7F7', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EEEEEE', currentDayBg: '#E8E8E8',
                    primaryButtonBg: '#D1D1D1', primaryButtonText: '#333333',
                    secondaryButtonBg: '#E9E9E9', secondaryButtonText: '#555555', accentColor: '#AAAAAA', dayCellBorder: '#DDDDDD',
                },
                dark: {
                    name: "Aidah",
                    bodyBg: '#181926', mainText: '#c5cfe9', headerBg: '#333333', mainContainerBg: '#24273a',
                    dayCellBg: '#32354b', dayCellHoverBg: '#181926', currentDayBg: '#3a2c40',
                    primaryButtonBg: '#3a2c40', primaryButtonText: '#ff9bd5',
                    secondaryButtonBg: '#2f402c', secondaryButtonText: '#a6da85', accentColor: '#ff9bd5', dayCellBorder: '#454b66',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#a6d475', headerBorderColor: '#454b66',
                }
            }

        };

        let currentBaseThemeKey = null;
        let isDarkModeActive = false;
        let forceLandscapeMode = false;
        let currentBaseTheme = null;
        let areCustomColorPickersLocked = true;
        let unlockedSpecialThemesKeys = new Set();
        let savedCustomThemes = [];

        const saveEvents = async () => {
            await Preferences.set({ key: 'calendarEvents', value: JSON.stringify(events) });
        };

        const loadEvents = async () => {
            const { value } = await Preferences.get({ key: 'calendarEvents' });
            if (value) {
                events = JSON.parse(value);
            }
        };

        const saveSettings = async (fontName, fontData, baseThemeKey, isDarkMode, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColors = null, customColorPickersLocked = true, unlockedSpecialThemes = [], forceLandscape = false, savedThemes = []) => {
            const settings = {
                customFontName: fontName,
                customFontData: fontData,
                baseThemeKey: baseThemeKey,
                isDarkMode: isDarkMode,
                uiRoundness: uiRoundness,
                fontSize: fontSize,
                eventRoundness: eventRoundness,
                eventBorderThickness: eventBorderThickness,
                dayCellMinWidth: dayCellMinWidth,
                customThemeColors: customThemeColors,
                customColorPickersLocked: customColorPickersLocked,
                unlockedSpecialThemes: Array.from(unlockedSpecialThemes),
                forceLandscapeMode: forceLandscape,
                savedCustomThemes: savedThemes
            };
            await Preferences.set({ key: 'calendarSettings', value: JSON.stringify(settings) });
        };

        let calendarEl, currentMonthYearEl, prevMonthButton, nextMonthButton, todayButton, settingsButton,
            eventModal, modalTitle, eventTitleInput, eventTimeInput, eventDateInput, eventDescriptionInput,
            eventColorInput, eventIconInput, colorPaletteEl, iconGridEl, saveEventButton, deleteEventButton, cancelEventButton,
            settingsModal, customFontUploadInput, customFontNameDisplay, resetCustomFontButton,
            uiRoundnessInput, uiRoundnessValueDisplay, fontSizeInput, fontSizeValueDisplay, darkModeToggle, forceLandscapeToggle,
            eventRoundnessInput, eventRoundnessValueDisplay, eventBorderThicknessInput, eventBorderThicknessValueDisplay,
            dayCellMinWidthInput, dayCellMinWidthValueDisplay,
            themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
            themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
            themePrimaryButtonBgInput, themePrimaryButtonTextInput, themeSecondaryButtonBgInput,
            themeSecondaryButtonTextInput, themeAccentColorInput, themeDayCellBorderColorInput,
            saveSettingsButton, cancelSettingsButton, premadeThemeBoxesEl, iconSearchInput,
            adMobPlaceholder, customColorPickersContainer, colorPickersOverlay, watchAdButton, adLoadingSpinner,
            specialThemeBoxesEl, saveCustomThemeButton, savedThemePreviewsEl, removeAllEventsButton, resetApplicationButton,
            removeAllCustomThemesButton, themeNameModal, themeNameInput, cancelThemeNameButton, saveThemeNameButton,
            effectGlowing, effectStriped, effectDotted, effectParticles, effectSnowFalling, effectGlisteningStars, effectGradient, effectAnimatedStripes, eventIconDisplay;

        const loadSettings = async () => {
            const { value: storedSettings } = await Preferences.get({ key: 'calendarSettings' });
            const defaultRoundness = 8;
            const defaultFontSize = 16;
            const defaultEventBorderThickness = 3;
            const defaultDayCellMinWidth = 140;

            let currentUiRoundness = defaultRoundness;
            let currentFontSize = defaultFontSize;
            let currentEventRoundness = defaultRoundness;
            let currentEventBorderThickness = defaultEventBorderThickness;
            let currentDayCellMinWidth = defaultDayCellMinWidth;

            let loadedCustomFontName = null;
            let loadedCustomFontData = null;
            let loadedBaseThemeKey = 'blue';
            let loadedIsDarkMode = false;
            let loadedForceLandscapeMode = false;
            let loadedCustomThemeColors = null;
            let loadedCustomColorPickersLocked = true;
            let loadedUnlockedSpecialThemes = [];
            let loadedSavedCustomThemes = [];

            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                loadedCustomFontName = settings.customFontName;
                loadedCustomFontData = settings.customFontData;

                loadedBaseThemeKey = settings.baseThemeKey !== undefined ? settings.baseThemeKey : 'blue';
                loadedIsDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false;
                loadedForceLandscapeMode = settings.forceLandscapeMode !== undefined ? settings.forceLandscapeMode : false;

                currentUiRoundness = settings.uiRoundness !== undefined ? settings.uiRoundness : defaultRoundness;
                currentFontSize = settings.fontSize !== undefined ? settings.fontSize : defaultFontSize;
                currentEventRoundness = settings.eventRoundness !== undefined ? settings.eventRoundness : currentUiRoundness;
                currentEventBorderThickness = settings.eventBorderThickness !== undefined ? settings.eventBorderThickness : defaultEventBorderThickness;
                currentDayCellMinWidth = settings.dayCellMinWidth !== undefined ? settings.dayCellMinWidth : defaultDayCellMinWidth;

                loadedCustomThemeColors = settings.customThemeColors || null;
                loadedCustomColorPickersLocked = settings.customColorPickersLocked === false ? false : true;
                loadedUnlockedSpecialThemes = settings.unlockedSpecialThemes || [];
                loadedSavedCustomThemes = settings.savedCustomThemes || [];
            }

            if (loadedCustomFontData && loadedCustomFontName) {
                injectCustomFont(loadedCustomFontName, loadedCustomFontData);
            }

            currentCustomFontName = loadedCustomFontName;
            currentBaseThemeKey = loadedBaseThemeKey;
            isDarkModeActive = loadedIsDarkMode;
            forceLandscapeMode = loadedForceLandscapeMode;
            areCustomColorPickersLocked = loadedCustomColorPickersLocked;
            unlockedSpecialThemesKeys = new Set(loadedUnlockedSpecialThemes);
            savedCustomThemes = loadedSavedCustomThemes;

            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedCustomThemeColors || { ...DEFAULT_LIGHT_THEME };
            } else {
                currentBaseTheme = null;
            }


            return {
                currentCustomFontName: loadedCustomFontName,
                customFontData: loadedCustomFontData,
                currentBaseThemeKey: loadedBaseThemeKey,
                isDarkModeActive: loadedIsDarkMode,
                forceLandscapeMode: loadedForceLandscapeMode,
                currentUiRoundness: currentUiRoundness,
                currentFontSize: currentFontSize,
                currentEventRoundness: currentEventRoundness,
                currentEventBorderThickness: currentEventBorderThickness,
                currentDayCellMinWidth: currentDayCellMinWidth,
                customThemeColors: loadedCustomThemeColors,
                customColorPickersLocked: loadedCustomColorPickersLocked,
                unlockedSpecialThemes: loadedUnlockedSpecialThemes,
                savedCustomThemes: loadedSavedCustomThemes
            };
        };

        const eventColors = [
            // Light Colors
            { name: 'red', primary: '#FFCDD2', text: '#b82121' },
            { name: 'orange', primary: '#FFE0B2', text: '#d15e00' },
            { name: 'dandelion', primary: '#FFF9C4', text: '#db9d02' },
            { name: 'pale yellow', primary: '#FFFDE7', text: '#F9A825' },
            { name: 'lime green', primary: '#DCEDC8', text: '#689F38' },
            { name: 'green', primary: '#C8E6C9', text: '#2E7D32' },
            { name: 'bluergreen', primary: '#a0dece', text: '#2e7d32' },
            { name: 'cyan', primary: '#B2EBF2', text: '#0097A7' },
            { name: 'aqua', primary: '#B2EBF2', text: '#0097A7' },
            { name: 'sky blue', primary: '#B3E5FC', text: '#0277BD' },
            { name: 'blue', primary: '#93c3ed', text: '#003b99' },
            { name: 'indigo', primary: '#afb8ed', text: '#303F9F' },
            { name: 'purple', primary: '#bbacff', text: '#2608a2' },
            { name: 'violet', primary: '#e6adf0', text: '#7B1FA2' },
            { name: 'magenta', primary: '#ffc4fa', text: '#b30098' },
            { name: 'rose pink', primary: '#F8BBD0', text: '#C2185B' },
            { name: 'pink', primary: '#FCE4EC', text: '#E91E63' },
            { name: 'brown', primary: '#D7CCC8', text: '#5D4037' },
            { name: 'grey', primary: '#E0E0E0', text: '#616161' },
            { name: 'white', primary: '#FFFFFF', text: '#212121' },

            // Dark Colors
            { name: 'red', primary: '#880e0e', text: '#FF8A80' },
            { name: 'orange', primary: '#ab3d02', text: '#FFD180' },
            { name: 'dandelion', primary: '#F57F17', text: '#FFF59D' },
            { name: 'pale yellow', primary: '#edb207', text: '#FFFDE7' },
            { name: 'lime green', primary: '#558B2F', text: '#C5E1A5' },
            { name: 'green', primary: '#1B5E20', text: '#A5D6A7' },
            { name: 'bluergreen', primary: '#004D40', text: '#80CBC4' },
            { name: 'cyan', primary: '#006064', text: '#80DEEA' },
            { name: 'aqua', primary: '#015870', text: '#82cded' },
            { name: 'sky blue', primary: '#01579B', text: '#81D4FA' },
            { name: 'blue', primary: '#0D47A1', text: '#90CAF9' },
            { name: 'indigo', primary: '#1A237E', text: '#C5CAE9' },
            { name: 'purple', primary: '#4527A0', text: '#B39DDB' },
            { name: 'violet', primary: '#6A1B9A', text: '#E1BEE7' },
            { name: 'magenta', primary: '#880E4F', text: '#F8BBD0' },
            { name: 'rose pink', primary: '#AD1457', text: '#F8BBD0' },
            { name: 'pink', primary: '#C2185B', text: '#FFCDD2' },
            { name: 'brown', primary: '#3E2723', text: '#BCAAA4' },
            { name: 'grey', primary: '#424242', text: '#BDBDBD' },
            { name: 'white', primary: '#E0E0E0', text: '#424242' }
        ];


const initColorPalette = () => {
    colorPaletteEl.innerHTML = '';
    const colorsToShow = [];

    // First 20 are light colors!!! remember
    const lightColors = eventColors.slice(0, 20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: true
    }));

    // Last 20 are dark colors okie?
    const darkColors = eventColors.slice(20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: false
    }));

    colorsToShow.push(...lightColors, ...darkColors);

    colorsToShow.forEach(color => {
        const colorBox = document.createElement('div');
        colorBox.classList.add('color-box');
        colorBox.title = color.name;
        colorBox.style.backgroundColor = color.primary;
        colorBox.dataset.primary = color.primary;
        colorBox.dataset.textColor = color.text;
        colorBox.addEventListener('click', () => {
            document.querySelectorAll('.color-box').forEach(box => box.classList.remove('selected'));
            colorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: color.primary, text: color.text });
        });
        colorPaletteEl.appendChild(colorBox);
    });

    const initialSelectedColor = eventColorInput.value;
    let foundInitialSelection = false;
    if (initialSelectedColor) {
        try {
            const parsedColor = JSON.parse(initialSelectedColor);
            const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${parsedColor.primary}"][data-text-color="${parsedColor.text}"]`);
            if (colorBox) {
                colorBox.classList.add('selected');
                foundInitialSelection = true;
            }
        } catch (e) {
            console.error("Failed to parse initial event color:", initialSelectedColor, e);
        }
    }

    // Default to first color if none selected hahah
    if (!foundInitialSelection && colorsToShow.length > 0) {
        const defaultColor = colorsToShow[0];
        const defaultColorBox = document.querySelector(`#colorPalette .color-box[data-primary="${defaultColor.primary}"][data-text-color="${defaultColor.text}"]`);
        if (defaultColorBox) {
            defaultColorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: defaultColor.primary, text: defaultColor.text });
        }
    }
};


        const allEventIcons = [
            'fas fa-star', 'far fa-star', 'fas fa-heart', 'far fa-heart', 'fas fa-bell', 'far fa-bell',
            'fas fa-bookmark', 'far fa-bookmark', 'fas fa-flag', 'far fa-flag', 'fas fa-calendar-alt', 'far fa-calendar-alt',
            'fas fa-compass', 'far fa-compass', 'fas fa-lightbulb', 'far fa-lightbulb', 'fas fa-comment', 'far fa-comment',
            'fas fa-folder', 'far fa-folder', 'far fa-circle', 'fas fa-circle', 'far fa-square', 'fas fa-square', 'fas fa-file', 'far fa-file', 'fas fa-image', 'far fa-image',
            'fas fa-play-circle', 'far fa-play-circle', 'fas fa-question-circle', 'far fa-question-circle',
            'fas fa-smile', 'far fa-smile', 'fas fa-meh', 'far fa-meh', 'fas fa-frown', 'far fa-frown',
            'fas fa-paper-plane', 'far fa-paper-plane', 'fas fa-envelope', 'far fa-envelope', 'fab fa-youtube', 'fab fa-instagram', 'fab fa-facebook', 'fab fa-tiktok', 'fab fa-whatsapp', 'fab fa-telegram', 'fab fa-twitter', 'fab fa-linkedin',
            'fab fa-github', 'fab fa-google', 'fab fa-apple', 'fab fa-windows', 'fab fa-android', 'fab fa-linux',
            'fas fa-sun', 'far fa-sun', 'fas fa-moon', 'far fa-moon', 'fas fa-grin', 'far fa-grin',
            'fas fa-surprise', 'far fa-surprise', 'fas fa-tired', 'far fa-tired', 'fas fa-sad-cry', 'far fa-sad-cry', 'far fa-face-laugh-beam', 'fas fa-clock', 'far fa-clock', 'far fa-hourglass', 'fas fa-lemon', 'far fa-lemon',
            'fas fa-futbol', 'far fa-futbol', 'fas fa-hand-peace', 'far fa-hand-peace',
            'fas fa-snowflake', 'far fa-snowflake', 'fas fa-thumbs-up', 'far fa-thumbs-up',
            'fas fa-thumbs-down', 'far fa-thumbs-down', 'fas fa-check-circle', 'far fa-check-circle',
            'fas fa-times-circle', 'far fa-times-circle', 'fas fa-edit', 'far fa-edit',
            'fas fa-trash', 'far fa-trash-alt', 'fas fa-plus-circle', 'far fa-plus-circle',
            'fas fa-minus-circle', 'far fa-minus-circle', 'fas fa-info-circle', 'far fa-info-circle',
            'fas fa-briefcase', 'fas fa-home', 'fas fa-gift', 'fas fa-plane', 'fas fa-utensils',
            'fas fa-dumbbell', 'fas fa-graduation-cap', 'fas fa-film', 'fas fa-book', 'fas fa-music',
            'fas fa-shopping-cart', 'fas fa-phone', 'fas fa-laptop', 'fas fa-coffee', 'fas fa-gamepad',
            'fas fa-cloud', 'fas fa-tree', 'fas fa-car', 'fas fa-train', 'fas fa-building',
            'fas fa-pizza-slice', 'fas fa-palette', 'fas fa-brush', 'fas fa-microchip',
            'fas fa-chart-line', 'fas fa-globe', 'fas fa-paint-brush',
            'fas fa-lock', 'fas fa-unlock', 'fas fa-key', 'fas fa-wifi', 'fas fa-plug',
            'fas fa-cube', 'fas fa-flask', 'fas fa-bug', 'fas fa-code', 'fas fa-terminal',
            'fas fa-database', 'fas fa-server', 'fas fa-cloud-upload-alt', 'fas fa-cloud-download-alt',
            'fas fa-chart-pie', 'fas fa-chart-bar', 'fas fa-receipt', 'fas fa-credit-card',
            'fas fa-dollar-sign', 'fas fa-euro-sign', 'fas fa-pound-sign', 'fas fa-yen-sign',
            'fas fa-handshake', 'fas fa-gavel', 'fas fa-balance-scale', 'fas fa-shield-alt',
            'fas fa-user-friends', 'fas fa-users', 'fas fa-user-circle', 'far fa-user-circle',
            'fas fa-trophy', 'fas fa-medal', 'fas fa-award', 'fas fa-crown',
            'fas fa-rocket', 'fas fa-space-shuttle', 'fas fa-earth-americas', 'fas fa-map-marker-alt',
            'fas fa-bus', 'fas fa-bicycle', 'fas fa-motorcycle', 'fas fa-ship',
            'fas fa-camera', 'fas fa-video', 'fas fa-microphone', 'fas fa-headphones',
            'fas fa-desktop', 'fas fa-tablet-alt', 'fas fa-mobile-alt', 'fas fa-gamepad',
            'fas fa-cogs', 'fas fa-tools', 'fas fa-wrench', 'fas fa-hammer',
            'fas fa-shopping-bag', 'fas fa-store', 'fas fa-warehouse', 'fas fa-truck',
            'fas fa-hospital', 'fas fa-clinic-medical', 'fas fa-stethoscope', 'fas fa-syringe',
            'fas fa-first-aid', 'fas fa-briefcase-medical',
            'fas fa-dog', 'fas fa-cat', 'fas fa-paw',
            'fas fa-fish', 'fas fa-carrot', 'fas fa-egg', 'fas fa-apple-alt', 'fas fa-mountain', 'fas fa-water', 'fas fa-fire',
            'fas fa-anchor', 'fas fa-life-ring', 'fas fa-umbrella', 'fas fa-wind',
            'fas fa-poo', 'fas fa-ghost', 'fas fa-spider', 'fas fa-skull',
            'fas fa-robot', 'fas fa-microchip', 'fas fa-atom', 'fas fa-dna',
            'fas fa-satellite', 'fas fa-globe-americas', 'fas fa-flask', 'fas fa-magnet',
            'fas fa-bug', 'fas fa-seedling', 'fas fa-leaf', 'fas fa-concierge-bell', 'fas fa-hotel', 'fas fa-bed',
            'fas fa-person-walking', 'fas fa-running', 'fas fa-biking', 'fas fa-swimmer',
            'fas fa-chart-line', 'fas fa-mug-hot', 'fas fa-pizza-slice', 'fas fa-plane-departure', 'fas fa-school', 'fas fa-hospital-user', 'far fa-closed-captioning', 'fab fa-money-bill', 'fas fa-'
        ];

        const initIconGrid = (filterText = '') => {
            iconGridEl.innerHTML = '';
            const filteredIcons = allEventIcons.filter(iconClass =>
                iconClass.toLowerCase().includes(filterText.toLowerCase())
            );

            filteredIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-item');
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                iconItem.dataset.icon = iconClass;
                iconItem.addEventListener('click', () => {
                    document.querySelectorAll('.icon-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    eventIconInput.value = iconClass;
                    eventIconDisplay.innerHTML = `<i class="${iconClass}"></i>`;
                    eventIconDisplay.classList.add('selected'); 
                });
                iconGridEl.appendChild(iconItem);
            });

            const currentSelectedIcon = eventIconInput.value;
            if (currentSelectedIcon) {
                const iconItemInGrid = document.querySelector(`#iconGrid .icon-item[data-icon="${currentSelectedIcon}"]`);
                if (iconItemInGrid) {
                    iconItemInGrid.classList.add('selected');
                    eventIconDisplay.innerHTML = `<i class="${currentSelectedIcon}"></i>`;
                    eventIconDisplay.classList.add('selected');
                } else {
                    eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                    eventIconDisplay.classList.remove('selected');
                    eventIconInput.value = '';
                }
            } else {
                // If no icon selected, default to plus!!!
                eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                eventIconDisplay.classList.remove('selected');
                eventIconInput.value = '';
            }
        };

        const applyFont = (fontFamily) => {
            document.body.style.fontFamily = fontFamily;
        };

        const getEffectiveTheme = (baseThemeKey, isDarkMode) => {
            let themeToApply;

            if (baseThemeKey && PASTEL_THEMES[baseThemeKey]) {
                themeToApply = { ...(isDarkMode ? PASTEL_THEMES[baseThemeKey].dark : PASTEL_THEMES[baseThemeKey].light) };
            } else if (baseThemeKey && SPECIAL_THEMES[baseThemeKey]) {
                themeToApply = { ...(isDarkMode ? SPECIAL_THEMES[baseThemeKey].dark : SPECIAL_THEMES[baseThemeKey].light) };
            } else {
                themeToApply = { ...currentBaseTheme };
            }

            if (baseThemeKey === 'pureBlack' || (baseThemeKey === null && themeToApply.bodyBg === '#000000')) {
                themeToApply.bodyBg = '#000000';
                themeToApply.mainText = '#FFFFFF';
                themeToApply.headerBg = '#000000';
                themeToApply.mainContainerBg = '#000000';
                themeToApply.dayCellBg = '#0A0A0A';
                themeToApply.dayCellHoverBg = '#1A1A1A';
                themeToApply.currentDayBg = '#2A2A2A';
                themeToApply.primaryButtonBg = '#FFFFFF';
                themeToApply.primaryButtonText = '#000000';
                themeToApply.secondaryButtonBg = '#1A1A1A';
                themeToApply.secondaryButtonText = '#AAAAAA';
                themeToApply.accentColor = '#AAAAAA';
                themeToApply.dayCellBorder = '#1A1A1A';
                themeToApply.arrowButtonBg = 'transparent';
                themeToApply.arrowButtonHoverBg = 'rgba(255,255,255,0.1)';
                themeToApply.arrowButtonText = '#E0E0E0';
                themeToApply.headerBorderColor = '#1A1A1A';
            }

            themeToApply.primaryButtonBorderColor = themeToApply.primaryButtonText;

            return themeToApply;
        };


        const applyTheme = (effectiveTheme, inputs) => {
            document.documentElement.style.setProperty('--body-bg', effectiveTheme.bodyBg);
            document.documentElement.style.setProperty('--text-color', effectiveTheme.mainText);
            document.documentElement.style.setProperty('--header-bg', effectiveTheme.headerBg);
            document.documentElement.style.setProperty('--main-container-bg', effectiveTheme.mainContainerBg);
            document.documentElement.style.setProperty('--day-cell-bg', effectiveTheme.dayCellBg);
            document.documentElement.style.setProperty('--day-cell-hover-bg-color', effectiveTheme.dayCellHoverBg);
            document.documentElement.style.setProperty('--current-day-bg', effectiveTheme.currentDayBg);

            document.documentElement.style.setProperty('--primary-button-bg', effectiveTheme.primaryButtonBg);
            document.documentElement.style.setProperty('--primary-button-text', effectiveTheme.primaryButtonText);
            document.documentElement.style.setProperty('--primary-button-border-color', effectiveTheme.primaryButtonText);

            document.documentElement.style.setProperty('--secondary-button-bg', effectiveTheme.secondaryButtonBg);
            document.documentElement.style.setProperty('--secondary-button-text', effectiveTheme.secondaryButtonText);

            document.documentElement.style.setProperty('--accent-color', effectiveTheme.accentColor);
            document.documentElement.style.setProperty('--day-cell-border-color', effectiveTheme.dayCellBorder);

            document.documentElement.style.setProperty('--arrow-button-bg', effectiveTheme.arrowButtonBg);
            document.documentElement.style.setProperty('--arrow-button-hover-bg', effectiveTheme.arrowButtonHoverBg);
            document.documentElement.style.setProperty('--arrow-button-text', effectiveTheme.arrowButtonText);
            document.documentElement.style.setProperty('--header-border-color', effectiveTheme.headerBorderColor);

            if (isDarkModeActive) {
                document.documentElement.style.setProperty('--slider-track-bg', '#666666');
            } else {
                document.documentElement.style.setProperty('--slider-track-bg', effectiveTheme.secondaryButtonBg);
            }

            document.documentElement.style.setProperty('--modal-overlay-bg', `rgba(0, 0, 0, 0.5)`);

            if (isDarkModeActive) {
                document.documentElement.style.setProperty('--custom-pickers-overlay-bg', `rgba(0, 0, 0, 0.5)`);
            } else {
                document.documentElement.style.setProperty('--custom-pickers-overlay-bg', `rgba(255, 255, 255, 0.5)`);
            }

            if (inputs && inputs.themeBodyBgInput) {
                const sourceThemeForPickers = effectiveTheme;

                if (sourceThemeForPickers) {
                    inputs.themeBodyBgInput.value = sourceThemeForPickers.bodyBg;
                    inputs.themeTextColorInput.value = sourceThemeForPickers.mainText;
                    inputs.themeHeaderBgInput.value = sourceThemeForPickers.headerBg;
                    inputs.themeMainContainerBgInput.value = sourceThemeForPickers.mainContainerBg;
                    inputs.themeDayCellBgInput.value = sourceThemeForPickers.dayCellBg;
                    inputs.themeDayCellHoverBgInput.value = sourceThemeForPickers.dayCellHoverBg;
                    inputs.themeCurrentDayBgInput.value = sourceThemeForPickers.currentDayBg;
                    inputs.themePrimaryButtonBgInput.value = sourceThemeForPickers.primaryButtonBg;
                    inputs.themePrimaryButtonTextInput.value = sourceThemeForPickers.primaryButtonText;
                    inputs.themeSecondaryButtonBgInput.value = sourceThemeForPickers.secondaryButtonBg;
                    inputs.themeSecondaryButtonTextInput.value = sourceThemeForPickers.secondaryButtonText;
                    inputs.themeAccentColorInput.value = sourceThemeForPickers.accentColor;
                    inputs.themeDayCellBorderColorInput.value = sourceThemeForPickers.dayCellBorder;
                }
            }


            document.documentElement.style.setProperty('--day-cell-drag-bg', effectiveTheme.dayCellHoverBg);

            const accentHex = effectiveTheme.accentColor.replace('#', '');
            const r = parseInt(accentHex.substring(0, 2), 16);
            const g = parseInt(accentHex.substring(2, 4), 16);
            const b = parseInt(accentHex.substring(4, 6), 16);
            document.documentElement.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);

            renderCalendar();
        };

        const injectCustomFont = (fontName, fontData) => {
            const styleId = 'custom-uploaded-font-style';
            let styleTag = document.getElementById(styleId);
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = styleId;
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = `
                @font-face {
                    font-family: "${fontName}";
                    src: url("${fontData}") format("woff2"),
                         url("${fontData}") format("woff"),
                         url("${fontData}") format("truetype"),
                         url("${fontData}") format("opentype");
                    font-weight: normal;
                    font-style: normal;
                }
            `;
        };

        const handleFontUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const fontData = reader.result;
                const fontName = `CustomUploadedFont-${Date.now()}`;
                injectCustomFont(fontName, fontData);
                applyFont(fontName);
                currentCustomFontName = fontName;
                customFontNameDisplay.textContent = file.name;

                await saveSettings(fontName, fontData, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
            };
            reader.readAsDataURL(file);
        };

        const resetCustomFont = async () => {
            const styleTag = document.getElementById('custom-uploaded-font-style');
            if (styleTag) {
                styleTag.remove();
            }
            applyFont(DEFAULT_FONT_FAMILY);
            customFontNameDisplay.textContent = 'Inter (Default)';
            currentCustomFontName = null;

            await saveSettings(null, null, currentBaseThemeKey, isDarkModeActive,
                         uiRoundnessInput.value, fontSizeInput.value,
                         eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
        };

        const initPremadeThemeBoxes = () => {
            premadeThemeBoxesEl.innerHTML = '';
            const themeKeysOrdered = ['blue', 'green', 'yellow', 'purple', 'pink', 'pureBlack'];

            themeKeysOrdered.forEach(key => {
                const theme = PASTEL_THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box');
                themeBox.dataset.themeKey = key;

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                if (key === 'yellow') {
                    colorPreview.style.backgroundColor = '#FFD700';
                } else {
                    colorPreview.style.backgroundColor = theme.accentColor;
                }
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name.replace(' (Dark)', '');
                themeBox.appendChild(themeName);

                themeBox.addEventListener('click', async () => {
                    document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                    themeBox.classList.add('selected');

                    currentBaseThemeKey = key;
                    currentBaseTheme = null;

                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });

                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                });
                premadeThemeBoxesEl.appendChild(themeBox);
            });
        };

        const initSpecialThemeBoxes = () => {
            specialThemeBoxesEl.innerHTML = '';
            const specialThemeKeysOrdered = Object.keys(SPECIAL_THEMES);

            specialThemeKeysOrdered.forEach(key => {
                const theme = SPECIAL_THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box', 'special-theme-box');
                themeBox.dataset.themeKey = key;

                if (unlockedSpecialThemesKeys.has(key)) {
                    themeBox.classList.add('unlocked');
                }

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                if (key === 'aidah') {
                    colorPreview.style.backgroundColor = '#e983d0';
                } else {
                    colorPreview.style.backgroundColor = theme.accentColor;
                }
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name;
                themeBox.appendChild(themeName);

                const lockOverlay = document.createElement('div');
                lockOverlay.classList.add('special-theme-lock-overlay');
                lockOverlay.innerHTML = '<i class="fas fa-lock"></i>';
                themeBox.appendChild(lockOverlay);


                themeBox.addEventListener('click', async () => {
                    const isLocked = !unlockedSpecialThemesKeys.has(key);
                    const selectedSpecialTheme = SPECIAL_THEMES[key];

                    if (isLocked) {
                        showAdMobPlaceholder();
                        watchAdButton.classList.add('hidden');
                        adLoadingSpinner.classList.remove('hidden');

                        setTimeout(async () => {
                            adMobPlaceholder.classList.add('hidden');
                            adLoadingSpinner.classList.add('hidden');

                            unlockedSpecialThemesKeys.add(key);
                            themeBox.classList.add('unlocked');

                            document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                            themeBox.classList.add('selected');

                            currentBaseThemeKey = key;
                            currentBaseTheme = null;

                            isDarkModeActive = selectedSpecialTheme.defaultIsDark;
                            darkModeToggle.checked = isDarkModeActive;

                            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                                themeAccentColorInput, themeDayCellBorderColorInput
                            });

                            await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                         uiRoundnessInput.value, fontSizeInput.value,
                                         eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                        }, 3000);
                    } else {
                        document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                        themeBox.classList.add('selected');

                        currentBaseThemeKey = key;
                        currentBaseTheme = null;

                        isDarkModeActive = selectedSpecialTheme.defaultIsDark;
                        darkModeToggle.checked = isDarkModeActive;

                        applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                            themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                            themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                            themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                            themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                            themeAccentColorInput, themeDayCellBorderColorInput
                        });

                        await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                     uiRoundnessInput.value, fontSizeInput.value,
                                     eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                    }
                });
                specialThemeBoxesEl.appendChild(themeBox);
            });
        };


        const renderCalendar = () => {
            calendarEl.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthYearEl.textContent = new Date(year, month).toLocaleString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const numDaysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'p-2');
                emptyCell.style.backgroundColor = `var(--body-bg)`;
                emptyCell.style.borderColor = `var(--day-cell-border-color)`;
                emptyCell.style.color = `var(--text-color)`;
                emptyCell.style.opacity = '0.4';
                calendarEl.appendChild(emptyCell);
            }

            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell', 'p-2');
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = fullDate;

                const dayNumber = document.createElement('div');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                dayNumber.style.color = `var(--text-color)`;
                dayCell.appendChild(dayNumber);

                const eventsContainer = document.createElement('div');
                eventsContainer.classList.add('events-container');

                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('current-day');
                }

                if (selectionStartDate && selectionEndDate) {
                    const cellDate = new Date(fullDate);
                    if (cellDate >= selectionStartDate && cellDate <= selectionEndDate) {
                        dayCell.classList.add('selected-range');
                    }
                }

                const dayEvents = events.filter(event => {
                    const eventDate = new Date(event.date);
                    const eventEndDate = event.endDate ? new Date(event.endDate) : eventDate;
                    return (eventDate <= new Date(fullDate) && eventEndDate >= new Date(fullDate));
                });

                dayEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    let eventColorData = { primary: '#FFCDD2', text: '#C62828' };

                    try {
                        const parsedColor = JSON.parse(event.color);
                        eventColorData = parsedColor;
                    } catch (e) {
                        console.error("Failed to parse event color:", event.color, e);
                    }

                    eventItem.style.backgroundColor = eventColorData.primary;
                    eventItem.style.color = eventColorData.text;
                    eventItem.style.borderColor = eventColorData.text;
                    eventItem.style.setProperty('--event-item-text-color', eventColorData.text);

                    const textColorRgba25 = hexToRgba(eventColorData.text, 0.25);
                    eventItem.style.setProperty('--event-item-text-color-rgba-25', textColorRgba25);

                    if (event.description) {
                        eventItem.classList.add('has-description');
                    }

                    eventItem.classList.add('event-item');
                    eventItem.dataset.id = event.id;
                    eventItem.title = `${event.title} ${event.time ? '(' + event.time + ')' : ''}${event.description ? ' - ' + event.description : ''}`;

                    if (event.effects) {
                        const effectClasses = {
                            glowing: 'glowing',
                            striped: 'striped-effect',
                            dotted: 'dotted-effect',
                            particles: 'particles',
                            snowFalling: 'snow-falling',
                            glisteningStars: 'glistening-stars',
                            gradientEffect: 'gradient-effect',
                            animatedStripes: 'animated-stripes',
                            rainbowVertical: 'rainbow-vertical',
                            svgStars: 'svg-stars',
                            innerGlow: 'inner-glow'
                        };
                        Object.entries(event.effects).forEach(([effectName, isActive]) => {
                            if (isActive && effectClasses[effectName]) {
                                eventItem.classList.add(effectClasses[effectName]);
                            }
                        });
                    }
                    
                    // drag and drop
                    let isDragging = false;
                    let dragStartX = 0;
                    let dragStartY = 0;
                    let originalParent = null;
                    let dragGhost = null;

                    eventItem.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // Left mouse button only
                            e.stopPropagation();
                            e.preventDefault();
                            
                            // drag detection
                            const dragThreshold = 5;
                            let hasMoved = false;
                            
                            isDragging = true;
                            dragStartX = e.clientX;
                            dragStartY = e.clientY;
                            originalParent = eventItem.parentElement;
                            
                            // ghost event
                            dragGhost = eventItem.cloneNode(true);
                            dragGhost.style.position = 'fixed';
                            dragGhost.style.zIndex = '1000';
                            dragGhost.style.opacity = '0.7';
                            dragGhost.style.pointerEvents = 'none';
                            dragGhost.style.width = eventItem.offsetWidth + 'px';
                            dragGhost.style.height = eventItem.offsetHeight + 'px';
                            
                            // original event pos = ghost event pos
                            const rect = eventItem.getBoundingClientRect();
                            dragGhost.style.left = rect.left + 'px';
                            dragGhost.style.top = rect.top + 'px';
                            
                            document.body.appendChild(dragGhost);
                            
                            eventItem.classList.add('dragging');
                            
                            const handleMouseMove = (e) => {
                                if (!isDragging) return;
                                
                                const deltaX = Math.abs(e.clientX - dragStartX);
                                const deltaY = Math.abs(e.clientY - dragStartY);
                                
                                if (!hasMoved && (deltaX > dragThreshold || deltaY > dragThreshold)) {
                                    hasMoved = true;
                                }
                                
                                if (hasMoved) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    
                                    dragGhost.style.left = (e.clientX - dragStartX + rect.left) + 'px';
                                    dragGhost.style.top = (e.clientY - dragStartY + rect.top) + 'px';
                                    
                                    const elementsUnderMouse = document.elementsFromPoint(e.clientX, e.clientY);
                                    const dayCell = elementsUnderMouse.find(el => el.classList.contains('day-cell'));
                                    
                                    document.querySelectorAll('.day-cell.drag-over').forEach(cell => {
                                        cell.classList.remove('drag-over');
                                    });
                                    
                                    if (dayCell && dayCell !== originalParent) {
                                        dayCell.classList.add('drag-over');
                                    }
                                }
                            };
                            
                            const handleMouseUp = (e) => {
                                if (!isDragging) return;
                                
                                if (hasMoved) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    
                                    const elementsUnderMouse = document.elementsFromPoint(e.clientX, e.clientY);
                                    const dayCell = elementsUnderMouse.find(el => el.classList.contains('day-cell'));
                                    
                                    if (dayCell && dayCell !== originalParent) {
                                        const eventIndex = events.findIndex(ev => ev.id === event.id);
                                        if (eventIndex !== -1) {
                                            const eventToUpdate = events[eventIndex];
                                            eventToUpdate.date = dayCell.dataset.date;
                                            if (eventToUpdate.endDate) {
                                                const duration = new Date(eventToUpdate.endDate) - new Date(eventToUpdate.date);
                                                eventToUpdate.endDate = new Date(new Date(eventToUpdate.date).getTime() + duration).toISOString().split('T')[0];
                                            }
                                            saveEvents();
                                            renderCalendar();
                                        }
                                    }
                                }
                                
                                isDragging = false;
                                eventItem.classList.remove('dragging');
                                document.querySelectorAll('.day-cell.drag-over').forEach(cell => {
                                    cell.classList.remove('drag-over');
                                });
                                if (dragGhost) {
                                    dragGhost.remove();
                                    dragGhost = null;
                                }
                                
                                document.removeEventListener('mousemove', handleMouseMove);
                                document.removeEventListener('mouseup', handleMouseUp);
                            };
                            
                            document.addEventListener('mousemove', handleMouseMove);
                            document.addEventListener('mouseup', handleMouseUp);
                        }
                    });

                    eventItem.addEventListener('click', (e) => {
                        if (!isDragging && !isDraggingEvent) {
                            e.stopPropagation();
                            e.preventDefault();
                            const eventId = eventItem.dataset.id;
                            if (eventId) {
                                openEventModal(eventId);
                            }
                        }
                    });

                    dayCell.addEventListener('mousedown', (e) => {
                        if (e.target.closest('.event-item')) {
                            e.stopPropagation();
                            e.preventDefault();
                        }
                    });

                    if (event.endDate) {
                        const eventStartDate = new Date(event.date);
                        const eventEndDate = new Date(event.endDate);
                        const cellDate = new Date(fullDate);
                        
                        eventItem.classList.add('multi-day');
                        
                        const startRow = Math.floor((eventStartDate.getDate() - 1) / 7);
                        const currentRow = Math.floor((cellDate.getDate() - 1) / 7);
                        const endRow = Math.floor((eventEndDate.getDate() - 1) / 7);

                        if (cellDate.getTime() === eventStartDate.getTime()) {
                            eventItem.classList.add('event-start');
                        } else if (cellDate.getTime() === eventEndDate.getTime()) {
                            eventItem.classList.add('event-end');
                        } else {
                            eventItem.classList.add('event-middle');
                        }
                        
                        const mainContentDiv = document.createElement('div');
                        mainContentDiv.classList.add('event-content');
                        mainContentDiv.style.overflow = 'hidden';
                        mainContentDiv.style.textOverflow = 'ellipsis';
                        mainContentDiv.style.whiteSpace = 'nowrap';

                        const totalDays = Math.ceil((eventEndDate - eventStartDate) / (1000 * 60 * 60 * 24)) + 1;
                        const currentDayIndex = Math.ceil((cellDate - eventStartDate) / (1000 * 60 * 60 * 24));
                        const isMiddleDay = currentDayIndex === Math.ceil(totalDays / 2);

                        const hasStartOrEndInRow = dayEvents.some(e => {
                            if (!e.endDate) return false;
                            const eStartDate = new Date(e.date);
                            const eEndDate = new Date(e.endDate);
                            const eStartRow = Math.floor((eStartDate.getDate() - 1) / 7);
                            const eEndRow = Math.floor((eEndDate.getDate() - 1) / 7);
                            return (eStartRow === currentRow || eEndRow === currentRow);
                        });

                        if (cellDate.getTime() === eventStartDate.getTime()) {
                            if (event.icon) {
                                const iconContainer = document.createElement('span');
                                iconContainer.classList.add('event-icon-container');
                                iconContainer.innerHTML = `<i class="${event.icon}"></i>`;
                                mainContentDiv.appendChild(iconContainer);
                            }

                            const timeTitleWrapper = document.createElement('div');
                            timeTitleWrapper.classList.add('time-title-wrapper');

                            if (event.time) {
                                const timePart = document.createElement('span');
                                timePart.classList.add('time-part');
                                const use24Hour = document.getElementById('timeFormatToggle').checked;
                                timePart.setAttribute('data-original-time', event.time);
                                timePart.textContent = formatTime(event.time, use24Hour);
                                timeTitleWrapper.appendChild(timePart);
                            }

                            const titlePart = document.createElement('span');
                            titlePart.classList.add('title-part');
                            titlePart.textContent = event.title;
                            timeTitleWrapper.appendChild(titlePart);

                            mainContentDiv.appendChild(timeTitleWrapper);
                            
                            if (event.startDescription) {
                                const descDiv = document.createElement('div');
                                descDiv.classList.add('event-description');
                                descDiv.textContent = event.startDescription;
                                mainContentDiv.appendChild(descDiv);
                                eventItem.classList.add('has-description');
                            } else {
                                const descDiv = document.createElement('div');
                                descDiv.classList.add('event-description', 'placeholder-description');
                                descDiv.textContent = 'starting day';
                                mainContentDiv.appendChild(descDiv);
                                eventItem.classList.add('no-description');
                            }
                        } else if (cellDate.getTime() === eventEndDate.getTime()) {
                            if (event.icon) {
                                const iconContainer = document.createElement('span');
                                iconContainer.classList.add('event-icon-container');
                                iconContainer.innerHTML = `<i class="${event.icon}"></i>`;
                                mainContentDiv.appendChild(iconContainer);
                            }

                            const timeTitleWrapper = document.createElement('div');
                            timeTitleWrapper.classList.add('time-title-wrapper');

                            if (event.endTime) {
                                const timePart = document.createElement('span');
                                timePart.classList.add('time-part');
                                const use24Hour = document.getElementById('timeFormatToggle').checked;
                                timePart.setAttribute('data-original-time', event.endTime);
                                timePart.textContent = formatTime(event.endTime, use24Hour);
                                timeTitleWrapper.appendChild(timePart);
                            }

                            const titlePart = document.createElement('span');
                            titlePart.classList.add('title-part');
                            titlePart.textContent = event.title;
                            timeTitleWrapper.appendChild(titlePart);

                            mainContentDiv.appendChild(timeTitleWrapper);
                            
                            if (event.endDescription) {
                                const descDiv = document.createElement('div');
                                descDiv.classList.add('event-description');
                                descDiv.textContent = event.endDescription;
                                mainContentDiv.appendChild(descDiv);
                                eventItem.classList.add('has-description');
                            } else {
                                const descDiv = document.createElement('div');
                                descDiv.classList.add('event-description', 'placeholder-description');
                                descDiv.textContent = 'ending day';
                                mainContentDiv.appendChild(descDiv);
                                eventItem.classList.add('no-description');
                            }
                        } else if (isMiddleDay && !hasStartOrEndInRow) {
                            // For middle days, show title on Wednesday (day 3) of each week
                            const dayOfWeek = cellDate.getDay(); // 0 = Sunday, 3 = Wednesday
                            if (dayOfWeek === 3) {
                                const titlePart = document.createElement('span');
                                titlePart.classList.add('title-part');
                                titlePart.style.textAlign = 'center';
                                titlePart.style.display = 'block';
                                titlePart.style.width = '100%';
                                titlePart.textContent = event.title;
                                mainContentDiv.appendChild(titlePart);
                            }
                        }
                        // For other middle days, no content is added

                        eventItem.appendChild(mainContentDiv);
                    } else {
                        // !!!Single day event - show content as before
                    const mainContentDiv = document.createElement('div');
                    mainContentDiv.classList.add('event-content');

                    const textContentSpan = document.createElement('span');
                    textContentSpan.classList.add('event-text-content');

                    const timeTitleWrapper = document.createElement('div');
                    timeTitleWrapper.classList.add('time-title-wrapper');

                    if (event.time) {
                        const timePart = document.createElement('span');
                        timePart.classList.add('font-semibold', 'time-part');
                        const use24Hour = document.getElementById('timeFormatToggle').checked;
                        timePart.setAttribute('data-original-time', event.time);
                        timePart.textContent = formatTime(event.time, use24Hour);
                        timeTitleWrapper.appendChild(timePart);
                        
                        const spaceSpan = document.createElement('span');
                        spaceSpan.innerHTML = '&nbsp;';
                        timeTitleWrapper.appendChild(spaceSpan);
                    }
                    const titlePart = document.createElement('span');
                    titlePart.classList.add('title-part');
                    titlePart.textContent = event.title;
                    timeTitleWrapper.appendChild(titlePart);

                    textContentSpan.appendChild(timeTitleWrapper);
                    mainContentDiv.appendChild(textContentSpan);

                    if (event.icon) {
                        const iconContainer = document.createElement('span');
                        iconContainer.classList.add('event-icon-container');
                        iconContainer.innerHTML = `<i class="${event.icon}"></i> `;
                        eventItem.appendChild(iconContainer);
                    }
                    eventItem.appendChild(mainContentDiv);

                    if (event.description) {
                        const eventDescriptionEl = document.createElement('div');
                        eventDescriptionEl.classList.add('event-description');
                        eventDescriptionEl.style.color = adjustColor(eventColorData.text, 0.15);
                        eventDescriptionEl.textContent = event.description;
                        eventItem.appendChild(eventDescriptionEl);
                        }
                    }

                    dayCell.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dayCell.classList.add('drag-over');
                    });

                    dayCell.addEventListener('dragleave', (e) => {
                        dayCell.classList.remove('drag-over');
                    });

                    dayCell.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dayCell.classList.remove('drag-over');

                        const droppedEventId = e.dataTransfer.getData('text/plain');
                        console.log('Dropped event:', droppedEventId);
                        
                        if (droppedEventId) {
                            const eventIndex = events.findIndex(event => event.id === droppedEventId);
                            if (eventIndex !== -1) {
                                const event = events[eventIndex];
                                event.date = dayCell.dataset.date;
                                if (event.endDate) {
                                    const duration = new Date(event.endDate) - new Date(event.date);
                                    event.endDate = new Date(new Date(event.date).getTime() + duration).toISOString().split('T')[0];
                        }
                        saveEvents();
                        renderCalendar();
                            }
                        }
                    });

                    eventsContainer.appendChild(eventItem);
                });

                dayCell.appendChild(eventsContainer);

                dayCell.addEventListener('click', () => {
                    openEventModal(null, dayCell.dataset.date);
                });

                    dayCell.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        dayCell.classList.add('drag-over');
                    });

                    dayCell.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!dayCell.contains(e.relatedTarget)) {
                            dayCell.classList.remove('drag-over');
                        }
                    });

                    dayCell.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dayCell.classList.remove('drag-over');

                        if (e.target.classList.contains('event-item') || e.target.closest('.event-item')) {
                            return;
                        }

                        const droppedEventId = e.dataTransfer.getData('text/plain');
                        const newDate = dayCell.dataset.date;

                        if (droppedEventId) {
                            const eventIndex = events.findIndex(event => event.id === droppedEventId);
                            if (eventIndex !== -1) {
                                const event = events[eventIndex];
                                event.date = newDate;
                                if (event.endDate) {
                                    const duration = new Date(event.endDate) - new Date(event.date);
                                    event.endDate = new Date(new Date(newDate).getTime() + duration).toISOString().split('T')[0];
                                }
                                saveEvents();
                                renderCalendar();
                            }
                        }
                    });

                    let isSelecting = false;
                    let isDraggingEvent = false;

                    dayCell.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // Left mouse button
                            e.preventDefault(); // Prevent text selection
                            
                            if (e.target.closest('.event-item')) {
                                isDraggingEvent = true;
                                return;
                            }

                            isSelecting = true;
                            isDraggingSelection = true;
                            selectionStartDate = new Date(fullDate);
                            selectionEndDate = new Date(fullDate);
                            
                            selectionDelayTimer = setTimeout(() => {
                                if (isDraggingSelection) {
                                    dayCell.classList.add('selecting');
                                }
                            }, SELECTION_DELAY);
                        }
                    });

                    dayCell.addEventListener('mouseenter', () => {
                        if (isDraggingSelection && !isDraggingEvent) {
                            selectionEndDate = new Date(fullDate);
                            clearTimeout(selectionDelayTimer);
                            selectionDelayTimer = setTimeout(() => {
                                dayCell.classList.add('selecting');
                                renderCalendar(); // Re-render to update selection highlights
                            }, SELECTION_DELAY);
                        }
                    });

                    document.addEventListener('mouseup', () => {
                            clearTimeout(longPressTimer);
                            isDraggingSelection = false;
                            isSelecting = false;
                            isDraggingEvent = false;
                            
                            document.querySelectorAll('.day-cell.selecting').forEach(cell => {
                                cell.classList.remove('selecting');
                            });
                            
                        if (selectionStartDate && selectionEndDate) {
                            if (selectionStartDate.getTime() !== selectionEndDate.getTime()) {
                                openEventModal(null, selectionStartDate.toISOString().split('T')[0], true, selectionEndDate.toISOString().split('T')[0]);
                            } else {
                                const clickedDate = selectionStartDate.toISOString().split('T')[0];
                                openEventModal(null, clickedDate, false);
                            }
                            
                            selectionStartDate = null;
                            selectionEndDate = null;
                            renderCalendar();
                        }
                    });
                    
                    dayCell.addEventListener('click', (e) => {
                        if (!isDraggingSelection && !isDraggingEvent) {
                            openEventModal(null, fullDate, false);
                        }
                    });

                calendarEl.appendChild(dayCell);
            }
        };

        const openEventModal = (eventId = null, date = null, isMultiDay = false, endDate = null) => {
            eventModal.classList.remove('hidden');
            editingEventId = eventId;

            eventTitleInput.value = '';
            eventTimeInput.value = '';
            eventDateInput.value = '';
            eventDescriptionInput.value = '';
            eventColorInput.value = '';
            eventIconInput.value = '';
            iconSearchInput.value = '';
            eventStartDateInput.value = '';
            eventStartTimeInput.value = '';
            eventEndDateInput.value = '';
            eventEndTimeInput.value = '';

            effectGlowing.checked = false;
            effectStriped.checked = false;
            effectDotted.checked = false;
            effectParticles.checked = false;
            effectSnowFalling.checked = false;
            effectGlisteningStars.checked = false;
            effectGradient.checked = false;
            effectAnimatedStripes.checked = false;
            effectRainbowVertical.checked = false;
            effectSvgStars.checked = false;
            effectInnerGlow.checked = false;

            document.querySelectorAll('#colorPalette .color-box').forEach(box => box.classList.remove('selected'));
            document.querySelectorAll('#iconGrid .icon-item').forEach(item => item.classList.remove('selected'));
            eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
            eventIconDisplay.classList.remove('selected');

            if (eventId) {
                modalTitle.textContent = 'Edit Event';
                saveEventButton.textContent = 'Update Event';
                deleteEventButton.classList.remove('hidden');

                const event = events.find(e => e.id === eventId);
                if (event) {
                    eventTitleInput.value = event.title;
                    eventDescriptionInput.value = event.description || '';
                    eventStartDescriptionInput.value = event.startDescription || '';
                    eventEndDescriptionInput.value = event.endDescription || '';

                    if (event.endDate) {
                        singleDayFields.classList.add('hidden');
                        multiDayFields.classList.remove('hidden');
                        eventStartDateInput.value = event.date;
                        eventEndDateInput.value = event.endDate;
                        eventStartTimeInput.value = event.time || '';
                        eventEndTimeInput.value = event.endTime || '';
                    } else {
                        singleDayFields.classList.remove('hidden');
                        multiDayFields.classList.add('hidden');
                        eventDateInput.value = event.date;
                        eventTimeInput.value = event.time || '';
                    }

                    try {
                        const eventColor = JSON.parse(event.color);
                        const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${eventColor.primary}"][data-text-color="${eventColor.text}"]`);
                        if (colorBox) {
                            colorBox.classList.add('selected');
                            eventColorInput.value = event.color;
                        }
                    } catch (e) {
                        console.error("Failed to parse event color:", event.color, e);
                    }

                    if (event.icon) {
                        eventIconDisplay.innerHTML = `<i class="${event.icon}"></i>`;
                        eventIconDisplay.classList.add('selected');
                        eventIconInput.value = event.icon;
                    }

                    if (event.effects) {
                        effectGlowing.checked = event.effects.glowing || false;
                        effectStriped.checked = event.effects.striped || false;
                        effectDotted.checked = event.effects.dotted || false;
                        effectParticles.checked = event.effects.particles || false;
                        effectSnowFalling.checked = event.effects.snowFalling || false;
                        effectGlisteningStars.checked = event.effects.glisteningStars || false;
                        effectGradient.checked = event.effects.gradientEffect || false;
                        effectAnimatedStripes.checked = event.effects.animatedStripes || false;
                        effectRainbowVertical.checked = event.effects.rainbowVertical || false;
                        effectSvgStars.checked = event.effects.svgStars || false;
                        effectInnerGlow.checked = event.effects.innerGlow || false;
                    }
                }
            } else {
                modalTitle.textContent = 'Add New Event';
                saveEventButton.textContent = 'Save Event';
                deleteEventButton.classList.add('hidden');

                if (isMultiDay) {
                    singleDayFields.classList.add('hidden');
                    multiDayFields.classList.remove('hidden');
                    eventStartDateInput.value = date;
                    eventEndDateInput.value = endDate;
                } else {
                    singleDayFields.classList.remove('hidden');
                    multiDayFields.classList.add('hidden');
                    eventDateInput.value = date;
                }

                initColorPalette();
                initIconGrid();
            }
        };

        const closeEventModal = () => {
            eventModal.classList.add('hidden');
            editingEventId = null;
        };

        const getCustomThemeColorsFromInputs = () => {
            return {
                bodyBg: themeBodyBgInput.value,
                mainText: themeTextColorInput.value,
                headerBg: themeHeaderBgInput.value,
                mainContainerBg: themeMainContainerBgInput.value,
                dayCellBg: themeDayCellBgInput.value,
                dayCellHoverBg: themeDayCellHoverBgInput.value,
                currentDayBg: themeCurrentDayBgInput.value,
                primaryButtonBg: themePrimaryButtonBgInput.value,
                primaryButtonText: themePrimaryButtonTextInput.value,
                secondaryButtonBg: themeSecondaryButtonBgInput.value,
                secondaryButtonText: themeSecondaryButtonTextInput.value,
                accentColor: themeAccentColorInput.value,
                dayCellBorder: themeDayCellBorderColorInput.value,
                arrowButtonBg: getComputedStyle(document.documentElement).getPropertyValue('--arrow-button-bg'),
                arrowButtonHoverBg: getComputedStyle(document.documentElement).getPropertyValue('--arrow-button-hover-bg'),
                arrowButtonText: getComputedStyle(document.documentElement).getPropertyValue('--arrow-button-text'),
                headerBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--header-border-color')
            };
        };

        const setCustomColorPickerState = (locked) => {
            console.log("Setting picker state - locked:", locked);
            areCustomColorPickersLocked = locked;
            
            const inputs = [
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            ];

            inputs.forEach(input => {
                input.disabled = locked;
            });

            if (locked) {
                colorPickersOverlay.classList.remove('hidden');
                watchAdButton.classList.remove('hidden');
                adLoadingSpinner.classList.add('hidden');
            } else {
                colorPickersOverlay.classList.add('hidden');
            }
        };

        const applyOrientationLock = (shouldLock) => {
            const isAndroid = /Android/i.test(navigator.userAgent);
            if (isAndroid && screen.orientation && screen.orientation.lock) {
                if (shouldLock) {
                    screen.orientation.lock('landscape').then(() => {
                        console.log("Screen orientation locked to landscape.");
                    }).catch((err) => {
                        console.warn("Could not lock screen orientation:", err);
                    });
                } else {
                    screen.orientation.unlock();
                    console.log("Screen orientation unlocked.");
                }
            } else if (isAndroid) {
                console.log("Screen orientation lock API not available or not supported on this Android device.");
            }
        };

        const renderSavedThemes = () => {
            savedThemePreviewsEl.innerHTML = '';
            savedCustomThemes.forEach((theme, index) => {
                const themePreviewDiv = document.createElement('div');
                themePreviewDiv.classList.add('last-saved-theme-preview', 'flex-shrink-0');
                themePreviewDiv.style.flexBasis = 'calc(20% - 8px)';

                const colorSwatches = document.createElement('div');
                colorSwatches.classList.add('color-swatches');
                colorSwatches.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness');

                const mainSwatch = document.createElement('div');
                mainSwatch.classList.add('color-swatch-main');
                mainSwatch.style.backgroundColor = theme.mainContainerBg;
                mainSwatch.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness');
                colorSwatches.appendChild(mainSwatch);

                const headerSwatch = document.createElement('div');
                headerSwatch.classList.add('color-swatch-header');
                headerSwatch.style.backgroundColor = theme.headerBg;
                headerSwatch.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness');
                colorSwatches.appendChild(headerSwatch);

                themePreviewDiv.appendChild(colorSwatches);

                const themeName = document.createElement('div');
                themeName.classList.add('theme-name');
                themeName.textContent = theme.name || `Theme ${index + 1}`;
                themePreviewDiv.appendChild(themeName);

                const applyButton = document.createElement('button');
                applyButton.classList.add('apply-button');
                applyButton.textContent = 'Apply';
                applyButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    currentBaseThemeKey = null;
                    currentBaseTheme = theme;
                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                });
                themePreviewDiv.appendChild(applyButton);

                savedThemePreviewsEl.appendChild(themePreviewDiv);
            });
        };

        const showThemeNameModal = (defaultName, callback) => {
            themeNameModal.classList.remove('hidden');
            themeNameInput.value = defaultName;
            themeNameInput.focus();

            const handleSave = () => {
                let name = themeNameInput.value.trim();
                if (name === "") {
                    name = defaultName;
                }
                themeNameModal.classList.add('hidden');
                callback(name);
                saveThemeNameButton.removeEventListener('click', handleSave);
                cancelThemeNameButton.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                themeNameModal.classList.add('hidden');
                callback(null);
                saveThemeNameButton.removeEventListener('click', handleSave);
                cancelThemeNameButton.removeEventListener('click', handleCancel);
            };

            saveThemeNameButton.addEventListener('click', handleSave);
            cancelThemeNameButton.addEventListener('click', handleCancel);

            themeNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSave();
                } else if (e.key === 'Escape') {
                    handleCancel();
                }
            }, { once: true });
        };


        const handleSaveCustomTheme = async () => {
            console.log("Save Custom Theme button clicked.");
            showThemeNameModal(`Custom Theme ${savedCustomThemes.length + 1}`, async (themeName) => {
                if (themeName === null) {
                    return;
                }

                const currentCustomColors = getCustomThemeColorsFromInputs();
                currentCustomColors.name = themeName;

                savedCustomThemes.unshift(currentCustomColors);

                if (savedCustomThemes.length > MAX_SAVED_THEMES) {
                    savedCustomThemes = savedCustomThemes.slice(0, MAX_SAVED_THEMES);
                }

                renderSavedThemes();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);

                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Custom theme "${themeName}" saved!</p>
                            <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
            });
        };

        const handleRemoveAllEvents = () => {
            console.log("Remove All Events button clicked.");
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove ALL calendar events?</p>
                        <p class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button danger" id="confirmRemoveEventsYes">Yes, Remove All</button>
                            <button class="themed-button secondary" id="confirmRemoveEventsNo">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveEventsYes').onclick = async () => {
                console.log("Confirmed: Removing all events.");
                events = [];
                await saveEvents();
                renderCalendar();
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveEventsNo').onclick = () => {
                console.log("Cancelled: Removing all events.");
                confirmBox.remove();
            };
        };

        const handleRemoveAllCustomThemes = () => {
            console.log("Remove All Custom Themes button clicked.");
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove ALL saved custom themes?</p>
                        <p class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button danger" id="confirmRemoveThemesYes">Yes, Remove All</button>
                            <button class="themed-button secondary" id="confirmRemoveThemesNo">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveThemesYes').onclick = async () => {
                console.log("Confirmed: Removing all custom themes.");
                savedCustomThemes = [];
                renderSavedThemes();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveThemesNo').onclick = () => {
                console.log("Cancelled: Removing all custom themes.");
                confirmBox.remove();
            };
        };


        const handleResetApplication = () => {
            console.log("Reset Application button clicked.");
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to reset the entire application?</p>
                        <p class="text-sm text-gray-600 mb-6">This will remove all events and settings. This action cannot be undone.</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button danger" id="confirmResetAppYes">Yes, Reset App</button>
                            <button class="themed-button secondary" id="confirmResetAppNo">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmResetAppYes').onclick = async () => {
                console.log("Confirmed: Resetting application.");
                await Preferences.clear();
                location.reload();
                confirmBox.remove();
            };
            document.getElementById('confirmResetAppNo').onclick = () => {
                console.log("Cancelled: Resetting application.");
                confirmBox.remove();
            };
        };


        const openSettingsModal = async () => {
            settingsModal.classList.remove('hidden');

            const loadedSettings = await loadSettings();

            if (loadedSettings.currentBaseThemeKey === null) {
                currentBaseTheme = loadedSettings.customThemeColors || { ...DEFAULT_LIGHT_THEME };
            } else {
                currentBaseTheme = null;
            }

            applyTheme(getEffectiveTheme(loadedSettings.currentBaseThemeKey, loadedSettings.isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });

            uiRoundnessInput.value = loadedSettings.currentUiRoundness;
            uiRoundnessValueDisplay.textContent = `${loadedSettings.currentUiRoundness}px`;
            uiRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(loadedSettings.currentUiRoundness) / 24) * 8}px`;

            fontSizeInput.value = loadedSettings.currentFontSize;
            fontSizeValueDisplay.textContent = `${loadedSettings.currentFontSize}px`;

            eventRoundnessInput.value = loadedSettings.currentEventRoundness;
            eventRoundnessValueDisplay.textContent = `${loadedSettings.currentEventRoundness}px`;
            eventRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(loadedSettings.currentEventRoundness) / 24) * 8}px`;

            eventBorderThicknessInput.value = loadedSettings.currentEventBorderThickness;
            eventBorderThicknessValueDisplay.textContent = `${loadedSettings.currentEventBorderThickness}px`;
            eventBorderThicknessValueDisplay.style.fontSize = `${14 + (parseInt(loadedSettings.currentEventBorderThickness) / 5) * 4}px`;

            dayCellMinWidthInput.value = loadedSettings.currentDayCellMinWidth;
            dayCellMinWidthValueDisplay.textContent = `${loadedSettings.currentDayCellMinWidth}px`;

            darkModeToggle.checked = loadedSettings.isDarkModeActive;
            isDarkModeActive = loadedSettings.isDarkModeActive;
            forceLandscapeToggle.checked = loadedSettings.forceLandscapeMode;
            forceLandscapeMode = loadedSettings.forceLandscapeMode;
            setCustomColorPickerState(areCustomColorPickersLocked);

            document.querySelectorAll('.theme-box').forEach(box => {
                if (box.dataset.themeKey === currentBaseThemeKey) {
                    box.classList.add('selected');
                } else {
                    box.classList.remove('selected');
                }
            });

            renderSavedThemes();
        };

        const closeSettingsModal = () => {
            settingsModal.classList.add('hidden');
        };

        const generateUniqueId = () => {
            return '_' + Math.random().toString(36).substr(2, 9);
        };

        const handleSaveEvent = async () => {
            const title = eventTitleInput.value.trim();
            const description = eventDescriptionInput.value.trim();
            const color = eventColorInput.value;
            const icon = eventIconInput.value;

            const effects = {
                glowing: effectGlowing.checked,
                striped: effectStriped.checked,
                dotted: effectDotted.checked,
                particles: effectParticles.checked,
                snowFalling: effectSnowFalling.checked,
                glisteningStars: effectGlisteningStars.checked,
                gradientEffect: effectGradient.checked,
                animatedStripes: effectAnimatedStripes.checked,
                rainbowVertical: effectRainbowVertical.checked,
                svgStars: effectSvgStars.checked,
                innerGlow: effectInnerGlow.checked
            };

            if (!title) {
                showMessage('Please enter an event title.');
                return;
            }

            let eventData;
            if (multiDayFields.classList.contains('hidden')) {

                const date = eventDateInput.value;
                const time = eventTimeInput.value.trim();
                
                if (!date) {
                    showMessage('Please select a date.');
                    return;
                }

                eventData = {
                    title,
                    date,
                    time,
                    description,
                    color,
                    icon,
                    effects
                };
            } else {

                const startDate = eventStartDateInput.value;
                const endDate = eventEndDateInput.value;
                const startTime = eventStartTimeInput.value.trim();
                const endTime = eventEndTimeInput.value.trim();

                if (!startDate || !endDate) {
                    showMessage('Please select both start and end dates.');
                    return;
                }

                if (new Date(endDate) < new Date(startDate)) {
                    showMessage('End date cannot be before start date.');
                    return;
                }

                eventData = {
                    title,
                    date: startDate,
                    endDate,
                    time: startTime,
                    endTime,
                    description,
                    startDescription: eventStartDescriptionInput.value.trim(),
                    endDescription: eventEndDescriptionInput.value.trim(),
                    color,
                    icon,
                    effects
                };
            }

            if (editingEventId) {
                const eventIndex = events.findIndex(e => e.id === editingEventId);
                if (eventIndex !== -1) {
                    events[eventIndex] = { ...events[eventIndex], ...eventData };
                }
            } else {
                const newEvent = {
                    id: generateUniqueId(),
                    ...eventData
                };
                events.push(newEvent);
            }

            await saveEvents();
            renderCalendar();
            closeEventModal();
        };

        const handleDeleteEvent = async () => {
            if (editingEventId) {
                const confirmBox = document.createElement('div');
                confirmBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to delete this event?</p>
                            <div class="flex justify-center space-x-4">
                                <button class="themed-button danger" id="confirmDeleteYes">Yes, Delete</button>
                                <button class="themed-button secondary" id="confirmDeleteNo">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirmDeleteYes').onclick = async () => {
                    events = events.filter(e => e.id !== editingEventId);
                    await saveEvents();
                    renderCalendar();
                    closeEventModal();
                    confirmBox.remove();
                };
                document.getElementById('confirmDeleteNo').onclick = () => {
                    confirmBox.remove();
                };
            }
        };

        const handleSaveSettings = async () => {
            console.log("Save Settings button clicked.");
            const uiRoundness = uiRoundnessInput.value;
            const fontSize = fontSizeInput.value;
            const eventRoundness = eventRoundnessInput.value;
            const eventBorderThickness = eventBorderThicknessInput.value;
            const dayCellMinWidth = dayCellMinWidthInput.value;
            const isDarkMode = darkModeToggle.checked;
            const newForceLandscapeMode = forceLandscapeToggle.checked;

            let customThemeColorsToSave = null;
            if (currentBaseThemeKey === null) {
                customThemeColorsToSave = getCustomThemeColorsFromInputs();
                currentBaseTheme = customThemeColorsToSave;
            }

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkMode), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });

            document.documentElement.style.setProperty('--ui-roundness', `${uiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${uiRoundness * 1.5}px`);
            document.getElementById('main-container').style.borderRadius = `${uiRoundness * 1.5}px`;
            document.querySelector('#event-modal .modal-content').style.borderRadius = `${uiRoundness * 1.5}px`;
            document.querySelector('#settings-modal .modal-content').style.borderRadius = `${uiRoundness * 1.5}px`;

            document.documentElement.style.setProperty('--base-font-size', `${fontSize}px`);
            document.documentElement.style.setProperty('--event-item-roundness', `${eventRoundness}px`);
            document.documentElement.style.setProperty('--event-item-border-thickness', `${eventBorderThickness}px`);
            document.documentElement.style.setProperty('--day-cell-min-width', `${dayCellMinWidth}px`);

            const fontToSave = currentCustomFontName || null;
            let fontDataToSave = null;
            if (fontToSave) {
                const storedSettingsValue = (await Preferences.get({ key: 'calendarSettings' })).value;
                if (storedSettingsValue) {
                    fontDataToSave = JSON.parse(storedSettingsValue).customFontData;
                }
            }

            await saveSettings(fontToSave, fontDataToSave, currentBaseThemeKey, isDarkMode, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColorsToSave, areCustomColorPickersLocked, unlockedSpecialThemesKeys, newForceLandscapeMode, savedCustomThemes);
            applyOrientationLock(newForceLandscapeMode);
            closeSettingsModal();
        };

        const showAdMobPlaceholder = () => {
            adMobPlaceholder.classList.remove('hidden');
        };

        const handleWatchAd = async () => {
            // IMPORTANT: Replace this with your actual AdMob rewarded interstitial ad unit ID
            // when you build your app for production.
            const adUnitId = ''; // Test Ad Unit ID for rewarded interstitial
            const isTesting = true; // Set to false when you are ready to publish your app!

            showAdMobPlaceholder('Loading Ad...');

            try {
                if (window.AdMob) {
                    // Check if AdMob plugin is available (only in Capacitor environment)
                    await window.AdMob.prepareRewardedInterstitial({
                        adId: adUnitId,
                        isTesting: isTesting,
                    });
                    await window.AdMob.showRewardedInterstitial();
                } else {
                    // Fallback for browser environment (not running in Capacitor)
                    console.warn('window.AdMob not found. Simulating rewarded ad experience.');
                    showAdMobPlaceholder('Showing Ad...');
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate ad duration
                    hideAdMobPlaceholder();
                    
                    // Simulate reward for browser testing
                    areCustomColorPickersLocked = false;
                    setCustomColorPickerState(false);
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                        uiRoundnessInput.value, fontSizeInput.value,
                        eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, 
                        currentBaseTheme, false, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
                }
            } catch (e) {
                console.error('Error preparing or showing rewarded ad:', e);
                hideAdMobPlaceholder();
                // Show error message to user
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Error loading ad. Please try again later.</p>
                            <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }
        };

        document.addEventListener('adMob.rewardedInterstitialAdDismissed', (event) => {
            // This event specifically fires for rewarded interstitial ads when dismissed.
            // It includes information about whether the user was rewarded.
            console.log('AdMob.rewardedInterstitialAdDismissed: Rewarded ad was dismissed.', event.detail);
            hideAdMobPlaceholder();
            if (event.detail && event.detail.rewarded) {
                console.log('AdMob: User was rewarded. Unlocking feature.');
                areCustomColorPickersLocked = false;
                setCustomColorPickerState(false);
                // Save the unlocked state
                saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                    uiRoundnessInput.value, fontSizeInput.value,
                    eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, 
                    currentBaseTheme, false, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
            } else {
                console.log('AdMob: User was not rewarded or dismissed ad without full completion.');
                // Show message that reward wasn't earned
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Ad dismissed without reward. Please watch the full ad to unlock features.</p>
                            <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }
        });

        document.addEventListener('adMob.adFailedToLoad', (data) => {
            console.error('AdMob.adFailedToLoad:', data.detail?.message || 'Unknown error');
            hideAdMobPlaceholder();
            // Show error message to user
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Ad failed to load: ${data.detail?.message || 'Unknown error'}</p>
                        <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        });

        document.addEventListener('adMob.adFailedToShow', (data) => {
            console.error('AdMob.adFailedToShow:', data.detail?.message || 'Unknown error');
            hideAdMobPlaceholder();
            // Show error message to user
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Ad failed to show: ${data.detail?.message || 'Unknown error'}</p>
                        <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        });


        window.onload = async () => {
            calendarEl = document.getElementById('calendar');
            currentMonthYearEl = document.getElementById('currentMonthYear');
            prevMonthButton = document.getElementById('prevMonth');
            nextMonthButton = document.getElementById('nextMonth');
            todayButton = document.getElementById('todayButton');
            settingsButton = document.getElementById('settingsButton');

            eventModal = document.getElementById('event-modal');
            modalTitle = document.getElementById('modal-title');
            eventTitleInput = document.getElementById('eventTitle');
            eventTimeInput = document.getElementById('eventTime');
            eventDateInput = document.getElementById('eventDate');
            eventDescriptionInput = document.getElementById('eventDescription');
            eventColorInput = document.getElementById('eventColor');
            iconGridEl = document.getElementById('iconGrid');
            eventIconInput = document.getElementById('eventIcon');
            colorPaletteEl = document.getElementById('colorPalette');
            saveEventButton = document.getElementById('saveEvent');
            deleteEventButton = document.getElementById('deleteEvent');
            cancelEventButton = document.getElementById('cancelEvent');
            iconSearchInput = document.getElementById('iconSearchInput');
            eventIconDisplay = document.getElementById('eventIconDisplay');

            effectGlowing = document.getElementById('effectGlowing');
            effectStriped = document.getElementById('effectStriped');
            effectDotted = document.getElementById('effectDotted');
            effectParticles = document.getElementById('effectParticles');
            effectSnowFalling = document.getElementById('effectSnowFalling');
            effectGlisteningStars = document.getElementById('effectGlisteningStars');
            effectGradient = document.getElementById('effectGradient');
            effectAnimatedStripes = document.getElementById('effectAnimatedStripes');
            effectRainbowVertical = document.getElementById('effectRainbowVertical');
            effectSvgStars = document.getElementById('effectSvgStars');
            effectInnerGlow = document.getElementById('effectInnerGlow');


            settingsModal = document.getElementById('settings-modal');
            customFontUploadInput = document.getElementById('customFontUpload');
            customFontNameDisplay = document.getElementById('customFontNameDisplay');
            resetCustomFontButton = document.getElementById('resetCustomFont');
            premadeThemeBoxesEl = document.getElementById('premadeThemeBoxes');
            specialThemeBoxesEl = document.getElementById('specialThemeBoxes');

            uiRoundnessInput = document.getElementById('uiRoundness');
            uiRoundnessValueDisplay = document.getElementById('uiRoundnessValue');
            fontSizeInput = document.getElementById('fontSize');
            fontSizeValueDisplay = document.getElementById('fontSizeValue');
            darkModeToggle = document.getElementById('darkModeToggle');
            forceLandscapeToggle = document.getElementById('forceLandscapeToggle');

            eventRoundnessInput = document.getElementById('eventRoundness');
            eventRoundnessValueDisplay = document.getElementById('eventRoundnessValue');
            eventBorderThicknessInput = document.getElementById('eventBorderThickness');
            eventBorderThicknessValueDisplay = document.getElementById('eventBorderThicknessValue');
            dayCellMinWidthInput = document.getElementById('dayCellMinWidth');
            dayCellMinWidthValueDisplay = document.getElementById('dayCellMinWidthValue');


            themeBodyBgInput = document.getElementById('themeBodyBg');
            themeTextColorInput = document.getElementById('themeTextColor');
            themeHeaderBgInput = document.getElementById('themeHeaderBg');
            themeMainContainerBgInput = document.getElementById('themeMainContainerBg');
            themeDayCellBgInput = document.getElementById('themeDayCellBg');
            themeDayCellHoverBgInput = document.getElementById('themeDayCellHoverBg');
            themeCurrentDayBgInput = document.getElementById('themeCurrentDayBg');
            themePrimaryButtonBgInput = document.getElementById('themePrimaryButtonBg');
            themePrimaryButtonTextInput = document.getElementById('themePrimaryButtonText');
            themeSecondaryButtonBgInput = document.getElementById('themeSecondaryButtonBg');
            themeSecondaryButtonTextInput = document.getElementById('themeSecondaryButtonText');
            themeAccentColorInput = document.getElementById('themeAccentColor');
            themeDayCellBorderColorInput = document.getElementById('themeDayCellBorderColor');

            saveSettingsButton = document.getElementById('saveSettings');
            cancelSettingsButton = document.getElementById('cancelSettings');

            adMobPlaceholder = document.getElementById('adMobPlaceholder');
            customColorPickersContainer = document.getElementById('customColorPickersContainer');
            colorPickersOverlay = document.getElementById('colorPickersOverlay');
            watchAdButton = document.getElementById('watchAdButton');
            adLoadingSpinner = document.getElementById('adLoadingSpinner');

            saveCustomThemeButton = document.getElementById('saveCustomThemeButton');
            savedThemePreviewsEl = document.getElementById('savedThemePreviews');
            removeAllEventsButton = document.getElementById('removeAllEventsButton');
            resetApplicationButton = document.getElementById('resetApplicationButton');
            removeAllCustomThemesButton = document.getElementById('removeAllCustomThemesButton');

            themeNameModal = document.getElementById('theme-name-modal');
            themeNameInput = document.getElementById('themeNameInput');
            cancelThemeNameButton = document.getElementById('cancelThemeName');
            saveThemeNameButton = document.getElementById('saveThemeName');

                    // Add these event listeners in your window.onload function
        document.addEventListener('adMob.adLoaded', () => {
            console.log('AdMob.adLoaded: Ad has loaded and is ready to show.');
            showAdMobPlaceholder('Ad Loaded, preparing to show...');
        });

        document.addEventListener('adMob.adShowed', () => {
            console.log('AdMob.adShowed: Ad is now visible.');
            hideAdMobPlaceholder(); // Hide the placeholder as the actual ad is now covering the screen
        });


            const loadedSettings = await loadSettings();

            if (loadedSettings.customFontData && loadedSettings.currentCustomFontName) {
                injectCustomFont(loadedSettings.currentCustomFontName, loadedSettings.customFontData);
                applyFont(loadedSettings.currentCustomFontName);
                customFontNameDisplay.textContent = loadedSettings.currentCustomFontName;
            } else {
                applyFont(DEFAULT_FONT_FAMILY);
                customFontNameDisplay.textContent = 'Inter (Default)';
            }
            currentCustomFontName = loadedSettings.currentCustomFontName;

            darkModeToggle.checked = loadedSettings.isDarkModeActive;
            isDarkModeActive = loadedSettings.isDarkModeActive;
            forceLandscapeToggle.checked = loadedSettings.forceLandscapeMode;
            forceLandscapeMode = loadedSettings.forceLandscapeMode;

            areCustomColorPickersLocked = loadedSettings.customColorPickersLocked;
            setCustomColorPickerState(areCustomColorPickersLocked);

            currentBaseThemeKey = loadedSettings.currentBaseThemeKey;
            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedSettings.customThemeColors || { ...DEFAULT_LIGHT_THEME };
            } else {
                currentBaseTheme = null;
            }


            initPremadeThemeBoxes();
            initSpecialThemeBoxes();

            uiRoundnessInput.value = loadedSettings.currentUiRoundness;
            uiRoundnessValueDisplay.textContent = `${loadedSettings.currentUiRoundness}px`;
            document.documentElement.style.setProperty('--ui-roundness', `${loadedSettings.currentUiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${loadedSettings.currentUiRoundness * 1.5}px`);
            const mainContainer = document.getElementById('main-container');
            if (mainContainer) {
                mainContainer.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;
            }
            const eventModalContent = document.querySelector('#event-modal .modal-content');
            if (eventModalContent) eventModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;
            const settingsModalContent = document.querySelector('#settings-modal .modal-content');
            if (settingsModalContent) settingsModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;

            fontSizeInput.value = loadedSettings.currentFontSize;
            fontSizeValueDisplay.textContent = `${loadedSettings.currentFontSize}px`;
            document.documentElement.style.setProperty('--base-font-size', `${loadedSettings.currentFontSize}px`);

            eventRoundnessInput.value = loadedSettings.currentEventRoundness;
            eventRoundnessValueDisplay.textContent = `${loadedSettings.currentEventRoundness}px`;
            document.documentElement.style.setProperty('--event-item-roundness', `${loadedSettings.currentEventRoundness}px`);

            eventBorderThicknessInput.value = loadedSettings.currentEventBorderThickness;
            eventBorderThicknessValueDisplay.textContent = `${loadedSettings.currentEventBorderThickness}px`;
            document.documentElement.style.setProperty('--event-item-border-thickness', `${loadedSettings.currentEventBorderThickness}px`);

            dayCellMinWidthInput.value = loadedSettings.currentDayCellMinWidth;
            dayCellMinWidthValueDisplay.textContent = `${loadedSettings.currentDayCellMinWidth}px`;
            document.documentElement.style.setProperty('--day-cell-min-width', `${loadedSettings.currentDayCellMinWidth}px`);

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });

            await loadEvents();
            initColorPalette();
            initIconGrid();
            renderCalendar();

            applyOrientationLock(forceLandscapeMode);

            prevMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthButton.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            todayButton.addEventListener('click', () => {
                currentDate = new Date();
                renderCalendar();
            });

            settingsButton.addEventListener('click', openSettingsModal);
            saveEventButton.addEventListener('click', handleSaveEvent);
            deleteEventButton.addEventListener('click', handleDeleteEvent);
            cancelEventButton.addEventListener('click', closeEventModal);
            saveSettingsButton.addEventListener('click', handleSaveSettings);
            cancelSettingsButton.addEventListener('click', closeSettingsModal);
            customFontUploadInput.addEventListener('change', handleFontUpload);
            resetCustomFontButton.addEventListener('click', resetCustomFont);

            iconSearchInput.addEventListener('input', (e) => {
                initIconGrid(e.target.value);
            });

            eventIconDisplay.addEventListener('click', () => {
                const iconSection = document.getElementById('iconSearchInput').closest('div');
                if (iconSection) {
                    const modalScrollableContent = eventModal.querySelector('.modal-content-scrollable');
                    if (modalScrollableContent) {
                        modalScrollableContent.scrollTo({
                            top: iconSection.offsetTop - (modalScrollableContent.offsetTop || 0),
                            behavior: 'smooth'
                        });
                    }
                }
            });


            uiRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                uiRoundnessValueDisplay.textContent = `${value}px`;
                uiRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 24) * 8}px`;
                document.documentElement.style.setProperty('--ui-roundness', `${value}px`);
                document.documentElement.style.setProperty('--ui-roundness-lg', `${value * 1.5}px`);
                document.getElementById('main-container').style.borderRadius = `${value * 1.5}px`;
                document.querySelector('#event-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                document.querySelector('#settings-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                renderSavedThemes();
            });

            eventRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventRoundnessValueDisplay.textContent = `${value}px`;
                eventRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 24) * 8}px`;
                document.documentElement.style.setProperty('--event-item-roundness', `${value}px`);
            });

            eventBorderThicknessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventBorderThicknessValueDisplay.textContent = `${value}px`;
                eventBorderThicknessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 5) * 4}px`;
                document.documentElement.style.setProperty('--event-item-border-thickness', `${value}px`);
            });

            fontSizeInput.addEventListener('input', (e) => {
                const value = e.target.value;
                fontSizeValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--base-font-size', `${value}px`);
            });

            dayCellMinWidthInput.addEventListener('input', (e) => {
                const value = e.target.value;
                dayCellMinWidthValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--day-cell-min-width', `${value}px`);
            });

            darkModeToggle.addEventListener('change', async () => {
                isDarkModeActive = darkModeToggle.checked;
                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                initColorPalette();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
            });

            forceLandscapeToggle.addEventListener('change', async () => {
                forceLandscapeMode = forceLandscapeToggle.checked;
                applyOrientationLock(forceLandscapeMode);
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, areCustomColorPickersLocked, unlockedSpecialThemesKeys, forceLandscapeMode, savedCustomThemes);
            });

            const updateThemeAndApply = async () => {
                currentBaseThemeKey = null;
                currentBaseTheme = getCustomThemeColorsFromInputs();

                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
            };

            themeBodyBgInput.addEventListener('input', updateThemeAndApply);
            themeTextColorInput.addEventListener('input', updateThemeAndApply);
            themeHeaderBgInput.addEventListener('input', updateThemeAndApply);
            themeMainContainerBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellHoverBgInput.addEventListener('input', updateThemeAndApply);
            themeCurrentDayBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeAccentColorInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBorderColorInput.addEventListener('input', updateThemeAndApply);

            watchAdButton.addEventListener('click', handleWatchAd);

            let mouseDownOnOverlay = false;
            eventModal.addEventListener('mousedown', (e) => {
                mouseDownOnOverlay = (e.target === eventModal);
            });
            eventModal.addEventListener('mouseup', (e) => {
                if (mouseDownOnOverlay && e.target === eventModal) {
                    closeEventModal();
                }
                mouseDownOnOverlay = false;
            });

            removeAllEventsButton.addEventListener('click', handleRemoveAllEvents);
            removeAllCustomThemesButton.addEventListener('click', handleRemoveAllCustomThemes);
            resetApplicationButton.addEventListener('click', handleResetApplication);
            saveCustomThemeButton.addEventListener('click', handleSaveCustomTheme); 

            eventStartDateInput = document.getElementById('eventStartDate');
            eventStartTimeInput = document.getElementById('eventStartTime');
            eventEndDateInput = document.getElementById('eventEndDate');
            eventEndTimeInput = document.getElementById('eventEndTime');
            eventStartDescriptionInput = document.getElementById('eventStartDescription');
            eventEndDescriptionInput = document.getElementById('eventEndDescription');
            singleDayFields = document.getElementById('singleDayFields');
            multiDayFields = document.getElementById('multiDayFields');
        };

        function formatTime(time, use24Hour = false) {
            if (!time) return '';
            
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            
            if (use24Hour) {
                return `${hours}:${minutes}`;
            } else {
                const period = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${period}`;
            }
        }

        document.getElementById('timeFormatToggle').addEventListener('change', function(e) {
            const use24Hour = e.target.checked;
            const timeElements = document.querySelectorAll('.time-display');
            timeElements.forEach(element => {
                const currentTime = element.getAttribute('data-time');
                if (currentTime) {
                    const [hours, minutes] = currentTime.split(':');
                    const date = new Date();
                    date.setHours(parseInt(hours));
                    date.setMinutes(parseInt(minutes));
                    
                    element.textContent = use24Hour 
                        ? date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                        : date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                }
            });
        });

        function enforceTitleWordWrap() {
            document.querySelectorAll('.title-part').forEach(el => {
                el.style.whiteSpace = 'normal';
                el.style.wordBreak = 'break-word';
                el.style.overflowWrap = 'break-word';
                el.style.paddingRight = '3em';
            });
        }

        document.addEventListener('DOMContentLoaded', enforceTitleWordWrap);

        const observer = new MutationObserver(enforceTitleWordWrap);
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aidah's Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&family=Open+Sans:wght@400;600&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --base-font-size: 16px;
            --ui-roundness: 8px;
            --ui-roundness-lg: calc(var(--ui-roundness) * 1.5);
            --ui-roundness-full: 9999px;
            --event-item-border-thickness: 3px;
            --event-item-roundness: 8px;
            --day-cell-min-width: 140px;
            --text-color: #4A4A4A;
            --header-bg: #ffffff;
            --primary-button-bg: #FFFFFF;
            --primary-button-text: #E085B0;
            --secondary-button-bg: #F3E0E9;
            --secondary-button-text: #8B4B66;
            --accent-color: #E085B0;
            --day-cell-border-color: #D4DDE3;
            --main-container-bg: #ffffff;
            --day-cell-bg: #ffffff;
            --day-cell-hover-bg-color: #F8F0F5;
            --current-day-bg: #FFEAF4;
            --arrow-button-bg: transparent;
            --arrow-button-hover-bg: rgba(0,0,0,0.05);
            --arrow-button-text: #4B5563;
            --header-border-color: #E5E7EB;
            --day-cell-drag-bg: #e0f7fa;
            --current-day-border-color: var(--accent-color);
            --drag-over-border-color: var(--accent-color);
            --slider-track-bg: var(--secondary-button-bg);
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --custom-pickers-overlay-bg: rgba(255, 255, 255, 0.5);
            --holder-sidebar-width: 250px; 
            --holder-border-thickness: 2px; 

            --main-container-margin: 1rem auto;
            --main-container-width: 90vw;
            --main-container-height: calc(100vh - 2rem);
            --main-container-border-radius-actual: var(--ui-roundness-lg);
            --icon-padding-right: 0;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
            font-size: var(--base-font-size);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #main-container {
            margin: var(--main-container-margin);
            width: var(--main-container-width);
            max-width: var(--main-container-width);
            height: var(--main-container-height);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--main-container-bg);
            border-radius: var(--main-container-border-radius-actual);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            transition: all 0.2s ease-out;
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                padding: 0;
            }
            #main-container {
                width: 100vw;
                max-width: 100vw;
                height: 100vh;
                max-height: 100vh;
                margin: 0;
                border-radius: 0 !important;
                padding: 1rem;
            }
            #main-container > div.modal-content, #settings-modal > div.modal-content {
                border-radius: 0 !important;
            }
        }

        .calendar-scroll-container {
            flex-grow: 1;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
            margin-bottom: -0.5rem;
        }
        .calendar-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: transparent;
        }
        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
        }
        .calendar-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .hide-scrollbars::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbars {
            scrollbar-width: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(var(--day-cell-min-width), 1fr));
            gap: 0.75rem;
            min-width: calc(7 * var(--day-cell-min-width) + 6 * 0.75rem);
            flex-shrink: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .day-cell {
            min-height: 120px;
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 3px solid var(--day-cell-border-color);
            background-color: var(--day-cell-bg);
            padding-bottom: 0.5rem;
            border-radius: var(--ui-roundness);
        }
        .day-cell.inactive {
            background-color: var(--body-bg);
            opacity: 0.9;
        }
        .day-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: var(--day-cell-hover-bg-color);
        }
        .current-day {
            border: 3px solid var(--current-day-border-color);
            background-color: var(--current-day-bg);
        }
        .day-cell.drag-over {
            border: 3px dashed var(--drag-over-border-color);
            background-color: var(--day-cell-drag-bg);
        }

        .day-cell.folded {
            max-height: 140px; 
            overflow: hidden;
            position: relative;
        }


        .day-cell.folded:hover {
            overflow-y: auto; 
        }
        .day-cell.folded.hide-scrollbars::-webkit-scrollbar {
            display: none;
        }
        .day-cell.folded.hide-scrollbars {
            scrollbar-width: none;
        }


        .event-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.4rem 0.6rem;
            font-size: 0.75em;
            margin-bottom: 0.25rem;
            cursor: grab;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
            border-width: var(--event-item-border-thickness);
            border-style: solid;
            border-radius: var(--event-item-roundness);
            position: relative;
        }
        .event-item:hover {
            filter: brightness(1.05);
        }
        .event-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--drag-over-border-color);
        }
        .event-item.drop-target-top {
            border-top: 3px solid var(--accent-color);
        }
        .event-item.drop-target-bottom {
            border-bottom: 3px solid var(--accent-color);
        }

        .event-item.striped-effect {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
        }

        .event-item.dotted-effect {
            background-image: radial-gradient(circle at 3px 3px, var(--event-item-text-color-rgba-25) 2px, transparent 0);
            background-size: 8px 8px;
        }

        .event-item.glowing {
            box-shadow: 0 0 8px var(--event-item-text-color), 0 0 15px var(--event-item-text-color);
        }

        .event-item.particles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-shadow:
                0px 0px 0 0px var(--event-item-text-color),
                10px 15px 0 0px var(--event-item-text-color),
                -5px 20px 0 0px var(--event-item-text-color),
                15px 5px 0 0px var(--event-item-text-color),
                -10px -10px 0 0px var(--event-item-text-color);
            animation: particle-flow 5s linear infinite;
            opacity: 0.7;
        }

        @keyframes particle-flow {
            0% {
                transform: translate(0, 0);
                opacity: 0.7;
                box-shadow:
                    0px 0px 0 0px var(--event-item-text-color),
                    10px 15px 0 0px var(--event-item-text-color),
                    -5px 20px 0 0px var(--event-item-text-color),
                    15px 5px 0 0px var(--event-item-text-color),
                    -10px -10px 0 0px var(--event-item-text-color);
            }
            100% {
                transform: translate(calc(100% * var(--particle-x-dir, 1)), calc(100% * var(--particle-y-dir, 1)));
                opacity: 0;
                box-shadow:
                    calc(100% * var(--particle-x-dir, 1)) calc(100% * var(--particle-y-dir, 1)) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 10px) calc(100% * var(--particle-y-dir, 1) + 15px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 5px) calc(100% * var(--particle-y-dir, 1) + 20px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) + 15px) calc(100% * var(--particle-y-dir, 1) + 5px) 0 0px var(--event-item-text-color),
                    calc(100% * var(--particle-x-dir, 1) - 10px) calc(100% * var(--particle-y-dir, 1) - 10px) 0 0px var(--event-item-text-color);
            }
        }

        .event-item.snow-falling::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(ellipse at 20% 10%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 70% 30%, var(--event-item-text-color-rgba-25) 2px, transparent 4px),
                radial-gradient(ellipse at 50% 50%, var(--event-item-text-color-rgba-25) 2.5px, transparent 5px),
                radial-gradient(ellipse at 90% 70%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 30% 90%, var(--event-item-text-color-rgba-25) 2.2px, transparent 4.4px),
                radial-gradient(ellipse at 10% 60%, var(--event-item-text-color-rgba-25) 2.4px, transparent 4.8px),
                radial-gradient(ellipse at 40% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(ellipse at 80% 10%, var(--event-item-text-color-rgba-25) 1.2px, transparent 2.4px),
                radial-gradient(ellipse at 15% 40%, var(--event-item-text-color-rgba-25) 1.5px, transparent 3px),
                radial-gradient(ellipse at 60% 80%, var(--event-item-text-color-rgba-25) 1.8px, transparent 3.6px),
                radial-gradient(ellipse at 25% 70%, var(--event-item-text-color-rgba-25) 1.3px, transparent 2.6px),
                radial-gradient(ellipse at 85% 50%, var(--event-item-text-color-rgba-25) 1.7px, transparent 3.4px);
            background-size: 200px 200px;
            animation: snow-fall 5s linear infinite;
            pointer-events: none;
        }

        @keyframes snow-fall {
            0% { 
                background-position: 
                    0 0, 50px 50px, 100px 100px, 150px 150px, 200px 200px, 250px 250px,
                    30px 30px, 80px 80px, 130px 130px, 180px 180px, 230px 230px, 280px 280px; 
            }
            100% { 
                background-position: 
                    0 400px, 50px 450px, 100px 500px, 150px 550px, 200px 600px, 250px 650px,
                    30px 430px, 80px 480px, 130px 530px, 180px 580px, 230px 630px, 280px 680px; 
            }
        }

        .event-item.glistening-stars::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(circle at 10% 20%, var(--event-item-text-color-rgba-25) 1px, transparent 2px),
                radial-gradient(circle at 70% 80%, var(--event-item-text-color-rgba-25) 1.2px, transparent 2.2px),
                radial-gradient(circle at 40% 60%, var(--event-item-text-color-rgba-25) 0.8px, transparent 1.8px),
                radial-gradient(circle at 90% 30%, var(--event-item-text-color-rgba-25) 1.1px, transparent 2.1px),
                radial-gradient(circle at 25% 70%, var(--event-item-text-color-rgba-25) 0.9px, transparent 1.9px),
                radial-gradient(circle at 60% 10%, var(--event-item-text-color-rgba-25) 1.3px, transparent 2.3px);
            background-size: 50px 50px;
            animation: twinkle 2s ease-in-out infinite alternate, twinkle-scale 3s ease-in-out infinite;
            animation-delay: 0s, 1s;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            70% { opacity: 1; }
        }

        @keyframes twinkle-scale {
            0% { transform: scale(1); }
            40% { transform: scale(0.95); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }


        .event-item.gradient-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(45deg, 
                    var(--event-item-text-color-rgba-25) 0%, 
                    hsla(180, 100%, 50%, 0.315) 25%, 
                    hsla(270, 100%, 50%, 0.321) 50%,
                    hsla(0, 100%, 50%, 0.268) 75%, 
                    var(--event-item-text-color-rgba-25) 100%);
            background-size: 200% 200%;
            animation: 
                subtle-gradient 6s ease-in-out infinite alternate,
                hue-rotate 12s linear infinite;
            mix-blend-mode: overlay;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes subtle-gradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes hue-rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .event-item.animated-stripes {
            background-image: linear-gradient(
                45deg,
                var(--event-item-text-color-rgba-25) 25%,
                transparent 25%,
                transparent 50%,
                var(--event-item-text-color-rgba-25) 50%,
                var(--event-item-text-color-rgba-25) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: stripes-animation 2s linear infinite;
        }

        @keyframes stripes-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 0;
            }
        }

.event-item.animated-vertical-rainbow {
    position: relative;
    overflow: hidden;
}

.event-item.animated-vertical-rainbow::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        to bottom,
        hsla(0, 100%, 50%, 0.3) 0%,
        hsla(30, 100%, 50%, 0.3) 10%,
        hsla(60, 100%, 50%, 0.3) 20%,
        hsla(120, 100%, 50%, 0.3) 40%,
        hsla(240, 100%, 50%, 0.3) 60%,
        hsla(270, 100%, 50%, 0.3) 80%,
        hsla(300, 100%, 50%, 0.3) 100%
    );
    background-size: 100% 300%;
    animation: vertical-rainbow-scroll 1s linear infinite;
    z-index: 0;
    mix-blend-mode: overlay;
    opacity: 0.5;
    pointer-events: none;
    border-radius: inherit;
}

@keyframes vertical-rainbow-scroll {
    0% { background-position: 0% 0%; }
    100% { background-position: 0% 100%; }
}

.event-item.animated-vertical-rainbow > * {
    position: relative;
    z-index: 1;
}





        .event-item.no-animations {
            animation: none !important;
            transition: none !important;
        }
        .event-item.no-animations::before,
        .event-item.no-animations::after {
            animation: none !important;
            transition: none !important;
            display: none !important;
        }


        .event-item .main-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .event-item .text-content {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-grow: 1;
            min-width: 0;
        }
        .event-item .text-content .time-title-wrapper {
            display: flex;
            flex-wrap: wrap;
            flex-grow: 1;
            min-width: 0;
            align-items: baseline;
        }
        .event-item .text-content .time-title-wrapper .time-part {
            flex-shrink: 0;
            white-space: nowrap;
            margin-right: 0.25rem;
        }
        .event-item .text-content .time-title-wrapper .title-part {
            flex-grow: 1;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-item .event-icon-container {
            position: absolute;
            top: 0.1rem;
            right: 0.6rem;
            z-index: 10;
            font-size: 1.25rem;
            width: 1.5rem;
            text-align: center;
        }

        .event-description {
            font-size: 0.85em;
            white-space: normal;
            line-height: 1.2;
            margin-top: 0.2rem;
            padding-bottom: 3px;
            width: 100%;
            word-break: break-word;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background-color: var(--main-container-bg);
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            max-height: 90vh;
            overflow-y: hidden;
            border-radius: var(--ui-roundness-lg);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
            border-radius: var(--ui-roundness-lg);
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        #settings-modal .modal-content {
            max-width: 720px;
        }

        .modal-content-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-right: 0.5rem;
        }
        .modal-content-scrollable::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .modal-content-scrollable::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .modal-content-scrollable {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .modal-footer {
            position: sticky;
            bottom: 0;
            background-color: var(--main-container-bg);
            padding: 1.5rem 1.5rem 1.5rem 0;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-bottom-left-radius: var(--ui-roundness-lg);
            border-bottom-right-radius: var(--ui-roundness-lg);
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            border: 3px solid var(--day-cell-border-color);
            padding: 0.5rem;
            border-radius: var(--ui-roundness);
        }
        .icon-grid::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
            border: 2px solid transparent;
        }
        .icon-grid::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        .icon-grid {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }


        .icon-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            background-color: var(--secondary-button-bg);
            cursor: pointer;
            font-size: 1.25em;
            transition: background-color 0.2s, transform 0.1s, color 0.2s;
            border-radius: var(--ui-roundness);
            color: var(--secondary-button-text);
        }
        .icon-item.selected {
            background-color: var(--primary-button-bg);
            border: 2px solid var(--primary-button-text);
            color: var(--primary-button-text);
        }
        .icon-item:hover {
            background-color: var(--secondary-button-hover-bg);
            transform: scale(1.05);
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .color-box {
            width: 30px;
            height: 30px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.1s;
            border-radius: var(--ui-roundness);
        }
        .color-box.selected {
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        .color-box:hover {
            transform: scale(1.05);
        }

        .theme-box {
            width: 150px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            border: 3px solid rgba(var(--secondary-button-text-rgb), 0.5); 
            border-radius: var(--ui-roundness);
            transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .theme-box .color-preview {
            width: 40px;
            height: 20px;
            border-radius: var(--ui-roundness);
            margin-bottom: 0.25rem;
            border: 1px solid rgba(0,0,0,0.1);
        }


        .theme-box.selected {
            border-width: 4px;
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .special-theme-box.selected {
            border-width: 4px !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
        }
        .theme-box:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .custom-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        .custom-file-input + label {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            border-radius: var(--ui-roundness);
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--secondary-button-text);
            width: 100%;
            justify-content: center;
        }
        .custom-file-input + label:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .custom-file-input:focus + label {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .themed-button {
            padding: 0.75rem 1.5rem;
            border-radius: var(--ui-roundness);
            font-weight: 600;
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 3px solid var(--primary-button-text);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .themed-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
            border-color: var(--primary-button-text);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .themed-button.secondary {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 3px solid var(--secondary-button-text);
        }
        .themed-button.secondary:hover {
            background-color: var(--secondary-button-text);
            color: var(--secondary-button-bg);
            border-color: var(--secondary-button-text);
        }
        .themed-button.danger {
            background-color: #ef4444;
            color: white;
            border: 3px solid #dc2626;
        }
        .themed-button.danger:hover {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        input[type="text"], textarea {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        #iconSearchInput {
            border: 3px solid var(--day-cell-border-color);
        }

        input[type="time"], input[type="date"] {
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            padding: 0.75rem;
            border: 3px solid var(--day-cell-border-color);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            position: relative;
            padding-right: 2.5rem;
        }

        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--day-cell-border-color); 
        }
        input[type="time"]:focus::-webkit-calendar-picker-indicator,
        input[type="date"]:focus::-webkit-calendar-picker-indicator {
            color: var(--accent-color);
        }
        input[type="time"]::-moz-calendar-picker-indicator,
        input[type="date"]::-moz-calendar-picker-indicator {
            background: none;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            color: var(--day-cell-border-color);
        }
        input[type="time"]:focus::-moz-calendar-picker-indicator,
        input[type="date"]:focus::-moz-calendar-picker-indicator {
            color: var(--accent-color); 
        }


        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: var(--slider-track-bg);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s, background-color .2s, box-shadow .2s;
            border-radius: var(--ui-roundness);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.1);
            cursor: grabbing;
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: var(--ui-roundness);
            background: var(--accent-color);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--primary-button-text);
        }
        input[type="range"]::-moz-range-thumb:hover {
            background-color: var(--primary-button-bg);
            border-radius: var(--ui-roundness);
        }
        input[type="range"]::-moz-range:active {
            transform: scale(1.1);
            cursor: grabbing;
        }


        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
            border-radius: var(--ui-roundness);
        }
        input[type="color"]::-moz-color-swatch {
            border: 1px solid #ccc;
            border-radius: var(--ui-roundness);
        }
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .color-input-group label {
            flex-grow: 1;
            font-size: 0.9em;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .toggle-container + .toggle-container {
            margin-top: 0.55rem;
        }

        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 44px;
            width: 44px;
            height: 26px;
            background-color: var(--secondary-button-bg);
            border-radius: var(--ui-roundness);
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 3px; 
            left: 3px; 
            width: 20px;
            height: 20px;
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-radius: var(--ui-roundness);
        }

        input[type="checkbox"]:checked::before {
            transform: translateX(18px);
            background-color: #ffffff;
            border-radius: var(--ui-roundness);
        }

        .toggle-label {
            margin-left: 0.5rem;
            cursor: pointer;
            display: inline-block;
            color: var(--text-color);
            flex-grow: 1;
            white-space: normal;
        }


        .special-theme-box {
            position: relative;
            border: 3px solid rgba(var(--secondary-button-text-rgb), 0.5);
        }

        .special-theme-lock-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--ui-roundness);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
        }

        .special-theme-box.unlocked .special-theme-lock-overlay {
            opacity: 0;
            pointer-events: none;
        }

        .special-theme-box.unlocked {
             border-color: var(--accent-color) !important;
        }

        .h4-settings {
            font-size: calc(var(--base-font-size) * 1.125);
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .last-saved-theme-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 3px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            padding: 0.5rem;
            background-color: var(--day-cell-bg);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            min-width: 100px;
        }
        .last-saved-theme-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .last-saved-theme-preview .color-swatches {
            display: flex;
            gap: 2px;
            width: 100%;
            height: 30px;
            border-radius: var(--ui-roundness);
            overflow: hidden;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .last-saved-theme-preview .color-swatch-main {
            flex-grow: 1;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .color-swatch-header {
            width: 30%;
            border-radius: var(--ui-roundness);
        }
        .last-saved-theme-preview .theme-name {
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .last-saved-theme-preview .apply-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: var(--ui-roundness);
            background-color: var(--primary-button-bg);
            color: var(--primary-button-text);
            border: 2px solid var(--primary-button-text);
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .last-saved-theme-preview .apply-button:hover {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
        }

        .event-icon-display {
            width: 60px;
            height: 60px; 
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--ui-roundness);
            color: var(--text-color);
            background-color: var(--day-cell-bg);
            border: 3px solid var(--day-cell-border-color);
            cursor: pointer;
            font-size: 1.5em; 
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .event-icon-display:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }
        .event-icon-display.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        #holder-sidebar {
            background-color: var(--main-container-bg);
            border-right: var(--holder-border-thickness) solid var(--day-cell-border-color); 
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.15);
            transition: left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out;
            width: var(--holder-sidebar-width);
            overflow: hidden;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: calc(-1 * var(--holder-sidebar-width));
            height: 100%;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
        }
        #holder-sidebar.active {
            pointer-events: auto;
            left: 0;
        }

        #holder-sidebar h3 {
            color: var(--text-color);
            transition: color 0.3s ease-in-out;
            text-align: center;
            margin-bottom: 1rem;
        }
        #holder-content {
            border-color: var(--day-cell-border-color);
            background-color: var(--day-cell-bg);
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
            border: 2px dashed var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
        }

        #addHolderEventButton.styled-like-holder {
            background-color: var(--day-cell-bg);
            color: var(--text-color);
            border: 3px solid var(--day-cell-border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        #addHolderEventButton.styled-like-holder:hover {
            background-color: var(--day-cell-hover-bg-color);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #eventContextMenu {
            position: fixed;
            background-color: var(--main-container-bg);
            border: 1px solid var(--day-cell-border-color);
            border-radius: var(--ui-roundness);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0.5rem 0;
            min-width: 150px;
            display: none;
            flex-direction: column;
        }

        #eventContextMenu button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1rem;
            width: 100%;
            text-align: left;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #eventContextMenu button:hover {
            background-color: var(--day-cell-hover-bg-color);
        }

        #holderSidebarCloseButton {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            z-index: 60;
        }

        @media (max-width: 768px) {
            #holderSidebarCloseButton {
                display: block;
            }
        }

        .dark-mode-toggle-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1em; 
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: var(--ui-roundness);
            border: 3px solid var(--secondary-button-text);
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 100px;
            height: calc(80px * 2 + 0.75rem);             
            flex-shrink: 0; 
        }
        .dark-mode-toggle-button.selected {
            background-color: var(--primary-button-text);
            color: var(--primary-button-bg);
            border-color: var(--primary-button-text);
            border-width: 4px;
        }
        .dark-mode-toggle-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .dark-mode-toggle-button .small-text {
            font-size: 0.7em; 
            font-weight: 400;
            margin-top: 0.25rem;
        }

        #premadeThemeBoxesContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            width: 100%; 
        }

        #premadeThemeBoxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            flex-grow: 1; 
            justify-content: flex-start;
        }

        @media (min-width: 768px) {

            .modal-content {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            #premadeThemeBoxesContainer {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            #premadeThemeBoxes {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 0.75rem;
                width: auto;
                transform: translateX(6px);
            }

            #specialThemeBoxes {
                display: grid;
                width: auto;
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(3, 1fr);
                gap: 0.75rem;
            }
            
            .dark-mode-toggle-button {
                height: auto;
                min-height: calc(85px * 2 + 0.75rem);
            }
            
        }

        @media (max-width: 767px) { 
            #premadeThemeBoxesContainer {
                flex-direction: column; 
                align-items: center;
            }
            .dark-mode-toggle-button {
                width: 100%; 
                height: auto; 
                margin-bottom: 0.75rem; 
            }
            #premadeThemeBoxes {
                width: 100%; 
                justify-content: center; 
            }
            #premadeThemeBoxes .theme-box,
            #specialThemeBoxes .theme-box {
                flex-basis: calc(50% - 0.375rem); 
                max-width: calc(50% - 0.375rem);
            }
            
        }

        .resize-handle {
            width: 1.5px;
            height: 100%;
            background-color: var(--day-cell-border-color);
            position: absolute;
            right: 0;
            top: 0;
            cursor: ew-resize;
            z-index: 51;
            transition: background-color 0.2s ease;
        }
        .resize-handle:hover {
            background-color: var(--accent-color);
        }
    </style>
</head>
<body>

    <div class="bg-white shadow-2xl p-6 w-full overflow-hidden transform transition-all duration-300"
         id="main-container">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4"
             style="border-color: var(--header-border-color);">
            <div class="flex items-center space-x-2 mb-4 md:mb-0">
                <button id="hamburgerIcon" class="p-3 transition duration-200 ease-in-out -ml-2 hidden"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-bars"></i>
                </button>
                <button id="prevMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="currentMonthYear" class="font-extrabold text-3xl tracking-tight"
                    style="color: var(--text-color);"></h2>
                <button id="nextMonth" class="p-3 transition duration-200 ease-in-out"
                        style="border-radius: var(--ui-roundness); background-color: var(--arrow-button-bg); color: var(--arrow-button-text);">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="todayButton" class="themed-button">
                    Today
                </button>
                <button id="settingsButton" class="themed-button secondary">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>

        <div class="calendar-scroll-container">
            <div class="calendar-grid text-center font-bold text-sm uppercase tracking-wide mb-2"
                 style="color: var(--text-color);">
                <div class="p-2">Sun</div>
                <div class="p-2">Mon</div>
                <div class="p-2">Tue</div>
                <div class="p-2">Wed</div>
                <div class="p-2">Thu</div>
                <div class="p-2">Fri</div>
                <div class="p-2">Sat</div>
            </div>

            <div id="calendar" class="calendar-grid">
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4" style="color: var(--text-color);">Add New Event</h3>
            <div class="modal-content-scrollable">
                <div class="mb-4">
                    <label for="eventTitle" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);"> Event Icon & Title</label>
                    <div class="flex items-center space-x-2">
                        <div id="eventIconDisplay" class="event-icon-display">
                            <i class="fas fa-plus"></i> 
                        </div>
                        <input type="text" id="eventTitle" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 flex-grow">
                    </div>
                </div>

                <div class="mb-4 flex space-x-4">
                    <div class="w-1/2">
                        <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Time (Optional)</label>
                        <input type="time" id="eventTime" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                    </div>
                    <div class="w-1/2">
                        <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Date</label>
                        <input type="date" id="eventDate" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Description (Optional)</label>
                    <textarea id="eventDescription" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Event Color</label>
                    <div id="colorPalette" class="color-palette">
                        </div>
                    <input type="hidden" id="eventColor">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Effects</label>
                    <div class="flex flex-col space-y-2">
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGlowing">
                            <span class="toggle-label">Glowing</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectStriped">
                            <span class="toggle-label">Striped</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectDotted">
                            <span class="toggle-label">Dotted</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Animated Effects</label>
                    <div class="flex flex-col space-y-2">
                        <label class="toggle-container">
                            <input type="checkbox" id="effectParticles">
                            <span class="toggle-label">Particles</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectSnowFalling">
                            <span class="toggle-label">Snow Falling</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGlisteningStars">
                            <span class="toggle-label">Glistening Stars</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectAnimatedStripes">
                            <span class="toggle-label">Animated Stripes</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectGradient">
                            <span class="toggle-label">Animated Gradient</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="effectAnimatedVerticalRainbow">
                            <span class="toggle-label">Animated Vertical Rainbow</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-color);">Choose Icon</label>
                    <input type="text" id="iconSearchInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 mb-3" placeholder="Search icons...">
                    <div id="iconGrid" class="icon-grid">
                        </div>
                    <input type="hidden" id="eventIcon">
                </div>
            </div>

            <div class="modal-footer">
                <button id="deleteEvent" class="themed-button secondary hidden">Delete</button>
                <button id="cancelEvent" class="themed-button secondary">Cancel</button>
                <button id="saveEvent" class="themed-button">Save Event</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Settings</h3>

            <div class="modal-content-scrollable">
                <div class="mb-6">
                    <h4 class="h4-settings">Custom Font Upload</h4>
                    <input type="file" id="customFontUpload" accept=".ttf,.otf,.woff,.woff2" class="custom-file-input">
                    <label for="customFontUpload">
                        <i class="fas fa-upload"></i>
                        <span>Upload Font File</span>
                    </label>
                    <div id="currentCustomFontDisplay" class="mt-2 text-sm text-gray-600" style="color: var(--text-color);">
                        <span class="font-semibold">Current:</span> <span id="customFontNameDisplay">Inter (Default)</span>
                    </div>
                    <button id="resetCustomFont" class="themed-button secondary mt-2">Reset to Default</button>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">UI Roundness</h4>
                    <input type="range" id="uiRoundness" min="0" max="24" value="8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="uiRoundnessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">8px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Event Roundness</h4>
                    <input type="range" id="eventRoundness" min="0" max="24" value="8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="eventRoundnessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">8px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Event Border Thickness</h4>
                    <input type="range" id="eventBorderThickness" min="0" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="eventBorderThicknessValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">3px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Base Font Size</h4>
                    <input type="range" id="fontSize" min="12" max="36" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="fontSizeValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">16px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Day Cell Minimum Width</h4>
                    <input type="range" id="dayCellMinWidth" min="100" max="300" value="140" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="dayCellMinWidthValue" class="block text-sm text-gray-600 mt-2 text-right" style="color: var(--text-color);">140px</span>
                </div>

                <div class="mb-6">
                    <h4 class="h4-settings">Application Settings</h4>
                    <div class="toggle-container">
                        <input type="checkbox" id="use24HourFormatToggle">
                        <label for="use24HourFormatToggle" class="toggle-label">Use 24-Hour Format</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="hideScrollbarsToggle">
                        <label for="hideScrollbarsToggle" class="toggle-label">Hide Scrollbars</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="noBackgroundToggle">
                        <label for="noBackgroundToggle" class="toggle-label">No Background (Full Screen)</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="foldDayCellsToggle">
                        <label for="foldDayCellsToggle" class="toggle-label">Fold Day Cells (on hover)</label>
                    </div>
                    
                    <h4 class="h4-settings">Holder</h4>
                    <div class="toggle-container">
                        <input type="checkbox" id="holderIconToggle">
                        <label for="holderIconToggle" class="toggle-label">Show Holder Icon</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="showHolderByDefaultToggle">
                        <label for="showHolderByDefaultToggle" class="toggle-label">Show Holder Sidebar by Default</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="disableSidebarAnimationsToggle">
                        <label for="disableSidebarAnimationsToggle" class="toggle-label">Disable Sidebar Animations</label>
                    </div>
                    <div class="toggle-container">
                        <input type="checkbox" id="hideAddEventButtonInHolderToggle">
                        <label for="hideAddEventButtonInHolderToggle" class="toggle-label">Hide Add Event Button in Holder</label>
                    </div>


                    <div class="mb-4">
                        <h4 class="h4-settings">Pre-made Themes</h4>
                        <div id="premadeThemeBoxesContainer">
                            <button id="darkModeButton" class="dark-mode-toggle-button">
                                Dark Mode <span class="small-text">(Off)</span>
                            </button>
                            <div id="premadeThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="h4-settings">Special Themes</h4>
                        <div id="specialThemeBoxes" class="flex flex-wrap gap-3 mt-2 justify-center">
                            </div>
                    </div>

                    <div id="customColorPickersContainer" class="relative">
                        <h4 class="h4-settings">Custom Theming</h4>
                        <div class="color-input-group">
                            <label for="themeBodyBg">Background Color</label>
                            <input type="color" id="themeBodyBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeTextColor">Main Text Color</label>
                            <input type="color" id="themeTextColor">
                        </div>
                         <div class="color-input-group">
                            <label for="themeHeaderBg">Header Background</label>
                            <input type="color" id="themeHeaderBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeMainContainerBg">Main Container Background</label>
                            <input type="color" id="themeMainContainerBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellBg">Day Cell Background</label>
                            <input type="color" id="themeDayCellBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellHoverBg">Day Cell Hover Background</label>
                            <input type="color" id="themeDayCellHoverBg">
                        </div>
                         <div class="color-input-group">
                            <label for="themeCurrentDayBg">Today's Day Cell Background</label>
                            <input type="color" id="themeCurrentDayBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themePrimaryButtonBg">Primary Button Background</label>
                            <input type="color" id="themePrimaryButtonBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themePrimaryButtonText">Primary Button Text</label>
                            <input type="color" id="themePrimaryButtonText">
                        </div>
                         <div class="color-input-group">
                            <label for="themeSecondaryButtonBg">Secondary Button Background</label>
                            <input type="color" id="themeSecondaryButtonBg">
                        </div>
                        <div class="color-input-group">
                            <label for="themeSecondaryButtonText">Secondary Button Text</label>
                            <input type="color" id="themeSecondaryButtonText">
                        </div>
                        <div class="color-input-group">
                            <label for="themeAccentColor">Accent Color (Borders, Sliders)</label>
                            <input type="color" id="themeAccentColor">
                        </div>
                        <div class="color-input-group">
                            <label for="themeDayCellBorderColor">Day Cell Border Color</label>
                            <input type="color" id="themeDayCellBorderColor">
                        </div>
                        <button id="saveCustomThemeButton" class="themed-button w-full mb-3">Save Current Custom Theme</button>
                    </div>

                    <div class="mb-4 pt-4 border-t" style="border-color: var(--header-border-color);">
                        <h4 class="h4-settings">Saved Custom Themes</h4>
                        <div id="savedThemePreviews" class="flex flex-wrap gap-2 mt-2 justify-center">
                        </div>
                    </div>
                </div>

                <div class="mb-6 pt-4 border-t" style="border-color: var(--header-border-color);">
                    <h4 class="h4-settings" style="color: #ef4444;">Danger Zone</h4>
                    <button id="removeAllEventsButton" class="themed-button danger w-full mb-3">Remove All Events</button>
                    <button id="removeAllCustomThemesButton" class="themed-button danger w-full mb-3">Remove All Custom Themes</button>
                    <button id="resetApplicationButton" class="themed-button danger w-full">Reset the Application</button>
                </div>

            </div>

            <div class="modal-footer">
                <button id="cancelSettings" class="themed-button secondary">Cancel</button>
                <button id="saveSettings" class="themed-button">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="theme-name-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Name Your Custom Theme</h3>
            <div class="mb-4">
                <label for="themeNameInput" class="block text-sm font-medium text-gray-700 mb-1" style="color: var(--text-color);">Theme Name</label>
                <input type="text" id="themeNameInput" class="w-full p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
            </div>
            <div class="modal-footer">
                <button id="cancelThemeName" class="themed-button secondary">Cancel</button>
                <button id="saveThemeName" class="themed-button">Save</button>
            </div>
        </div>
    </div>

    <div id="holder-sidebar" class="fixed top-0 left-0 h-full bg-white shadow-lg z-50 transition-all duration-300 flex flex-col items-center p-4">
        <button id="holderSidebarCloseButton" class="md:hidden">
            <i class="fas fa-times"></i>
        </button>
        <h3 class="text-xl font-bold mb-4 text-gray-700">HOLDER</h3>
        <div id="holder-content" class="flex-grow w-full border-2 border-dashed border-gray-300 rounded-lg p-2 overflow-y-auto"
             style="min-height: 100px; background-color: var(--day-cell-bg);">
        </div>
        <button id="addHolderEventButton" class="themed-button w-full mt-4 styled-like-holder">
            <i class="fas fa-plus mr-2"></i> Add Event
        </button>
        <div class="resize-handle"></div>
    </div>

    <div id="eventContextMenu" class="hidden">
        <button id="contextEditEvent"><i class="fas fa-edit"></i> Edit Event</button>
        <button id="contextDuplicateEvent"><i class="fas fa-copy"></i> Duplicate Event</button>
        <button id="contextDeleteEvent"><i class="fas fa-trash"></i> Delete Event</button>
    </div>

    <script>
        let currentDate = new Date();
        let events = [];
        let holderEvents = [];
        let editingEventId = null;
        let currentCustomFontName = null;
        let draggedEventId = null;
        let contextMenuEventId = null;
        let isResizingHolder = false;
        let initialHolderWidth;
        let initialMouseX;

        const MAX_SAVED_THEMES = 5;
        const MAX_VISIBLE_EVENTS_FOLDED = 3;
        const MIN_HOLDER_WIDTH = 150;
        const MAX_HOLDER_WIDTH = 400;

        const DEFAULT_FONT_FAMILY = 'Inter, sans-serif';

        class CapacitorPreferences {
            async set({ key, value }) {
                try {
                    localStorage.setItem(key, value);
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async get({ key }) {
                try {
                    const value = localStorage.getItem(key);
                    return Promise.resolve({ value });
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async remove({ key }) {
                try {
                    localStorage.removeItem(key);
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }

            async clear() {
                try {
                    localStorage.clear();
                    return Promise.resolve();
                } catch (e) {
                    return Promise.reject(e);
                }
            }
        }
        const Preferences = new CapacitorPreferences();

        const adjustColor = (hex, lum) => {
            if (!hex || typeof hex !== 'string') return hex;
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            let rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }
            return rgb;
        };

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };

        const rgbToHsl = (r, g, b) => {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; 
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s * 100, l * 100];
        };

        const hslToRgb = (h, s, l) => {
            h /= 360;
            s /= 100;
            l /= 100;
            let r, g, b;

            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        };

        const hexToHsl = (hex) => {
            const rgb = hexToRgb(hex);
            if (rgb) {
                return rgbToHsl(rgb.r, rgb.g, rgb.b);
            }
            return [0, 0, 0];
        };

        const hslToHex = (h, s, l) => {
            const [r, g, b] = hslToRgb(h, s, l);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        };

        const hexToRgba = (hex, alpha) => {
            const rgb = hexToRgb(hex);
            if (rgb) {
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
            }
            return hex;
        };

        const isColorLight = (hex) => {
            if (!hex || typeof hex !== 'string' || hex.length < 7) return false;
            const cleanHex = hex.startsWith('#') ? hex.substring(1) : hex;
            if (cleanHex.length !== 6) return false;

            const r = parseInt(cleanHex.substring(0, 2), 16);
            const g = parseInt(cleanHex.substring(2, 4), 16);
            const b = parseInt(cleanHex.substring(4, 6), 16);
            const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
            return luminance > 0.5;
        };

        const THEMES = {
            light: {
                name: "Light",
                bodyBg: '#F8E8F0',
                mainText: '#4A4A4A',
                headerBg: '#FFFFFF',
                primaryButtonBg: '#F3E0E9',
                primaryButtonText: '#8B4B66',
                secondaryButtonBg: '#FFFFFF',
                secondaryButtonText: '#E085B0',
                accentColor: '#E085B0',
                dayCellBorder: '#D4DDE3',
                mainContainerBg: '#FFFFFF',
                dayCellBg: '#FFFFFF',
                dayCellHoverBg: '#F8F0F5',
                currentDayBg: '#FFEAF4',
                arrowButtonBg: 'transparent',
                arrowButtonHoverBg: 'rgba(0,0,0,0.05)',
                arrowButtonText: '#4B5563',
                headerBorderColor: '#E5E7EB'
            },
            dark: {
                name: "Dark",
                bodyBg: '#2C2C34',
                mainText: '#E0E0E0',
                headerBg: '#3A3A45',
                mainContainerBg: '#3A3A45',
                dayCellBg: '#4A4A50',
                dayCellHoverBg: '#5A5A60',
                currentDayBg: '#6A6A70',
                primaryButtonBg: '#E085B0',
                primaryButtonText: '#FFFFFF',
                secondaryButtonBg: '#6E6E77',
                secondaryButtonText: '#C0C0C0',
                accentColor: '#FFADD9',
                dayCellBorder: '#5A5A60',
                arrowButtonBg: 'transparent',
                arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                arrowButtonText: '#E0E0E0',
                headerBorderColor: 'rgba(255,255,255,0.15)'
            },
            pastelBlue: {
                light: {
                    name: "Blue", bodyBg: '#E0F2F7', mainText: '#3F51B5', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#CFECF5', currentDayBg: '#B3E5FC',
                    primaryButtonBg: '#BBDEFB',
                    primaryButtonText: '#2196F3',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#42A5F5',
                    accentColor: '#42A5F5', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#2196F3', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Blue (Dark)", bodyBg: '#060b14', mainText: '#90caf9', headerBg: '#3A4B5C', mainContainerBg: '#12152b',
                    dayCellBg: '#18203a', dayCellHoverBg: '#18437c', currentDayBg: '#1a2854',
                    primaryButtonBg: '#18587e', primaryButtonText: '#85d6ff',
                    secondaryButtonBg: '#12152b',
                    secondaryButtonText: '#90CAF9', accentColor: '#81D4FA', dayCellBorder: '#2a4f7e',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#81d4fa', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelGreen: {
                light: {
                    name: "Green", bodyBg: '#E8F5E9', mainText: '#388E3C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#D9F1DB', currentDayBg: '#C8E6C9',
                    primaryButtonBg: '#C5E1A5',
                    primaryButtonText: '#66BB6A',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#81C784',
                    accentColor: '#81C784', dayCellBorder: '#A1CF90',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#66BB6A', headerBorderColor: '#A1CF90'
                },
                dark: {
                    name: "Green (Dark)", bodyBg: '#132018', mainText: '#C8E6C9', headerBg: '#4B5C4A', mainContainerBg: '#1e332c',
                    dayCellBg: '#375847', dayCellHoverBg: '#20402a', currentDayBg: '#2f4b36',
                    primaryButtonBg: '#418145', primaryButtonText: '#b8eab9',
                    secondaryButtonBg: '#2f4b36',
                    secondaryButtonText: '#a5d6a7', accentColor: '#a5d6a7', dayCellBorder: '#6c906a',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C8E6C9', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelYellow: {
                light: {
                    name: "Yellow", bodyBg: '#FFFDE7', mainText: '#c78800', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#fff9c4', currentDayBg: '#fff9c4',
                    primaryButtonBg: '#fff59d',
                    primaryButtonText: '#c89406', 
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#d39831',
                    accentColor: '#ffc800', dayCellBorder: '#FFD375',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#FFCA28', headerBorderColor: '#FFF176'
                },
                dark: {
                    name: "Yellow (Dark)",
                    bodyBg: '#0b0d11',
                    mainText: '#eeda9f',
                    headerBg: '#f4ad35',
                    mainContainerBg: '#1f180c',
                    dayCellBg: '#281b0d',
                    dayCellHoverBg: '#170f08',
                    currentDayBg: '#22160a',
                    primaryButtonBg: '#663a1c',
                    primaryButtonText: '#c89406',
                    secondaryButtonBg: '#391c0b',
                    secondaryButtonText: '#e0a906',
                    accentColor: '#c89406', 
                    dayCellBorder: '#50371b',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#e6a900',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelPurple: {
                light: {
                    name: "Purple", bodyBg: '#F3E5F5', mainText: '#7B1FA2', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#ECCFF0', currentDayBg: '#E1BEE7',
                    primaryButtonBg: '#E1BEE7',
                    primaryButtonText: '#9C27B0',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#BA68C8',
                    accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Purple (Dark)",
                    bodyBg: '#080512',
                    mainText: '#d0a1ed',
                    headerBg: '#402a63',
                    mainContainerBg: '#1c102f',
                    dayCellBg: '#291547',
                    dayCellHoverBg: '#190c2e',
                    currentDayBg: '#220e42',
                    primaryButtonBg: '#51227f',
                    primaryButtonText: '#cc9beb',
                    secondaryButtonBg: '#25123f',
                    secondaryButtonText: '#b994e6',
                    accentColor: '#9876df',
                    dayCellBorder: '#5A3D82',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#cc9beb',
                    headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pastelPink: {
                light: {
                    name: "Pink", bodyBg: '#FCE4EC', mainText: '#C2185B', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F8D1DF', currentDayBg: '#F8BBD0',
                    primaryButtonBg: '#F8BBD0',
                    primaryButtonText: '#EC407A',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#E91E63',
                    accentColor: '#E91E63', dayCellBorder: '#ffa3c2',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#EC407A', headerBorderColor: '#F06292'
                },
                dark: {
                    name: "Pink (Dark)", bodyBg: '#29071e', mainText: '#ff93c8', headerBg: '#523A40', mainContainerBg: '#350825',
                    dayCellBg: '#400c2e', dayCellHoverBg: '#2f0422', currentDayBg: '#3d0a2b',
                    primaryButtonBg: '#891857', primaryButtonText: '#f56eb6',
                    secondaryButtonBg: '#4c1238',
                    secondaryButtonText: '#F48FB1', accentColor: '#ef70b9', dayCellBorder: '#731f53',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ff93c8', headerBorderColor: 'rgba(255,255,255,0.15)'
                }
            },
            pureBlack: {
                light: {
                    name: "Pure Black", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#111111', dayCellHoverBg: '#222222', currentDayBg: '#333333',
                    primaryButtonBg: '#333333',
                    primaryButtonText: '#CCCCCC',
                    secondaryButtonBg: '#FFFFFF',
                    secondaryButtonText: '#000000',
                    accentColor: '#CCCCCC', dayCellBorder: '#3d3d3d',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#BBBBBB', headerBorderColor: '#2A2A2A'
                },
                dark: {
                    name: "Pure Black (Dark)", bodyBg: '#000000', mainText: '#FFFFFF', headerBg: '#000000', mainContainerBg: '#000000',
                    dayCellBg: '#0A0A0A', dayCellHoverBg: '#1A1A1A', currentDayBg: '#2A2A2A',
                    primaryButtonBg: '#FFFFFF', primaryButtonText: '#000000',
                    secondaryButtonBg: '#1A1A1A',
                    secondaryButtonText: '#AAAAAA', accentColor: '#AAAAAA', dayCellBorder: '#1A1A1A',
                    arrowButtonBg: 'transparent',
                    arrowButtonHoverBg: 'rgba(255,255,255,0.1)',
                    arrowButtonText: '#E0E0E0', headerBorderColor: '#1A1A1A'
                }
            },
            aidah: {
                light: {
                    name: "Aidah", bodyBg: '#F7F7F7', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EEEEEE', currentDayBg: '#E8E8E8',
                    primaryButtonBg: '#D1D1D1',
                    primaryButtonText: '#333333',
                    secondaryButtonBg: '#E9E9E9',
                    secondaryButtonText: '#555555',
                    accentColor: '#AAAAAA', dayCellBorder: '#DDDDDD',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4B5563', headerBorderColor: '#E5E7EB'
                },
                dark: {
                    name: "Aidah (Dark)",
                    bodyBg: '#181926', mainText: '#c5cfe9', headerBg: '#333333', mainContainerBg: '#24273a',
                    dayCellBg: '#32354b', dayCellHoverBg: '#181926', currentDayBg: '#3a2c40',
                    primaryButtonBg: '#2f402c', primaryButtonText: '#a6da85',
                    secondaryButtonBg: '#3a2c40', secondaryButtonText: '#ff9bd5',
                    accentColor: '#ff9bd5', dayCellBorder: '#454b66',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#a6d475', headerBorderColor: '#454b66',
                }
            },
            dracula: {
                light: {
                    name: "Dracula", bodyBg: '#F8F8F2', mainText: '#282A36', headerBg: '#F8F8F2', mainContainerBg: '#F8F8F2',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#EAEAEA', currentDayBg: '#F0F0F0',
                    primaryButtonBg: '#FF79C6',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#BD93F9',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#FF79C6', dayCellBorder: '#EAEAEA',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#44475A', headerBorderColor: '#EAEAEA'
                },
                dark: {
                    name: "Dracula", bodyBg: '#282A36', mainText: '#F8F8F2', headerBg: '#3A3A4A', mainContainerBg: '#3A3A4A',
                    dayCellBg: '#44475A', dayCellHoverBg: '#505364', currentDayBg: '#6272A4',
                    primaryButtonBg: '#FF79C6', 
                    primaryButtonText: '#FFFFFF', 
                    secondaryButtonBg: '#6272A4', 
                    secondaryButtonText: '#F8F8F2', 
                    accentColor: '#FF79C6', dayCellBorder: '#5d6283',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#F8F8F2', headerBorderColor: '#44475A'
                }
            },
            nord: {
                light: {
                    name: "Nord", bodyBg: '#ECEFF4', mainText: '#2E3440', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#D8DEE9', dayCellHoverBg: '#E5E9F0', currentDayBg: '#BF616A',
                    primaryButtonBg: '#88C0D0',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#E5E9F0',
                    secondaryButtonText: '#4C566A',
                    accentColor: '#88C0D0', dayCellBorder: '#D8DEE9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4C566A', headerBorderColor: '#D8DEE9'
                },
                dark: {
                    name: "Nord", bodyBg: '#2E3440', mainText: '#ECEFF4', headerBg: '#3B4252', mainContainerBg: '#3B4252',
                    dayCellBg: '#4C566A', dayCellHoverBg: '#5E81AC', currentDayBg: '#81A1C1',
                    primaryButtonBg: '#88C0D0', 
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#4C566A', 
                    secondaryButtonText: '#ECEFF4',
                    accentColor: '#88C0D0', dayCellBorder: '#4C566A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ECEFF4', headerBorderColor: '#4C566A'
                }
            },
            oneDark: {
                light: {
                    name: "One Dark", bodyBg: '#FBFBFB', mainText: '#383A42', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#61AFEF',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#98C379',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#E06C75', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#4B5563', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "One Dark", bodyBg: '#282C34', mainText: '#ABB2BF', headerBg: '#333842', mainContainerBg: '#333842',
                    dayCellBg: '#3E4451', dayCellHoverBg: '#4B5262', currentDayBg: '#5C6777',
                    primaryButtonBg: '#61AFEF',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#ABB2BF', 
                    secondaryButtonText: '#282C34',
                    accentColor: '#E06C75', dayCellBorder: '#3E4451',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ABB2BF', headerBorderColor: '#3E4451'
                }
            },
            serikaDark: {
                light: {
                    name: "Serika Dark", bodyBg: '#F0F0F0', mainText: '#363636', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#F5C77F',
                    primaryButtonText: '#363636',
                    secondaryButtonBg: '#E0E0E0',
                    secondaryButtonText: '#5A5A5A',
                    accentColor: '#F5C77F', dayCellBorder: '#C7C7C7',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#5A5A5A', headerBorderColor: '#C7C7C7'
                },
                dark: {
                    name: "Serika Dark", bodyBg: '#2C2C2C', mainText: '#D0D0D0', headerBg: '#3A3A3A', mainContainerBg: '#3A3A3A',
                    dayCellBg: '#4A4A4A', dayCellHoverBg: '#5A5A5A', currentDayBg: '#6A6A6A',
                    primaryButtonBg: '#F5C77F',
                    primaryButtonText: '#363636', 
                    secondaryButtonBg: '#5A5A5A', 
                    secondaryButtonText: '#D0D0D0',
                    accentColor: '#F5C77F', dayCellBorder: '#4A4A4A',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#D0D0D0', headerBorderColor: '#4A4A4A'
                }
            },
            superuser: {
                light: {
                    name: "Super user", bodyBg: '#EFEFEF', mainText: '#1C1C1C', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EAEAEA', dayCellHoverBg: '#DBDBDB', currentDayBg: '#C7C7C7',
                    primaryButtonBg: '#00FF00',
                    primaryButtonText: '#1C1C1C',
                    secondaryButtonBg: '#333333',
                    secondaryButtonText: '#EFEFEF',
                    accentColor: '#00FF00', dayCellBorder: '#DBDBDB',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1C1C1C', headerBorderColor: '#DBDBDB'
                },
                dark: {
                    name: "Super user", bodyBg: '#000000', mainText: '#00FF00', headerBg: '#111111', mainContainerBg: '#111111',
                    dayCellBg: '#222222', dayCellHoverBg: '#333333', currentDayBg: '#444444',
                    primaryButtonBg: '#00FF00',
                    primaryButtonText: '#000000',
                    secondaryButtonBg: '#444444', 
                    secondaryButtonText: '#00FF00', 
                    accentColor: '#00FF00', dayCellBorder: '#222222',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#00FF00', headerBorderColor: '#222222'
                }
            },
            stealth: {
                light: {
                    name: "Stealth", bodyBg: '#F5F5F5', mainText: '#424242', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E0E0E0', dayCellHoverBg: '#D0D0D0', currentDayBg: '#C0C0C0',
                    primaryButtonBg: '#BDBDBD', 
                    primaryButtonText: '#424242',
                    secondaryButtonBg: '#9E9E9E', 
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#757575', dayCellBorder: '#D0D0D0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#424242', headerBorderColor: '#D0D0D0'
                },
                dark: {
                    name: "Stealth", bodyBg: '#212121', mainText: '#BDBDBD', headerBg: '#2C2C2C', mainContainerBg: '#2C2C2C',
                    dayCellBg: '#363636', dayCellHoverBg: '#424242', currentDayBg: '#525252',
                    primaryButtonBg: '#9E9E9E', 
                    primaryButtonText: '#212121', 
                    secondaryButtonBg: '#424242', 
                    secondaryButtonText: '#BDBDBD', 
                    accentColor: '#9E9E9E', dayCellBorder: '#363636',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#BDBDBD', headerBorderColor: '#363636'
                }
            },
            taro: {
                light: {
                    name: "Taro", bodyBg: '#F5F0FF', mainText: '#5A2C85', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E1BEE7', dayCellHoverBg: '#CFADDF', currentDayBg: '#BA68C8',
                    primaryButtonBg: '#FFEB3B',
                    primaryButtonText: '#5A2C85',
                    secondaryButtonBg: '#CE93D8',
                    secondaryButtonText: '#9C27B0',
                    accentColor: '#BA68C8', dayCellBorder: '#D1C4E9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#9C27B0', headerBorderColor: '#D1C4E9'
                },
                dark: {
                    name: "Taro", bodyBg: '#3A2B5E', mainText: '#FDF9E2', headerBg: '#47396B', mainContainerBg: '#47396B',
                    dayCellBg: '#544679', dayCellHoverBg: '#615486', currentDayBg: '#706294',
                    primaryButtonBg: '#FFEB3B', 
                    primaryButtonText: '#3A2B5E', 
                    secondaryButtonBg: '#615486', 
                    secondaryButtonText: '#FDF9E2',
                    accentColor: '#BA68C8', dayCellBorder: '#544679',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#FDF9E2', headerBorderColor: '#544679',
                }
            },
            horizon: {
                light: {
                    name: "Horizon", bodyBg: '#FDF0ED', mainText: '#333333', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FDF0ED', dayCellHoverBg: '#FADAD1', currentDayBg: '#E73665',
                    primaryButtonBg: '#E73665',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#F7806D',
                    secondaryButtonText: '#FFFFFF',
                    accentColor: '#E73665', dayCellBorder: '#FADAD1',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#333333', headerBorderColor: '#FADAD1'
                },
                dark: {
                    name: "Horizon", bodyBg: '#1C1E26', mainText: '#F9F0DA', headerBg: '#2A2C34', mainContainerBg: '#2A2C34',
                    dayCellBg: '#2E303B', dayCellHoverBg: '#3A3C47', currentDayBg: '#E95678',
                    primaryButtonBg: '#E95678',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FAB795',
                    secondaryButtonText: '#6d7095',
                    accentColor: '#E95678', dayCellBorder: '#3A3C47',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#F9F0DA', headerBorderColor: '#3A3C47'
                }
            },
            sweden: {
                light: {
                    name: "Sweden", bodyBg: '#E0F2F7', mainText: '#004B8E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#B3E5FC', dayCellHoverBg: '#81D4FA', currentDayBg: '#4FC3F7',
                    primaryButtonBg: '#FFD700',
                    primaryButtonText: '#004B8E',
                    secondaryButtonBg: '#BBDEFB',
                    secondaryButtonText: '#1976D2',
                    accentColor: '#FFD700', dayCellBorder: '#90CAF9',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#1976D2', headerBorderColor: '#90CAF9'
                },
                dark: {
                    name: "Sweden", bodyBg: '#002B4B', mainText: '#ADD8E6', headerBg: '#003A63', mainContainerBg: '#003A63',
                    dayCellBg: '#004D8C', dayCellHoverBg: '#005CA8', currentDayBg: '#006CD0',
                    primaryButtonBg: '#FFD700',
                    primaryButtonText: '#002B4B', 
                    secondaryButtonBg: '#004D8C',
                    secondaryButtonText: '#ADD8E6', 
                    accentColor: '#FFD700', dayCellBorder: '#004D8C',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#ADD8E6', headerBorderColor: '#004D8C'
                }
            },
            catppuccinLatte: {
                light: {
                    name: "Catppuccin Latte", bodyBg: '#EFF1F5', mainText: '#4C4F69', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#E6E9EF', dayCellHoverBg: '#DCE0EE', currentDayBg: '#CCD0DA',
                    primaryButtonBg: '#DC8A78',
                    primaryButtonText: '#4C4F69',
                    secondaryButtonBg: '#D2D4E3',
                    secondaryButtonText: '#6C6F85',
                    accentColor: '#DC8A78', dayCellBorder: '#DCE0EE',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#6C6F85', headerBorderColor: '#DCE0EE'
                },
                dark: {
                    name: "Catppuccin Mocha", bodyBg: '#1E1E2E', mainText: '#CDD6F4', headerBg: '#181825', mainContainerBg: '#181825',
                    dayCellBg: '#313244', dayCellHoverBg: '#45475A', currentDayBg: '#F38BA8',
                    primaryButtonBg: '#F38BA8',
                    primaryButtonText: '#1E1E2E',
                    secondaryButtonBg: '#45475A',
                    secondaryButtonText: '#CDD6F4',
                    accentColor: '#F38BA8', dayCellBorder: '#313244',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#CDD6F4', headerBorderColor: '#313244'
                }
            },
            github: {
                light: {
                    name: "GitHub", bodyBg: '#F6F8FA', mainText: '#24292E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F3F4F6', currentDayBg: '#E6E8EB',
                    primaryButtonBg: '#28A745',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#F6F8FA',
                    secondaryButtonText: '#24292E',
                    accentColor: '#0366D6', dayCellBorder: '#D1D5DA',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#24292E', headerBorderColor: '#D1D5DA'
                },
                dark: {
                    name: "GitHub Dark", bodyBg: '#0D1117', mainText: '#C9D1D9', headerBg: '#161B22', mainContainerBg: '#161B22',
                    dayCellBg: '#21262D', dayCellHoverBg: '#30363D', currentDayBg: '#444C56',
                    primaryButtonBg: '#238636',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#30363D',
                    secondaryButtonText: '#C9D1D9',
                    accentColor: '#58A6FF', dayCellBorder: '#30363D',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C9D1D9', headerBorderColor: '#30363D'
                }
            },
            tokyoNight: {
                light: {
                    name: "Tokyo Night", bodyBg: '#E1E4F2', mainText: '#565A6E', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#FFFFFF', dayCellHoverBg: '#F0F2F9', currentDayBg: '#C7C9DB',
                    primaryButtonBg: '#BB9AF7',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#DDE1F0',
                    secondaryButtonText: '#565A6E', 
                    accentColor: '#BB9AF7', dayCellBorder: '#DDE1F0',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#565A6E', headerBorderColor: '#DDE1F0'
                },
                dark: {
                    name: "Tokyo Night", bodyBg: '#1A1B26', mainText: '#C0CAF5', headerBg: '#232635', mainContainerBg: '#232635',
                    dayCellBg: '#2D3043', dayCellHoverBg: '#393D55', currentDayBg: '#4A4F6B',
                    primaryButtonBg: '#BB9AF7',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#393D55', 
                    secondaryButtonText: '#C0CAF5',
                    accentColor: '#BB9AF7', dayCellBorder: '#2D3043',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#C0CAF5', headerBorderColor: '#2D3043'
                }
            },
            gruvbox: {
                light: {
                    name: "Gruvbox", bodyBg: '#FBF1C7', mainText: '#3C3836', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#F2E5BC', dayCellHoverBg: '#EBDBB2', currentDayBg: '#D5C4A1',
                    primaryButtonBg: '#FABD2F',
                    primaryButtonText: '#3C3836',
                    secondaryButtonBg: '#EBDBB2',
                    secondaryButtonText: '#3C3836',
                    accentColor: '#D79921', dayCellBorder: '#EBDBB2',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#3C3836', headerBorderColor: '#EBDBB2'
                },
                dark: {
                    name: "Gruvbox Dark", bodyBg: '#282828', mainText: '#EBDBB2', headerBg: '#32302F', mainContainerBg: '#32302F',
                    dayCellBg: '#3C3836', dayCellHoverBg: '#504945', currentDayBg: '#665C54',
                    primaryButtonBg: '#FABD2F',
                    primaryButtonText: '#282828',
                    secondaryButtonBg: '#504945',
                    secondaryButtonText: '#EBDBB2',
                    accentColor: '#FABD2F', dayCellBorder: '#3C3836',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#EBDBB2', headerBorderColor: '#3C3836'
                }
            },
            solarized: {
                light: {
                    name: "Solarized Light", bodyBg: '#FDF6E3', mainText: '#657B83', headerBg: '#FFFFFF', mainContainerBg: '#FFFFFF',
                    dayCellBg: '#EEE8D5', dayCellHoverBg: '#E0DECE', currentDayBg: '#D9D2B6',
                    primaryButtonBg: '#2AA198',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#FDF6E3',
                    secondaryButtonText: '#657B83',
                    accentColor: '#2AA198', dayCellBorder: '#E0DECE',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(0,0,0,0.05)', arrowButtonText: '#657B83', headerBorderColor: '#E0DECE'
                },
                dark: {
                    name: "Solarized Dark", bodyBg: '#002B36', mainText: '#839496', headerBg: '#073642', mainContainerBg: '#073642',
                    dayCellBg: '#073642', dayCellHoverBg: '#586E75', currentDayBg: '#1a575b',
                    primaryButtonBg: '#2AA198',
                    primaryButtonText: '#FFFFFF',
                    secondaryButtonBg: '#073642',
                    secondaryButtonText: '#839496',
                    accentColor: '#2AA198', dayCellBorder: '#586E75',
                    arrowButtonBg: 'transparent', arrowButtonHoverBg: 'rgba(255,255,255,0.1)', arrowButtonText: '#839496', headerBorderColor: '#586E75'
                }
            }
        };

        let currentBaseThemeKey = 'pastelBlue';
        let isDarkModeActive = false;
        let holderIconEnabled = true;
        let noBackgroundMode = false;
        let disableSidebarAnimations = true;
        let hideScrollbars = false;
        let foldDayCellsEnabled = false;
        let showHolderByDefault = false;
        let use24HourFormat = false;
        let hideAddEventButtonInHolder = false;
        let currentBaseTheme = THEMES.pastelBlue.light;
        let unlockedSpecialThemesKeys = new Set();
        let savedCustomThemes = [];
        let holderSidebarWidth = 250; 

        const saveEvents = async () => {
            await Preferences.set({ key: 'calendarEvents', value: JSON.stringify(events) });
            await Preferences.set({ key: 'holderEvents', value: JSON.stringify(holderEvents) });
        };

        const loadEvents = async () => {
            const { value: eventsValue } = await Preferences.get({ key: 'calendarEvents' });
            if (eventsValue) {
                try {
                    const parsedEvents = JSON.parse(eventsValue);
                    events = parsedEvents.filter(event => event && typeof event === 'object' && event.id && typeof event.color === 'string');
                } catch (e) {
                    events = [];
                }
            } else {
                events = [];
            }

            const { value: holderValue } = await Preferences.get({ key: 'holderEvents' });
            if (holderValue) {
                try {
                    const parsedHolderEvents = JSON.parse(holderValue);
                    holderEvents = parsedHolderEvents.filter(event => event && typeof event === 'object' && event.id && typeof event.color === 'string');
                } catch (e) {
                    holderEvents = [];
                }
            } else {
                holderEvents = [];
            }
        };

        const saveSettings = async (fontName, fontData, baseThemeKey, isDarkMode, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColors = null, unlockedSpecialThemes = [], holderIconEnabledState = false, noBackgroundModeState = false, savedThemes = [], disableSidebarAnimationsState = false, hideScrollbarsState = false, foldDayCellsEnabledState = false, showHolderByDefaultState = false, use24HourFormatState = false, currentHolderSidebarWidth = 250, hideAddEventButtonInHolderState = false) => {
            const settings = {
                customFontName: fontName,
                customFontData: fontData,
                baseThemeKey: baseThemeKey,
                isDarkMode: isDarkMode,
                uiRoundness: uiRoundness,
                fontSize: fontSize,
                eventRoundness: eventRoundness,
                eventBorderThickness: eventBorderThickness,
                dayCellMinWidth: dayCellMinWidth,
                customThemeColors: baseThemeKey === null ? customThemeColors : null,
                unlockedSpecialThemes: Array.from(unlockedSpecialThemes),
                holderIconEnabled: holderIconEnabledState,
                noBackgroundMode: noBackgroundModeState,
                savedCustomThemes: savedThemes,
                disableSidebarAnimations: disableSidebarAnimationsState,
                hideScrollbars: hideScrollbarsState,
                foldDayCellsEnabled: foldDayCellsEnabledState,
                showHolderByDefault: showHolderByDefaultState,
                use24HourFormat: use24HourFormatState,
                holderSidebarWidth: currentHolderSidebarWidth,
                hideAddEventButtonInHolder: hideAddEventButtonInHolderState 
            };
            await Preferences.set({ key: 'calendarSettings', value: JSON.stringify(settings) });
        };

        let calendarEl, currentMonthYearEl, prevMonthButton, nextMonthButton, todayButton, settingsButton,
            eventModal, modalTitle, eventTitleInput, eventTimeInput, eventDateInput, eventDescriptionInput,
            eventColorInput, eventIconInput, colorPaletteEl, iconGridEl, saveEventButton, deleteEventButton, cancelEventButton,
            settingsModal, customFontUploadInput, customFontNameDisplay, resetCustomFontButton,
            uiRoundnessInput, uiRoundnessValueDisplay, fontSizeInput, fontSizeValueDisplay,
            eventRoundnessInput, eventRoundnessValueDisplay, eventBorderThicknessInput, eventBorderThicknessValueDisplay,
            dayCellMinWidthInput, dayCellMinWidthValueDisplay,
            themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
            themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
            themePrimaryButtonBgInput, themePrimaryButtonTextInput, themeSecondaryButtonBgInput,
            themeSecondaryButtonTextInput, themeAccentColorInput, themeDayCellBorderColorInput,
            saveSettingsButton, cancelSettingsButton, premadeThemeBoxesEl, iconSearchInput,
            specialThemeBoxesEl, saveCustomThemeButton, savedThemePreviewsEl, removeAllEventsButton, resetApplicationButton,
            removeAllCustomThemesButton, themeNameModal, themeNameInput, cancelThemeNameButton, saveThemeNameButton,
            effectGlowing, effectStriped, effectDotted, effectParticles, effectSnowFalling, effectGlisteningStars, effectGradient, effectAnimatedStripes, effectAnimatedVerticalRainbow, eventIconDisplay,
            holderContentEl, hamburgerIcon, holderSidebar, holderIconToggle, noBackgroundToggle, disableSidebarAnimationsToggle, mainContainerEl,
            eventContextMenu, contextEditEventButton, contextDuplicateEventButton, contextDeleteEventButton, hideScrollbarsToggle, holderSidebarCloseButton,
            darkModeButton, foldDayCellsToggle, showHolderByDefaultToggle, use24HourFormatToggle, addHolderEventButton, hideAddEventButtonInHolderToggle,
            holderResizeHandle, premadeThemeBoxesContainer;

        const loadSettings = async () => {
            const { value: storedSettings } = await Preferences.get({ key: 'calendarSettings' });
            const defaultRoundness = 8;
            const defaultFontSize = 16;
            const defaultEventBorderThickness = 3;
            const defaultDayCellMinWidth = 140;

            let currentUiRoundness = defaultRoundness;
            let currentFontSize = defaultFontSize;
            let currentEventRoundness = defaultRoundness;
            let currentEventBorderThickness = defaultEventBorderThickness;
            let currentDayCellMinWidth = defaultDayCellMinWidth;

            let loadedCustomFontName = null;
            let loadedCustomFontData = null;
            let loadedBaseThemeKey = 'pastelBlue';
            let loadedIsDarkMode = false;
            let loadedHolderIconEnabled = true;
            let loadedNoBackgroundMode = false;
            let loadedDisableSidebarAnimations = true;
            let loadedHideScrollbars = true;
            let loadedFoldDayCellsEnabled = false;
            let loadedShowHolderByDefault = false;
            let loadedUse24HourFormat = false;
            let loadedHideAddEventButtonInHolder = false;
            let loadedCustomThemeColors = null;
            let loadedUnlockedSpecialThemes = [];
            let loadedSavedCustomThemes = [];
            let loadedHolderSidebarWidth = 250;

            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                loadedCustomFontName = settings.customFontName;
                loadedCustomFontData = settings.customFontData;

                loadedBaseThemeKey = settings.baseThemeKey !== undefined ? settings.baseThemeKey : 'pastelBlue';
                loadedIsDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false;
                loadedHolderIconEnabled = settings.holderIconEnabled !== undefined ? settings.holderIconEnabled : false;
                loadedNoBackgroundMode = settings.noBackgroundMode !== undefined ? settings.noBackgroundMode : false;
                loadedDisableSidebarAnimations = settings.disableSidebarAnimations !== undefined ? settings.disableSidebarAnimations : true;
                loadedHideScrollbars = settings.hideScrollbars !== undefined ? settings.hideScrollbars : false;
                loadedFoldDayCellsEnabled = settings.foldDayCellsEnabled !== undefined ? settings.foldDayCellsEnabled : false;
                loadedShowHolderByDefault = settings.showHolderByDefault !== undefined ? settings.showHolderByDefault : false;
                loadedUse24HourFormat = settings.use24HourFormat !== undefined ? settings.use24HourFormat : false;
                loadedHideAddEventButtonInHolder = settings.hideAddEventButtonInHolder !== undefined ? settings.hideAddEventButtonInHolder : false; 

                currentUiRoundness = settings.uiRoundness !== undefined ? settings.uiRoundness : defaultRoundness;
                currentFontSize = settings.fontSize !== undefined ? settings.fontSize : defaultFontSize;
                currentEventRoundness = settings.eventRoundness !== undefined ? settings.eventRoundness : currentUiRoundness;
                currentEventBorderThickness = settings.eventBorderThickness !== undefined ? settings.eventBorderThickness : defaultEventBorderThickness;
                currentDayCellMinWidth = settings.dayCellMinWidth !== undefined ? settings.dayCellMinWidth : defaultDayCellMinWidth;
                loadedHolderSidebarWidth = settings.holderSidebarWidth !== undefined ? settings.holderSidebarWidth : 250;

                loadedCustomThemeColors = settings.customThemeColors || null;
                loadedUnlockedSpecialThemes = settings.unlockedSpecialThemes || [];
                loadedSavedCustomThemes = settings.savedCustomThemes || [];
            }

            if (loadedCustomFontData && loadedCustomFontName) {
                injectCustomFont(loadedCustomFontName, loadedCustomFontData);
            }

            currentCustomFontName = loadedCustomFontName;
            currentBaseThemeKey = loadedBaseThemeKey;
            isDarkModeActive = loadedIsDarkMode;
            holderIconEnabled = loadedHolderIconEnabled;
            noBackgroundMode = loadedNoBackgroundMode;
            disableSidebarAnimations = loadedDisableSidebarAnimations;
            hideScrollbars = loadedHideScrollbars;
            foldDayCellsEnabled = loadedFoldDayCellsEnabled;
            showHolderByDefault = loadedShowHolderByDefault;
            use24HourFormat = loadedUse24HourFormat;
            hideAddEventButtonInHolder = loadedHideAddEventButtonInHolder; 
            unlockedSpecialThemesKeys = new Set(loadedUnlockedSpecialThemes);
            savedCustomThemes = loadedSavedCustomThemes;
            holderSidebarWidth = loadedHolderSidebarWidth;

            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedCustomThemeColors || { ...THEMES.pastelBlue.light };
            } else {
                if (THEMES[currentBaseThemeKey]) {
                    currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
                } else {
                    currentBaseTheme = THEMES.pastelBlue.light;
                    currentBaseThemeKey = 'pastelBlue';
                }
            }


            return {
                currentCustomFontName: loadedCustomFontName,
                customFontData: loadedCustomFontData,
                currentBaseThemeKey: loadedBaseThemeKey,
                isDarkModeActive: loadedIsDarkMode,
                holderIconEnabled: loadedHolderIconEnabled,
                noBackgroundMode: loadedNoBackgroundMode,
                disableSidebarAnimations: loadedDisableSidebarAnimations,
                hideScrollbars: loadedHideScrollbars,
                foldDayCellsEnabled: loadedFoldDayCellsEnabled,
                showHolderByDefault: loadedShowHolderByDefault,
                use24HourFormat: loadedUse24HourFormat,
                hideAddEventButtonInHolder: loadedHideAddEventButtonInHolder, 
                currentUiRoundness: currentUiRoundness,
                currentFontSize: currentFontSize,
                currentEventRoundness: currentEventRoundness,
                currentEventBorderThickness: currentEventBorderThickness,
                currentDayCellMinWidth: currentDayCellMinWidth,
                customThemeColors: loadedCustomThemeColors,
                unlockedSpecialThemes: loadedUnlockedSpecialThemes,
                savedCustomThemes: loadedSavedCustomThemes,
                holderSidebarWidth: loadedHolderSidebarWidth
            };
        };

        const eventColors = [
            { name: 'red', primary: '#FFCDD2', text: '#b82121' },
            { name: 'orange', primary: '#FFE0B2', text: '#d15e00' },
            { name: 'dandelion', primary: '#FFF9C4', text: '#db9d02' },
            { name: 'pale yellow', primary: '#FFFDE7', text: '#F9A825' },
            { name: 'lime green', primary: '#DCEDC8', text: '#689F38' },
            { name: 'green', primary: '#C8E6C9', text: '#2E7D32' },
            { name: 'bluergreen', primary: '#a0dece', text: '#2e7d32' },
            { name: 'cyan', primary: '#B2EBF2', text: '#0097A7' },
            { name: 'aqua', primary: '#B2EBF2', text: '#0097A7' },
            { name: 'sky blue', primary: '#B3E5FC', text: '#0277BD' },
            { name: 'blue', primary: '#93c3ed', text: '#003b99' },
            { name: 'indigo', primary: '#afb8ed', text: '#303F9F' },
            { name: 'purple', primary: '#bbacff', text: '#2608a2' },
            { name: 'violet', primary: '#e6adf0', text: '#7B1FA2' },
            { name: 'magenta', primary: '#ffc4fa', text: '#b30098' },
            { name: 'rose pink', primary: '#F8BBD0', text: '#C2185B' },
            { name: 'pink', primary: '#FCE4EC', text: '#E91E63' },
            { name: 'brown', primary: '#D7CCC8', text: '#5D4037' },
            { name: 'grey', primary: '#E0E0E0', text: '#616161' },
            { name: 'white', primary: '#FFFFFF', text: '#212121' },

            { name: 'red', primary: '#880e0e', text: '#FF8A80' },
            { name: 'orange', primary: '#ab3d02', text: '#FFD180' },
            { name: 'dandelion', primary: '#F57F17', text: '#FFF59D' },
            { name: 'pale yellow', primary: '#edb207', text: '#FFFDE7' },
            { name: 'lime green', primary: '#558B2F', text: '#C5E1A5' },
            { name: 'green', primary: '#1B5E20', text: '#A5D6A7' },
            { name: 'bluergreen', primary: '#004D40', text: '#80CBC4' },
            { name: 'cyan', primary: '#006064', text: '#80DEEA' },
            { name: 'aqua', primary: '#015870', text: '#82cded' },
            { name: 'sky blue', primary: '#01579B', text: '#81D4FA' },
            { name: 'blue', primary: '#0D47A1', text: '#90CAF9' },
            { name: 'indigo', primary: '#1A237E', text: '#C5CAE9' },
            { name: 'purple', primary: '#4527A0', text: '#B39DDB' },
            { name: 'violet', primary: '#6A1B9A', text: '#E1BEE7' },
            { name: 'magenta', primary: '#880E4F', text: '#F8BBD0' },
            { name: 'rose pink', primary: '#AD1457', text: '#F8BBD0' },
            { name: 'pink', primary: '#C2185B', text: '#FFCDD2' },
            { name: 'brown', primary: '#3E2723', text: '#BCAAA4' },
            { name: 'grey', primary: '#424242', text: '#BDBDBD' },
            { name: 'white', primary: '#E0E0E0', text: '#424242' }
        ];


const initColorPalette = () => {
    colorPaletteEl.innerHTML = '';
    const colorsToShow = [];

    const lightColors = eventColors.slice(0, 20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: true
    }));

    const darkColors = eventColors.slice(20).map(color => ({
        name: color.name,
        primary: color.primary,
        text: color.text,
        isLight: false
    }));

    colorsToShow.push(...lightColors, ...darkColors);

    colorsToShow.forEach(color => {
        const colorBox = document.createElement('div');
        colorBox.classList.add('color-box');
        colorBox.title = color.name;
        colorBox.style.backgroundColor = color.primary;
        colorBox.dataset.primary = color.primary;
        colorBox.dataset.textColor = color.text;
        colorBox.addEventListener('click', () => {
            document.querySelectorAll('.color-box').forEach(box => box.classList.remove('selected'));
            colorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: color.primary, text: color.text });
        });
        colorPaletteEl.appendChild(colorBox);
    });

    const initialSelectedColor = eventColorInput.value;
    let foundInitialSelection = false;
    if (initialSelectedColor) {
        try {
            const parsedColor = JSON.parse(initialSelectedColor);
            const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${parsedColor.primary}"][data-text-color="${parsedColor.text}"]`);
            if (colorBox) {
                colorBox.classList.add('selected');
                foundInitialSelection = true;
            }
        } catch (e) {
        }
    }

    if (!foundInitialSelection && colorsToShow.length > 0) {
        const defaultColor = colorsToShow[0];
        const defaultColorBox = document.querySelector(`#colorPalette .color-box[data-primary="${defaultColor.primary}"][data-text-color="${defaultColor.text}"]`);
        if (defaultColorBox) {
            defaultColorBox.classList.add('selected');
            eventColorInput.value = JSON.stringify({ primary: defaultColor.primary, text: defaultColor.text });
        }
    }
};


        const allEventIcons = [
            'fas fa-star', 'far fa-star', 'fas fa-heart', 'far fa-heart', 'fas fa-bell', 'far fa-bell',
            'fas fa-bookmark', 'far fa-bookmark', 'fas fa-flag', 'far fa-flag', 'fas fa-calendar-alt', 'far fa-calendar-alt',
            'fas fa-compass', 'far fa-compass', 'fas fa-lightbulb', 'far fa-lightbulb', 'fas fa-comment', 'far fa-comment',
            'fas fa-folder', 'far fa-folder', 'far fa-circle', 'fas fa-circle', 'far fa-square', 'fas fa-square', 'fas fa-file', 'far fa-file', 'fas fa-image', 'far fa-image',
            'fas fa-play-circle', 'far fa-play-circle', 'fas fa-question-circle', 'far fa-question-circle',
            'fas fa-smile', 'far fa-smile', 'fas fa-meh', 'far fa-meh', 'fas fa-frown', 'far fa-frown',
            'fas fa-paper-plane', 'far fa-paper-plane', 'fas fa-envelope', 'far fa-envelope', 'fab fa-youtube', 'fab fa-instagram', 'fab fa-facebook', 'fab fa-tiktok', 'fab fa-whatsapp', 'fab fa-telegram', 'fab fa-twitter', 'fab fa-linkedin',
            'fab fa-github', 'fab fa-google', 'fab fa-apple', 'fab fa-windows', 'fab fa-android', 'fab fa-linux',
            'fas fa-sun', 'far fa-sun', 'fas fa-moon', 'far fa-moon', 'fas fa-grin', 'far fa-grin',
            'fas fa-surprise', 'far fa-surprise', 'fas fa-tired', 'far fa-tired', 'fas fa-sad-cry', 'far fa-sad-cry', 'far fa-face-laugh-beam', 'fas fa-clock', 'far fa-clock', 'far fa-hourglass', 'fas fa-lemon', 'far fa-lemon',
            'fas fa-futbol', 'far fa-futbol', 'fas fa-hand-peace', 'far fa-hand-peace',
            'fas fa-snowflake', 'far fa-snowflake', 'fas fa-thumbs-up', 'far fa-thumbs-up',
            'fas fa-thumbs-down', 'far fa-thumbs-down', 'fas fa-check-circle', 'far fa-check-circle',
            'fas fa-times-circle', 'far fa-times-circle', 'fas fa-edit', 'far fa-edit',
            'fas fa-trash', 'far fa-trash-alt', 'fas fa-plus-circle', 'far fa-plus-circle',
            'fas fa-minus-circle', 'far fa-minus-circle', 'fas fa-info-circle', 'far fa-info-circle',
            'fas fa-briefcase', 'fas fa-home', 'fas fa-gift', 'fas fa-plane', 'fas fa-utensils',
            'fas fa-dumbbell', 'fas fa-graduation-cap', 'fas fa-film', 'fas fa-book', 'fas fa-music',
            'fas fa-shopping-cart', 'fas fa-phone', 'fas fa-laptop', 'fas fa-coffee', 'fas fa-gamepad',
            'fas fa-cloud', 'fas fa-tree', 'fas fa-car', 'fas fa-train', 'fas fa-building',
            'fas fa-pizza-slice', 'fas fa-palette', 'fas fa-brush', 'fas fa-microchip',
            'fas fa-chart-line', 'fas fa-globe', 'fas fa-paint-brush',
            'fas fa-lock', 'fas fa-unlock', 'fas fa-key', 'fas fa-wifi', 'fas fa-plug',
            'fas fa-cube', 'fas fa-flask', 'fas fa-bug', 'fas fa-code', 'fas fa-terminal',
            'fas fa-database', 'fas fa-server', 'fas fa-cloud-upload-alt', 'fas fa-cloud-download-alt',
            'fas fa-chart-pie', 'fas fa-chart-bar', 'fas fa-receipt', 'fas fa-credit-card',
            'fas fa-dollar-sign', 'fas fa-euro-sign', 'fas fa-pound-sign', 'fas fa-yen-sign',
            'fas fa-handshake', 'fas fa-gavel', 'fas fa-balance-scale', 'fas fa-shield-alt',
            'fas fa-user-friends', 'fas fa-users', 'fas fa-user-circle', 'far fa-user-circle',
            'fas fa-trophy', 'fas fa-medal', 'fas fa-award', 'fas fa-crown',
            'fas fa-rocket', 'fas fa-space-shuttle', 'fas fa-earth-americas', 'fas fa-map-marker-alt',
            'fas fa-bus', 'fas fa-bicycle', 'fas fa-motorcycle', 'fas fa-ship',
            'fas fa-camera', 'fas fa-video', 'fas fa-microphone', 'fas fa-headphones',
            'fas fa-desktop', 'fas fa-tablet-alt', 'fas fa-mobile-alt', 'fas fa-gamepad',
            'fas fa-cogs', 'fas fa-tools', 'fas fa-wrench', 'fas fa-hammer',
            'fas fa-shopping-bag', 'fas fa-store', 'fas fa-warehouse', 'fas fa-truck',
            'fas fa-hospital', 'fas fa-clinic-medical', 'fas fa-stethoscope', 'fas fa-syringe',
            'fas fa-first-aid', 'fas fa-briefcase-medical',
            'fas fa-dog', 'fas fa-cat', 'fas fa-paw',
            'fas fa-fish', 'fas fa-carrot', 'fas fa-egg', 'fas fa-apple-alt', 'fas fa-mountain', 'fas fa-water', 'fas fa-fire',
            'fas fa-anchor', 'fas fa-life-ring', 'fas fa-umbrella', 'fas fa-wind',
            'fas fa-poo', 'fas fa-ghost', 'fas fa-spider', 'fas fa-skull',
            'fas fa-robot', 'fas fa-microchip', 'fas fa-atom', 'fas fa-dna',
            'fas fa-satellite', 'fas fa-globe-americas', 'fas fa-flask', 'fas fa-magnet',
            'fas fa-bug', 'fas fa-seedling', 'fas fa-leaf', 'fas fa-concierge-bell', 'fas fa-hotel', 'fas fa-bed',
            'fas fa-person-walking', 'fas fa-running', 'fas fa-biking', 'fas fa-swimmer',
            'fas fa-chart-line', 'fas fa-mug-hot', 'fas fa-pizza-slice', 'fas fa-plane-departure', 'fas fa-school', 'fas fa-hospital-user', 'far fa-closed-captioning', 'fab fa-money-bill', 
            'fas fa-clipboard', 'fas fa-clipboard-list', 'fas fa-clipboard-check',
            'fas fa-birthday-cake', 'fas fa-candy-cane', 'fas fa-cookie', 'fas fa-ice-cream',
            'fas fa-beer', 'fas fa-cocktail', 'fas fa-wine-glass-alt',
            'fas fa-whiskey-glass', 'fas fa-champagne-glasses', 'fas fa-basketball-ball',
            'fas fa-football-ball', 'fas fa-baseball-ball', 'fas fa-hockey-puck',
            'fas fa-table-tennis', 'fas fa-volleyball-ball', 'fas fa-swimming-pool',
            'fas fa-skiing', 'fas fa-snowboarding', 'fas fa-campground',
            'fas fa-binoculars', 'fas fa-camera-retro', 'fas fa-video-slash',
            'fas fa-headset', 'fas fa-keyboard', 'fas fa-mouse', 'fas fa-print',
            'fas fa-fax', 'fas fa-sd-card', 'fas fa-sim-card',
            'fas fa-ethernet', 'fas fa-hdd', 'fas fa-memory',
            'fas fa-barcode', 'fas fa-qrcode', 'fas fa-satellite-dish',
            'fas fa-stopwatch', 'fas fa-calendar-plus',
            'fas fa-calendar-minus', 'fas fa-calendar-times', 'fas fa-calendar-check',
            'fas fa-business-time', 'fas fa-piggy-bank', 'fas fa-wallet',
            'fas fa-money-bill-wave', 'fas fa-coins', 'fas fa-ring',
            'fas fa-tshirt', 'fas fa-hat-cowboy', 'fas fa-socks', 'fas fa-shoe-prints',
            'fas fa-umbrella-beach', 'fas fa-bath', 'fas fa-shower',
            'fas fa-toilet', 'fas fa-sink', 'fas fa-couch', 'fas fa-chair',
            'fas fa-door-open', 'fas fa-traffic-light', 'fas fa-car-battery', 'fas fa-gas-pump',
            'fas fa-screwdriver', 'fas fa-toolbox', 'fas fa-ruler', 'fas fa-tape',
            'fas fa-paint-roller', 'fas fa-pencil-ruler', 'fas fa-stamp',
            'fas fa-paperclip', 'fas fa-scissors', 'fas fa-calculator',
            'fas fa-chalkboard', 'fas fa-atlas', 'fas fa-map-marked',
            'fas fa-map-marked-alt', 'fas fa-vials',
            'fas fa-prescription', 'fas fa-thermometer', 'fas fa-crutch',
            'fas fa-wheelchair', 'fas fa-procedures', 'fas fa-virus',
            'fas fa-virus-slash', 'fas fa-filter', 'fas fa-funnel-dollar',
            'fas fa-trash-restore', 'fas fa-trash-restore-alt', 'fas fa-broom',
            'fas fa-spray-can', 'fas fa-hand-sparkles', 'fas fa-hand-holding-water',
            'fas fa-hand-holding-medical', 'fas fa-peace',
            'fas fa-pray', 'fas fa-om', 'fas fa-yin-yang', 'fas fa-star-and-crescent',
            'fas fa-cross', 'fas fa-church', 'fas fa-mosque', 'fas fa-synagogue',
            'fas fa-torah', 'fas fa-bible', 'fas fa-quran', 'fas fa-place-of-worship',
            'fas fa-ankh', 'fas fa-hamsa', 'fas fa-kaaba', 'fas fa-jedi',
            'fas fa-journal-whills', 'fas fa-pastafarianism', 'fas fa-pen-fancy',
            'fas fa-feather', 'fas fa-scroll', 'fas fa-chess', 'fas fa-chess-king',
            'fas fa-chess-queen', 'fas fa-chess-pawn', 'fas fa-chess-bishop',
            'fas fa-chess-knight', 'fas fa-chess-rook', 'fas fa-dice-d20',
            'fas fa-dice-d6', 'fas fa-dice-five',
            'fas fa-head-side-virus', 'fas fa-mask', 'fas fa-theater-masks',
            'fas fa-hat-wizard', 'fas fa-dragon', 'fas fa-horse-head',
            'fas fa-kiwi-bird', 'fas fa-otter', 'fas fa-hippo', 'fas fa-crow',
            'fas fa-pepper-hot', 'fas fa-tractor', 'fas fa-truck-pickup', 'fas fa-icicles', 'fas fa-smog', 'fas fa-meteor',
            'fas fa-shuttle-space', 'fas fa-user-astronaut', 'fas fa-cloud-moon-rain',
            'fas fa-cloud-showers-heavy', 'fas fa-cloud-sun-rain',
            'fas fa-temperature-high', 'fas fa-temperature-low',
            'fas fa-spa',
        ];

        const initIconGrid = (filterText = '') => {
            iconGridEl.innerHTML = '';
            const filteredIcons = allEventIcons.filter(iconClass =>
                iconClass.toLowerCase().includes(filterText.toLowerCase())
            );

            filteredIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-item');
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                iconItem.dataset.icon = iconClass;
                iconItem.addEventListener('click', () => {
                    if (iconItem.classList.contains('selected') && eventIconInput.value === iconClass) {
                        iconItem.classList.remove('selected');
                        eventIconInput.value = '';
                        eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                        eventIconDisplay.classList.remove('selected');
                    } else {
                        document.querySelectorAll('.icon-item').forEach(item => item.classList.remove('selected'));
                        iconItem.classList.add('selected');
                        eventIconInput.value = iconClass;
                        eventIconDisplay.innerHTML = `<i class="${iconClass}"></i>`;
                        eventIconDisplay.classList.add('selected'); 
                    }
                });
                iconGridEl.appendChild(iconItem);
            });

            const currentSelectedIcon = eventIconInput.value;
            if (currentSelectedIcon) {
                const iconItemInGrid = document.querySelector(`#iconGrid .icon-item[data-icon="${currentSelectedIcon}"]`);
                if (iconItemInGrid) {
                    iconItemInGrid.classList.add('selected');
                    eventIconDisplay.innerHTML = `<i class="${currentSelectedIcon}"></i>`;
                    eventIconDisplay.classList.add('selected');
                } else {
                    eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                    eventIconDisplay.classList.remove('selected');
                    eventIconInput.value = '';
                }
            } else {
                eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                eventIconDisplay.classList.remove('selected');
                eventIconInput.value = '';
            }
        };

        const applyFont = (fontFamily) => {
            document.body.style.fontFamily = fontFamily;
        };

        const getEffectiveTheme = (baseThemeKey, isDarkMode) => {
            let themeToApply;

            if (baseThemeKey === null) {
                themeToApply = { ...currentBaseTheme };
            } else {
                const themeDef = THEMES[baseThemeKey];
                if (themeDef) {
                    themeToApply = isDarkMode ? { ...themeDef.dark } : { ...themeDef.light };
                } else {
                    themeToApply = isDarkMode ? { ...THEMES.pastelBlue.dark } : { ...THEMES.pastelBlue.light };
                    currentBaseThemeKey = 'pastelBlue';
                }
            }

            themeToApply.primaryButtonBorderColor = themeToApply.primaryButtonText;
            return themeToApply;
        };


        const applyTheme = (effectiveTheme, inputs) => {
            document.body.style.backgroundColor = effectiveTheme.bodyBg;

            document.documentElement.style.setProperty('--text-color', effectiveTheme.mainText);
            document.documentElement.style.setProperty('--header-bg', effectiveTheme.headerBg);
            document.documentElement.style.setProperty('--main-container-bg', effectiveTheme.mainContainerBg);
            document.documentElement.style.setProperty('--day-cell-bg', effectiveTheme.dayCellBg);
            document.documentElement.style.setProperty('--day-cell-hover-bg-color', effectiveTheme.dayCellHoverBg);
            document.documentElement.style.setProperty('--current-day-bg', effectiveTheme.currentDayBg);

            document.documentElement.style.setProperty('--primary-button-bg', effectiveTheme.primaryButtonBg);
            document.documentElement.style.setProperty('--primary-button-text', effectiveTheme.primaryButtonText);
            document.documentElement.style.setProperty('--primary-button-border-color', effectiveTheme.primaryButtonText);

            document.documentElement.style.setProperty('--secondary-button-bg', effectiveTheme.secondaryButtonBg);
            document.documentElement.style.setProperty('--secondary-button-text', effectiveTheme.secondaryButtonText);
            const secondaryTextRgb = hexToRgb(effectiveTheme.secondaryButtonText);
            if (secondaryTextRgb) {
                document.documentElement.style.setProperty('--secondary-button-text-rgb', `${secondaryTextRgb.r}, ${secondaryTextRgb.g}, ${secondaryTextRgb.b}`);
            }


            document.documentElement.style.setProperty('--accent-color', effectiveTheme.accentColor);
            document.documentElement.style.setProperty('--day-cell-border-color', effectiveTheme.dayCellBorder);

            document.documentElement.style.setProperty('--arrow-button-bg', effectiveTheme.arrowButtonBg);
            document.documentElement.style.setProperty('--arrow-button-hover-bg', effectiveTheme.arrowButtonHoverBg);
            document.documentElement.style.setProperty('--arrow-button-text', effectiveTheme.arrowButtonText);
            document.documentElement.style.setProperty('--header-border-color', effectiveTheme.headerBorderColor);

            if (isDarkModeActive) {
                document.documentElement.style.setProperty('--slider-track-bg', '#666666');
            } else {
                document.documentElement.style.setProperty('--slider-track-bg', '#D1D5DB');
            }

            document.documentElement.style.setProperty('--modal-overlay-bg', `rgba(0, 0, 0, 0.5)`);

            document.documentElement.style.setProperty('--custom-pickers-overlay-bg', `rgba(255, 255, 255, 0.5)`);

            if (inputs && inputs.themeBodyBgInput) {
                const sourceThemeForPickers = effectiveTheme;

                if (sourceThemeForPickers) {
                    inputs.themeBodyBgInput.value = sourceThemeForPickers.bodyBg;
                    inputs.themeTextColorInput.value = sourceThemeForPickers.mainText;
                    inputs.themeHeaderBgInput.value = sourceThemeForPickers.headerBg;
                    inputs.themeMainContainerBgInput.value = sourceThemeForPickers.mainContainerBg;
                    inputs.themeDayCellBgInput.value = sourceThemeForPickers.dayCellBg;
                    inputs.themeDayCellHoverBgInput.value = sourceThemeForPickers.dayCellHoverBg;
                    inputs.themeCurrentDayBgInput.value = sourceThemeForPickers.currentDayBg;
                    inputs.themePrimaryButtonBgInput.value = sourceThemeForPickers.primaryButtonBg;
                    inputs.themePrimaryButtonTextInput.value = sourceThemeForPickers.primaryButtonText;
                    inputs.themeSecondaryButtonBgInput.value = sourceThemeForPickers.secondaryButtonBg;
                    inputs.themeSecondaryButtonTextInput.value = sourceThemeForPickers.secondaryButtonText;
                    inputs.themeAccentColorInput.value = sourceThemeForPickers.accentColor;
                    inputs.themeDayCellBorderColorInput.value = sourceThemeForPickers.dayCellBorder;
                }
            }


            document.documentElement.style.setProperty('--day-cell-drag-bg', effectiveTheme.dayCellHoverBg);

            const accentHex = effectiveTheme.accentColor.replace('#', '');
            const r = parseInt(accentHex.substring(0, 2), 16);
            const g = parseInt(accentHex.substring(2, 4), 16);
            const b = parseInt(accentHex.substring(4, 6), 16);
            document.documentElement.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);

            updateMainContainerLayout();
            renderCalendar();
            renderHolderEvents();
            applyAnimationsState();
            applyScrollbarVisibility();
            updateThemeSelectionInSettings();
            applyAddEventButtonVisibility(); 
        };

        const injectCustomFont = (fontName, fontData) => {
            const styleId = 'custom-uploaded-font-style';
            let styleTag = document.getElementById(styleId);
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = styleId;
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = `
                @font-face {
                    font-family: "${fontName}";
                    src: url("${fontData}") format("woff2"),
                         url("${fontData}") format("woff"),
                         url("${fontData}") format("truetype"),
                         url("${fontData}") format("opentype");
                    font-weight: normal;
                    font-style: normal;
                }
            `;
        };

        const handleFontUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const fontData = reader.result;
                const fontName = `CustomUploadedFont-${Date.now()}`;
                injectCustomFont(fontName, fontData);
                applyFont(fontName);
                currentCustomFontName = fontName;
                customFontNameDisplay.textContent = file.name;

                await saveSettings(fontName, fontData, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            };
            reader.readAsDataURL(file);
        };

        const resetCustomFont = async () => {
            const styleTag = document.getElementById('custom-uploaded-font-style');
            if (styleTag) {
                styleTag.remove();
            }
            applyFont(DEFAULT_FONT_FAMILY);
            customFontNameDisplay.textContent = 'Inter (Default)';
            currentCustomFontName = null;

            await saveSettings(null, null, currentBaseThemeKey, isDarkModeActive,
                         uiRoundnessInput.value, fontSizeInput.value,
                         eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
        };

        const initPremadeThemeBoxes = () => {
            premadeThemeBoxesEl.innerHTML = '';
        
            const pureBlackTheme = THEMES.pureBlack.light;
            const pureBlackThemeBox = document.createElement('div');
            pureBlackThemeBox.classList.add('theme-box');

            const pureBlackColorPreview = document.createElement('div');
            pureBlackColorPreview.classList.add('color-preview');
            pureBlackColorPreview.style.backgroundColor = pureBlackTheme.accentColor;
            pureBlackThemeBox.appendChild(pureBlackColorPreview);

            const pureBlackThemeName = document.createElement('span');
            pureBlackThemeName.textContent = 'Pure Black';
            pureBlackThemeBox.appendChild(pureBlackThemeName);

            pureBlackThemeBox.addEventListener('click', async () => {
                document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                pureBlackThemeBox.classList.add('selected');
                darkModeButton.classList.remove('selected');

                currentBaseThemeKey = 'pureBlack';
                currentBaseTheme = null;

                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                initColorPalette();

                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });
            premadeThemeBoxesEl.appendChild(pureBlackThemeBox);

            const pastelThemeKeysOrdered = ['pastelBlue', 'pastelGreen', 'pastelYellow', 'pastelPink', 'pastelPurple'];

            pastelThemeKeysOrdered.forEach(key => {
                const theme = THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box');
                themeBox.dataset.themeKey = key;

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                colorPreview.style.backgroundColor = theme.accentColor;
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name.replace(' (Dark)', '');
                themeBox.appendChild(themeName);

                themeBox.addEventListener('click', async () => {
                    document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                    themeBox.classList.add('selected');
                    darkModeButton.classList.remove('selected');

                    currentBaseThemeKey = key;
                    currentBaseTheme = null;

                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    initColorPalette();

                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                premadeThemeBoxesEl.appendChild(themeBox);
            });
            updateThemeSelectionInSettings();
        };

        const initSpecialThemeBoxes = () => {
            specialThemeBoxesEl.innerHTML = '';
            const specialThemeKeysOrdered = ['dracula', 'nord', 'oneDark', 'serikaDark', 'superuser', 'stealth', 'taro', 'horizon', 'sweden', 'catppuccinLatte', 'github', 'tokyoNight', 'gruvbox', 'solarized', 'aidah'];

            specialThemeKeysOrdered.forEach(key => {
                const theme = THEMES[key].light;
                const themeBox = document.createElement('div');
                themeBox.classList.add('theme-box', 'special-theme-box');
                themeBox.dataset.themeKey = key;

                unlockedSpecialThemesKeys.add(key);
                themeBox.classList.add('unlocked');

                const colorPreview = document.createElement('div');
                colorPreview.classList.add('color-preview');
                colorPreview.style.backgroundColor = theme.accentColor;
                themeBox.appendChild(colorPreview);

                const themeName = document.createElement('span');
                themeName.textContent = theme.name;
                themeBox.appendChild(themeName);

                themeBox.addEventListener('click', async () => {
                    document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
                    themeBox.classList.add('selected');
                    darkModeButton.classList.remove('selected');

                    currentBaseThemeKey = key;
                    currentBaseTheme = null;
                    
                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    initColorPalette();

                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, null, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                specialThemeBoxesEl.appendChild(themeBox);
            });
        };

        const updateThemeSelectionInSettings = () => {
            document.querySelectorAll('.theme-box').forEach(box => box.classList.remove('selected'));
            if (currentBaseThemeKey) {
                const selectedThemeBox = document.querySelector(`.theme-box[data-theme-key="${currentBaseThemeKey}"]`);
                if (selectedThemeBox) {
                    selectedThemeBox.classList.add('selected');
                }
            }
            if (darkModeButton) {
                if (isDarkModeActive) {
                    darkModeButton.classList.add('selected');
                    darkModeButton.innerHTML = `Dark Mode <span class="small-text">(On)</span>`;
                } else {
                    darkModeButton.classList.remove('selected');
                    darkModeButton.innerHTML = `Dark Mode <span class="small-text">(Off)</span>`;
                }
            }
        };


        const renderCalendar = () => {
            calendarEl.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthYearEl.textContent = new Date(year, month).toLocaleString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const numDaysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'p-2', 'inactive');
                emptyCell.style.borderColor = `var(--day-cell-border-color)`;
                emptyCell.style.color = `var(--text-color)`;
                calendarEl.appendChild(emptyCell);
            }

            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell', 'p-2');
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = fullDate;

                const dayNumber = document.createElement('div');
                dayNumber.classList.add('text-left', 'font-bold', 'text-lg', 'mb-2');
                dayNumber.textContent = day;
                dayNumber.style.color = `var(--text-color)`;
                dayCell.appendChild(dayNumber);

                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('current-day');
                }

                const dayEvents = events.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.getDate() === day &&
                           eventDate.getMonth() === month &&
                           eventDate.getFullYear() === year &&
                           event.date !== 'holder';
                });

                const eventContainer = document.createElement('div');
                eventContainer.classList.add('event-container');
                dayCell.appendChild(eventContainer);

                if (foldDayCellsEnabled && dayEvents.length > MAX_VISIBLE_EVENTS_FOLDED) {
                    dayCell.classList.add('folded');
                    if (hideScrollbars) {
                        dayCell.classList.add('hide-scrollbars');
                    }
                    dayEvents.forEach(event => {
                        eventContainer.appendChild(createEventItem(event));
                    });
                } else {
                    dayEvents.forEach(event => {
                        eventContainer.appendChild(createEventItem(event));
                    });
                }

                dayCell.addEventListener('click', (e) => {
                    if (!e.target.closest('.event-item')) {
                        openEventModal(null, dayCell.dataset.date);
                    }
                });

                dayCell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dayCell.classList.add('drag-over');
                });

                dayCell.addEventListener('dragleave', () => {
                    dayCell.classList.remove('drag-over');
                });

                dayCell.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (e.target.classList.contains('event-item') || e.target.closest('.event-item')) {
                        dayCell.classList.remove('drag-over');
                        return;
                    }

                    dayCell.classList.remove('drag-over');

                    const droppedEventId = e.dataTransfer.getData('text/plain');
                    const newDate = dayCell.dataset.date;

                    if (droppedEventId) {
                        let eventFound = false;

                        let eventIndex = events.findIndex(event => event.id === droppedEventId);
                        if (eventIndex !== -1) {
                            events[eventIndex].date = newDate;
                            eventFound = true;
                        } else {
                            eventIndex = holderEvents.findIndex(event => event.id === droppedEventId);
                            if (eventIndex !== -1) {
                                const eventToMove = holderEvents.splice(eventIndex, 1)[0];
                                eventToMove.date = newDate;
                                events.push(eventToMove);
                                eventFound = true;
                            }
                        }

                        if (eventFound) {
                            await saveEvents();
                            renderCalendar();
                            renderHolderEvents();
                        }
                    }
                });

                calendarEl.appendChild(dayCell);
            }
            applyAnimationsState();
        };

        const createEventItem = (event) => {
            const eventItem = document.createElement('div');
            let eventColorData = { primary: '#FFCDD2', text: '#C62828' };

            try {
                const parsedColor = JSON.parse(event.color);
                eventColorData = parsedColor;
            } catch (e) {
            }

            eventItem.style.backgroundColor = eventColorData.primary;
            eventItem.style.color = eventColorData.text;
            eventItem.style.borderColor = eventColorData.text;
            eventItem.style.setProperty('--event-item-text-color', eventColorData.text);

            const textColorRgba25 = hexToRgba(eventColorData.text, 0.25);
            eventItem.style.setProperty('--event-item-text-color-rgba-25', textColorRgba25);


            eventItem.classList.add('event-item');
            eventItem.dataset.id = event.id;
            eventItem.title = `${event.title} ${event.time ? '(' + event.time + ')' : ''}${event.description ? ' - ' + event.description : ''}`;
            eventItem.setAttribute('draggable', 'true');

            if (event.effects) {
                if (event.effects.glowing) eventItem.classList.add('glowing');
                if (event.effects.striped) eventItem.classList.add('striped-effect');
                if (event.effects.dotted) eventItem.classList.add('dotted-effect');
                if (event.effects.particles) eventItem.classList.add('particles');
                if (event.effects.snowFalling) eventItem.classList.add('snow-falling');
                if (event.effects.glisteningStars) eventItem.classList.add('glistening-stars');
                if (event.effects.gradientEffect) eventItem.classList.add('gradient-effect');
                if (event.effects.animatedStripes) eventItem.classList.add('animated-stripes');
                
                if (event.effects.animatedVerticalRainbow) {
                    eventItem.classList.add('animated-vertical-rainbow');
                    const [h, s, l] = hexToHsl(eventColorData.text);
                    const gradientColors = [];
                    for (let i = 0; i < 7; i++) {
                        const hue = (h + (i * (360 / 6))) % 360;
                        gradientColors.push(hslToHex(hue, s, l));
                    }
                    eventItem.style.backgroundImage = `linear-gradient(to bottom, ${gradientColors.join(', ')})`;
                }
            }


            const mainContentDiv = document.createElement('div');
            mainContentDiv.classList.add('main-content');

            const textContentSpan = document.createElement('span');
            textContentSpan.classList.add('text-content');

            const timeTitleWrapper = document.createElement('span');
            timeTitleWrapper.classList.add('time-title-wrapper');

            if (event.time) {
                const timePart = document.createElement('span');
                timePart.classList.add('font-semibold', 'time-part');
                const [hours, minutes] = event.time.split(':');
                const dateForFormatting = new Date();
                dateForFormatting.setHours(parseInt(hours), parseInt(minutes));
                timePart.textContent = dateForFormatting.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: !use24HourFormat });
                timeTitleWrapper.appendChild(timePart);
            }
            const titlePart = document.createElement('span');
            titlePart.classList.add('title-part');
            titlePart.textContent = event.title;
            timeTitleWrapper.appendChild(titlePart);

            textContentSpan.appendChild(timeTitleWrapper);
            mainContentDiv.appendChild(textContentSpan);

            if (event.icon) {
                const iconContainer = document.createElement('span');
                iconContainer.classList.add('event-icon-container');
                iconContainer.innerHTML = `<i class="${event.icon}"></i> `;
                eventItem.appendChild(iconContainer);
            } else {
            }
            eventItem.appendChild(mainContentDiv);


            if (event.description) {
                const eventDescriptionEl = document.createElement('div');
                eventDescriptionEl.classList.add('event-description');
                eventDescriptionEl.style.color = adjustColor(eventColorData.text, 0.15);
                eventDescriptionEl.textContent = event.description;
                eventItem.appendChild(eventDescriptionEl);
            }

            eventItem.addEventListener('click', (e) => {
                e.stopPropagation();
                openEventModal(event.id);
            });

            eventItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                contextMenuEventId = event.id;
                eventContextMenu.style.left = `${e.clientX}px`;
                eventContextMenu.style.top = `${e.clientY}px`;
                eventContextMenu.style.display = 'flex';
            });

            eventItem.addEventListener('dragstart', (e) => {
                draggedEventId = event.id;
                e.dataTransfer.setData('text/plain', event.id);
                setTimeout(() => {
                    eventItem.classList.add('dragging');
                }, 0);
            });

            eventItem.addEventListener('dragend', () => {
                draggedEventId = null;
                eventItem.classList.remove('dragging');
                document.querySelectorAll('.event-item').forEach(item => item.classList.remove('drop-target-top', 'drop-target-bottom'));
                document.querySelectorAll('.day-cell').forEach(cell => cell.classList.remove('drag-over'));
                holderContentEl.classList.remove('drag-over');
            });

            eventItem.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const rect = eventItem.getBoundingClientRect();
                const y = e.clientY - rect.top;
                if (y < rect.height / 2) {
                    eventItem.classList.add('drop-target-top');
                    eventItem.classList.remove('drop-target-bottom');
                } else {
                    eventItem.classList.add('drop-target-bottom');
                    eventItem.classList.remove('drop-target-top');
                }
            });

            eventItem.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                eventItem.classList.remove('drop-target-top', 'drop-target-bottom');
            });

            eventItem.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                eventItem.classList.remove('drop-target-top', 'drop-target-bottom');

                const droppedEventId = e.dataTransfer.getData('text/plain');
                if (!droppedEventId || droppedEventId === event.id) return;

                const draggedEventIndex = events.findIndex(ev => ev.id === droppedEventId);
                const targetEventIndex = events.findIndex(ev => ev.id === event.id);

                if (draggedEventIndex === -1 && holderEvents.findIndex(ev => ev.id === droppedEventId) === -1) return;
                if (targetEventIndex === -1 && holderEvents.findIndex(ev => ev.id === event.id) === -1) return;

                let draggedEvent;
                let draggedFromHolder = false;

                if (events.findIndex(ev => ev.id === droppedEventId) !== -1) {
                    draggedEvent = events.splice(events.findIndex(ev => ev.id === droppedEventId), 1)[0];
                } else {
                    draggedEvent = holderEvents.splice(holderEvents.findIndex(ev => ev.id === droppedEventId), 1)[0];
                    draggedFromHolder = true;
                }

                if (draggedEvent.date !== event.date) {
                    draggedEvent.date = event.date;
                    events.push(draggedEvent);
                } else {
                    const rect = eventItem.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const currentEventsInDay = events.filter(ev => ev.date === event.date);
                    const targetIndexInDay = currentEventsInDay.findIndex(ev => ev.id === event.id);

                    let newPositionIndex = events.indexOf(currentEventsInDay[targetIndexInDay]);
                    if (y > rect.height / 2) {
                        newPositionIndex++;
                    }

                    events.splice(newPositionIndex, 0, draggedEvent);
                }
                saveEvents();
                renderCalendar();
                renderHolderEvents();
            });
            return eventItem;
        };

        const renderHolderEvents = () => {
            holderContentEl.innerHTML = '';
            holderEvents.forEach(event => {
                const eventItem = document.createElement('div');
                let eventColorData = { primary: '#FFCDD2', text: '#C62828' };
                try {
                    const parsedColor = JSON.parse(event.color);
                    eventColorData = parsedColor;
                } catch (e) {
                }

                eventItem.style.backgroundColor = eventColorData.primary;
                eventItem.style.color = eventColorData.text;
                eventItem.style.borderColor = eventColorData.text;
                eventItem.style.setProperty('--event-item-text-color', eventColorData.text);

                const textColorRgba25 = hexToRgba(eventColorData.text, 0.25);
                eventItem.style.setProperty('--event-item-text-color-rgba-25', textColorRgba25);

                eventItem.classList.add('event-item');
                eventItem.dataset.id = event.id;
                eventItem.title = `${event.title}${event.time ? ' (' + event.time + ')' : ''}${event.description ? ' - ' + event.description : ''}`;
                eventItem.setAttribute('draggable', 'true');

                if (event.effects) {
                    if (event.effects.glowing) eventItem.classList.add('glowing');
                    if (event.effects.striped) eventItem.classList.add('striped-effect');
                    if (event.effects.dotted) eventItem.classList.add('dotted-effect');
                    if (event.effects.particles) eventItem.classList.add('particles');
                    if (event.effects.snowFalling) eventItem.classList.add('snow-falling');
                    if (event.effects.glisteningStars) eventItem.classList.add('glistening-stars');
                    if (event.effects.gradientEffect) eventItem.classList.add('gradient-effect');
                    if (event.effects.animatedStripes) eventItem.classList.add('animated-stripes');
                    
                    if (event.effects.animatedVerticalRainbow) {
                        eventItem.classList.add('animated-vertical-rainbow');
                        const [h, s, l] = hexToHsl(eventColorData.text);
                        const gradientColors = [];
                        for (let i = 0; i < 7; i++) {
                            const hue = (h + (i * (360 / 6))) % 360;
                            gradientColors.push(hslToHex(hue, s, l));
                        }
                        eventItem.style.backgroundImage = `linear-gradient(to bottom, ${gradientColors.join(', ')})`;
                    }
                }

                const mainContentDiv = document.createElement('div');
                mainContentDiv.classList.add('main-content');

                const textContentSpan = document.createElement('span');
                textContentSpan.classList.add('text-content');

                const timeTitleWrapper = document.createElement('span');
                timeTitleWrapper.classList.add('time-title-wrapper');

                if (event.time) {
                    const timePart = document.createElement('span');
                    timePart.classList.add('font-semibold', 'time-part');
                    const [hours, minutes] = event.time.split(':');
                    const dateForFormatting = new Date();
                    dateForFormatting.setHours(parseInt(hours), parseInt(minutes));
                    timePart.textContent = dateForFormatting.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: !use24HourFormat });
                    timeTitleWrapper.appendChild(timePart);
                }
                const titlePart = document.createElement('span');
                titlePart.classList.add('title-part');
                titlePart.textContent = event.title;
                timeTitleWrapper.appendChild(titlePart);

                textContentSpan.appendChild(timeTitleWrapper);
                mainContentDiv.appendChild(textContentSpan);

                if (event.icon) {
                    const iconContainer = document.createElement('span');
                    iconContainer.classList.add('event-icon-container');
                    iconContainer.innerHTML = `<i class="${event.icon}"></i> `;
                    eventItem.appendChild(iconContainer);
                } else {
                }
                eventItem.appendChild(mainContentDiv);

                if (event.description) {
                    const eventDescriptionEl = document.createElement('div');
                    eventDescriptionEl.classList.add('event-description');
                    eventDescriptionEl.style.color = adjustColor(eventColorData.text, 0.15);
                    eventDescriptionEl.textContent = event.description;
                    eventItem.appendChild(eventDescriptionEl);
                }

                eventItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEventModal(event.id);
                });

                eventItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    contextMenuEventId = event.id;
                    eventContextMenu.style.left = `${e.clientX}px`;
                    eventContextMenu.style.top = `${e.clientY}px`;
                    eventContextMenu.style.display = 'flex';
                });

                eventItem.addEventListener('dragstart', (e) => {
                    draggedEventId = event.id;
                    e.dataTransfer.setData('text/plain', event.id);
                    setTimeout(() => {
                        eventItem.classList.add('dragging');
                    }, 0);
                });

                eventItem.addEventListener('dragend', () => {
                    draggedEventId = null;
                    eventItem.classList.remove('dragging');
                    document.querySelectorAll('.event-item').forEach(item => item.classList.remove('drop-target-top', 'drop-target-bottom'));
                    document.querySelectorAll('.day-cell').forEach(cell => cell.classList.remove('drag-over'));
                    holderContentEl.classList.remove('drag-over');
                });

                eventItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const rect = eventItem.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    if (y < rect.height / 2) {
                        eventItem.classList.add('drop-target-top');
                        eventItem.classList.remove('drop-target-bottom');
                    } else {
                        eventItem.classList.add('drop-target-bottom');
                        eventItem.classList.remove('drop-target-top');
                    }
                });

                eventItem.addEventListener('dragleave', (e) => {
                    e.stopPropagation();
                    eventItem.classList.remove('drop-target-top', 'drop-target-bottom');
                });

                eventItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    eventItem.classList.remove('drop-target-top', 'drop-target-bottom');

                    const droppedEventId = e.dataTransfer.getData('text/plain');
                    if (!droppedEventId || droppedEventId === event.id) return;

                    const draggedEventIndex = holderEvents.findIndex(ev => ev.id === droppedEventId);
                    const targetEventIndex = holderEvents.findIndex(ev => ev.id === event.id);

                    if (draggedEventIndex === -1 && events.findIndex(ev => ev.id === droppedEventId) === -1) return;
                    if (targetEventIndex === -1 && events.findIndex(ev => ev.id === event.id) === -1) return;

                    let draggedEvent;
                    let draggedFromCalendar = false;

                    if (holderEvents.findIndex(ev => ev.id === droppedEventId) !== -1) {
                        draggedEvent = holderEvents.splice(holderEvents.findIndex(ev => ev.id === droppedEventId), 1)[0];
                    } else {
                        draggedEvent = events.splice(events.findIndex(ev => ev.id === droppedEventId), 1)[0];
                        draggedFromCalendar = true;
                    }

                    if (draggedEvent.date !== 'holder') {
                        draggedEvent.date = 'holder';
                        holderEvents.push(draggedEvent);
                    } else {
                        const rect = eventItem.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        const currentEventsInHolder = holderEvents;
                        const targetIndexInHolder = currentEventsInHolder.findIndex(ev => ev.id === event.id);

                        let newPositionIndex = holderEvents.indexOf(currentEventsInHolder[targetIndexInHolder]);
                        if (y > rect.height / 2) {
                            newPositionIndex++;
                        }
                        holderEvents.splice(newPositionIndex, 0, draggedEvent);
                    }
                    saveEvents();
                    renderHolderEvents();
                    renderCalendar();
                });
                holderContentEl.appendChild(eventItem);
            });
            applyAnimationsState();
            applyAddEventButtonVisibility();
        };

        const openEventModal = (eventId = null, date = null) => {
            eventModal.classList.remove('hidden');
            editingEventId = eventId;

            eventTitleInput.value = '';
            eventTimeInput.value = '';
            eventDescriptionInput.value = '';
            eventDateInput.value = '';
            eventColorInput.value = '';
            eventIconInput.value = '';
            iconSearchInput.value = '';
            effectGlowing.checked = false;
            effectStriped.checked = false;
            effectDotted.checked = false;
            effectParticles.checked = false;
            effectSnowFalling.checked = false;
            effectGlisteningStars.checked = false;
            effectGradient.checked = false;
            effectAnimatedStripes.checked = false;
            effectAnimatedVerticalRainbow.checked = false;

            document.querySelectorAll('#colorPalette .color-box').forEach(box => box.classList.remove('selected'));
            document.querySelectorAll('.icon-item').forEach(item => item.classList.remove('selected'));

            eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>'; 
            eventIconDisplay.classList.remove('selected'); 

            let eventToEdit = null;
            if (eventId) {
                eventToEdit = events.find(e => e.id === eventId) || holderEvents.find(e => e.id === eventId);
            }

            if (eventToEdit) {
                modalTitle.textContent = 'Edit Event';
                saveEventButton.textContent = 'Update Event';
                deleteEventButton.classList.remove('hidden');

                eventTitleInput.value = eventToEdit.title;
                eventTimeInput.value = eventToEdit.time || '';
                eventDescriptionInput.value = eventToEdit.description || '';

                if (eventToEdit.date === 'holder') {
                    eventDateInput.value = ''; 
                    eventDateInput.disabled = true; 
                } else {
                    eventDateInput.value = eventToEdit.date;
                    eventDateInput.disabled = false;
                }
                
                let selectedColorPrimary;
                let selectedColorText;
                try {
                    const eventColor = JSON.parse(eventToEdit.color);
                    selectedColorPrimary = eventColor.primary;
                    selectedColorText = eventColor.text;
                } catch (e) {
                }
                const colorBox = document.querySelector(`#colorPalette .color-box[data-primary="${selectedColorPrimary}"][data-text-color="${selectedColorText}"]`);
                if (colorBox) {
                    colorBox.classList.add('selected');
                    eventColorInput.value = eventToEdit.color;
                } else {
                    initColorPalette();
                    const defaultColor = eventColors.find(c => c.isLight) || eventColors[0];
                    const defaultPrimary = defaultColor.primary;
                    const defaultText = defaultColor.text;
                    eventColorInput.value = JSON.stringify({ primary: defaultPrimary, text: defaultText });
                    const defaultColorBox = document.querySelector(`#colorPalette .color-box[data-primary="${defaultPrimary}"][data-text-color="${defaultText}"]`);
                    if(defaultColorBox) defaultColorBox.classList.add('selected');
                }


                if (eventToEdit.icon) {
                    eventIconDisplay.innerHTML = `<i class="${eventToEdit.icon}"></i>`;
                    eventIconDisplay.classList.add('selected');
                    eventIconInput.value = eventToEdit.icon;
                } else {
                    eventIconDisplay.innerHTML = '<i class="fas fa-plus"></i>';
                    eventIconDisplay.classList.remove('selected');
                    eventIconInput.value = '';
                }
                initIconGrid();


                if (eventToEdit.effects) {
                    effectGlowing.checked = eventToEdit.effects.glowing || false;
                    effectStriped.checked = eventToEdit.effects.striped || false;
                    effectDotted.checked = eventToEdit.effects.dotted || false;
                    effectParticles.checked = eventToEdit.effects.particles || false;
                    effectSnowFalling.checked = eventToEdit.effects.snowFalling || false;
                    effectGlisteningStars.checked = eventToEdit.effects.glisteningStars || false;
                    effectGradient.checked = eventToEdit.effects.gradientEffect || false;
                    effectAnimatedStripes.checked = eventToEdit.effects.animatedStripes || false;
                    effectAnimatedVerticalRainbow.checked = eventToEdit.effects.animatedVerticalRainbow || false;
                }
            } else {
                modalTitle.textContent = 'Add New Event';
                saveEventButton.textContent = 'Save Event';
                deleteEventButton.classList.add('hidden');
                eventDateInput.value = date;
                eventDateInput.disabled = (date === 'holder'); 
                initColorPalette();
                initIconGrid();
            }
        };

        const closeEventModal = () => {
            eventModal.classList.add('hidden');
            editingEventId = null;
        };

        const generateUniqueId = () => {
            return '_' + Math.random().toString(36).substr(2, 9);
        };

        const handleSaveEvent = async () => {
            const title = eventTitleInput.value.trim();
            const time = eventTimeInput.value.trim();
            const description = eventDescriptionInput.value.trim();
            let date = eventDateInput.value; 
            const color = eventColorInput.value;
            const icon = eventIconInput.value;

        const effects = {
            glowing: effectGlowing.checked,
            striped: effectStriped.checked,
            dotted: effectDotted.checked,
            particles: effectParticles.checked,
            snowFalling: effectSnowFalling.checked,
            glisteningStars: effectGlisteningStars.checked,
            gradientEffect: effectGradient.checked,
            animatedStripes: effectAnimatedStripes.checked,
            animatedVerticalRainbow: effectAnimatedVerticalRainbow.checked
        };

            if (eventDateInput.disabled && editingEventId) {
                const existingEvent = holderEvents.find(e => e.id === editingEventId);
                if (existingEvent && existingEvent.date === 'holder') {
                    date = 'holder';
                }
            } else if (eventDateInput.disabled && !editingEventId) {
                date = 'holder';
            }


            if (!title || (!date && !eventDateInput.disabled)) { 
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Please enter event title and date.</p>
                            <button class="px-4 py-2 themed-button" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
                return;
            }

            if (editingEventId) {
                let eventIndex = events.findIndex(e => e.id === editingEventId);
                if (eventIndex !== -1) {
                    if (date === 'holder') {
                        const eventToMove = events.splice(eventIndex, 1)[0];
                        eventToMove.title = title; eventToMove.time = time; eventToMove.date = date;
                        eventToMove.description = description; eventToMove.color = color; eventToMove.icon = icon;
                        eventToMove.effects = effects;
                        holderEvents.push(eventToMove);
                    } else {
                        events[eventIndex] = {
                            id: editingEventId, title, time, date, description, color, icon, effects
                        };
                    }
                } else {
                    eventIndex = holderEvents.findIndex(e => e.id === editingEventId);
                    if (eventIndex !== -1) {
                        if (date === 'holder') {
                            holderEvents[eventIndex] = {
                                id: editingEventId, title, time, date, description, color, icon, effects
                            };
                        } else {
                            const eventToMove = holderEvents.splice(eventIndex, 1)[0];
                            eventToMove.title = title; eventToMove.time = time; eventToMove.date = date;
                            eventToMove.description = description; eventToMove.color = color; eventToMove.icon = icon;
                            eventToMove.effects = effects;
                            events.push(eventToMove);
                        }
                    }
                }
            } else {
                const newEvent = {
                    id: generateUniqueId(), title, time, date, description, color, icon, effects
                };
                if (date === 'holder') {
                    holderEvents.push(newEvent);
                } else {
                    events.push(newEvent);
                }
            }
            await saveEvents();
            renderCalendar();
            renderHolderEvents();
            closeEventModal();
        };

        const handleDeleteEvent = () => {
            if (contextMenuEventId) {
                editingEventId = contextMenuEventId;
            }
            if (editingEventId) {
                const confirmBox = document.createElement('div');
                confirmBox.innerHTML = `
                    <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                            <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to delete this event?</p>
                            <div class="flex justify-center space-x-4">
                                <button class="themed-button" id="confirmDeleteYes">Yes</button>
                                <button class="themed-button secondary" id="confirmDeleteNo">No</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirmDeleteYes').onclick = async () => {
                    let deleted = false;
                    const initialEventsLength = events.length;
                    events = events.filter(e => e.id !== editingEventId);
                    if (events.length < initialEventsLength) {
                        deleted = true;
                    } else {
                        const initialHolderLength = holderEvents.length;
                        holderEvents = holderEvents.filter(e => e.id !== editingEventId);
                        if (holderEvents.length < initialHolderLength) {
                            deleted = true;
                        }
                    }

                    if (deleted) {
                        await saveEvents();
                        renderCalendar();
                        renderHolderEvents();
                        closeEventModal();
                    }
                    confirmBox.remove();
                    contextMenuEventId = null;
                };
                document.getElementById('confirmDeleteNo').onclick = () => {
                    confirmBox.remove();
                    contextMenuEventId = null;
                };
            }
        };

        const handleDuplicateEvent = async () => {
            if (contextMenuEventId) {
                let eventToDuplicate = events.find(e => e.id === contextMenuEventId) || holderEvents.find(e => e.id === contextMenuEventId);
                if (eventToDuplicate) {
                    const newEvent = { ...eventToDuplicate, id: generateUniqueId() };
                    if (newEvent.date === 'holder') {
                        holderEvents.push(newEvent);
                    } else {
                        events.push(newEvent);
                    }
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                }
                contextMenuEventId = null;
            }
        };

        //  open settings modal!
        const openSettingsModal = () => {
            settingsModal.classList.remove('hidden');
            // Initialization stuff
            uiRoundnessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness').replace('px', '');
            uiRoundnessValueDisplay.textContent = `${uiRoundnessInput.value}px`;
            fontSizeInput.value = getComputedStyle(document.documentElement).getPropertyValue('--base-font-size').replace('px', '');
            fontSizeValueDisplay.textContent = `${fontSizeInput.value}px`;
            eventRoundnessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--event-item-roundness').replace('px', '');
            eventRoundnessValueDisplay.textContent = `${eventRoundnessInput.value}px`;
            eventBorderThicknessInput.value = getComputedStyle(document.documentElement).getPropertyValue('--event-item-border-thickness').replace('px', '');
            eventBorderThicknessValueDisplay.textContent = `${eventBorderThicknessInput.value}px`;
            dayCellMinWidthInput.value = getComputedStyle(document.documentElement).getPropertyValue('--day-cell-min-width').replace('px', '');
            dayCellMinWidthValueDisplay.textContent = `${dayCellMinWidthInput.value}px`;

            holderIconToggle.checked = holderIconEnabled;
            noBackgroundToggle.checked = noBackgroundMode;
            disableSidebarAnimationsToggle.checked = disableSidebarAnimations;
            hideScrollbarsToggle.checked = hideScrollbars;
            foldDayCellsToggle.checked = foldDayCellsEnabled;
            showHolderByDefaultToggle.checked = showHolderByDefault;
            use24HourFormatToggle.checked = use24HourFormat;
            hideAddEventButtonInHolderToggle.checked = hideAddEventButtonInHolder; 


            updateThemeSelectionInSettings();
            renderSavedThemes();
            
            // MAKE color picker have values of current theme
            const rootStyles = getComputedStyle(document.documentElement);
            themeBodyBgInput.value = rootStyles.getPropertyValue('--body-bg');
            themeTextColorInput.value = rootStyles.getPropertyValue('--text-color');
            themeHeaderBgInput.value = rootStyles.getPropertyValue('--header-bg');
            themeMainContainerBgInput.value = rootStyles.getPropertyValue('--main-container-bg');
            themeDayCellBgInput.value = rootStyles.getPropertyValue('--day-cell-bg');
            themeDayCellHoverBgInput.value = rootStyles.getPropertyValue('--day-cell-hover-bg-color');
            themeCurrentDayBgInput.value = rootStyles.getPropertyValue('--current-day-bg');
            themePrimaryButtonBgInput.value = rootStyles.getPropertyValue('--primary-button-bg');
            themePrimaryButtonTextInput.value = rootStyles.getPropertyValue('--primary-button-text');
            themeSecondaryButtonBgInput.value = rootStyles.getPropertyValue('--secondary-button-bg');
            themeSecondaryButtonTextInput.value = rootStyles.getPropertyValue('--secondary-button-text');
            themeAccentColorInput.value = rootStyles.getPropertyValue('--accent-color');
            themeDayCellBorderColorInput.value = rootStyles.getPropertyValue('--day-cell-border-color');
        };

        // close settings modal
        const closeSettingsModal = () => {
            settingsModal.classList.add('hidden');
        };

        const getCustomThemeColorsFromInputs = () => {
            return {
                name: "Custom",
                bodyBg: themeBodyBgInput.value,
                mainText: themeTextColorInput.value,
                headerBg: themeHeaderBgInput.value,
                mainContainerBg: themeMainContainerBgInput.value,
                dayCellBg: themeDayCellBgInput.value,
                dayCellHoverBg: themeDayCellHoverBgInput.value,
                currentDayBg: themeCurrentDayBgInput.value,
                primaryButtonBg: themePrimaryButtonBgInput.value,
                primaryButtonText: themePrimaryButtonTextInput.value,
                secondaryButtonBg: themeSecondaryButtonBgInput.value,
                secondaryButtonText: themeSecondaryButtonTextInput.value,
                accentColor: themeAccentColorInput.value,
                dayCellBorder: themeDayCellBorderColorInput.value
            };
        };

        const handleSaveCustomTheme = () => {
            openThemeNameModal();
        };

        const openThemeNameModal = () => {
            themeNameModal.classList.remove('hidden');
            themeNameInput.value = '';
        };

        const closeThemeNameModal = () => {
            themeNameModal.classList.add('hidden');
        };

        const handleSaveThemeName = async () => {
            const themeName = themeNameInput.value.trim();
            if (!themeName) {
                // Show error message
                return;
            }

            const customTheme = getCustomThemeColorsFromInputs();
            customTheme.name = themeName;

            // Ensure we don't exceed max saved themes
            if (savedCustomThemes.length >= MAX_SAVED_THEMES) {
                savedCustomThemes.shift();
            }
            
            // Check if theme with same name exists
            const existingIndex = savedCustomThemes.findIndex(t => t.name === themeName);
            if (existingIndex >= 0) {
                savedCustomThemes[existingIndex] = customTheme;
            } else {
                savedCustomThemes.push(customTheme);
            }

            await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                        uiRoundnessInput.value, fontSizeInput.value,
                        eventRoundnessInput.value, eventBorderThicknessInput.value, 
                        dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, 
                        holderIconEnabled, noBackgroundMode, savedCustomThemes, 
                        disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, 
                        showHolderByDefault, use24HourFormat, holderSidebarWidth, 
                        hideAddEventButtonInHolder);
                        
            renderSavedThemes();
            closeThemeNameModal();
        };

        const renderSavedThemes = () => {
            savedThemePreviewsEl.innerHTML = '';
            if (savedCustomThemes.length === 0) {
                savedThemePreviewsEl.textContent = 'No custom themes saved yet.';
                savedThemePreviewsEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                savedThemePreviewsEl.style.fontSize = '0.9em';
                savedThemePreviewsEl.style.textAlign = 'center';
                return;
            }

            savedCustomThemes.forEach((theme, index) => {
                const themePreview = document.createElement('div');
                themePreview.classList.add('last-saved-theme-preview');

                const colorSwatches = document.createElement('div');
                colorSwatches.classList.add('color-swatches');

                const mainSwatch = document.createElement('div');
                mainSwatch.classList.add('color-swatch-main');
                mainSwatch.style.backgroundColor = theme.mainContainerBg;
                colorSwatches.appendChild(mainSwatch);

                const headerSwatch = document.createElement('div');
                headerSwatch.classList.add('color-swatch-header');
                headerSwatch.style.backgroundColor = theme.headerBg;
                colorSwatches.appendChild(headerSwatch);

                themePreview.appendChild(colorSwatches);

                const themeName = document.createElement('div');
                themeName.classList.add('theme-name');
                themeName.textContent = theme.name;
                themePreview.appendChild(themeName);

                const applyButton = document.createElement('button');
                applyButton.classList.add('apply-button');
                applyButton.textContent = 'Apply';
                applyButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    currentBaseThemeKey = null;
                    currentBaseTheme = theme;
                    applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                        themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                        themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                        themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                        themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                        themeAccentColorInput, themeDayCellBorderColorInput
                    });
                    updateThemeSelectionInSettings();
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, theme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                });
                themePreview.appendChild(applyButton);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('themed-button', 'danger', 'mt-2', 'w-full', 'py-1', 'text-xs');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    deleteCustomTheme(index);
                });
                themePreview.appendChild(deleteButton);

                savedThemePreviewsEl.appendChild(themePreview);
            });
        };

        const deleteCustomTheme = async (index) => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to delete this custom theme?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmDeleteThemeYes">Yes</button>
                            <button class="themed-button secondary" id="confirmDeleteThemeNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmDeleteThemeYes').onclick = async () => {
                savedCustomThemes.splice(index, 1);
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                renderSavedThemes();
                confirmBox.remove();
            };
            document.getElementById('confirmDeleteThemeNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleRemoveAllEvents = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove all events?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmRemoveAllEventsYes">Yes</button>
                            <button class="themed-button secondary" id="confirmRemoveAllEventsNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveAllEventsYes').onclick = async () => {
                events = [];
                holderEvents = [];
                await saveEvents();
                renderCalendar();
                renderHolderEvents();
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveAllEventsNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleRemoveAllCustomThemes = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to remove all custom themes?</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button" id="confirmRemoveAllThemesYes">Yes</button>
                            <button class="themed-button secondary" id="confirmRemoveAllThemesNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmRemoveAllThemesYes').onclick = async () => {
                savedCustomThemes = [];
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                renderSavedThemes();
                confirmBox.remove();
            };
            document.getElementById('confirmRemoveAllThemesNo').onclick = () => {
                confirmBox.remove();
            };
        };

        const handleResetApplication = () => {
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0" style="background-color: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="p-6 rounded-lg shadow-xl text-center" style="border-radius: var(--ui-roundness-lg); background-color: var(--main-container-bg); color: var(--text-color);">
                        <p class="text-lg font-semibold mb-4" style="color: var(--text-color);">Are you sure you want to reset the entire application?</p>
                        <p class="text-sm text-gray-500 mb-4">(This will delete all events, custom themes, and reset all settings)</p>
                        <div class="flex justify-center space-x-4">
                            <button class="themed-button danger" id="confirmResetAppYes">Yes, Reset All</button>
                            <button class="themed-button secondary" id="confirmResetAppNo">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmResetAppYes').onclick = async () => {
                await Preferences.clear();
                location.reload();
            };
            document.getElementById('confirmResetAppNo').onclick = () => {
                confirmBox.remove();
            };
        };


        const handleSaveSettings = async () => {
            const uiRoundness = uiRoundnessInput.value;
            const fontSize = fontSizeInput.value;
            const eventRoundness = eventRoundnessInput.value;
            const eventBorderThickness = eventBorderThicknessInput.value;
            const dayCellMinWidth = dayCellMinWidthInput.value;
            const newHolderIconEnabled = holderIconToggle.checked;
            const newNoBackgroundMode = noBackgroundToggle.checked;
            const newDisableSidebarAnimations = disableSidebarAnimationsToggle.checked;
            const newHideScrollbars = hideScrollbarsToggle.checked;
            const newFoldDayCellsEnabled = foldDayCellsToggle.checked;
            const newShowHolderByDefault = showHolderByDefaultToggle.checked;
            const newUse24HourFormat = use24HourFormatToggle.checked;
            const newHideAddEventButtonInHolder = hideAddEventButtonInHolderToggle.checked;

            let customThemeColorsToSave = null;
            if (currentBaseThemeKey === null) {
                customThemeColorsToSave = getCustomThemeColorsFromInputs();
                currentBaseTheme = customThemeColorsToSave;
            } else {
                currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
            }

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });

            document.documentElement.style.setProperty('--ui-roundness', `${uiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${uiRoundness * 1.5}px`);
            
            const mainContainerRadius = noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${uiRoundness * 1.5}px`;
            document.querySelector('#main-container').style.borderRadius = mainContainerRadius;
            document.querySelector('#event-modal .modal-content').style.borderRadius = `${uiRoundness * 1.5}px`;
            document.querySelector('#settings-modal .modal-content').style.borderRadius = `${uiRoundness * 1.5}px`;

            document.documentElement.style.setProperty('--base-font-size', `${fontSize}px`);
            document.documentElement.style.setProperty('--event-item-roundness', `${eventRoundness}px`);
            document.documentElement.style.setProperty('--event-item-border-thickness', `${eventBorderThickness}px`);
            document.documentElement.style.setProperty('--day-cell-min-width', `${dayCellMinWidth}px`);

            const fontToSave = currentCustomFontName || null;
            let fontDataToSave = null;
            if (fontToSave) {
                const storedSettingsValue = (await Preferences.get({ key: 'calendarSettings' })).value;
                if (storedSettingsValue) {
                    fontDataToSave = JSON.parse(storedSettingsValue).customFontData;
                }
            }

            disableSidebarAnimations = newDisableSidebarAnimations;
            applyAnimationsState();

            hideScrollbars = newHideScrollbars;
            applyScrollbarVisibility();

            foldDayCellsEnabled = newFoldDayCellsEnabled;
            showHolderByDefault = newShowHolderByDefault;
            use24HourFormat = newUse24HourFormat;
            hideAddEventButtonInHolder = newHideAddEventButtonInHolder; 
            applyAddEventButtonVisibility(); 

            await saveSettings(fontToSave, fontDataToSave, currentBaseThemeKey, isDarkModeActive, uiRoundness, fontSize, eventRoundness, eventBorderThickness, dayCellMinWidth, customThemeColorsToSave, unlockedSpecialThemesKeys, newHolderIconEnabled, newNoBackgroundMode, savedCustomThemes, newDisableSidebarAnimations, newHideScrollbars, newFoldDayCellsEnabled, newShowHolderByDefault, newUse24HourFormat, holderSidebarWidth, newHideAddEventButtonInHolder);
            holderIconEnabled = newHolderIconEnabled;
            noBackgroundMode = newNoBackgroundMode;
            updateHamburgerIconVisibility();
            updateMainContainerLayout();
            if (showHolderByDefault && !holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            } else if (!showHolderByDefault && holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            }
            closeSettingsModal();
        };

        const updateHamburgerIconVisibility = () => {
            if (holderIconEnabled) {
                hamburgerIcon.classList.remove('hidden');
            } else {
                hamburgerIcon.classList.add('hidden');
                holderSidebar.style.left = `-${parseInt(getComputedStyle(holderSidebar).width)}px`;
                holderSidebar.classList.remove('active');
            }
            updateMainContainerLayout();
        };

        const toggleHolderSidebar = () => {
            const sidebar = document.getElementById('holder-sidebar');
            if (disableSidebarAnimations) {
                sidebar.style.transition = 'none';
            } else {
                sidebar.style.transition = 'left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out';
            }

            if (sidebar.classList.contains('active')) {
                sidebar.style.left = `-${parseInt(getComputedStyle(sidebar).width)}px`;
                sidebar.classList.remove('active');
            } else {
                sidebar.style.left = '0px';
                sidebar.classList.add('active');
            }
            updateMainContainerLayout();
        };

        const updateMainContainerLayout = () => {
            const sidebarWidth = parseInt(getComputedStyle(holderSidebar).width);
            const mainContainer = document.getElementById('main-container');

            if (disableSidebarAnimations) {
                mainContainer.style.transition = 'none';
            } else {
                mainContainer.style.transition = 'all 0.2s ease-out';
            }

            if (window.innerWidth <= 768) {
                document.documentElement.style.setProperty('--main-container-margin', '0');
                document.documentElement.style.setProperty('--main-container-width', '100vw');
                document.documentElement.style.setProperty('--main-container-height', '100vh');
                document.documentElement.style.setProperty('--main-container-border-radius-actual', '0px');
                return;
            }

            if (holderSidebar.classList.contains('active')) {
                document.documentElement.style.setProperty('--main-container-width', `calc(100vw - ${noBackgroundMode ? '0px' : '2rem'} - ${sidebarWidth}px)`);
                document.documentElement.style.setProperty('--main-container-margin', `${noBackgroundMode ? '0' : '1rem'} ${noBackgroundMode ? '0' : '1rem'} ${noBackgroundMode ? '0' : '1rem'} calc(${noBackgroundMode ? '0px' : '1rem'} + ${sidebarWidth}px)`);
                if (noBackgroundMode) {
                    mainContainer.style.borderRadius = '0px';
                }
            } else {
                document.documentElement.style.setProperty('--main-container-width', `calc(100vw - ${noBackgroundMode ? '0px' : '2rem'})`);
                document.documentElement.style.setProperty('--main-container-margin', `${noBackgroundMode ? '0' : '1rem'} auto`);
                document.documentElement.style.setProperty('--main-container-border-radius-actual', noBackgroundMode ? '0px' : 'var(--ui-roundness-lg)');
                mainContainer.style.borderRadius = noBackgroundMode ? '0px' : getComputedStyle(document.documentElement).getPropertyValue('--ui-roundness-lg');
            }
            document.documentElement.style.setProperty('--main-container-height', noBackgroundMode ? '100vh' : 'calc(100vh - 2rem)');
        };

        const applyAnimationsState = () => {
            const sidebar = document.getElementById('holder-sidebar');
            const mainContainer = document.getElementById('main-container');

            if (disableSidebarAnimations) {
                sidebar.style.transition = 'none';
                mainContainer.style.transition = 'none';
            } else {
                sidebar.style.transition = 'left 0.3s ease-in-out, background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out';
                mainContainer.style.transition = 'all 0.2s ease-out';
            }
        };

        const applyScrollbarVisibility = () => {
            const scrollContainers = document.querySelectorAll('.calendar-scroll-container, .modal-content-scrollable, .icon-grid, #holder-content');
            if (hideScrollbars) {
                scrollContainers.forEach(container => container.classList.add('hide-scrollbars'));
                document.querySelectorAll('.day-cell.folded').forEach(cell => cell.classList.add('hide-scrollbars'));
            } else {
                scrollContainers.forEach(container => container.classList.remove('hide-scrollbars'));
                document.querySelectorAll('.day-cell.folded').forEach(cell => cell.classList.remove('hide-scrollbars'));
            }
        };

        const applyAddEventButtonVisibility = () => {
            if (addHolderEventButton) {
                if (hideAddEventButtonInHolder) {
                    addHolderEventButton.classList.add('hidden');
                } else {
                    addHolderEventButton.classList.remove('hidden');
                }
            }
        };

        const setupHolderResizing = () => {
            holderResizeHandle.addEventListener('mousedown', (e) => {
                isResizingHolder = true;
                initialMouseX = e.clientX;
                initialHolderWidth = holderSidebar.offsetWidth;
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none'; 
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizingHolder) return;

                let newWidth = initialHolderWidth + (e.clientX - initialMouseX);
                newWidth = Math.max(MIN_HOLDER_WIDTH, Math.min(MAX_HOLDER_WIDTH, newWidth));

                holderSidebar.style.width = `${newWidth}px`;
                document.documentElement.style.setProperty('--holder-sidebar-width', `${newWidth}px`);
                holderSidebarWidth = newWidth;
                updateMainContainerLayout();
            });

            document.addEventListener('mouseup', async () => {
                if (isResizingHolder) {
                    isResizingHolder = false;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';
                    await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                                 uiRoundnessInput.value, fontSizeInput.value,
                                 eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
                }
            });
        };


        window.onload = async () => {
            calendarEl = document.getElementById('calendar');
            currentMonthYearEl = document.getElementById('currentMonthYear');
            prevMonthButton = document.getElementById('prevMonth');
            nextMonthButton = document.getElementById('nextMonth');
            todayButton = document.getElementById('todayButton');
            settingsButton = document.getElementById('settingsButton');

            eventModal = document.getElementById('event-modal');
            modalTitle = document.getElementById('modal-title');
            eventTitleInput = document.getElementById('eventTitle');
            eventTimeInput = document.getElementById('eventTime');
            eventDateInput = document.getElementById('eventDate');
            eventDescriptionInput = document.getElementById('eventDescription');
            eventColorInput = document.getElementById('eventColor');
            iconGridEl = document.getElementById('iconGrid');
            eventIconInput = document.getElementById('eventIcon');
            colorPaletteEl = document.getElementById('colorPalette');
            saveEventButton = document.getElementById('saveEvent');
            deleteEventButton = document.getElementById('deleteEvent');
            cancelEventButton = document.getElementById('cancelEvent');
            iconSearchInput = document.getElementById('iconSearchInput');
            eventIconDisplay = document.getElementById('eventIconDisplay');

            effectGlowing = document.getElementById('effectGlowing');
            effectStriped = document.getElementById('effectStriped');
            effectDotted = document.getElementById('effectDotted');
            effectParticles = document.getElementById('effectParticles');
            effectSnowFalling = document.getElementById('effectSnowFalling');
            effectGlisteningStars = document.getElementById('effectGlisteningStars');
            effectGradient = document.getElementById('effectGradient');
            effectAnimatedStripes = document.getElementById('effectAnimatedStripes');
            effectAnimatedVerticalRainbow = document.getElementById('effectAnimatedVerticalRainbow');


            settingsModal = document.getElementById('settings-modal');
            customFontUploadInput = document.getElementById('customFontUpload');
            customFontNameDisplay = document.getElementById('customFontNameDisplay');
            resetCustomFontButton = document.getElementById('resetCustomFont');
            premadeThemeBoxesContainer = document.getElementById('premadeThemeBoxesContainer');
            premadeThemeBoxesEl = document.getElementById('premadeThemeBoxes');
            specialThemeBoxesEl = document.getElementById('specialThemeBoxes');

            uiRoundnessInput = document.getElementById('uiRoundness');
            uiRoundnessValueDisplay = document.getElementById('uiRoundnessValue');
            fontSizeInput = document.getElementById('fontSize');
            fontSizeValueDisplay = document.getElementById('fontSizeValue');
            holderIconToggle = document.getElementById('holderIconToggle');
            noBackgroundToggle = document.getElementById('noBackgroundToggle');
            disableSidebarAnimationsToggle = document.getElementById('disableSidebarAnimationsToggle');
            hideScrollbarsToggle = document.getElementById('hideScrollbarsToggle');
            foldDayCellsToggle = document.getElementById('foldDayCellsToggle');
            showHolderByDefaultToggle = document.getElementById('showHolderByDefaultToggle');
            use24HourFormatToggle = document.getElementById('use24HourFormatToggle');
            hideAddEventButtonInHolderToggle = document.getElementById('hideAddEventButtonInHolderToggle');

            eventRoundnessInput = document.getElementById('eventRoundness');
            eventRoundnessValueDisplay = document.getElementById('eventRoundnessValue');
            eventBorderThicknessInput = document.getElementById('eventBorderThickness');
            eventBorderThicknessValueDisplay = document.getElementById('eventBorderThicknessValue');
            dayCellMinWidthInput = document.getElementById('dayCellMinWidth');
            dayCellMinWidthValueDisplay = document.getElementById('dayCellMinWidthValue');


            themeBodyBgInput = document.getElementById('themeBodyBg');
            themeTextColorInput = document.getElementById('themeTextColor');
            themeHeaderBgInput = document.getElementById('themeHeaderBg');
            themeMainContainerBgInput = document.getElementById('themeMainContainerBg');
            themeDayCellBgInput = document.getElementById('themeDayCellBg');
            themeDayCellHoverBgInput = document.getElementById('themeDayCellHoverBg');
            themeCurrentDayBgInput = document.getElementById('themeCurrentDayBg');
            themePrimaryButtonBgInput = document.getElementById('themePrimaryButtonBg');
            themePrimaryButtonTextInput = document.getElementById('themePrimaryButtonText');
            themeSecondaryButtonBgInput = document.getElementById('themeSecondaryButtonBg');
            themeSecondaryButtonTextInput = document.getElementById('themeSecondaryButtonText');
            themeAccentColorInput = document.getElementById('themeAccentColor');
            themeDayCellBorderColorInput = document.getElementById('themeDayCellBorderColor');

            saveSettingsButton = document.getElementById('saveSettings');
            cancelSettingsButton = document.getElementById('cancelSettings');

            saveCustomThemeButton = document.getElementById('saveCustomThemeButton');
            savedThemePreviewsEl = document.getElementById('savedThemePreviews');
            removeAllEventsButton = document.getElementById('removeAllEventsButton');
            resetApplicationButton = document.getElementById('resetApplicationButton');
            removeAllCustomThemesButton = document.getElementById('removeAllCustomThemesButton');

            themeNameModal = document.getElementById('theme-name-modal');
            themeNameInput = document.getElementById('themeNameInput');
            cancelThemeNameButton = document.getElementById('cancelThemeName');
            saveThemeNameButton = document.getElementById('saveThemeName');
            cancelThemeNameButton.addEventListener('click', closeThemeNameModal);
            saveThemeNameButton.addEventListener('click', handleSaveThemeName);

            holderContentEl = document.getElementById('holder-content');
            hamburgerIcon = document.getElementById('hamburgerIcon');
            holderSidebar = document.getElementById('holder-sidebar');
            mainContainerEl = document.getElementById('main-container');
            holderSidebarCloseButton = document.getElementById('holderSidebarCloseButton');
            addHolderEventButton = document.getElementById('addHolderEventButton');
            holderResizeHandle = document.querySelector('.resize-handle');


            eventContextMenu = document.getElementById('eventContextMenu');
            contextEditEventButton = document.getElementById('contextEditEvent');
            contextDuplicateEventButton = document.getElementById('contextDuplicateEvent');
            contextDeleteEventButton = document.getElementById('contextDeleteEvent');

            darkModeButton = document.getElementById('darkModeButton');
            
            darkModeButton.addEventListener('click', async () => {
                isDarkModeActive = !isDarkModeActive;
                
                // dark mode button on off thingy switchy
                darkModeButton.innerHTML = `Dark Mode <span class="small-text">(${isDarkModeActive ? 'On' : 'Off'})</span>`;
                
                darkModeButton.classList.toggle('selected');
                
                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                
                // SAVE SETTINGS RAAAAAAAAAAAAHHHHHHH
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                    uiRoundnessInput.value, fontSizeInput.value,
                    eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, 
                    currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, 
                    savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, 
                    showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            const loadedSettings = await loadSettings();

            if (loadedSettings.customFontData && loadedSettings.currentCustomFontName) {
                injectCustomFont(loadedSettings.currentCustomFontName, loadedSettings.customFontData);
                applyFont(loadedSettings.currentCustomFontName);
                customFontNameDisplay.textContent = loadedSettings.currentCustomFontName;
            } else {
                applyFont(DEFAULT_FONT_FAMILY);
                customFontNameDisplay.textContent = 'Inter (Default)';
            }
            currentCustomFontName = loadedSettings.currentCustomFontName;

            isDarkModeActive = loadedSettings.isDarkModeActive;
            holderIconToggle.checked = loadedSettings.holderIconEnabled;
            holderIconEnabled = loadedSettings.holderIconEnabled;
            noBackgroundToggle.checked = loadedSettings.noBackgroundMode;
            noBackgroundMode = loadedSettings.noBackgroundMode;
            disableSidebarAnimationsToggle.checked = loadedSettings.disableSidebarAnimations;
            disableSidebarAnimations = loadedSettings.disableSidebarAnimations;
            hideScrollbarsToggle.checked = loadedSettings.hideScrollbars;
            hideScrollbars = loadedSettings.hideScrollbars;
            foldDayCellsToggle.checked = loadedSettings.foldDayCellsEnabled;
            foldDayCellsEnabled = loadedSettings.foldDayCellsEnabled;
            showHolderByDefaultToggle.checked = loadedSettings.showHolderByDefault;
            showHolderByDefault = loadedSettings.showHolderByDefault;
            use24HourFormatToggle.checked = loadedSettings.use24HourFormat;
            use24HourFormat = loadedSettings.use24HourFormat;
            hideAddEventButtonInHolderToggle.checked = loadedSettings.hideAddEventButtonInHolder;
            hideAddEventButtonInHolder = loadedSettings.hideAddEventButtonInHolder;
            holderSidebarWidth = loadedSettings.holderSidebarWidth;
            document.documentElement.style.setProperty('--holder-sidebar-width', `${holderSidebarWidth}px`);


            currentBaseThemeKey = loadedSettings.currentBaseThemeKey;
            if (currentBaseThemeKey === null) {
                currentBaseTheme = loadedSettings.customThemeColors || { ...THEMES.pastelBlue.light };
            } else {
                if (THEMES[currentBaseThemeKey]) {
                    currentBaseTheme = isDarkModeActive ? THEMES[currentBaseThemeKey].dark : THEMES[currentBaseThemeKey].light;
                } else {
                    currentBaseTheme = THEMES.pastelBlue.light;
                    currentBaseThemeKey = 'pastelBlue';
                }
            }


            initPremadeThemeBoxes();
            initSpecialThemeBoxes();

            updateThemeSelectionInSettings();

            uiRoundnessInput.value = loadedSettings.currentUiRoundness;
            uiRoundnessValueDisplay.textContent = `${loadedSettings.currentUiRoundness}px`;
            document.documentElement.style.setProperty('--ui-roundness', `${loadedSettings.currentUiRoundness}px`);
            document.documentElement.style.setProperty('--ui-roundness-lg', `${loadedSettings.currentUiRoundness * 1.5}px`);
            
            const initialMainContainerRadius = loadedSettings.noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${loadedSettings.currentUiRoundness * 1.5}px`;
            document.documentElement.style.setProperty('--main-container-border-radius-actual', initialMainContainerRadius);
            mainContainerEl.style.borderRadius = initialMainContainerRadius;


            const eventModalContent = document.querySelector('#event-modal .modal-content');
            if (eventModalContent) eventModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;
            const settingsModalContent = document.querySelector('#settings-modal .modal-content');
            if (settingsModalContent) settingsModalContent.style.borderRadius = `${loadedSettings.currentUiRoundness * 1.5}px`;

            fontSizeInput.value = loadedSettings.currentFontSize;
            fontSizeValueDisplay.textContent = `${loadedSettings.currentFontSize}px`;
            document.documentElement.style.setProperty('--base-font-size', `${loadedSettings.currentFontSize}px`);

            eventRoundnessInput.value = loadedSettings.currentEventRoundness;
            eventRoundnessValueDisplay.textContent = `${loadedSettings.currentEventRoundness}px`;
            document.documentElement.style.setProperty('--event-item-roundness', `${loadedSettings.currentEventRoundness}px`);

            eventBorderThicknessInput.value = loadedSettings.currentEventBorderThickness;
            eventBorderThicknessValueDisplay.textContent = `${loadedSettings.currentEventBorderThickness}px`;
            document.documentElement.style.setProperty('--event-item-border-thickness', `${loadedSettings.currentEventBorderThickness}px`);

            dayCellMinWidthInput.value = loadedSettings.currentDayCellMinWidth;
            dayCellMinWidthValueDisplay.textContent = `${loadedSettings.currentDayCellMinWidth}px`;
            document.documentElement.style.setProperty('--day-cell-min-width', `${loadedSettings.currentDayCellMinWidth}px`);

            applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                themeAccentColorInput, themeDayCellBorderColorInput
            });
            updateMainContainerLayout();


            await loadEvents();
            initColorPalette();
            initIconGrid();
            renderCalendar();
            renderHolderEvents();
            applyAnimationsState();
            applyScrollbarVisibility();
            applyAddEventButtonVisibility(); 


            updateHamburgerIconVisibility();
            if (showHolderByDefault && !holderSidebar.classList.contains('active')) {
                toggleHolderSidebar();
            }
            setupHolderResizing();


            prevMonthButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            nextMonthButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            todayButton.addEventListener('click', () => {
                calendarEl.style.opacity = 0;
                setTimeout(() => {
                    currentDate = new Date();
                    renderCalendar();
                    calendarEl.style.opacity = 1;
                }, 200);
            });

            settingsButton.addEventListener('click', openSettingsModal);
            saveEventButton.addEventListener('click', handleSaveEvent);
            deleteEventButton.addEventListener('click', handleDeleteEvent);
            cancelEventButton.addEventListener('click', closeEventModal);
            saveSettingsButton.addEventListener('click', handleSaveSettings);
            cancelSettingsButton.addEventListener('click', closeSettingsModal);
            customFontUploadInput.addEventListener('change', handleFontUpload);
            resetCustomFontButton.addEventListener('click', resetCustomFont);

            iconSearchInput.addEventListener('input', (e) => {
                initIconGrid(e.target.value);
            });

            eventIconDisplay.addEventListener('click', () => {
                const iconSection = document.getElementById('iconSearchInput').closest('div');
                if (iconSection) {
                    const modalScrollableContent = eventModal.querySelector('.modal-content-scrollable');
                    if (modalScrollableContent) {
                        modalScrollableContent.scrollTo({
                            top: iconSection.offsetTop - (modalScrollableContent.offsetTop || 0),
                            behavior: 'smooth'
                        });
                    }
                }
            });


            uiRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                uiRoundnessValueDisplay.textContent = `${value}px`;
                uiRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 24) * 8}px`;
                document.documentElement.style.setProperty('--ui-roundness', `${value}px`);
                document.documentElement.style.setProperty('--ui-roundness-lg', `${value * 1.5}px`);
                
                const currentMainContainerRadius = noBackgroundMode && holderSidebar.classList.contains('active') ? '0px' : `${value * 1.5}px`;
                document.documentElement.style.setProperty('--main-container-border-radius-actual', currentMainContainerRadius);
                mainContainerEl.style.borderRadius = currentMainContainerRadius;

                document.querySelector('#event-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                document.querySelector('#settings-modal .modal-content').style.borderRadius = `${value * 1.5}px`;
                renderSavedThemes();
            });

            eventRoundnessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventRoundnessValueDisplay.textContent = `${value}px`;
                eventRoundnessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 24) * 8}px`;
                document.documentElement.style.setProperty('--event-item-roundness', `${value}px`);
            });

            eventBorderThicknessInput.addEventListener('input', (e) => {
                const value = e.target.value;
                eventBorderThicknessValueDisplay.textContent = `${value}px`;
                eventBorderThicknessValueDisplay.style.fontSize = `${14 + (parseInt(value) / 5) * 4}px`;
                document.documentElement.style.setProperty('--event-item-border-thickness', `${value}px`);
            });

            fontSizeInput.addEventListener('input', (e) => {
                const value = e.target.value;
                fontSizeValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--base-font-size', `${value}px`);
            });

            dayCellMinWidthInput.addEventListener('input', (e) => {
                const value = e.target.value;
                dayCellMinWidthValueDisplay.textContent = `${value}px`;
                document.documentElement.style.setProperty('--day-cell-min-width', `${value}px`);
            });

            holderIconToggle.addEventListener('change', async () => {
                holderIconEnabled = holderIconToggle.checked;
                updateHamburgerIconVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            noBackgroundToggle.addEventListener('change', async () => {
                noBackgroundMode = noBackgroundToggle.checked;
                updateMainContainerLayout();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth, hideAddEventButtonInHolder);
            });

            disableSidebarAnimationsToggle.addEventListener('change', async () => {
                disableSidebarAnimations = disableSidebarAnimationsToggle.checked;
                applyAnimationsState();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            hideScrollbarsToggle.addEventListener('change', async () => {
                hideScrollbars = hideScrollbarsToggle.checked;
                applyScrollbarVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            foldDayCellsToggle.addEventListener('change', async () => {
                foldDayCellsEnabled = foldDayCellsToggle.checked;
                renderCalendar();
                applyScrollbarVisibility();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            showHolderByDefaultToggle.addEventListener('change', async () => {
                showHolderByDefault = showHolderByDefaultToggle.checked;
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });

            use24HourFormatToggle.addEventListener('change', async () => {
                use24HourFormat = use24HourFormatToggle.checked;
                renderCalendar();
                renderHolderEvents();
                await saveSettings(currentCustomFontName, null, currentBaseThemeKey, isDarkModeActive,
                             uiRoundnessInput.value, fontSizeInput.value,
                             eventRoundnessInput.value, eventBorderThicknessInput.value, dayCellMinWidthInput.value, currentBaseTheme, unlockedSpecialThemesKeys, holderIconEnabled, noBackgroundMode, savedCustomThemes, disableSidebarAnimations, hideScrollbars, foldDayCellsEnabled, showHolderByDefault, use24HourFormat, holderSidebarWidth);
            });


            hamburgerIcon.addEventListener('click', toggleHolderSidebar);
            holderSidebarCloseButton.addEventListener('click', toggleHolderSidebar);
            addHolderEventButton.addEventListener('click', () => {
                openEventModal(null, 'holder');
            });

            const updateThemeAndApply = async () => {
                currentBaseThemeKey = null;
                currentBaseTheme = getCustomThemeColorsFromInputs();

                applyTheme(getEffectiveTheme(currentBaseThemeKey, isDarkModeActive), {
                    themeBodyBgInput, themeTextColorInput, themeHeaderBgInput, themeMainContainerBgInput,
                    themeDayCellBgInput, themeDayCellHoverBgInput, themeCurrentDayBgInput,
                    themePrimaryButtonBgInput, themePrimaryButtonTextInput,
                    themeSecondaryButtonBgInput, themeSecondaryButtonTextInput,
                    themeAccentColorInput, themeDayCellBorderColorInput
                });
                updateThemeSelectionInSettings();
            };

            themeBodyBgInput.addEventListener('input', updateThemeAndApply);
            themeTextColorInput.addEventListener('input', updateThemeAndApply);
            themeHeaderBgInput.addEventListener('input', updateThemeAndApply);
            themeMainContainerBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBgInput.addEventListener('input', updateThemeAndApply);
            themeDayCellHoverBgInput.addEventListener('input', updateThemeAndApply);
            themeCurrentDayBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themePrimaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonBgInput.addEventListener('input', updateThemeAndApply);
            themeSecondaryButtonTextInput.addEventListener('input', updateThemeAndApply);
            themeAccentColorInput.addEventListener('input', updateThemeAndApply);
            themeDayCellBorderColorInput.addEventListener('input', updateThemeAndApply);

            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    closeEventModal();
                }
            });

            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    closeSettingsModal();
                }
            });

            holderContentEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                holderContentEl.classList.add('drag-over');
            });

            holderContentEl.addEventListener('dragleave', () => {
                holderContentEl.classList.remove('drag-over');
            });

            holderContentEl.addEventListener('drop', async (e) => {
                e.preventDefault();
                holderContentEl.classList.remove('drag-over');

                const droppedEventId = e.dataTransfer.getData('text/plain');
                if (!droppedEventId) return;

                const eventIndex = events.findIndex(event => event.id === droppedEventId);
                if (eventIndex !== -1) {
                    const eventToMove = events.splice(eventIndex, 1)[0];
                    eventToMove.date = 'holder';
                    holderEvents.push(eventToMove);
                    await saveEvents();
                    renderCalendar();
                    renderHolderEvents();
                }
            });

            removeAllEventsButton.addEventListener('click', handleRemoveAllEvents);
            removeAllCustomThemesButton.addEventListener('click', handleRemoveAllCustomThemes);
            resetApplicationButton.addEventListener('click', handleResetApplication);
            saveCustomThemeButton.addEventListener('click', handleSaveCustomTheme); 

            contextEditEventButton.addEventListener('click', () => {
                eventContextMenu.style.display = 'none';
                if (contextMenuEventId) {
                    openEventModal(contextMenuEventId);
                }
            });

            contextDuplicateEventButton.addEventListener('click', () => {
                eventContextMenu.style.display = 'none';
                handleDuplicateEvent();
            });

            contextDeleteEventButton.addEventListener('click', () => {
                eventContextMenu.style.display = 'none';
                handleDeleteEvent();
            });

            document.addEventListener('click', (e) => {
                if (eventContextMenu.style.display === 'flex' && !eventContextMenu.contains(e.target)) {
                    eventContextMenu.style.display = 'none';
                    contextMenuEventId = null;
                }
            });

            document.addEventListener('contextmenu', (e) => {
                if (eventContextMenu.style.display === 'flex' && !eventContextMenu.contains(e.target)) {
                    eventContextMenu.style.display = 'none';
                    contextMenuEventId = null;
                }
            });
        };
    </script>
</body>
</html>
